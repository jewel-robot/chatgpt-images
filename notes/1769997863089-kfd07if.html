<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>量化回测框架Frozen 2.0 - 知乎</title>
  <meta name="created-at" content="1769997893944">
  <meta name="updated-at" content="1769997893944">
  <meta name="source-type" content="zhihu">
  <meta name="source-url" content="https://zhuanlan.zhihu.com/p/1908184551370527645">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
      color: #333;
    }
    h1 {
      color: #333;
      border-bottom: 2px solid #10a37f;
      padding-bottom: 10px;
    }
    .message-block {
      margin: 20px 0;
      padding: 16px;
      border-radius: 12px;
    }
    .role-user {
      background: #e8f4fd;
      border-left: 4px solid #3b82f6;
    }
    .role-ai {
      background: #f0fdf4;
      border-left: 4px solid #10b981;
    }
    .message-role {
      font-weight: 700;
      margin-bottom: 8px;
    }
    .role-user .message-role { color: #2563eb; }
    .role-ai .message-role { color: #059669; }
    .message-content {
      line-height: 1.6;
    }
    pre {
      background: #1a1a1a;
      color: #e5e5e5;
      padding: 16px;
      border-radius: 8px;
      overflow-x: auto;
    }
    code {
      font-family: 'Consolas', 'Monaco', monospace;
    }
    img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <h1>量化回测框架Frozen 2.0 - 知乎</h1>
  <div class="message-block role-ai">
          <div class="message-role">AI</div>
          <div class="message-content"><h1>量化回测框架Frozen 2.0</h1>
<div class="css-1od93p9"><div class="css-376mun"><span id="content"><div class="RichText ztext Post-RichText css-10o75c2" options="[object Object]"><h2 data-first-child="">前言</h2><p data-pid="GReVd4gG">时隔近一年，适配全市场的量化回测框架Frozen 2.0正式上线。相较于Frozen 1.0版本，此次更新实现了先前构思的系统架构设想，并对所计划的优化方向逐一做出了改进，详见量化回测框架Frozen 1.0。</p><p data-pid="IDXJ-cV0">事实上，Frozen 1.0版本已经具备了一个回测框架所有的基本功能，并且足够应用于实战，但在应用过程中仍然发现了很多问题，比如数据更新困难，因子计算繁琐，计算效率低下，回测中的bug......</p><p data-pid="dxOIcX1c">基于以上痛点，Frozen 2.0应运而生。其实早在去年年底就基本完成了整体框架的开发，剩下的时间都用于对框架细节的打磨，以及对现有库的二次开发，到目前为止已经形成了一个较为成熟的框架体系。</p><h2>1. Frozen回测框架介绍</h2><h2>1.1 回测框架逻辑</h2><p data-pid="J7hVuYXm">Frozen是一个通用的时间驱动量化回测框架，旨在标准化整个因子研究流程。框架将因子研究与交易回测相结合，以流水线的形式一体化投研流程；同时为在境内落地实施，框架针对A股市场的特点进行了调整（如T+1，涨跌停限制，手续费，转股分红等），以尽可能地准确反映真实市场情况。</p><p data-pid="qw8vGp_v">设计逻辑：数据终端 -&gt; 因子模块 -&gt; 组合优化 -&gt; 回测引擎</p><figure data-size="normal"><div><img src="https://raw.githubusercontent.com/jewel-robot/chatgpt-images/main/images/note_1769997863089-kfd07if_img_0_1769997863198.png" data-size="normal" data-rawwidth="1382" data-rawheight="1201" data-original-token="v2-1090ba148726708432cfae207674a267" class="origin_image zh-lightbox-thumb" width="1382" data-original="https://picx.zhimg.com/v2-cfc5891287e6081298934bc809f8b4ed_r.jpg" style="max-width: 100%; height: auto; display: block; margin: 8px 0px; border-radius: 8px;" data-github-path="images/note_1769997863089-kfd07if_img_0_1769997863198.png" data-github-sha="f5d21dc071faff02e5157b442364878d0eec3c79" alt="图片"></div><figcaption>图1 Frozen回测框架模块设计</figcaption></figure><p data-pid="lffvU1A2">此外，框架专为指数增强系列策略设计，是一个综合的选股模型；用户可对各个模块进行灵活搭配、设置自定义参数等，且相较于各大开源平台的黑箱式操作，框架的源代码透明，可直观地进行debug及业绩溯源；同时兼顾策略的私有属性，本地部署能最大限度地保障安全性。</p><h2>1.2 框架基本假设</h2><p data-pid="kIYXvyQC">回测引擎有如下默认设置：</p><ul style="list-style-type: disc; padding-left: 1.5em; margin-left: 0px; margin-top: 0.5em; margin-bottom: 0.5em;"><li data-pid="OFSLYf7v" style="display: list-item; margin-top: 0.25em; margin-bottom: 0.25em;">信号生成：因子的计算于调仓日前一天收盘后进行</li><li data-pid="AFOFH_Xm" style="display: list-item; margin-top: 0.25em; margin-bottom: 0.25em;">下单模拟：在每个持仓期间，投资者以起始日开盘价买入，以结束日收盘价卖出</li><li data-pid="Y-5YAus0" style="display: list-item; margin-top: 0.25em; margin-bottom: 0.25em;">交易成本：手续费（佣金）双边收取，印花税及滑点固定</li><li data-pid="S6VJP9ku" style="display: list-item; margin-top: 0.25em; margin-bottom: 0.25em;">交易限制：成交额资金量无限制，成交单位最少为一手（100股）</li><li data-pid="P2N2NmTP" style="display: list-item; margin-top: 0.25em; margin-bottom: 0.25em;">调仓频率：支持中低频策略（日频以上）</li><li data-pid="PtYagKLs" style="display: list-item; margin-top: 0.25em; margin-bottom: 0.25em;">风控阈值：股价触及止盈/止损阈值，投资者立刻以当前价格卖出</li><li data-pid="7UfEZFkP" style="display: list-item; margin-top: 0.25em; margin-bottom: 0.25em;">涨停处理：计划买入的股票当日涨停无法买入，顺延至下一交易日以开盘价买入</li><li data-pid="eVGH08gz" style="display: list-item; margin-top: 0.25em; margin-bottom: 0.25em;">跌停处理：持有的股票当日跌停不能卖出，顺延至下一交易日以收盘价卖出</li></ul><h2>1.3 基本模块说明</h2><h3>1.3.1 basis</h3><p data-pid="q-3EIP32">该模块是框架的基本配置，以yaml形式储存，其中defalut_config是框架的默认设置，包括日志配置、运行配置和策略配置等，用户可通过user_config进行自定义参数覆盖。</p><h3>1.3.2 factor</h3><p data-pid="2d1IAv1q">该模块是因子计算模块，主要有utils和extensions两个部分：</p><p data-pid="1-PWAi5s">其中utils下包括了自研的基础因子表达式模块，并用numba对部分算子进行了加速，同时加入了因子预处理功能的装饰器。</p><p data-pid="Lwd9JT-O">extensions目录下是对外部库一些功能的改写，包括alphalens，gplearn，qlib等：</p><ul style="list-style-type: disc; padding-left: 1.5em; margin-left: 0px; margin-top: 0.5em; margin-bottom: 0.5em;"><li data-pid="oRzPfoFQ" style="display: list-item; margin-top: 0.25em; margin-bottom: 0.25em;">_alphalens：因子分析模块，原本是Quantopian开发的开源工具包，但自2020年下线后不再维护，这里稍微改了些bug，能够成功运行；</li><li data-pid="cgluQ7-D" style="display: list-item; margin-top: 0.25em; margin-bottom: 0.25em;">_gplearn3d：遗传算法模块，原生的gplearn仅支持二维数据的输入，因此只能对单支股票数据进行训练，这里对源代码进行了大量修改，改为支持三维特征数据输入，同时新增大量时序算子和适应度函数；</li><li data-pid="cDm27xMv" style="display: list-item; margin-top: 0.25em; margin-bottom: 0.25em;">_qlibExpr：Qlib因子表达式引擎，源代码中存在许多开发过程中遗留的debug程序，且耦合度较高，这里整理了引擎的逻辑并进行了改造，将冗余的部分移除，重构后架构较为清晰。</li></ul><h3>1.3.3 frozen_engine</h3><p data-pid="ykjRMLja">这里存放着框架的回测引擎及组合优化模块，回测时Framework会调用Optimizer对投资组合进行优化。</p><p data-pid="lPkTIZ_u">组合优化支持等权组合、Mean-Variance、Black-Litterman以及协方差矩阵的shrinkage estimation等算法。</p><h3>1.3.4 mongodb</h3><p data-pid="cxdFU2kp">这是框架的数据端，采用mongodb作为底层数据库，定义了data_handler，data_loader，data_updater三个模块，分别对应数据的存储、提取、更新功能。</p><h3>1.3.5 sample_strategy</h3><p data-pid="Tzqd1tDn">在该目录下编写策略，通过class继承FrozenBt父类，并分别定义univ，prepare_data，calc三个方法。</p><h3>1.3.6 strategy_output</h3><p data-pid="8NP8-v75">该目录用于存储sample_strategy下的策略结果，按照策略文件名创建文件夹，文件夹下包括策略运行日志，quantstats生成的html策略绩效分析，以及记录调仓的excel表。</p><h3>1.3.7 utility</h3><p data-pid="R-85BRFm">该模块是框架运行时需调用的效用函数，如日历调整、装饰器等。</p><h2>2. 框架基本用法</h2><p data-pid="biYIhcyF">下图展示了框架运行的基本流程和相关的数据流：</p><figure data-size="normal"><div><img src="https://raw.githubusercontent.com/jewel-robot/chatgpt-images/main/images/note_1769997863089-kfd07if_img_1_1769997867759.png" data-size="normal" data-rawwidth="1454" data-rawheight="1040" data-original-token="v2-d65f7302290a932c1333927c4fc4c1b5" class="origin_image zh-lightbox-thumb" width="1454" data-original="https://picx.zhimg.com/v2-af4f23493d7a15aa54e45138bddbdafd_r.jpg" style="max-width: 100%; height: auto; display: block; margin: 8px 0px; border-radius: 8px;" data-github-path="images/note_1769997863089-kfd07if_img_1_1769997867759.png" data-github-sha="a395b6e97cb673ac8a085079f9d16ff3662c9a81" alt="图片"></div><figcaption>图2 Frozen回测框架流程图</figcaption></figure><ol style="list-style-type: decimal; padding-left: 1.5em; margin-left: 0px; margin-top: 0.5em; margin-bottom: 0.5em;"><li data-pid="AswcfXaZ" style="display: list-item; margin-top: 0.25em; margin-bottom: 0.25em;">用户在user_config中自定义框架和策略（组合优化）参数；</li><li data-pid="MvMEhKkl" style="display: list-item; margin-top: 0.25em; margin-bottom: 0.25em;">使用dataHandler/dataUpdater存储或更新数据库；</li><li data-pid="iNU8r5BS" style="display: list-item; margin-top: 0.25em; margin-bottom: 0.25em;">编写策略，需要包括定义股票池、准备数据、写因子（表达式）这三个方法； </li></ol><ul style="list-style-type: disc; padding-left: 1.5em; margin-left: 0px; margin-top: 0.5em; margin-bottom: 0.5em;"><li data-pid="Q-RQVeiw" style="display: list-item; margin-top: 0.25em; margin-bottom: 0.25em;">使用gplearn3D生成因子表达式</li><li data-pid="P1-7iapn" style="display: list-item; margin-top: 0.25em; margin-bottom: 0.25em;">使用alphalens进行因子分析检验</li></ul><ol style="list-style-type: decimal; padding-left: 1.5em; margin-left: 0px; margin-top: 0.5em; margin-bottom: 0.5em;"><li data-pid="y592w1aU" style="display: list-item; margin-top: 0.25em; margin-bottom: 0.25em;">调用FrozenBt回测引擎进行回测检验；</li><li data-pid="wRJ34ElP" style="display: list-item; margin-top: 0.25em; margin-bottom: 0.25em;">在策略对应文件夹下输出绩效分析报告；</li><li data-pid="pRq19Ztj" style="display: list-item; margin-top: 0.25em; margin-bottom: 0.25em;">改变框架参数设置，通过框架的并行调参功能进行参数寻优。</li></ol><p data-pid="Xd6CToSW">下面是一个框架全流程实况运行的demo：</p><p data-pid="tjjEKCka">视频</p><h2>2.1 数据端</h2><p data-pid="fkWjQhqX">数据端采用tushare作为数据源（至少需要5000积分的token，需自备），在本地/云端建立mongodb数据库连接，进行数据的存储、提取、更新。</p><p data-pid="kkAmXMZC">MongoDB Compass是是mongodb的可视化图形界面，能够更为便捷地与数据库进行交互，包括开展查询、监控和优化数据库，以加快开发速度。</p><figure data-size="normal"><div><img src="https://raw.githubusercontent.com/jewel-robot/chatgpt-images/main/images/note_1769997863089-kfd07if_img_2_1769997869984.png" data-size="normal" data-rawwidth="2288" data-rawheight="1508" data-original-token="v2-34ecb78f655dd7402840550570013001" class="origin_image zh-lightbox-thumb" width="2288" data-original="https://pica.zhimg.com/v2-f277b909a3108c0d12a7c063f9ac9fa6_r.jpg" style="max-width: 100%; height: auto; display: block; margin: 8px 0px; border-radius: 8px;" data-github-path="images/note_1769997863089-kfd07if_img_2_1769997869984.png" data-github-sha="8bda91a880b0309a0f3cbfb45520c204057afa98" alt="图片"></div><figcaption>图3 MongoDB Compass界面</figcaption></figure><h3>2.1.1 数据提取</h3><p data-pid="JdXcFt1Z">对应mongodb的dataLoader模块。在回测引擎中该过程不需要进行手动操作，FrozenBt会自动提取数据用于回测；但在编写策略时需要手动添加相关数据，用于因子表达式计算因子。</p><h3>2.1.2 数据存储/更新</h3><ul style="list-style-type: disc; padding-left: 1.5em; margin-left: 0px; margin-top: 0.5em; margin-bottom: 0.5em;"><li data-pid="20jLuEPY" style="display: list-item; margin-top: 0.25em; margin-bottom: 0.25em;">存储：对应mongodb的dataHandler模块。若为首次运行框架，则需要在本地建立数据库，具体操作方式为在main.py中找到<code>tushare2db()</code>方法，选择需要存储的数据（将不需要的代码注释掉）后运行此脚本；<br> </li><li data-pid="WcmPCHeC" style="display: list-item; margin-top: 0.25em; margin-bottom: 0.25em;">更新：对应mongodb的dataUpdater模块。在本地建立数据库后，需要保持对应策略频率的数据更新状态，具体操作方式为在main.py中修改<code>dbupdate()</code>，选取需要操作的数据类型后运行此脚本。<br> </li></ul><h2>2.2 因子端</h2><p data-pid="DubF4Dm3">框架的因子端主要包括三个扩展模块：gplearn3D，alphalens和因子表达式引擎，分别用于机器学习生成因子表达式、因子分析与检验以及便捷式因子计算。</p><h3>2.2.1 GPlearn3D</h3><p data-pid="9exbYU5E">遗传算法模拟了自然界中生物进化的过程，将种群中基因的交叉、变异、选择写进了程序中。它作为一个监督式机器学习算法，利用符号回归（Symbolic Regression）试图发现特征与预测值间某种隐藏的关系，因此非常适合因子挖掘的任务。</p><p data-pid="UVyC9oH-">GPlearn是一个开源的遗传规划（Genetic Programming）库，用户可以灵活地自定义算子和适应度函数。然而，原生的代码只支持二维数据输入，因此只能对单标的时间序列进行训练，这对于CTA策略的适用性较高，但在股票上很容易过拟合，无法推广到整个股票市场。</p><p data-pid="eVnLJZKA">在此背景下，gplearn3D对该库进行了二次开发，不仅支持三维特征数据（多标的多特征时间序列）输入，还增加了许多常规的因子表达式算子及因子评价指标适应度函数如rankIC，ICIR等，同时还实现了时间序列函数的滚动窗口参数的自动遗传。此外，为提高因子挖掘的效率，模块使用numba对算子进行了加速，且与回测框架的因子表达式引擎共享算子，只需将遗传得到的表达式结果（formulatic alpha）复制粘贴，即可完成因子策略的编写。</p><p data-pid="YdjrIXtR">下面是一个遗传算法迭代的例子，使用CPU并行运算挖掘因子表达式：</p><figure data-size="normal"><div><img src="https://raw.githubusercontent.com/jewel-robot/chatgpt-images/main/images/note_1769997863089-kfd07if_img_3_1769997872082.png" data-size="normal" data-rawwidth="1564" data-rawheight="768" data-original-token="v2-31e6c65216362b8ede6009582ff3f385" class="origin_image zh-lightbox-thumb" width="1564" data-original="https://pic3.zhimg.com/v2-33e5df1505c913b2c1917857e53c5d38_r.jpg" style="max-width: 100%; height: auto; display: block; margin: 8px 0px; border-radius: 8px;" data-github-path="images/note_1769997863089-kfd07if_img_3_1769997872082.png" data-github-sha="7f5cefce43a1089155e603db236925d206a57be4" alt="图片"></div><figcaption>图4 遗传算法因子挖掘</figcaption></figure><p data-pid="fu9hpT0W">对于该模块的具体用法，可以参考框架的技术文档，在这里不多做赘述。</p><h3>2.2.2 Alphalens</h3><p data-pid="hFBvRwWL">Alphalens是由Quantopian公司自主研发的一款预测性股票因子（alpha）的性能分析框架。自2020年在线量化平台Quantopian宣布关闭下线后，该库不再进行维护，至今随着numpy等依赖库的更新迭代，其部分功能出现bug。框架对部分源码进行了修改，使其能够适用于现在的版本。</p><p data-pid="UjHA2QxF">下面是一个单因子检验报告案例，需要结合编写的策略使用：</p><figure data-size="normal"><div><img src="https://raw.githubusercontent.com/jewel-robot/chatgpt-images/main/images/note_1769997863089-kfd07if_img_4_1769997874541.png" data-size="normal" data-rawwidth="1216" data-rawheight="3409" data-original-token="v2-ad1935bd137bed1191645d7ce40bfb9f" class="origin_image zh-lightbox-thumb" width="1216" data-original="https://picx.zhimg.com/v2-b6a185b70e783d23b347c07348f2083d_r.jpg" style="max-width: 100%; height: auto; display: block; margin: 8px 0px; border-radius: 8px;" data-github-path="images/note_1769997863089-kfd07if_img_4_1769997874541.png" data-github-sha="13350124787ad6af5b8762cce3f00633fe96b86f" alt="图片"></div><figcaption>图5 因子评价体系</figcaption></figure><p data-pid="AVm9lltJ">此外，该测试框架还有分位数统计、收益分析、信息分析、换手率分析、因子半衰期分析等功能可供使用。该模块具体的操作说明可见<a href="https://github.com/quantopian/alphalens" class=" wrap external" target="_blank" rel="nofollow noreferrer" data-za-detail-view-id="1043">GitHub-alphalens</a>，在此也不做赘述。</p><h3>2.2.3 因子表达式引擎</h3><h3>2.2.3.1 自研表达式引擎</h3><p data-pid="3uAS_NQT">该引擎存放在factor的utils目录下，使用ast和re依赖搭建了基础的表达式功能。引擎使用numba对特定算子进行了加速，极大幅度地提高了计算效率（提升近60倍）；此外，还定义了因子预处理的装饰器，只需在编写策略时在calc方法前加装@preprocessing装饰器，即可实现因子中性化、异常值处理以及标准化等操作。</p><p data-pid="onYrEH3N">以WorldQuant开发的Alpha101中的第9个因子为例，因子表达式可写为：</p><div class="highlight"><pre><code class="language-text">alpha_str = 'where(ts_min(delta(close, 1), 5) &gt; 0 ? delta(close, 1) : where((ts_max(delta(close, 1), 5) &lt; 0) ? delta(close, 1) : (mltp(delta(close, 1), -1))))'
alpha = eval(str2expr(alpha_str))
</code></pre></div><h3>2.2.3.2 Qlib Expression Engine</h3><p data-pid="JmVK_wzU">qlibExpr整理了引擎的逻辑并进行了改造，使其能够无缝融入到回测框架中。其优势在于能够批量计算因子并整合到同一个dataframe，并且通过Cython优化算子的计算效率。注意到某些滚动函数算子基于Cython实现，需要手动进行预编译。</p><figure data-size="normal"><div><img src="https://raw.githubusercontent.com/jewel-robot/chatgpt-images/main/images/note_1769997863089-kfd07if_img_5_1769997877119.png" data-size="normal" data-rawwidth="2804" data-rawheight="1622" data-original-token="v2-eac09712aa9f226fb594ffde5cb087a0" class="origin_image zh-lightbox-thumb" width="2804" data-original="https://pic4.zhimg.com/v2-aa52d3b7355a2a3decb81b9e2f4962a9_r.jpg" style="max-width: 100%; height: auto; display: block; margin: 8px 0px; border-radius: 8px;" data-github-path="images/note_1769997863089-kfd07if_img_5_1769997877119.png" data-github-sha="62932b307788e9bd11118865086d9bf1c6705adb" alt="图片"></div><figcaption>图6 Qlib因子表达式引擎逻辑</figcaption></figure><p data-pid="ZUo5b63U">以相同的Alpha009因子为例，使用qlib的因子表达式可写为：</p><div class="highlight"><pre><code class="language-text">data = self.prepare_data()
expr = ['If(Min(Delta($close, 1), 5) &gt; 0, Delta($close, 1), If(Max(Delta($close, 1), 5) &lt; 0, Delta($close, 1), Mul(Delta($close, 1), 1)))']
name = ['alpha_9']
alpha = calc_factor(data, expr, name)
</code></pre></div><h2>2.3 回测端</h2><p data-pid="ESbmuFxT">框架的回测端主要包括策略的编写及回测检验报告的输出，是框架的主体。</p><p data-pid="t0sjM6gC">回测方式分为单体运行和多策略运行，其中：</p><ul style="list-style-type: disc; padding-left: 1.5em; margin-left: 0px; margin-top: 0.5em; margin-bottom: 0.5em;"><li data-pid="34J5Ptj2" style="display: list-item; margin-top: 0.25em; margin-bottom: 0.25em;">策略单体：可以通过终端或Jupyter Notebook运行。前者只能通过修改config调整参数，而后者可以直接对策略进行微调；<br> </li><li data-pid="AqImEyN7" style="display: list-item; margin-top: 0.25em; margin-bottom: 0.25em;">多策略：只能通过Jupyter运行。所谓多策略，就是对于同一个因子，通过调整框架及策略参数分别运行回测，根据回测结果找到最优的参数。<br> </li></ul><h3>2.3.1 策略编写</h3><p data-pid="mCpfGtZ6">在sample_strategy下进行策略的编写，通过继承FrozenBt父类，调用回测引擎运行回测。策略需要分别定义股票池、数据、因子三个方法：</p><ul style="list-style-type: disc; padding-left: 1.5em; margin-left: 0px; margin-top: 0.5em; margin-bottom: 0.5em;"><li data-pid="gMY29aM-" style="display: list-item; margin-top: 0.25em; margin-bottom: 0.25em;">筛选股票池，剔除ST股票、创业板和科创板及上市不满一年股票；</li></ul><div class="highlight"><pre><code class="language-text">def univ(self):
  pool = basicLoader('stock_basic')
  universe = np.unique(DataHandler.pro.index_weight(index_code=frozen_config.index_code, end_date='20230101')['con_code']).tolist()
  self.universe = tuple(preliminary_screening(pool, universe))
</code></pre></div><ul style="list-style-type: disc; padding-left: 1.5em; margin-left: 0px; margin-top: 0.5em; margin-bottom: 0.5em;"><li data-pid="ddsyYQRb" style="display: list-item; margin-top: 0.25em; margin-bottom: 0.25em;">准备计算因子所需数据；</li></ul><div class="highlight"><pre><code class="language-text">def prepare_data(self):
    close, pct_chg = dataLoader('stock_daily_hfq', ('close', 'pct_chg'), self.universe)
    close = factor(close, 'close')
    pct_chg = factor(pct_chg, 'pct_chg')
    return close, pct_chg
</code></pre></div><ul style="list-style-type: disc; padding-left: 1.5em; margin-left: 0px; margin-top: 0.5em; margin-bottom: 0.5em;"><li data-pid="8Wn99HOX" style="display: list-item; margin-top: 0.25em; margin-bottom: 0.25em;">计算因子值，采用常规写法或因子表达式，并进行因子预处理（中性化、标准化及异常值处理）；</li></ul><div class="highlight"><pre><code class="language-text">@preprocessing
def calc(self):
    close, returns = self.prepare_data()
    alpha_str = 'rank(Ts_ArgMax(SignedPower(where(returns &lt; 0 ? stddev(returns, 5) : close), 2.0), 5))'
    alpha = eval(str2expr(alpha_str))
    return alpha
</code></pre></div><h3>2.3.2 终端输出</h3><p data-pid="lEV4kzmA">若回测目标为策略单体，则运行回测后，只需等待进度条结束，框架会在终端自动输出策略评价指标。</p><figure data-size="normal"><div><img src="https://raw.githubusercontent.com/jewel-robot/chatgpt-images/main/images/note_1769997863089-kfd07if_img_6_1769997879159.png" data-size="normal" data-rawwidth="2002" data-rawheight="802" data-original-token="v2-788d3b17190989b3165db41f6ca512d0" class="origin_image zh-lightbox-thumb" width="2002" data-original="https://pic2.zhimg.com/v2-50324ac505a94adfb96a3ddd2f58d19f_r.jpg" style="max-width: 100%; height: auto; display: block; margin: 8px 0px; border-radius: 8px;" data-github-path="images/note_1769997863089-kfd07if_img_6_1769997879159.png" data-github-sha="06af7858a89006d496fc8cb858f156a9c7a765e5" alt="图片"></div><figcaption>图7 策略评价指标</figcaption></figure><p data-pid="F-JSSPhd">此外，框架还会输出策略损益分布图及净值曲线（与基准相比）。</p><figure data-size="normal"><div><img src="https://raw.githubusercontent.com/jewel-robot/chatgpt-images/main/images/note_1769997863089-kfd07if_img_7_1769997881510.png" data-size="normal" data-rawwidth="1440" data-rawheight="864" data-original-token="v2-9511ca3badef16872dad7f7463707fe2" class="origin_image zh-lightbox-thumb" width="1440" data-original="https://pic2.zhimg.com/v2-9b3a5f9fa3c11b40d0a188be3ff44563_r.jpg" style="max-width: 100%; height: auto; display: block; margin: 8px 0px; border-radius: 8px;" data-github-path="images/note_1769997863089-kfd07if_img_7_1769997881510.png" data-github-sha="63d7f913400efa703572f858f5a41d3640c79a06" alt="图片"></div><figcaption>图8 策略损益及净值曲线</figcaption></figure><h3>2.3.3 绩效评估</h3><p data-pid="ANkmrBe-">在strategy_output路径下生成相应策略的虚拟账户变动历史及模拟回测报告，具体包括以下三个文件：交易日志、调仓指引和绩效分析报告。</p><h3>2.3.3.1 交易日志</h3><p data-pid="PjwtU2vE">模拟交易日志（.log）文件中记录了调仓日所选股票，下单手数，买入及卖出的手续费，周期盈亏，账户余额，交易日调整通知，止盈止损通知，以及分红送股通知等具体交易信息。</p><figure data-size="normal"><div><img src="https://raw.githubusercontent.com/jewel-robot/chatgpt-images/main/images/note_1769997863089-kfd07if_img_8_1769997883484.png" data-size="normal" data-rawwidth="1300" data-rawheight="1000" data-original-token="v2-7ad98f0e2444a97c0fbbdb61e18e5de4" class="origin_image zh-lightbox-thumb" width="1300" data-original="https://pic3.zhimg.com/v2-fafafd7cb0cd881b39df6395b6e5b21a_r.jpg" style="max-width: 100%; height: auto; display: block; margin: 8px 0px; border-radius: 8px;" data-github-path="images/note_1769997863089-kfd07if_img_8_1769997883484.png" data-github-sha="a8b425018756b0308e2c2e5dc2d604d80b942824" alt="图片"></div><figcaption>图9 交易日志</figcaption></figure><h3>2.3.3.2 调仓指引</h3><p data-pid="g_18rHIj">生成的excel spreadsheet（.xlsx）文件里记录了调仓日所选股票及组合权重。其中，权重由组合优化算法计算得出，若市场上存在做空机制，则权重也可能为负数。</p><figure data-size="normal"><div><img src="https://raw.githubusercontent.com/jewel-robot/chatgpt-images/main/images/note_1769997863089-kfd07if_img_9_1769997885755.png" data-size="normal" data-rawwidth="840" data-rawheight="1034" data-original-token="v2-f91907024c62ba135b5f6cd6119a1a2d" class="origin_image zh-lightbox-thumb" width="840" data-original="https://pica.zhimg.com/v2-7c87864966140a3c862c4317a244a668_r.jpg" style="max-width: 100%; height: auto; display: block; margin: 8px 0px; border-radius: 8px;" data-github-path="images/note_1769997863089-kfd07if_img_9_1769997885755.png" data-github-sha="dcdc8fedb406ee9f84aaeb1abe4e088f346692c8" alt="图片"></div><figcaption>图10 调仓标的及权重</figcaption></figure><h3>2.3.3.3 绩效分析报告</h3><p data-pid="uqIeG-pf">Quantstats是一款集统计、绘图、报告功能为一体的投资组合定量分析库。生成的quantstats tearsheet（.html）文件中详细地报告了策略回测结果与各类技术分析指标。</p><p data-pid="t5oJMHLl">该模块具体的操作说明可见<a href="https://github.com/ranaroussi/quantstats" class=" wrap external" target="_blank" rel="nofollow noreferrer" data-za-detail-view-id="1043">GitHub-quantstats</a>，在此也不做赘述。</p><h3>2.3.4 参数优化</h3><p data-pid="NA6yq9fi">策略单体运行结束后，可在Jupyter中修改框架设置或组合优化参数进行调参，以找到对于该因子策略最优的参数（如配合因子半衰期等）。</p><p data-pid="uC5bDBwu">框架对于参数优化有两种运行模式：</p><ul style="list-style-type: disc; padding-left: 1.5em; margin-left: 0px; margin-top: 0.5em; margin-bottom: 0.5em;"><li data-pid="9EOFVaA0" style="display: list-item; margin-top: 0.25em; margin-bottom: 0.25em;">常规模式<br> 需要将<code>run_mode</code>设置为“normal”。该模式下框架以串行的方式对每一组参数运行回测；<br> </li><li data-pid="uqZvWtHl" style="display: list-item; margin-top: 0.25em; margin-bottom: 0.25em;">并行模式<br> 需要将<code>run_mode</code>设置为“parallel”。该模式下框架以并行的方式对每一组参数运行回测；<br> </li></ul><p data-pid="o-ZnDDiN">确定框架运行模式后，需要重新定义需要调整的参数（其它参数保持不变），示例如下：</p><div class="highlight"><pre><code class="language-text">params = [{'max_stocks': 10, 'optimizer': 'equal-weight'}, 
          {'date_rule': 'W-MON', 'optimizer': 'mean-variance', 'cov_method': 'historical'}, 
          {'cov_method': 'Ledoit-Wolf', 'opt_func': 'sharpe'}, 
          {'cov_window': 90, 'long_short': True}]
</code></pre></div><p data-pid="h48mFU80">调参运行结束后，所有回测结果将整合在一个dataframe中，包含终端输出的策略评价指标以及所用参数集合，以供参考。</p><figure data-size="normal"><div><img src="https://raw.githubusercontent.com/jewel-robot/chatgpt-images/main/images/note_1769997863089-kfd07if_img_10_1769997887947.png" data-size="normal" data-rawwidth="2138" data-rawheight="338" data-original-token="v2-60b3a5f0e4a6f56419447804e6849f1e" class="origin_image zh-lightbox-thumb" width="2138" data-original="https://pica.zhimg.com/v2-60b3a5f0e4a6f56419447804e6849f1e_r.jpg" style="max-width: 100%; height: auto; display: block; margin: 8px 0px; border-radius: 8px;" data-github-path="images/note_1769997863089-kfd07if_img_10_1769997887947.png" data-github-sha="abc100261dc1160102c9e915b76767f68056010c" alt="图片"></div><figcaption>图11 回测调参结果</figcaption></figure><h2>3. 框架高级用法</h2><h2>3.1 组合优化</h2><p data-pid="dO19yfCt">在user_config中更改portfolio_config的参数设置。设置中定义了优化器、协方差矩阵估计算法、前进回测窗口、目标函数和多空组合等。</p><p data-pid="ODjzIHVx">策略端进行因子选股后，回测端通过组合优化确定权重。组合优化前后的有效前沿（efficient frontier）如下：</p><figure data-size="normal"><div><img src="https://raw.githubusercontent.com/jewel-robot/chatgpt-images/main/images/note_1769997863089-kfd07if_img_11_1769997889808.png" data-size="normal" data-rawwidth="2386" data-rawheight="1574" data-original-token="v2-c37dc5041781cb1eaa6ed482b0f295a3" class="origin_image zh-lightbox-thumb" width="2386" data-original="https://pic3.zhimg.com/v2-d207285ff699ca2313f9fbf795b4acc0_r.jpg" style="max-width: 100%; height: auto; display: block; margin: 8px 0px; border-radius: 8px;" data-github-path="images/note_1769997863089-kfd07if_img_11_1769997889808.png" data-github-sha="10330459b12ee65c7ecb256b248bf06c69736099" alt="图片"></div><figcaption>图12 组合优化有效前沿</figcaption></figure><h2>3.2 并行调参</h2><p data-pid="7OCdFBcO">多策略模式下，若调用CPU多进程并行运算，由于并行运算会导致交易日志记录的不连续性，应将<code>verbose</code>设置为<code>False</code>，同时指定运行时需要使用的CPU核数<code>num_cores</code>。</p><h2>4. 框架优化方向</h2><p data-pid="f_4hDO-o">目前主流的量化因子研究主要分为四个阶段，参照下图：</p><figure data-size="normal"><div><img src="https://raw.githubusercontent.com/jewel-robot/chatgpt-images/main/images/note_1769997863089-kfd07if_img_12_1769997891892.png" data-size="normal" data-rawwidth="1400" data-rawheight="999" data-original-token="v2-177da5c0590b25eaeac7468876484cb6" class="origin_image zh-lightbox-thumb" width="1400" data-original="https://pic1.zhimg.com/v2-227217bc3865b993a76487887b73dba8_r.jpg" style="max-width: 100%; height: auto; display: block; margin: 8px 0px; border-radius: 8px;" data-github-path="images/note_1769997863089-kfd07if_img_12_1769997891892.png" data-github-sha="9671ead01acc0cd924bdc927f126433cd1e51e2f" alt="图片"></div><figcaption>图14 量化因子研究框架阶段</figcaption></figure><ul style="list-style-type: disc; padding-left: 1.5em; margin-left: 0px; margin-top: 0.5em; margin-bottom: 0.5em;"><li data-pid="CVhagY1J" style="display: list-item; margin-top: 0.25em; margin-bottom: 0.25em;">阶段一：打通因子生成-&gt;多因子合成-&gt;组合优化的通路；<br> 在这个阶段的因子可以是根据市场规律或投资经验人工构建的，或是常规机器学习和深度学习算法预测的涨跌概率；多因子合成通常根据统计方法进行；组合优化则以经典的投资组合理论作为指导。<br> </li><li data-pid="m4VZlgHt" style="display: list-item; margin-top: 0.25em; margin-bottom: 0.25em;">阶段二：优化因子生成方式，由人工构建转换为算法自动挖掘，并利用机器学习和神经网络进行多因子组合及组合优化；<br> 这个阶段的因子通常由遗传规划或强化学习海量生成，然后通过树模型进行组合，完成选股后输入神经网络得到资产权重。<br> </li><li data-pid="gYJaajPM" style="display: list-item; margin-top: 0.25em; margin-bottom: 0.25em;">阶段三：深度学习网络实现端到端的因子挖掘和因子合成；<br> 在这个阶段，给定个股的原始价量特征，能实现端到端的特征合成和模型训练。<br> </li><li data-pid="DPM5MyPj" style="display: list-item; margin-top: 0.25em; margin-bottom: 0.25em;">阶段四：实现端到端的因子挖掘、因子合成和组合优化；<br> 在一个理想的端到端神经网络框架中，输入资产的原始数据，通过神经网络进行特征提取和合成，再通过风险预算模型优化得到资产权重，并使用目标函数优化整个神经网络。<br> </li></ul><p data-pid="vgADE_EZ">目前Frozen 2.0已经打通了第一阶段，且第二阶段进度也已过半。接下来的开发方向就是逐步将ML/DL/RL融入到框架中，敬请期待。</p><p data-pid="zPx8qB8w">具体的框架参数说明及可选参数方案后续也将在官网进行更新。</p></div><span id="VirtualCatalogAnchorPoint"></span></span></div></div></div>
        </div>
</body>
</html>