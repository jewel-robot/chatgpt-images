<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>蓝牙连接稳定性分析</title>
  <meta name="created-at" content="1767671204035">
  <meta name="updated-at" content="1766383252000">
  <meta name="source-type" content="chatgpt">
  <meta name="source-url" content="">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
      color: #333;
    }
    h1 {
      color: #333;
      border-bottom: 2px solid #10a37f;
      padding-bottom: 10px;
    }
    .message-block {
      margin: 20px 0;
      padding: 16px;
      border-radius: 12px;
    }
    .role-user {
      background: #e8f4fd;
      border-left: 4px solid #3b82f6;
    }
    .role-ai {
      background: #f0fdf4;
      border-left: 4px solid #10b981;
    }
    .message-role {
      font-weight: 700;
      margin-bottom: 8px;
    }
    .role-user .message-role { color: #2563eb; }
    .role-ai .message-role { color: #059669; }
    .message-content {
      line-height: 1.6;
    }
    pre {
      background: #1a1a1a;
      color: #e5e5e5;
      padding: 16px;
      border-radius: 8px;
      overflow-x: auto;
    }
    code {
      font-family: 'Consolas', 'Monaco', monospace;
    }
    img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <h1>蓝牙连接稳定性分析</h1>
  <div style="margin-bottom:16px;"><strong>用户:</strong><br>我现在有一个设备A和设备B，它们使用的都是经典蓝牙，如果直接connect连接时，会出现经常断开重连问题。但是如果他们之间继续使用refcomm连接后，这个蓝牙连接就比较稳定，bluetoothctl中就不会看到蓝牙断开又重连得问题，这是为什么？</div>
<div style="margin-bottom:16px;"><strong>ChatGPT:</strong><br><p data-start="0" data-end="190">简短说：<strong data-start="4" data-end="153">“connect”只把两台设备的底层 ACL 链路拉起来，但如果上面没有真正的业务/协议在跑，这条链路很快就会因为空闲或省电策略被对端主动拆掉；而一旦你建立了 RFCOMM（通常就是 SPP 串口服务），上面有一个持续的 L2CAP/RFCOMM通道在活跃，底层 ACL 就会被稳稳地维持住</strong>，所以在 <code data-start="158" data-end="172">bluetoothctl</code> 里就不再看到“断开→重连”的抖动。</p>
<p data-start="192" data-end="220">下面把核心机制和可能原因展开说清楚，并给出排查/优化点：</p>
<h2 data-start="222" data-end="230">发生了什么</h2>
<ul data-start="231" data-end="689">
<li data-start="231" data-end="409">
<p data-start="233" data-end="250"><strong data-start="233" data-end="250">ACL vs RFCOMM</strong></p>
<ul data-start="253" data-end="409">
<li data-start="253" data-end="324">
<p data-start="255" data-end="324"><em data-start="255" data-end="263">ACL 链路</em>：经典蓝牙的基础物理/链路层连接，<code data-start="280" data-end="302">bluetoothctl connect</code> 做的主要就是这个（外加做下 SDP 等）。</p>
</li>
<li data-start="327" data-end="409">
<p data-start="329" data-end="409"><em data-start="329" data-end="341">RFCOMM/SPP</em>：跑在 L2CAP 之上的会话（类似串口）。只要 RFCOMM 通道开着并有流量/保活，控制器就认为“这条链路有用”，不会按空闲策略拆。</p>
</li>
</ul>
</li>
<li data-start="410" data-end="689">
<p data-start="412" data-end="436"><strong data-start="412" data-end="436">为什么“只 connect”会频繁断开？</strong></p>
<ul data-start="439" data-end="689">
<li data-start="439" data-end="531">
<p data-start="441" data-end="531">很多设备（尤其是配件类）在 <strong data-start="455" data-end="480">没有任何活动的 L2CAP 频道/配置文件</strong> 时会设置较短的<strong data-start="488" data-end="514">空闲定时器/省电策略（sniff/park）</strong>，几秒到几十秒后主动断开 ACL。</p>
</li>
<li data-start="534" data-end="597">
<p data-start="536" data-end="597">主机侧（BlueZ）可能还在做周期性名字/服务探测或自动重连，于是你看到的是<strong data-start="574" data-end="593">短连—空闲—对端断开—主机再连</strong>的循环。</p>
</li>
<li data-start="600" data-end="689">
<p data-start="602" data-end="689">当进入 sniff/低功耗模式且<strong data-start="618" data-end="628">几乎没有数据</strong>时，更容易触发 <strong data-start="636" data-end="664">Link Supervision Timeout</strong>（监督超时），表现也是“无流量就掉，发数据就稳”。</p>
</li>
</ul>
</li>
</ul>
<h2 data-start="691" data-end="711">你看到“RFCOMM后就稳”的原因</h2>
<ul data-start="712" data-end="891">
<li data-start="712" data-end="768">
<p data-start="714" data-end="768">建立 RFCOMM 会话 = <strong data-start="729" data-end="745">有活跃的 profile</strong>，通常还有周期性数据或 keep-alive。</p>
</li>
<li data-start="769" data-end="891">
<p data-start="771" data-end="777">活跃会话会：</p>
<ul data-start="780" data-end="891">
<li data-start="780" data-end="789">
<p data-start="782" data-end="789">阻止空闲拆链。</p>
</li>
<li data-start="792" data-end="843">
<p data-start="794" data-end="843">让控制器保持更“醒”的连接参数（即使进入 sniff，间隔也会比较合理），从而<strong data-start="833" data-end="842">不容易超时</strong>。</p>
</li>
<li data-start="846" data-end="891">
<p data-start="848" data-end="891">某些设备上还会<strong data-start="855" data-end="871">锁定角色/速率/功耗参数</strong>，减少因角色切换或参数不兼容导致的抖动。</p>
</li>
</ul>
</li>
</ul>
<h2 data-start="893" data-end="915">怎么验证确诊（Linux/BlueZ）</h2>
<ul data-start="916" data-end="1167">
<li data-start="916" data-end="1080">
<p data-start="918" data-end="963"><strong data-start="918" data-end="927">抓链路日志</strong>：<code data-start="928" data-end="935">btmon</code> 一边开着，一边复现。看 Disconn Reason：</p>
<ul data-start="966" data-end="1080">
<li data-start="966" data-end="1015">
<p data-start="968" data-end="1015"><code data-start="968" data-end="974">0x08</code>（Connection Timeout）多为监督超时/低功耗间隔过大 + 无流量；</p>
</li>
<li data-start="1018" data-end="1063">
<p data-start="1020" data-end="1063"><code data-start="1020" data-end="1026">0x13</code>（Remote User Terminated）多为对端空闲策略主动拆链；</p>
</li>
<li data-start="1066" data-end="1080">
<p data-start="1068" data-end="1080">其他错误码也能帮助定位。</p>
</li>
</ul>
</li>
<li data-start="1081" data-end="1167">
<p data-start="1083" data-end="1167"><strong data-start="1083" data-end="1102">观察有无 sniff/park</strong>：<code data-start="1103" data-end="1110">btmon</code> 里会看到 mode 切换与 interval；断开前若进入 sniff 且间隔很长，基本坐实“空闲+省电”导致。</p>
</li>
</ul>
<h2 data-start="1169" data-end="1178">实用优化思路</h2>
<blockquote data-start="1179" data-end="1212">
<p data-start="1181" data-end="1212">如果你希望“即使暂时没大量数据，也别掉线”，可以考虑以下做法：</p>
</blockquote>
<ol data-start="1214" data-end="1711">
<li data-start="1214" data-end="1324">
<p data-start="1217" data-end="1233"><strong data-start="1217" data-end="1233">保持一个轻量级会话/保活</strong></p>
<ul data-start="1237" data-end="1324">
<li data-start="1237" data-end="1273">
<p data-start="1239" data-end="1273">既然 RFCOMM 已经验证有效，可以维持一个长开的 SPP 通道；</p>
</li>
<li data-start="1277" data-end="1324">
<p data-start="1279" data-end="1324">或者定期发极少量的“心跳”字节（几十字节级别即可）以刷新 supervision 定时器。</p>
</li>
</ul>
</li>
<li data-start="1325" data-end="1436">
<p data-start="1328" data-end="1341"><strong data-start="1328" data-end="1341">适配对端的省电参数</strong></p>
<ul data-start="1345" data-end="1436">
<li data-start="1345" data-end="1436">
<p data-start="1347" data-end="1436">一些设备支持配置 <strong data-start="1356" data-end="1394">sniff interval / attempt / timeout</strong>；若可调，<strong data-start="1399" data-end="1414">缩短 sniff 间隔</strong>或干脆禁止过 aggressive 的省电。</p>
</li>
</ul>
</li>
<li data-start="1437" data-end="1511">
<p data-start="1440" data-end="1459"><strong data-start="1440" data-end="1459">避免主机侧的过度自动重连/探测</strong></p>
<ul data-start="1463" data-end="1511">
<li data-start="1463" data-end="1511">
<p data-start="1465" data-end="1511">查看 BlueZ/应用层是否在“空闲时还周期性发起连接/SDP”，造成你看到的“重连风暴”。</p>
</li>
</ul>
</li>
<li data-start="1512" data-end="1608">
<p data-start="1515" data-end="1527"><strong data-start="1515" data-end="1527">检查主机电源管理</strong></p>
<ul data-start="1531" data-end="1608">
<li data-start="1531" data-end="1608">
<p data-start="1533" data-end="1608">某些平台上 <strong data-start="1539" data-end="1564">USB 蓝牙适配器 autosuspend</strong> 过于激进会让空闲链路更易掉；可以临时关闭该设备的 autosuspend 做对比实验。</p>
</li>
</ul>
</li>
<li data-start="1609" data-end="1711">
<p data-start="1612" data-end="1626"><strong data-start="1612" data-end="1626">（高阶）调整监督超时</strong></p>
<ul data-start="1630" data-end="1711">
<li data-start="1630" data-end="1711">
<p data-start="1632" data-end="1711">若能控制连接参数（经典蓝牙上较受限），增大 <strong data-start="1654" data-end="1682">Link Supervision Timeout</strong> 可以容忍更长的静默期；实际可行性取决于控制器和对端实现。</p>
</li>
</ul>
</li>
</ol>
<h2 data-start="1713" data-end="1721">TL;DR</h2>
<ul data-start="1722" data-end="1873" data-is-last-node="" data-is-only-node="">
<li data-start="1722" data-end="1767">
<p data-start="1724" data-end="1767">只 <code data-start="1726" data-end="1735">connect</code> = 只有 ACL，<strong data-start="1745" data-end="1758">空闲时设备会主动拆</strong>，你看到频繁断连。</p>
</li>
<li data-start="1768" data-end="1819">
<p data-start="1770" data-end="1819">建立 <strong data-start="1773" data-end="1790">RFCOMM/SPP 会话</strong> = 有活跃频道/数据，<strong data-start="1802" data-end="1813">链路被持续维持</strong>，因此稳定。</p>
</li>
<li data-start="1820" data-end="1873" data-is-last-node="">
<p data-start="1822" data-end="1873" data-is-last-node="">用 <code data-start="1824" data-end="1831">btmon</code> 看断开原因码，基本就能验证这个判断；工程上用<strong data-start="1854" data-end="1867">保活/调整省电参数</strong>最直接见效。</p>
</li>
</ul></div>
<div style="margin-bottom:16px;"><strong>用户:</strong><br>蓝牙断开重连时，refcomm是否也有在蓝牙连上后的重连机制呢</div>
<div style="margin-bottom:16px;"><strong>ChatGPT:</strong><br><p data-start="0" data-end="150">短答：<strong data-start="3" data-end="26">RFCOMM 本身没有“自动重连”机制</strong>。一旦底层 ACL/L2CAP 链路断了，已有的 RFCOMM 会话（DLCI）就被内核/堆栈直接拆掉；链路恢复后，<strong data-start="84" data-end="106">RFCOMM 需要由一方重新发起建立</strong>（重新做 RFCOMM multiplexer、SABM/UA 握手并打开同一通道号）。</p>
<p data-start="152" data-end="160">再细一点分层看：</p>
<ul data-start="162" data-end="1289" data-is-last-node="" data-is-only-node="">
<li data-start="162" data-end="339">
<p data-start="164" data-end="174"><strong data-start="164" data-end="172">协议层面</strong></p>
<ul data-start="177" data-end="339">
<li data-start="177" data-end="223">
<p data-start="179" data-end="223">RFCOMM 运行在 <strong data-start="190" data-end="199">L2CAP</strong> 之上；L2CAP 又依赖 <strong data-start="213" data-end="220">ACL</strong>。</p>
</li>
<li data-start="226" data-end="288">
<p data-start="228" data-end="288">断链发生时，RFCOMM multiplexer 和所有 DLC 都被关闭；<strong data-start="266" data-end="285">没有跨断链的“会话保持/恢复”</strong>。</p>
</li>
<li data-start="291" data-end="339">
<p data-start="293" data-end="339">L2CAP 的基本/增强重传（ERTM）只在<strong data-start="315" data-end="323">链路仍在</strong>时处理丢包，不负责掉线后的重连。</p>
</li>
</ul>
</li>
<li data-start="341" data-end="584">
<p data-start="343" data-end="356"><strong data-start="343" data-end="354">实现/系统行为</strong></p>
<ul data-start="359" data-end="584">
<li data-start="359" data-end="434">
<p data-start="361" data-end="434">Linux/BlueZ：当 ACL 掉线，<strong data-start="382" data-end="420">内核 RFCOMM 套接字或 <code data-start="399" data-end="413">/dev/rfcommN</code> 会被关闭</strong>；不会自动重连同一通道。</p>
</li>
<li data-start="437" data-end="510">
<p data-start="439" data-end="510"><code data-start="439" data-end="451">bluetoothd</code> 会帮你做设备层的自动重连（取决于 profile/策略），但<strong data-start="482" data-end="507">不会替应用层把 RFCOMM 通道悄悄重建</strong>。</p>
</li>
<li data-start="513" data-end="584">
<p data-start="515" data-end="584">某些特定 profile（如 HID、HFP）在规范或设备策略里有“掉线重连”逻辑，但<strong data-start="558" data-end="583">SPP/RFCOMM 并不包含这类强制要求</strong>。</p>
</li>
</ul>
</li>
<li data-start="586" data-end="1110">
<p data-start="588" data-end="613"><strong data-start="588" data-end="611">你能如何获得“看起来会自动连上”的效果</strong></p>
<ol data-start="616" data-end="1110">
<li data-start="616" data-end="734">
<p data-start="619" data-end="734"><strong data-start="619" data-end="631">谁来当“主动方”</strong>：约定固定的“客户端—服务端”角色。让<strong data-start="650" data-end="657">服务端</strong>一直处于可被连接（Page Scan + 监听 SPP 通道）状态；让<strong data-start="692" data-end="699" data-is-only-node="">客户端</strong>在检测到断开后<strong data-start="706" data-end="722">定时重试 connect</strong>（指数退避/限频）。</p>
</li>
<li data-start="737" data-end="848">
<p data-start="740" data-end="848"><strong data-start="740" data-end="749">应用层重连</strong>：在应用里订阅断开事件（BlueZ D-Bus <code data-start="773" data-end="809">PropertiesChanged(Connected=false)</code> / 套接字 <code data-start="816" data-end="828" data-is-only-node="">ECONNRESET</code>），<strong data-start="830" data-end="845">立刻重建 RFCOMM</strong>。</p>
</li>
<li data-start="851" data-end="917">
<p data-start="854" data-end="917"><strong data-start="854" data-end="864">保活减少掉线</strong>：有空闲期时发少量心跳，避免因 sniff 过深或 supervision timeout 触发掉线。</p>
</li>
<li data-start="920" data-end="1023">
<p data-start="923" data-end="1023"><strong data-start="923" data-end="932">工具链辅助</strong>：如果你用 <code data-start="938" data-end="946">rfcomm</code> 工具绑定串口设备，可用外部**守护/系统服务（systemd、supervisor）**在设备节点断开时自动重启绑定命令，达到“掉了就拉起”的效果。</p>
</li>
<li data-start="1026" data-end="1110">
<p data-start="1029" data-end="1110"><strong data-start="1029" data-end="1044">设备侧“链接丢失重连”</strong>：有些外设在链路丢失后会主动回拨（发起到已配对主机的 RFCOMM 连接）。要利用这一点，确保主机端 SPP 服务<strong data-start="1101" data-end="1109">常驻监听</strong>。</p>
</li>
</ol>
</li>
<li data-start="1112" data-end="1289" data-is-last-node="">
<p data-start="1114" data-end="1122"><strong data-start="1114" data-end="1120">结论</strong></p>
<ul data-start="1125" data-end="1289" data-is-last-node="">
<li data-start="1125" data-end="1164">
<p data-start="1127" data-end="1164"><strong data-start="1127" data-end="1136">协议不保你</strong>：RFCOMM 没有内建的“连回来就自动恢复会话”。</p>
</li>
<li data-start="1167" data-end="1219">
<p data-start="1169" data-end="1219"><strong data-start="1169" data-end="1179">工程上可做到</strong>：通过应用层的重连逻辑（或让一端常驻监听 + 另一端定时重连）实现稳定体验。</p>
</li>
<li data-start="1222" data-end="1289" data-is-last-node="">
<p data-start="1224" data-end="1289" data-is-last-node=""><strong data-start="1224" data-end="1242">如果你看到“重连后就又稳了”</strong>，那是因为你/对端的应用重新建立了 RFCOMM 通道，而不是 RFCOMM 自己自动恢复的。</p>
</li>
</ul>
</li>
</ul></div>
<div style="margin-bottom:16px;"><strong>用户:</strong><br>具体要怎么做呢？我希望把建立refcomm连接、refcomm断开重连和当前已有的一个bridge结合。
下面这段程序是一个bridge，利用的就是已经建立起的refcomm接口。
设备A（iwalk）是客户端，设备B（imop）是服务端，它们两个都会运行这个bridge程序，它们只有MQTT_PORT的不同：

#!/usr/bin/env python3
import base64, json, struct, threading, time, re
import serial
import paho.mqtt.client as mqtt
from paho.mqtt.client import CallbackAPIVersion

# ===== 配置：按设备修改 =====
SERIAL_DEV = "/dev/rfcomm0"
SERIAL_BAUD = 115200

# i-walk 这端填本地 1884；i-mop 这端填本地 1883
MQTT_HOST = "127.0.0.1"
MQTT_PORT = 1884          # 在 i-mop 上改成 1883

CLIENT_ID = "bt-bridge"

# 订阅模式：任意主题
SUB_PATTERNS = ["#"]
# 排除模式：避免桥接系统主题 / 你不想转发的流
EXCLUDE_PATTERNS = [r"^\$SYS/"]

# 串口帧格式
MAGIC = b"\xAA\x55"

def pack_frame(topic: str, payload: bytes, qos: int, retain: bool) -&gt; bytes:
    obj = {
        "type": "pub",
        "topic": topic,
        "qos": int(qos),
        "retain": bool(retain),
        "payload_b64": base64.b64encode(payload).decode("ascii"),
    }
    data = json.dumps(obj, separators=(",", ":")).encode("utf-8")
    return MAGIC + struct.pack("&gt;I", len(data)) + data

def iter_frames(buf: bytearray):
    while True:
        mpos = buf.find(MAGIC)
        if mpos &lt; 0:
            if len(buf) &gt; 65536: buf.clear()
            return
        if len(buf) &lt; mpos + 6:
            return
        ln = struct.unpack("&gt;I", buf[mpos+2:mpos+6])[0]
        if len(buf) &lt; mpos + 6 + ln:
            return
        payload = bytes(buf[mpos+6:mpos+6+ln])
        del buf[:mpos+6+ln]
        yield payload

class Bridge:
    def __init__(self):
        self.ser = serial.Serial(SERIAL_DEV, SERIAL_BAUD, timeout=0.05)
        # 用一个 MQTT v5 客户端：既订阅也发布，配 no_local 避免自回环
        self.cli = mqtt.Client(
            client_id=CLIENT_ID,
            protocol=mqtt.MQTTv5,
            callback_api_version=CallbackAPIVersion.VERSION2,
        )
        self.cli.connect(MQTT_HOST, MQTT_PORT, keepalive=30)
        self.cli.on_message = self._on_message
        self._compile_filters()
        self._subscribe_all()
        self.cli.loop_start()

        threading.Thread(target=self._serial_reader, daemon=True).start()
        print(f"[bridge] up on mqtt {MQTT_HOST}:{MQTT_PORT}, serial {SERIAL_DEV}@{SERIAL_BAUD}")

    def _compile_filters(self):
        self._ex_filters = [re.compile(p) for p in EXCLUDE_PATTERNS]

    def _excluded(self, topic: str) -&gt; bool:
        return any(rx.search(topic) for rx in self._ex_filters)

    def _subscribe_all(self):
        # no_local=True：同一个客户端发布的消息不会被它自己订阅到 → 避免回环
        # retainHandling=2：不拉取已有的 retained 消息，避免首次洪泛；如需同步历史，把 2 改 0/1
        opts = mqtt.SubscribeOptions(qos=0, noLocal=True, retainAsPublished=False, retainHandling=2)
        for pat in SUB_PATTERNS:
            self.cli.subscribe(pat, options=opts)
        print(f"[bridge] subscribed: {SUB_PATTERNS}, exclude: {EXCLUDE_PATTERNS or 'none'}")

    # 本地 MQTT → 串口 → 对端
    def _on_message(self, client, userdata, msg: mqtt.MQTTMessage):
        if self._excluded(msg.topic):
            return
        try:
            frame = pack_frame(msg.topic, msg.payload, msg.qos, msg.retain)
            self.ser.write(frame)
            self.ser.flush()
        except Exception as e:
            print("[bridge] serial write error:", e)

    # 串口 → 本地 MQTT（发布），因 no_local 不会再被自己订阅，避免回环
    def _serial_reader(self):
        buf = bytearray()
        while True:
            try:
                chunk = self.ser.read(1024)
                if not chunk:
                    time.sleep(0.01)
                    continue
                buf += chunk
                for payload in iter_frames(buf):
                    try:
                        obj = json.loads(payload.decode("utf-8"))
                        if obj.get("type") != "pub":
                            continue
                        t = obj["topic"]
                        if self._excluded(t):
                            continue
                        qos = int(obj.get("qos", 0))
                        retain = bool(obj.get("retain", False))
                        pl = base64.b64decode(obj.get("payload_b64", ""))
                        # retainAsPublished：paho 会按 retain 标志转发；这里直接发布
                        self.cli.publish(t, pl, qos=qos, retain=retain, properties=mqtt.Properties(mqtt.PacketTypes.PUBLISH))
                    except Exception as e:
                        print("[bridge] frame error:", e)
            except Exception as e:
                print("[bridge] serial read error:", e)
                time.sleep(0.5)

if __name__ == "__main__":
    Bridge()
    try:
        while True: time.sleep(3600)
    except KeyboardInterrupt:
        pass</div>
<div style="margin-bottom:16px;"><strong>ChatGPT:</strong><br><p data-start="0" data-end="116">很好，把“建连 + 断开重连 + 你现有的 bridge”合成一体，最实用的做法是：<br data-start="42" data-end="45">
<strong data-start="45" data-end="89">让一个“RFCOMM 管理器”负责把 /dev/rfcomm0 拉起来并保持重连</strong>；你的 <code data-start="93" data-end="101">Bridge</code> 只认串口。这样既简单又稳定。</p>
<p data-start="118" data-end="161">下面给你两种落地方案，优先用 A；B 是把管理逻辑嵌进 Python，方便单进程部署。</p>
<hr data-start="163" data-end="166">

<blockquote data-start="210" data-end="268">
<p data-start="212" data-end="268">适合快速上线；<code data-start="219" data-end="227">rfcomm</code> 自带重连（不同版本选项名略有差异），配合 systemd 可做到“掉线就拉起”。</p>
</blockquote>
<h2 data-start="270" data-end="287">服务端（imop，监听）</h2>
<ol data-start="288" data-end="313">
<li data-start="288" data-end="313">
<p data-start="291" data-end="313">给设备发布 SPP（串口）服务（只需一次）：</p>
</li>
</ol>
<pre class="overflow-visible!" data-start="314" data-end="357"><div class="contain-inline-size rounded-2xl relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl">bash</div><div class="sticky top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="icon-sm"><path d="M12.668 10.667C12.668 9.95614 12.668 9.46258 12.6367 9.0791C12.6137 8.79732 12.5758 8.60761 12.5244 8.46387L12.4688 8.33399C12.3148 8.03193 12.0803 7.77885 11.793 7.60254L11.666 7.53125C11.508 7.45087 11.2963 7.39395 10.9209 7.36328C10.5374 7.33197 10.0439 7.33203 9.33301 7.33203H6.5C5.78896 7.33203 5.29563 7.33195 4.91211 7.36328C4.63016 7.38632 4.44065 7.42413 4.29688 7.47559L4.16699 7.53125C3.86488 7.68518 3.61186 7.9196 3.43555 8.20703L3.36524 8.33399C3.28478 8.49198 3.22795 8.70352 3.19727 9.0791C3.16595 9.46259 3.16504 9.95611 3.16504 10.667V13.5C3.16504 14.211 3.16593 14.7044 3.19727 15.0879C3.22797 15.4636 3.28473 15.675 3.36524 15.833L3.43555 15.959C3.61186 16.2466 3.86474 16.4807 4.16699 16.6348L4.29688 16.6914C4.44063 16.7428 4.63025 16.7797 4.91211 16.8027C5.29563 16.8341 5.78896 16.835 6.5 16.835H9.33301C10.0439 16.835 10.5374 16.8341 10.9209 16.8027C11.2965 16.772 11.508 16.7152 11.666 16.6348L11.793 16.5645C12.0804 16.3881 12.3148 16.1351 12.4688 15.833L12.5244 15.7031C12.5759 15.5594 12.6137 15.3698 12.6367 15.0879C12.6681 14.7044 12.668 14.211 12.668 13.5V10.667ZM13.998 12.665C14.4528 12.6634 14.8011 12.6602 15.0879 12.6367C15.4635 12.606 15.675 12.5492 15.833 12.4688L15.959 12.3975C16.2466 12.2211 16.4808 11.9682 16.6348 11.666L16.6914 11.5361C16.7428 11.3924 16.7797 11.2026 16.8027 10.9209C16.8341 10.5374 16.835 10.0439 16.835 9.33301V6.5C16.835 5.78896 16.8341 5.29563 16.8027 4.91211C16.7797 4.63025 16.7428 4.44063 16.6914 4.29688L16.6348 4.16699C16.4807 3.86474 16.2466 3.61186 15.959 3.43555L15.833 3.36524C15.675 3.28473 15.4636 3.22797 15.0879 3.19727C14.7044 3.16593 14.211 3.16504 13.5 3.16504H10.667C9.9561 3.16504 9.46259 3.16595 9.0791 3.19727C8.79739 3.22028 8.6076 3.2572 8.46387 3.30859L8.33399 3.36524C8.03176 3.51923 7.77886 3.75343 7.60254 4.04102L7.53125 4.16699C7.4508 4.32498 7.39397 4.53655 7.36328 4.91211C7.33985 5.19893 7.33562 5.54719 7.33399 6.00195H9.33301C10.022 6.00195 10.5791 6.00131 11.0293 6.03809C11.4873 6.07551 11.8937 6.15471 12.2705 6.34668L12.4883 6.46875C12.984 6.7728 13.3878 7.20854 13.6533 7.72949L13.7197 7.87207C13.8642 8.20859 13.9292 8.56974 13.9619 8.9707C13.9987 9.42092 13.998 9.97799 13.998 10.667V12.665ZM18.165 9.33301C18.165 10.022 18.1657 10.5791 18.1289 11.0293C18.0961 11.4302 18.0311 11.7914 17.8867 12.1279L17.8203 12.2705C17.5549 12.7914 17.1509 13.2272 16.6553 13.5313L16.4365 13.6533C16.0599 13.8452 15.6541 13.9245 15.1963 13.9619C14.8593 13.9895 14.4624 13.9935 13.9951 13.9951C13.9935 14.4624 13.9895 14.8593 13.9619 15.1963C13.9292 15.597 13.864 15.9576 13.7197 16.2939L13.6533 16.4365C13.3878 16.9576 12.9841 17.3941 12.4883 17.6982L12.2705 17.8203C11.8937 18.0123 11.4873 18.0915 11.0293 18.1289C10.5791 18.1657 10.022 18.165 9.33301 18.165H6.5C5.81091 18.165 5.25395 18.1657 4.80371 18.1289C4.40306 18.0962 4.04235 18.031 3.70606 17.8867L3.56348 17.8203C3.04244 17.5548 2.60585 17.151 2.30176 16.6553L2.17969 16.4365C1.98788 16.0599 1.90851 15.6541 1.87109 15.1963C1.83431 14.746 1.83496 14.1891 1.83496 13.5V10.667C1.83496 9.978 1.83432 9.42091 1.87109 8.9707C1.90851 8.5127 1.98772 8.10625 2.17969 7.72949L2.30176 7.51172C2.60586 7.0159 3.04236 6.6122 3.56348 6.34668L3.70606 6.28027C4.04237 6.136 4.40303 6.07083 4.80371 6.03809C5.14051 6.01057 5.53708 6.00551 6.00391 6.00391C6.00551 5.53708 6.01057 5.14051 6.03809 4.80371C6.0755 4.34588 6.15483 3.94012 6.34668 3.56348L6.46875 3.34473C6.77282 2.84912 7.20856 2.44514 7.72949 2.17969L7.87207 2.11328C8.20855 1.96886 8.56979 1.90385 8.9707 1.87109C9.42091 1.83432 9.978 1.83496 10.667 1.83496H13.5C14.1891 1.83496 14.746 1.83431 15.1963 1.87109C15.6541 1.90851 16.0599 1.98788 16.4365 2.17969L16.6553 2.30176C17.151 2.60585 17.5548 3.04244 17.8203 3.56348L17.8867 3.70606C18.031 4.04235 18.0962 4.40306 18.1289 4.80371C18.1657 5.25395 18.165 5.81091 18.165 6.5V9.33301Z"></path></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-bash"><span><span>sudo sdptool add --channel 1 SP
</span></span></code></div></div></pre>
<ol start="2" data-start="358" data-end="402">
<li data-start="358" data-end="402">
<p data-start="361" data-end="402">持续监听第 1 通道，并在有连接时把设备节点暴露成 <code data-start="387" data-end="401">/dev/rfcomm0</code>：</p>
</li>
</ol>
<pre class="overflow-visible!" data-start="403" data-end="448"><div class="contain-inline-size rounded-2xl relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl">bash</div><div class="sticky top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="icon-sm"><path d="M12.668 10.667C12.668 9.95614 12.668 9.46258 12.6367 9.0791C12.6137 8.79732 12.5758 8.60761 12.5244 8.46387L12.4688 8.33399C12.3148 8.03193 12.0803 7.77885 11.793 7.60254L11.666 7.53125C11.508 7.45087 11.2963 7.39395 10.9209 7.36328C10.5374 7.33197 10.0439 7.33203 9.33301 7.33203H6.5C5.78896 7.33203 5.29563 7.33195 4.91211 7.36328C4.63016 7.38632 4.44065 7.42413 4.29688 7.47559L4.16699 7.53125C3.86488 7.68518 3.61186 7.9196 3.43555 8.20703L3.36524 8.33399C3.28478 8.49198 3.22795 8.70352 3.19727 9.0791C3.16595 9.46259 3.16504 9.95611 3.16504 10.667V13.5C3.16504 14.211 3.16593 14.7044 3.19727 15.0879C3.22797 15.4636 3.28473 15.675 3.36524 15.833L3.43555 15.959C3.61186 16.2466 3.86474 16.4807 4.16699 16.6348L4.29688 16.6914C4.44063 16.7428 4.63025 16.7797 4.91211 16.8027C5.29563 16.8341 5.78896 16.835 6.5 16.835H9.33301C10.0439 16.835 10.5374 16.8341 10.9209 16.8027C11.2965 16.772 11.508 16.7152 11.666 16.6348L11.793 16.5645C12.0804 16.3881 12.3148 16.1351 12.4688 15.833L12.5244 15.7031C12.5759 15.5594 12.6137 15.3698 12.6367 15.0879C12.6681 14.7044 12.668 14.211 12.668 13.5V10.667ZM13.998 12.665C14.4528 12.6634 14.8011 12.6602 15.0879 12.6367C15.4635 12.606 15.675 12.5492 15.833 12.4688L15.959 12.3975C16.2466 12.2211 16.4808 11.9682 16.6348 11.666L16.6914 11.5361C16.7428 11.3924 16.7797 11.2026 16.8027 10.9209C16.8341 10.5374 16.835 10.0439 16.835 9.33301V6.5C16.835 5.78896 16.8341 5.29563 16.8027 4.91211C16.7797 4.63025 16.7428 4.44063 16.6914 4.29688L16.6348 4.16699C16.4807 3.86474 16.2466 3.61186 15.959 3.43555L15.833 3.36524C15.675 3.28473 15.4636 3.22797 15.0879 3.19727C14.7044 3.16593 14.211 3.16504 13.5 3.16504H10.667C9.9561 3.16504 9.46259 3.16595 9.0791 3.19727C8.79739 3.22028 8.6076 3.2572 8.46387 3.30859L8.33399 3.36524C8.03176 3.51923 7.77886 3.75343 7.60254 4.04102L7.53125 4.16699C7.4508 4.32498 7.39397 4.53655 7.36328 4.91211C7.33985 5.19893 7.33562 5.54719 7.33399 6.00195H9.33301C10.022 6.00195 10.5791 6.00131 11.0293 6.03809C11.4873 6.07551 11.8937 6.15471 12.2705 6.34668L12.4883 6.46875C12.984 6.7728 13.3878 7.20854 13.6533 7.72949L13.7197 7.87207C13.8642 8.20859 13.9292 8.56974 13.9619 8.9707C13.9987 9.42092 13.998 9.97799 13.998 10.667V12.665ZM18.165 9.33301C18.165 10.022 18.1657 10.5791 18.1289 11.0293C18.0961 11.4302 18.0311 11.7914 17.8867 12.1279L17.8203 12.2705C17.5549 12.7914 17.1509 13.2272 16.6553 13.5313L16.4365 13.6533C16.0599 13.8452 15.6541 13.9245 15.1963 13.9619C14.8593 13.9895 14.4624 13.9935 13.9951 13.9951C13.9935 14.4624 13.9895 14.8593 13.9619 15.1963C13.9292 15.597 13.864 15.9576 13.7197 16.2939L13.6533 16.4365C13.3878 16.9576 12.9841 17.3941 12.4883 17.6982L12.2705 17.8203C11.8937 18.0123 11.4873 18.0915 11.0293 18.1289C10.5791 18.1657 10.022 18.165 9.33301 18.165H6.5C5.81091 18.165 5.25395 18.1657 4.80371 18.1289C4.40306 18.0962 4.04235 18.031 3.70606 17.8867L3.56348 17.8203C3.04244 17.5548 2.60585 17.151 2.30176 16.6553L2.17969 16.4365C1.98788 16.0599 1.90851 15.6541 1.87109 15.1963C1.83431 14.746 1.83496 14.1891 1.83496 13.5V10.667C1.83496 9.978 1.83432 9.42091 1.87109 8.9707C1.90851 8.5127 1.98772 8.10625 2.17969 7.72949L2.30176 7.51172C2.60586 7.0159 3.04236 6.6122 3.56348 6.34668L3.70606 6.28027C4.04237 6.136 4.40303 6.07083 4.80371 6.03809C5.14051 6.01057 5.53708 6.00551 6.00391 6.00391C6.00551 5.53708 6.01057 5.14051 6.03809 4.80371C6.0755 4.34588 6.15483 3.94012 6.34668 3.56348L6.46875 3.34473C6.77282 2.84912 7.20856 2.44514 7.72949 2.17969L7.87207 2.11328C8.20855 1.96886 8.56979 1.90385 8.9707 1.87109C9.42091 1.83432 9.978 1.83496 10.667 1.83496H13.5C14.1891 1.83496 14.746 1.83431 15.1963 1.87109C15.6541 1.90851 16.0599 1.98788 16.4365 2.17969L16.6553 2.30176C17.151 2.60585 17.5548 3.04244 17.8203 3.56348L17.8867 3.70606C18.031 4.04235 18.0962 4.40306 18.1289 4.80371C18.1657 5.25395 18.165 5.81091 18.165 6.5V9.33301Z"></path></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-bash"><span><span>sudo rfcomm listen /dev/rfcomm0 1
</span></span></code></div></div></pre>
<blockquote data-start="449" data-end="545">
<p data-start="451" data-end="545">有的版本用法是 <code data-start="459" data-end="484">rfcomm listen rfcomm0 1</code>，创建的设备路径仍是 <code data-start="495" data-end="509">/dev/rfcomm0</code>。若提示 busy，先 <code data-start="521" data-end="544">sudo rfcomm release 0</code>。</p>
</blockquote>
<ol start="3" data-start="547" data-end="596">
<li data-start="547" data-end="596">
<p data-start="550" data-end="596">让你的 <code data-start="554" data-end="562">Bridge</code> 用默认 <code data-start="567" data-end="581">/dev/rfcomm0</code> 启动即可（你现有代码不改）：</p>
</li>
</ol>
<pre class="overflow-visible!" data-start="597" data-end="635"><div class="contain-inline-size rounded-2xl relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl">bash</div><div class="sticky top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="icon-sm"><path d="M12.668 10.667C12.668 9.95614 12.668 9.46258 12.6367 9.0791C12.6137 8.79732 12.5758 8.60761 12.5244 8.46387L12.4688 8.33399C12.3148 8.03193 12.0803 7.77885 11.793 7.60254L11.666 7.53125C11.508 7.45087 11.2963 7.39395 10.9209 7.36328C10.5374 7.33197 10.0439 7.33203 9.33301 7.33203H6.5C5.78896 7.33203 5.29563 7.33195 4.91211 7.36328C4.63016 7.38632 4.44065 7.42413 4.29688 7.47559L4.16699 7.53125C3.86488 7.68518 3.61186 7.9196 3.43555 8.20703L3.36524 8.33399C3.28478 8.49198 3.22795 8.70352 3.19727 9.0791C3.16595 9.46259 3.16504 9.95611 3.16504 10.667V13.5C3.16504 14.211 3.16593 14.7044 3.19727 15.0879C3.22797 15.4636 3.28473 15.675 3.36524 15.833L3.43555 15.959C3.61186 16.2466 3.86474 16.4807 4.16699 16.6348L4.29688 16.6914C4.44063 16.7428 4.63025 16.7797 4.91211 16.8027C5.29563 16.8341 5.78896 16.835 6.5 16.835H9.33301C10.0439 16.835 10.5374 16.8341 10.9209 16.8027C11.2965 16.772 11.508 16.7152 11.666 16.6348L11.793 16.5645C12.0804 16.3881 12.3148 16.1351 12.4688 15.833L12.5244 15.7031C12.5759 15.5594 12.6137 15.3698 12.6367 15.0879C12.6681 14.7044 12.668 14.211 12.668 13.5V10.667ZM13.998 12.665C14.4528 12.6634 14.8011 12.6602 15.0879 12.6367C15.4635 12.606 15.675 12.5492 15.833 12.4688L15.959 12.3975C16.2466 12.2211 16.4808 11.9682 16.6348 11.666L16.6914 11.5361C16.7428 11.3924 16.7797 11.2026 16.8027 10.9209C16.8341 10.5374 16.835 10.0439 16.835 9.33301V6.5C16.835 5.78896 16.8341 5.29563 16.8027 4.91211C16.7797 4.63025 16.7428 4.44063 16.6914 4.29688L16.6348 4.16699C16.4807 3.86474 16.2466 3.61186 15.959 3.43555L15.833 3.36524C15.675 3.28473 15.4636 3.22797 15.0879 3.19727C14.7044 3.16593 14.211 3.16504 13.5 3.16504H10.667C9.9561 3.16504 9.46259 3.16595 9.0791 3.19727C8.79739 3.22028 8.6076 3.2572 8.46387 3.30859L8.33399 3.36524C8.03176 3.51923 7.77886 3.75343 7.60254 4.04102L7.53125 4.16699C7.4508 4.32498 7.39397 4.53655 7.36328 4.91211C7.33985 5.19893 7.33562 5.54719 7.33399 6.00195H9.33301C10.022 6.00195 10.5791 6.00131 11.0293 6.03809C11.4873 6.07551 11.8937 6.15471 12.2705 6.34668L12.4883 6.46875C12.984 6.7728 13.3878 7.20854 13.6533 7.72949L13.7197 7.87207C13.8642 8.20859 13.9292 8.56974 13.9619 8.9707C13.9987 9.42092 13.998 9.97799 13.998 10.667V12.665ZM18.165 9.33301C18.165 10.022 18.1657 10.5791 18.1289 11.0293C18.0961 11.4302 18.0311 11.7914 17.8867 12.1279L17.8203 12.2705C17.5549 12.7914 17.1509 13.2272 16.6553 13.5313L16.4365 13.6533C16.0599 13.8452 15.6541 13.9245 15.1963 13.9619C14.8593 13.9895 14.4624 13.9935 13.9951 13.9951C13.9935 14.4624 13.9895 14.8593 13.9619 15.1963C13.9292 15.597 13.864 15.9576 13.7197 16.2939L13.6533 16.4365C13.3878 16.9576 12.9841 17.3941 12.4883 17.6982L12.2705 17.8203C11.8937 18.0123 11.4873 18.0915 11.0293 18.1289C10.5791 18.1657 10.022 18.165 9.33301 18.165H6.5C5.81091 18.165 5.25395 18.1657 4.80371 18.1289C4.40306 18.0962 4.04235 18.031 3.70606 17.8867L3.56348 17.8203C3.04244 17.5548 2.60585 17.151 2.30176 16.6553L2.17969 16.4365C1.98788 16.0599 1.90851 15.6541 1.87109 15.1963C1.83431 14.746 1.83496 14.1891 1.83496 13.5V10.667C1.83496 9.978 1.83432 9.42091 1.87109 8.9707C1.90851 8.5127 1.98772 8.10625 2.17969 7.72949L2.30176 7.51172C2.60586 7.0159 3.04236 6.6122 3.56348 6.34668L3.70606 6.28027C4.04237 6.136 4.40303 6.07083 4.80371 6.03809C5.14051 6.01057 5.53708 6.00551 6.00391 6.00391C6.00551 5.53708 6.01057 5.14051 6.03809 4.80371C6.0755 4.34588 6.15483 3.94012 6.34668 3.56348L6.46875 3.34473C6.77282 2.84912 7.20856 2.44514 7.72949 2.17969L7.87207 2.11328C8.20855 1.96886 8.56979 1.90385 8.9707 1.87109C9.42091 1.83432 9.978 1.83496 10.667 1.83496H13.5C14.1891 1.83496 14.746 1.83431 15.1963 1.87109C15.6541 1.90851 16.0599 1.98788 16.4365 2.17969L16.6553 2.30176C17.151 2.60585 17.5548 3.04244 17.8203 3.56348L17.8867 3.70606C18.031 4.04235 18.0962 4.40306 18.1289 4.80371C18.1657 5.25395 18.165 5.81091 18.165 6.5V9.33301Z"></path></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-bash"><span><span>MQTT_PORT=1883 ./bridge.py
</span></span></code></div></div></pre>
<h2 data-start="637" data-end="660">客户端（iwalk，主动拨号并自动重连）</h2>
<pre class="overflow-visible!" data-start="661" data-end="828"><div class="contain-inline-size rounded-2xl relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl">bash</div><div class="sticky top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="icon-sm"><path d="M12.668 10.667C12.668 9.95614 12.668 9.46258 12.6367 9.0791C12.6137 8.79732 12.5758 8.60761 12.5244 8.46387L12.4688 8.33399C12.3148 8.03193 12.0803 7.77885 11.793 7.60254L11.666 7.53125C11.508 7.45087 11.2963 7.39395 10.9209 7.36328C10.5374 7.33197 10.0439 7.33203 9.33301 7.33203H6.5C5.78896 7.33203 5.29563 7.33195 4.91211 7.36328C4.63016 7.38632 4.44065 7.42413 4.29688 7.47559L4.16699 7.53125C3.86488 7.68518 3.61186 7.9196 3.43555 8.20703L3.36524 8.33399C3.28478 8.49198 3.22795 8.70352 3.19727 9.0791C3.16595 9.46259 3.16504 9.95611 3.16504 10.667V13.5C3.16504 14.211 3.16593 14.7044 3.19727 15.0879C3.22797 15.4636 3.28473 15.675 3.36524 15.833L3.43555 15.959C3.61186 16.2466 3.86474 16.4807 4.16699 16.6348L4.29688 16.6914C4.44063 16.7428 4.63025 16.7797 4.91211 16.8027C5.29563 16.8341 5.78896 16.835 6.5 16.835H9.33301C10.0439 16.835 10.5374 16.8341 10.9209 16.8027C11.2965 16.772 11.508 16.7152 11.666 16.6348L11.793 16.5645C12.0804 16.3881 12.3148 16.1351 12.4688 15.833L12.5244 15.7031C12.5759 15.5594 12.6137 15.3698 12.6367 15.0879C12.6681 14.7044 12.668 14.211 12.668 13.5V10.667ZM13.998 12.665C14.4528 12.6634 14.8011 12.6602 15.0879 12.6367C15.4635 12.606 15.675 12.5492 15.833 12.4688L15.959 12.3975C16.2466 12.2211 16.4808 11.9682 16.6348 11.666L16.6914 11.5361C16.7428 11.3924 16.7797 11.2026 16.8027 10.9209C16.8341 10.5374 16.835 10.0439 16.835 9.33301V6.5C16.835 5.78896 16.8341 5.29563 16.8027 4.91211C16.7797 4.63025 16.7428 4.44063 16.6914 4.29688L16.6348 4.16699C16.4807 3.86474 16.2466 3.61186 15.959 3.43555L15.833 3.36524C15.675 3.28473 15.4636 3.22797 15.0879 3.19727C14.7044 3.16593 14.211 3.16504 13.5 3.16504H10.667C9.9561 3.16504 9.46259 3.16595 9.0791 3.19727C8.79739 3.22028 8.6076 3.2572 8.46387 3.30859L8.33399 3.36524C8.03176 3.51923 7.77886 3.75343 7.60254 4.04102L7.53125 4.16699C7.4508 4.32498 7.39397 4.53655 7.36328 4.91211C7.33985 5.19893 7.33562 5.54719 7.33399 6.00195H9.33301C10.022 6.00195 10.5791 6.00131 11.0293 6.03809C11.4873 6.07551 11.8937 6.15471 12.2705 6.34668L12.4883 6.46875C12.984 6.7728 13.3878 7.20854 13.6533 7.72949L13.7197 7.87207C13.8642 8.20859 13.9292 8.56974 13.9619 8.9707C13.9987 9.42092 13.998 9.97799 13.998 10.667V12.665ZM18.165 9.33301C18.165 10.022 18.1657 10.5791 18.1289 11.0293C18.0961 11.4302 18.0311 11.7914 17.8867 12.1279L17.8203 12.2705C17.5549 12.7914 17.1509 13.2272 16.6553 13.5313L16.4365 13.6533C16.0599 13.8452 15.6541 13.9245 15.1963 13.9619C14.8593 13.9895 14.4624 13.9935 13.9951 13.9951C13.9935 14.4624 13.9895 14.8593 13.9619 15.1963C13.9292 15.597 13.864 15.9576 13.7197 16.2939L13.6533 16.4365C13.3878 16.9576 12.9841 17.3941 12.4883 17.6982L12.2705 17.8203C11.8937 18.0123 11.4873 18.0915 11.0293 18.1289C10.5791 18.1657 10.022 18.165 9.33301 18.165H6.5C5.81091 18.165 5.25395 18.1657 4.80371 18.1289C4.40306 18.0962 4.04235 18.031 3.70606 17.8867L3.56348 17.8203C3.04244 17.5548 2.60585 17.151 2.30176 16.6553L2.17969 16.4365C1.98788 16.0599 1.90851 15.6541 1.87109 15.1963C1.83431 14.746 1.83496 14.1891 1.83496 13.5V10.667C1.83496 9.978 1.83432 9.42091 1.87109 8.9707C1.90851 8.5127 1.98772 8.10625 2.17969 7.72949L2.30176 7.51172C2.60586 7.0159 3.04236 6.6122 3.56348 6.34668L3.70606 6.28027C4.04237 6.136 4.40303 6.07083 4.80371 6.03809C5.14051 6.01057 5.53708 6.00551 6.00391 6.00391C6.00551 5.53708 6.01057 5.14051 6.03809 4.80371C6.0755 4.34588 6.15483 3.94012 6.34668 3.56348L6.46875 3.34473C6.77282 2.84912 7.20856 2.44514 7.72949 2.17969L7.87207 2.11328C8.20855 1.96886 8.56979 1.90385 8.9707 1.87109C9.42091 1.83432 9.978 1.83496 10.667 1.83496H13.5C14.1891 1.83496 14.746 1.83431 15.1963 1.87109C15.6541 1.90851 16.0599 1.98788 16.4365 2.17969L16.6553 2.30176C17.151 2.60585 17.5548 3.04244 17.8203 3.56348L17.8867 3.70606C18.031 4.04235 18.0962 4.40306 18.1289 4.80371C18.1657 5.25395 18.165 5.81091 18.165 6.5V9.33301Z"></path></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-bash"><span><span>REMOTE=AA:BB:CC:DD:EE:FF   </span><span><span class="hljs-comment"># imop 的蓝牙 MAC</span></span><span>
CH=1
</span><span><span class="hljs-comment"># 一些 rfcomm 版本支持 -r（断开后保持重连）；如果你的版本没有 -r，就用 while 循环外包一层（见下）</span></span><span>
sudo rfcomm connect -r /dev/rfcomm0 </span><span><span class="hljs-variable">$REMOTE</span></span><span> </span><span><span class="hljs-variable">$CH</span></span><span>
</span></span></code></div></div></pre>
<p data-start="830" data-end="874">若你的 <code data-start="834" data-end="842">rfcomm</code> <strong data-start="843" data-end="849">没有</strong> <code data-start="850" data-end="854">-r</code> 选项，就用一个壳脚本做重试 + 退避：</p>
<pre class="overflow-visible!" data-start="875" data-end="1107"><div class="contain-inline-size rounded-2xl relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl">bash</div><div class="sticky top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="icon-sm"><path d="M12.668 10.667C12.668 9.95614 12.668 9.46258 12.6367 9.0791C12.6137 8.79732 12.5758 8.60761 12.5244 8.46387L12.4688 8.33399C12.3148 8.03193 12.0803 7.77885 11.793 7.60254L11.666 7.53125C11.508 7.45087 11.2963 7.39395 10.9209 7.36328C10.5374 7.33197 10.0439 7.33203 9.33301 7.33203H6.5C5.78896 7.33203 5.29563 7.33195 4.91211 7.36328C4.63016 7.38632 4.44065 7.42413 4.29688 7.47559L4.16699 7.53125C3.86488 7.68518 3.61186 7.9196 3.43555 8.20703L3.36524 8.33399C3.28478 8.49198 3.22795 8.70352 3.19727 9.0791C3.16595 9.46259 3.16504 9.95611 3.16504 10.667V13.5C3.16504 14.211 3.16593 14.7044 3.19727 15.0879C3.22797 15.4636 3.28473 15.675 3.36524 15.833L3.43555 15.959C3.61186 16.2466 3.86474 16.4807 4.16699 16.6348L4.29688 16.6914C4.44063 16.7428 4.63025 16.7797 4.91211 16.8027C5.29563 16.8341 5.78896 16.835 6.5 16.835H9.33301C10.0439 16.835 10.5374 16.8341 10.9209 16.8027C11.2965 16.772 11.508 16.7152 11.666 16.6348L11.793 16.5645C12.0804 16.3881 12.3148 16.1351 12.4688 15.833L12.5244 15.7031C12.5759 15.5594 12.6137 15.3698 12.6367 15.0879C12.6681 14.7044 12.668 14.211 12.668 13.5V10.667ZM13.998 12.665C14.4528 12.6634 14.8011 12.6602 15.0879 12.6367C15.4635 12.606 15.675 12.5492 15.833 12.4688L15.959 12.3975C16.2466 12.2211 16.4808 11.9682 16.6348 11.666L16.6914 11.5361C16.7428 11.3924 16.7797 11.2026 16.8027 10.9209C16.8341 10.5374 16.835 10.0439 16.835 9.33301V6.5C16.835 5.78896 16.8341 5.29563 16.8027 4.91211C16.7797 4.63025 16.7428 4.44063 16.6914 4.29688L16.6348 4.16699C16.4807 3.86474 16.2466 3.61186 15.959 3.43555L15.833 3.36524C15.675 3.28473 15.4636 3.22797 15.0879 3.19727C14.7044 3.16593 14.211 3.16504 13.5 3.16504H10.667C9.9561 3.16504 9.46259 3.16595 9.0791 3.19727C8.79739 3.22028 8.6076 3.2572 8.46387 3.30859L8.33399 3.36524C8.03176 3.51923 7.77886 3.75343 7.60254 4.04102L7.53125 4.16699C7.4508 4.32498 7.39397 4.53655 7.36328 4.91211C7.33985 5.19893 7.33562 5.54719 7.33399 6.00195H9.33301C10.022 6.00195 10.5791 6.00131 11.0293 6.03809C11.4873 6.07551 11.8937 6.15471 12.2705 6.34668L12.4883 6.46875C12.984 6.7728 13.3878 7.20854 13.6533 7.72949L13.7197 7.87207C13.8642 8.20859 13.9292 8.56974 13.9619 8.9707C13.9987 9.42092 13.998 9.97799 13.998 10.667V12.665ZM18.165 9.33301C18.165 10.022 18.1657 10.5791 18.1289 11.0293C18.0961 11.4302 18.0311 11.7914 17.8867 12.1279L17.8203 12.2705C17.5549 12.7914 17.1509 13.2272 16.6553 13.5313L16.4365 13.6533C16.0599 13.8452 15.6541 13.9245 15.1963 13.9619C14.8593 13.9895 14.4624 13.9935 13.9951 13.9951C13.9935 14.4624 13.9895 14.8593 13.9619 15.1963C13.9292 15.597 13.864 15.9576 13.7197 16.2939L13.6533 16.4365C13.3878 16.9576 12.9841 17.3941 12.4883 17.6982L12.2705 17.8203C11.8937 18.0123 11.4873 18.0915 11.0293 18.1289C10.5791 18.1657 10.022 18.165 9.33301 18.165H6.5C5.81091 18.165 5.25395 18.1657 4.80371 18.1289C4.40306 18.0962 4.04235 18.031 3.70606 17.8867L3.56348 17.8203C3.04244 17.5548 2.60585 17.151 2.30176 16.6553L2.17969 16.4365C1.98788 16.0599 1.90851 15.6541 1.87109 15.1963C1.83431 14.746 1.83496 14.1891 1.83496 13.5V10.667C1.83496 9.978 1.83432 9.42091 1.87109 8.9707C1.90851 8.5127 1.98772 8.10625 2.17969 7.72949L2.30176 7.51172C2.60586 7.0159 3.04236 6.6122 3.56348 6.34668L3.70606 6.28027C4.04237 6.136 4.40303 6.07083 4.80371 6.03809C5.14051 6.01057 5.53708 6.00551 6.00391 6.00391C6.00551 5.53708 6.01057 5.14051 6.03809 4.80371C6.0755 4.34588 6.15483 3.94012 6.34668 3.56348L6.46875 3.34473C6.77282 2.84912 7.20856 2.44514 7.72949 2.17969L7.87207 2.11328C8.20855 1.96886 8.56979 1.90385 8.9707 1.87109C9.42091 1.83432 9.978 1.83496 10.667 1.83496H13.5C14.1891 1.83496 14.746 1.83431 15.1963 1.87109C15.6541 1.90851 16.0599 1.98788 16.4365 2.17969L16.6553 2.30176C17.151 2.60585 17.5548 3.04244 17.8203 3.56348L17.8867 3.70606C18.031 4.04235 18.0962 4.40306 18.1289 4.80371C18.1657 5.25395 18.165 5.81091 18.165 6.5V9.33301Z"></path></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-bash"><span><span><span class="hljs-meta">#!/usr/bin/env bash</span></span><span>
</span><span><span class="hljs-built_in">set</span></span><span> -euo pipefail
REMOTE=AA:BB:CC:DD:EE:FF
CH=1
DEV=/dev/rfcomm0
</span><span><span class="hljs-keyword">while</span></span><span> </span><span><span class="hljs-literal">true</span></span><span>; </span><span><span class="hljs-keyword">do</span></span><span>
  sudo rfcomm release 0 || </span><span><span class="hljs-literal">true</span></span><span>
  sudo rfcomm connect </span><span><span class="hljs-variable">$DEV</span></span><span> </span><span><span class="hljs-variable">$REMOTE</span></span><span> </span><span><span class="hljs-variable">$CH</span></span><span> || </span><span><span class="hljs-literal">true</span></span><span>
  </span><span><span class="hljs-comment"># 连接掉线或命令退出后稍等再试（指数退避也行）</span></span><span>
  </span><span><span class="hljs-built_in">sleep</span></span><span> 2
</span><span><span class="hljs-keyword">done</span></span><span>
</span></span></code></div></div></pre>
<p data-start="1109" data-end="1132">连接一旦成功，你这边直接跑 <code data-start="1123" data-end="1131">Bridge</code>：</p>
<pre class="overflow-visible!" data-start="1133" data-end="1171"><div class="contain-inline-size rounded-2xl relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl">bash</div><div class="sticky top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="icon-sm"><path d="M12.668 10.667C12.668 9.95614 12.668 9.46258 12.6367 9.0791C12.6137 8.79732 12.5758 8.60761 12.5244 8.46387L12.4688 8.33399C12.3148 8.03193 12.0803 7.77885 11.793 7.60254L11.666 7.53125C11.508 7.45087 11.2963 7.39395 10.9209 7.36328C10.5374 7.33197 10.0439 7.33203 9.33301 7.33203H6.5C5.78896 7.33203 5.29563 7.33195 4.91211 7.36328C4.63016 7.38632 4.44065 7.42413 4.29688 7.47559L4.16699 7.53125C3.86488 7.68518 3.61186 7.9196 3.43555 8.20703L3.36524 8.33399C3.28478 8.49198 3.22795 8.70352 3.19727 9.0791C3.16595 9.46259 3.16504 9.95611 3.16504 10.667V13.5C3.16504 14.211 3.16593 14.7044 3.19727 15.0879C3.22797 15.4636 3.28473 15.675 3.36524 15.833L3.43555 15.959C3.61186 16.2466 3.86474 16.4807 4.16699 16.6348L4.29688 16.6914C4.44063 16.7428 4.63025 16.7797 4.91211 16.8027C5.29563 16.8341 5.78896 16.835 6.5 16.835H9.33301C10.0439 16.835 10.5374 16.8341 10.9209 16.8027C11.2965 16.772 11.508 16.7152 11.666 16.6348L11.793 16.5645C12.0804 16.3881 12.3148 16.1351 12.4688 15.833L12.5244 15.7031C12.5759 15.5594 12.6137 15.3698 12.6367 15.0879C12.6681 14.7044 12.668 14.211 12.668 13.5V10.667ZM13.998 12.665C14.4528 12.6634 14.8011 12.6602 15.0879 12.6367C15.4635 12.606 15.675 12.5492 15.833 12.4688L15.959 12.3975C16.2466 12.2211 16.4808 11.9682 16.6348 11.666L16.6914 11.5361C16.7428 11.3924 16.7797 11.2026 16.8027 10.9209C16.8341 10.5374 16.835 10.0439 16.835 9.33301V6.5C16.835 5.78896 16.8341 5.29563 16.8027 4.91211C16.7797 4.63025 16.7428 4.44063 16.6914 4.29688L16.6348 4.16699C16.4807 3.86474 16.2466 3.61186 15.959 3.43555L15.833 3.36524C15.675 3.28473 15.4636 3.22797 15.0879 3.19727C14.7044 3.16593 14.211 3.16504 13.5 3.16504H10.667C9.9561 3.16504 9.46259 3.16595 9.0791 3.19727C8.79739 3.22028 8.6076 3.2572 8.46387 3.30859L8.33399 3.36524C8.03176 3.51923 7.77886 3.75343 7.60254 4.04102L7.53125 4.16699C7.4508 4.32498 7.39397 4.53655 7.36328 4.91211C7.33985 5.19893 7.33562 5.54719 7.33399 6.00195H9.33301C10.022 6.00195 10.5791 6.00131 11.0293 6.03809C11.4873 6.07551 11.8937 6.15471 12.2705 6.34668L12.4883 6.46875C12.984 6.7728 13.3878 7.20854 13.6533 7.72949L13.7197 7.87207C13.8642 8.20859 13.9292 8.56974 13.9619 8.9707C13.9987 9.42092 13.998 9.97799 13.998 10.667V12.665ZM18.165 9.33301C18.165 10.022 18.1657 10.5791 18.1289 11.0293C18.0961 11.4302 18.0311 11.7914 17.8867 12.1279L17.8203 12.2705C17.5549 12.7914 17.1509 13.2272 16.6553 13.5313L16.4365 13.6533C16.0599 13.8452 15.6541 13.9245 15.1963 13.9619C14.8593 13.9895 14.4624 13.9935 13.9951 13.9951C13.9935 14.4624 13.9895 14.8593 13.9619 15.1963C13.9292 15.597 13.864 15.9576 13.7197 16.2939L13.6533 16.4365C13.3878 16.9576 12.9841 17.3941 12.4883 17.6982L12.2705 17.8203C11.8937 18.0123 11.4873 18.0915 11.0293 18.1289C10.5791 18.1657 10.022 18.165 9.33301 18.165H6.5C5.81091 18.165 5.25395 18.1657 4.80371 18.1289C4.40306 18.0962 4.04235 18.031 3.70606 17.8867L3.56348 17.8203C3.04244 17.5548 2.60585 17.151 2.30176 16.6553L2.17969 16.4365C1.98788 16.0599 1.90851 15.6541 1.87109 15.1963C1.83431 14.746 1.83496 14.1891 1.83496 13.5V10.667C1.83496 9.978 1.83432 9.42091 1.87109 8.9707C1.90851 8.5127 1.98772 8.10625 2.17969 7.72949L2.30176 7.51172C2.60586 7.0159 3.04236 6.6122 3.56348 6.34668L3.70606 6.28027C4.04237 6.136 4.40303 6.07083 4.80371 6.03809C5.14051 6.01057 5.53708 6.00551 6.00391 6.00391C6.00551 5.53708 6.01057 5.14051 6.03809 4.80371C6.0755 4.34588 6.15483 3.94012 6.34668 3.56348L6.46875 3.34473C6.77282 2.84912 7.20856 2.44514 7.72949 2.17969L7.87207 2.11328C8.20855 1.96886 8.56979 1.90385 8.9707 1.87109C9.42091 1.83432 9.978 1.83496 10.667 1.83496H13.5C14.1891 1.83496 14.746 1.83431 15.1963 1.87109C15.6541 1.90851 16.0599 1.98788 16.4365 2.17969L16.6553 2.30176C17.151 2.60585 17.5548 3.04244 17.8203 3.56348L17.8867 3.70606C18.031 4.04235 18.0962 4.40306 18.1289 4.80371C18.1657 5.25395 18.165 5.81091 18.165 6.5V9.33301Z"></path></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-bash"><span><span>MQTT_PORT=1884 ./bridge.py
</span></span></code></div></div></pre>
<h2 data-start="1173" data-end="1192">用 systemd 守护（建议）</h2>
<p data-start="1193" data-end="1210">**客户端（iwalk）**示例：</p>
<pre class="overflow-visible!" data-start="1211" data-end="1487"><div class="contain-inline-size rounded-2xl relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl">ini</div><div class="sticky top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="icon-sm"><path d="M12.668 10.667C12.668 9.95614 12.668 9.46258 12.6367 9.0791C12.6137 8.79732 12.5758 8.60761 12.5244 8.46387L12.4688 8.33399C12.3148 8.03193 12.0803 7.77885 11.793 7.60254L11.666 7.53125C11.508 7.45087 11.2963 7.39395 10.9209 7.36328C10.5374 7.33197 10.0439 7.33203 9.33301 7.33203H6.5C5.78896 7.33203 5.29563 7.33195 4.91211 7.36328C4.63016 7.38632 4.44065 7.42413 4.29688 7.47559L4.16699 7.53125C3.86488 7.68518 3.61186 7.9196 3.43555 8.20703L3.36524 8.33399C3.28478 8.49198 3.22795 8.70352 3.19727 9.0791C3.16595 9.46259 3.16504 9.95611 3.16504 10.667V13.5C3.16504 14.211 3.16593 14.7044 3.19727 15.0879C3.22797 15.4636 3.28473 15.675 3.36524 15.833L3.43555 15.959C3.61186 16.2466 3.86474 16.4807 4.16699 16.6348L4.29688 16.6914C4.44063 16.7428 4.63025 16.7797 4.91211 16.8027C5.29563 16.8341 5.78896 16.835 6.5 16.835H9.33301C10.0439 16.835 10.5374 16.8341 10.9209 16.8027C11.2965 16.772 11.508 16.7152 11.666 16.6348L11.793 16.5645C12.0804 16.3881 12.3148 16.1351 12.4688 15.833L12.5244 15.7031C12.5759 15.5594 12.6137 15.3698 12.6367 15.0879C12.6681 14.7044 12.668 14.211 12.668 13.5V10.667ZM13.998 12.665C14.4528 12.6634 14.8011 12.6602 15.0879 12.6367C15.4635 12.606 15.675 12.5492 15.833 12.4688L15.959 12.3975C16.2466 12.2211 16.4808 11.9682 16.6348 11.666L16.6914 11.5361C16.7428 11.3924 16.7797 11.2026 16.8027 10.9209C16.8341 10.5374 16.835 10.0439 16.835 9.33301V6.5C16.835 5.78896 16.8341 5.29563 16.8027 4.91211C16.7797 4.63025 16.7428 4.44063 16.6914 4.29688L16.6348 4.16699C16.4807 3.86474 16.2466 3.61186 15.959 3.43555L15.833 3.36524C15.675 3.28473 15.4636 3.22797 15.0879 3.19727C14.7044 3.16593 14.211 3.16504 13.5 3.16504H10.667C9.9561 3.16504 9.46259 3.16595 9.0791 3.19727C8.79739 3.22028 8.6076 3.2572 8.46387 3.30859L8.33399 3.36524C8.03176 3.51923 7.77886 3.75343 7.60254 4.04102L7.53125 4.16699C7.4508 4.32498 7.39397 4.53655 7.36328 4.91211C7.33985 5.19893 7.33562 5.54719 7.33399 6.00195H9.33301C10.022 6.00195 10.5791 6.00131 11.0293 6.03809C11.4873 6.07551 11.8937 6.15471 12.2705 6.34668L12.4883 6.46875C12.984 6.7728 13.3878 7.20854 13.6533 7.72949L13.7197 7.87207C13.8642 8.20859 13.9292 8.56974 13.9619 8.9707C13.9987 9.42092 13.998 9.97799 13.998 10.667V12.665ZM18.165 9.33301C18.165 10.022 18.1657 10.5791 18.1289 11.0293C18.0961 11.4302 18.0311 11.7914 17.8867 12.1279L17.8203 12.2705C17.5549 12.7914 17.1509 13.2272 16.6553 13.5313L16.4365 13.6533C16.0599 13.8452 15.6541 13.9245 15.1963 13.9619C14.8593 13.9895 14.4624 13.9935 13.9951 13.9951C13.9935 14.4624 13.9895 14.8593 13.9619 15.1963C13.9292 15.597 13.864 15.9576 13.7197 16.2939L13.6533 16.4365C13.3878 16.9576 12.9841 17.3941 12.4883 17.6982L12.2705 17.8203C11.8937 18.0123 11.4873 18.0915 11.0293 18.1289C10.5791 18.1657 10.022 18.165 9.33301 18.165H6.5C5.81091 18.165 5.25395 18.1657 4.80371 18.1289C4.40306 18.0962 4.04235 18.031 3.70606 17.8867L3.56348 17.8203C3.04244 17.5548 2.60585 17.151 2.30176 16.6553L2.17969 16.4365C1.98788 16.0599 1.90851 15.6541 1.87109 15.1963C1.83431 14.746 1.83496 14.1891 1.83496 13.5V10.667C1.83496 9.978 1.83432 9.42091 1.87109 8.9707C1.90851 8.5127 1.98772 8.10625 2.17969 7.72949L2.30176 7.51172C2.60586 7.0159 3.04236 6.6122 3.56348 6.34668L3.70606 6.28027C4.04237 6.136 4.40303 6.07083 4.80371 6.03809C5.14051 6.01057 5.53708 6.00551 6.00391 6.00391C6.00551 5.53708 6.01057 5.14051 6.03809 4.80371C6.0755 4.34588 6.15483 3.94012 6.34668 3.56348L6.46875 3.34473C6.77282 2.84912 7.20856 2.44514 7.72949 2.17969L7.87207 2.11328C8.20855 1.96886 8.56979 1.90385 8.9707 1.87109C9.42091 1.83432 9.978 1.83496 10.667 1.83496H13.5C14.1891 1.83496 14.746 1.83431 15.1963 1.87109C15.6541 1.90851 16.0599 1.98788 16.4365 2.17969L16.6553 2.30176C17.151 2.60585 17.5548 3.04244 17.8203 3.56348L17.8867 3.70606C18.031 4.04235 18.0962 4.40306 18.1289 4.80371C18.1657 5.25395 18.165 5.81091 18.165 6.5V9.33301Z"></path></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre!"><span><span><span class="hljs-comment"># /etc/systemd/system/rfcomm-client@.service</span></span><span>
</span><span><span class="hljs-section">[Unit]</span></span><span>
</span><span><span class="hljs-attr">Description</span></span><span>=RFCOMM client to %I
</span><span><span class="hljs-attr">After</span></span><span>=bluetooth.service
</span><span><span class="hljs-attr">Requires</span></span><span>=bluetooth.service

</span><span><span class="hljs-section">[Service]</span></span><span>
</span><span><span class="hljs-attr">Type</span></span><span>=simple
</span><span><span class="hljs-attr">ExecStart</span></span><span>=/usr/local/bin/rfcomm-client.sh %i
</span><span><span class="hljs-attr">Restart</span></span><span>=always
</span><span><span class="hljs-attr">RestartSec</span></span><span>=</span><span><span class="hljs-number">2</span></span><span>

</span><span><span class="hljs-section">[Install]</span></span><span>
</span><span><span class="hljs-attr">WantedBy</span></span><span>=multi-user.target
</span></span></code></div></div></pre>
<p data-start="1488" data-end="1696">脚本 <code data-start="1491" data-end="1524">/usr/local/bin/rfcomm-client.sh</code> 内容可用上面的 while 循环版本（参数化 MAC/通道）。<br data-start="1556" data-end="1559">
再配一个 <code data-start="1564" data-end="1580">bridge.service</code>，让它 <strong data-start="1584" data-end="1619">After=<a data-start="1592" data-end="1617" class="decorated-link cursor-pointer" rel="noopener">rfcomm-client@MAC.service<span aria-hidden="true" class="ms-0.5 inline-block align-middle leading-none"><svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" data-rtl-flip="" class="block h-[0.75em] w-[0.75em] stroke-current stroke-[0.75]"><path d="M14.3349 13.3301V6.60645L5.47065 15.4707C5.21095 15.7304 4.78895 15.7304 4.52925 15.4707C4.26955 15.211 4.26955 14.789 4.52925 14.5293L13.3935 5.66504H6.66011C6.29284 5.66504 5.99507 5.36727 5.99507 5C5.99507 4.63273 6.29284 4.33496 6.66011 4.33496H14.9999L15.1337 4.34863C15.4369 4.41057 15.665 4.67857 15.665 5V13.3301C15.6649 13.6973 15.3672 13.9951 14.9999 13.9951C14.6327 13.9951 14.335 13.6973 14.3349 13.3301Z"></path></svg></span></a></strong> 并 <strong data-start="1622" data-end="1640">Restart=always</strong>。这样 rfcomm 断→重连、设备节点消失→重建时，bridge 也能被 systemd 自动拉起或保持运行。</p>
<hr data-start="1698" data-end="1701">
<h1 data-start="1703" data-end="1742">方案 B：单进程 Python：集成 RFCOMM 管理 + Bridge</h1>
<blockquote data-start="1744" data-end="1816">
<p data-start="1746" data-end="1816">你的 <code data-start="1749" data-end="1757">Bridge</code> 不改“帧协议/MQTT”核心，只是把串口打开/重开和 <code data-start="1785" data-end="1801">rfcomm connect</code> 的生命周期放到一个管理器里。</p>
</blockquote>
<p data-start="1818" data-end="1893">下面给一份可以直接用的<strong data-start="1829" data-end="1838">示例主程序</strong>（保留你原有 <code data-start="1845" data-end="1853">Bridge</code> 类，新增一个 <code data-start="1861" data-end="1876">RfcommManager</code> 和小改动以便在串口断开时重开）：</p>
<pre class="overflow-visible!" data-start="1895" data-end="9842"><div class="contain-inline-size rounded-2xl relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl">python</div><div class="sticky top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="icon-sm"><path d="M12.668 10.667C12.668 9.95614 12.668 9.46258 12.6367 9.0791C12.6137 8.79732 12.5758 8.60761 12.5244 8.46387L12.4688 8.33399C12.3148 8.03193 12.0803 7.77885 11.793 7.60254L11.666 7.53125C11.508 7.45087 11.2963 7.39395 10.9209 7.36328C10.5374 7.33197 10.0439 7.33203 9.33301 7.33203H6.5C5.78896 7.33203 5.29563 7.33195 4.91211 7.36328C4.63016 7.38632 4.44065 7.42413 4.29688 7.47559L4.16699 7.53125C3.86488 7.68518 3.61186 7.9196 3.43555 8.20703L3.36524 8.33399C3.28478 8.49198 3.22795 8.70352 3.19727 9.0791C3.16595 9.46259 3.16504 9.95611 3.16504 10.667V13.5C3.16504 14.211 3.16593 14.7044 3.19727 15.0879C3.22797 15.4636 3.28473 15.675 3.36524 15.833L3.43555 15.959C3.61186 16.2466 3.86474 16.4807 4.16699 16.6348L4.29688 16.6914C4.44063 16.7428 4.63025 16.7797 4.91211 16.8027C5.29563 16.8341 5.78896 16.835 6.5 16.835H9.33301C10.0439 16.835 10.5374 16.8341 10.9209 16.8027C11.2965 16.772 11.508 16.7152 11.666 16.6348L11.793 16.5645C12.0804 16.3881 12.3148 16.1351 12.4688 15.833L12.5244 15.7031C12.5759 15.5594 12.6137 15.3698 12.6367 15.0879C12.6681 14.7044 12.668 14.211 12.668 13.5V10.667ZM13.998 12.665C14.4528 12.6634 14.8011 12.6602 15.0879 12.6367C15.4635 12.606 15.675 12.5492 15.833 12.4688L15.959 12.3975C16.2466 12.2211 16.4808 11.9682 16.6348 11.666L16.6914 11.5361C16.7428 11.3924 16.7797 11.2026 16.8027 10.9209C16.8341 10.5374 16.835 10.0439 16.835 9.33301V6.5C16.835 5.78896 16.8341 5.29563 16.8027 4.91211C16.7797 4.63025 16.7428 4.44063 16.6914 4.29688L16.6348 4.16699C16.4807 3.86474 16.2466 3.61186 15.959 3.43555L15.833 3.36524C15.675 3.28473 15.4636 3.22797 15.0879 3.19727C14.7044 3.16593 14.211 3.16504 13.5 3.16504H10.667C9.9561 3.16504 9.46259 3.16595 9.0791 3.19727C8.79739 3.22028 8.6076 3.2572 8.46387 3.30859L8.33399 3.36524C8.03176 3.51923 7.77886 3.75343 7.60254 4.04102L7.53125 4.16699C7.4508 4.32498 7.39397 4.53655 7.36328 4.91211C7.33985 5.19893 7.33562 5.54719 7.33399 6.00195H9.33301C10.022 6.00195 10.5791 6.00131 11.0293 6.03809C11.4873 6.07551 11.8937 6.15471 12.2705 6.34668L12.4883 6.46875C12.984 6.7728 13.3878 7.20854 13.6533 7.72949L13.7197 7.87207C13.8642 8.20859 13.9292 8.56974 13.9619 8.9707C13.9987 9.42092 13.998 9.97799 13.998 10.667V12.665ZM18.165 9.33301C18.165 10.022 18.1657 10.5791 18.1289 11.0293C18.0961 11.4302 18.0311 11.7914 17.8867 12.1279L17.8203 12.2705C17.5549 12.7914 17.1509 13.2272 16.6553 13.5313L16.4365 13.6533C16.0599 13.8452 15.6541 13.9245 15.1963 13.9619C14.8593 13.9895 14.4624 13.9935 13.9951 13.9951C13.9935 14.4624 13.9895 14.8593 13.9619 15.1963C13.9292 15.597 13.864 15.9576 13.7197 16.2939L13.6533 16.4365C13.3878 16.9576 12.9841 17.3941 12.4883 17.6982L12.2705 17.8203C11.8937 18.0123 11.4873 18.0915 11.0293 18.1289C10.5791 18.1657 10.022 18.165 9.33301 18.165H6.5C5.81091 18.165 5.25395 18.1657 4.80371 18.1289C4.40306 18.0962 4.04235 18.031 3.70606 17.8867L3.56348 17.8203C3.04244 17.5548 2.60585 17.151 2.30176 16.6553L2.17969 16.4365C1.98788 16.0599 1.90851 15.6541 1.87109 15.1963C1.83431 14.746 1.83496 14.1891 1.83496 13.5V10.667C1.83496 9.978 1.83432 9.42091 1.87109 8.9707C1.90851 8.5127 1.98772 8.10625 2.17969 7.72949L2.30176 7.51172C2.60586 7.0159 3.04236 6.6122 3.56348 6.34668L3.70606 6.28027C4.04237 6.136 4.40303 6.07083 4.80371 6.03809C5.14051 6.01057 5.53708 6.00551 6.00391 6.00391C6.00551 5.53708 6.01057 5.14051 6.03809 4.80371C6.0755 4.34588 6.15483 3.94012 6.34668 3.56348L6.46875 3.34473C6.77282 2.84912 7.20856 2.44514 7.72949 2.17969L7.87207 2.11328C8.20855 1.96886 8.56979 1.90385 8.9707 1.87109C9.42091 1.83432 9.978 1.83496 10.667 1.83496H13.5C14.1891 1.83496 14.746 1.83431 15.1963 1.87109C15.6541 1.90851 16.0599 1.98788 16.4365 2.17969L16.6553 2.30176C17.151 2.60585 17.5548 3.04244 17.8203 3.56348L17.8867 3.70606C18.031 4.04235 18.0962 4.40306 18.1289 4.80371C18.1657 5.25395 18.165 5.81091 18.165 6.5V9.33301Z"></path></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-python"><span><span><span class="hljs-comment">#!/usr/bin/env python3</span></span><span>
</span><span><span class="hljs-keyword">import</span></span><span> os, sys, time, subprocess, signal, errno
</span><span><span class="hljs-keyword">import</span></span><span> serial
</span><span><span class="hljs-keyword">from</span></span><span> serial </span><span><span class="hljs-keyword">import</span></span><span> SerialException

</span><span><span class="hljs-comment"># ==== 配置 ====</span></span><span>
ROLE = os.getenv(</span><span><span class="hljs-string">"ROLE"</span></span><span>, </span><span><span class="hljs-string">"client"</span></span><span>)   </span><span><span class="hljs-comment"># "server" 或 "client"</span></span><span>
RFCOMM_DEV = os.getenv(</span><span><span class="hljs-string">"RFCOMM_DEV"</span></span><span>, </span><span><span class="hljs-string">"/dev/rfcomm0"</span></span><span>)
CHANNEL = </span><span><span class="hljs-built_in">int</span></span><span>(os.getenv(</span><span><span class="hljs-string">"CHANNEL"</span></span><span>, </span><span><span class="hljs-string">"1"</span></span><span>))

</span><span><span class="hljs-comment"># 仅客户端需要</span></span><span>
REMOTE = os.getenv(</span><span><span class="hljs-string">"REMOTE"</span></span><span>, </span><span><span class="hljs-string">"AA:BB:CC:DD:EE:FF"</span></span><span>)

</span><span><span class="hljs-comment"># 仅服务端需要（可选，只需一次）</span></span><span>
ENABLE_SDP = os.getenv(</span><span><span class="hljs-string">"ENABLE_SDP"</span></span><span>, </span><span><span class="hljs-string">"1"</span></span><span>) == </span><span><span class="hljs-string">"1"</span></span><span>

</span><span><span class="hljs-comment"># 你原来的 Bridge 参数</span></span><span>
SERIAL_BAUD = </span><span><span class="hljs-number">115200</span></span><span>
MQTT_HOST = os.getenv(</span><span><span class="hljs-string">"MQTT_HOST"</span></span><span>, </span><span><span class="hljs-string">"127.0.0.1"</span></span><span>)
MQTT_PORT = </span><span><span class="hljs-built_in">int</span></span><span>(os.getenv(</span><span><span class="hljs-string">"MQTT_PORT"</span></span><span>, </span><span><span class="hljs-string">"1884"</span></span><span>))  </span><span><span class="hljs-comment"># imop 上改为 1883</span></span><span>

</span><span><span class="hljs-comment"># ====== 你的 Bridge（只做很小的改动：支持串口重开） ======</span></span><span>
</span><span><span class="hljs-comment"># ——把你的 Bridge 类粘贴进来，只改 __init__ 和串口异常处理——</span></span><span>
</span><span><span class="hljs-keyword">import</span></span><span> base64, json, struct, threading, re
</span><span><span class="hljs-keyword">import</span></span><span> paho.mqtt.client </span><span><span class="hljs-keyword">as</span></span><span> mqtt
</span><span><span class="hljs-keyword">from</span></span><span> paho.mqtt.client </span><span><span class="hljs-keyword">import</span></span><span> CallbackAPIVersion

MAGIC = </span><span><span class="hljs-string">b"\xAA\x55"</span></span><span>
CLIENT_ID = </span><span><span class="hljs-string">"bt-bridge"</span></span><span>
SUB_PATTERNS = [</span><span><span class="hljs-string">"#"</span></span><span>]
EXCLUDE_PATTERNS = [</span><span><span class="hljs-string">r"^\$SYS/"</span></span><span>]

</span><span><span class="hljs-keyword">def</span></span><span> </span><span><span class="hljs-title function_">pack_frame</span></span><span>(</span><span><span class="hljs-params">topic: <span class="hljs-built_in">str</span></span></span><span>, payload: </span><span><span class="hljs-built_in">bytes</span></span><span>, qos: </span><span><span class="hljs-built_in">int</span></span><span>, retain: </span><span><span class="hljs-built_in">bool</span></span><span>) -&gt; </span><span><span class="hljs-built_in">bytes</span></span><span>:
    obj = {</span><span><span class="hljs-string">"type"</span></span><span>: </span><span><span class="hljs-string">"pub"</span></span><span>,</span><span><span class="hljs-string">"topic"</span></span><span>: topic,</span><span><span class="hljs-string">"qos"</span></span><span>: </span><span><span class="hljs-built_in">int</span></span><span>(qos),</span><span><span class="hljs-string">"retain"</span></span><span>: </span><span><span class="hljs-built_in">bool</span></span><span>(retain),
           </span><span><span class="hljs-string">"payload_b64"</span></span><span>: base64.b64encode(payload).decode(</span><span><span class="hljs-string">"ascii"</span></span><span>)}
    data = json.dumps(obj, separators=(</span><span><span class="hljs-string">","</span></span><span>, </span><span><span class="hljs-string">":"</span></span><span>)).encode(</span><span><span class="hljs-string">"utf-8"</span></span><span>)
    </span><span><span class="hljs-keyword">return</span></span><span> MAGIC + struct.pack(</span><span><span class="hljs-string">"&gt;I"</span></span><span>, </span><span><span class="hljs-built_in">len</span></span><span>(data)) + data

</span><span><span class="hljs-keyword">def</span></span><span> </span><span><span class="hljs-title function_">iter_frames</span></span><span>(</span><span><span class="hljs-params">buf: <span class="hljs-built_in">bytearray</span></span></span><span>):
    </span><span><span class="hljs-keyword">while</span></span><span> </span><span><span class="hljs-literal">True</span></span><span>:
        mpos = buf.find(MAGIC)
        </span><span><span class="hljs-keyword">if</span></span><span> mpos &lt; </span><span><span class="hljs-number">0</span></span><span>:
            </span><span><span class="hljs-keyword">if</span></span><span> </span><span><span class="hljs-built_in">len</span></span><span>(buf) &gt; </span><span><span class="hljs-number">65536</span></span><span>: buf.clear()
            </span><span><span class="hljs-keyword">return</span></span><span>
        </span><span><span class="hljs-keyword">if</span></span><span> </span><span><span class="hljs-built_in">len</span></span><span>(buf) &lt; mpos + </span><span><span class="hljs-number">6</span></span><span>: </span><span><span class="hljs-keyword">return</span></span><span>
        ln = struct.unpack(</span><span><span class="hljs-string">"&gt;I"</span></span><span>, buf[mpos+</span><span><span class="hljs-number">2</span></span><span>:mpos+</span><span><span class="hljs-number">6</span></span><span>])[</span><span><span class="hljs-number">0</span></span><span>]
        </span><span><span class="hljs-keyword">if</span></span><span> </span><span><span class="hljs-built_in">len</span></span><span>(buf) &lt; mpos + </span><span><span class="hljs-number">6</span></span><span> + ln: </span><span><span class="hljs-keyword">return</span></span><span>
        payload = </span><span><span class="hljs-built_in">bytes</span></span><span>(buf[mpos+</span><span><span class="hljs-number">6</span></span><span>:mpos+</span><span><span class="hljs-number">6</span></span><span>+ln])
        </span><span><span class="hljs-keyword">del</span></span><span> buf[:mpos+</span><span><span class="hljs-number">6</span></span><span>+ln]
        </span><span><span class="hljs-keyword">yield</span></span><span> payload

</span><span><span class="hljs-keyword">class</span></span><span> </span><span><span class="hljs-title class_">Bridge</span></span><span>:
    </span><span><span class="hljs-keyword">def</span></span><span> </span><span><span class="hljs-title function_">__init__</span></span><span>(</span><span><span class="hljs-params">self, serial_opener</span></span><span>):
        self._serial_opener = serial_opener
        self._ser = </span><span><span class="hljs-literal">None</span></span><span>
        self._ser_lock = threading.Lock()
        self._open_serial_blocking()

        self.cli = mqtt.Client(client_id=CLIENT_ID, protocol=mqtt.MQTTv5,
                               callback_api_version=CallbackAPIVersion.VERSION2)
        self.cli.connect(MQTT_HOST, MQTT_PORT, keepalive=</span><span><span class="hljs-number">30</span></span><span>)
        self.cli.on_message = self._on_message
        opts = mqtt.SubscribeOptions(qos=</span><span><span class="hljs-number">0</span></span><span>, noLocal=</span><span><span class="hljs-literal">True</span></span><span>, retainAsPublished=</span><span><span class="hljs-literal">False</span></span><span>, retainHandling=</span><span><span class="hljs-number">2</span></span><span>)
        </span><span><span class="hljs-keyword">for</span></span><span> pat </span><span><span class="hljs-keyword">in</span></span><span> SUB_PATTERNS:
            self.cli.subscribe(pat, options=opts)
        self.cli.loop_start()

        threading.Thread(target=self._serial_reader, daemon=</span><span><span class="hljs-literal">True</span></span><span>).start()
        </span><span><span class="hljs-built_in">print</span></span><span>(</span><span><span class="hljs-string">f"[bridge] up on mqtt <span class="hljs-subst">{MQTT_HOST}</span></span></span><span>:</span><span><span class="hljs-subst">{MQTT_PORT}</span></span><span>, serial </span><span><span class="hljs-subst">{RFCOMM_DEV}</span></span><span>@</span><span><span class="hljs-subst">{SERIAL_BAUD}</span></span><span>")

    </span><span><span class="hljs-keyword">def</span></span><span> </span><span><span class="hljs-title function_">_open_serial_blocking</span></span><span>(</span><span><span class="hljs-params">self</span></span><span>):
        </span><span><span class="hljs-keyword">while</span></span><span> </span><span><span class="hljs-literal">True</span></span><span>:
            </span><span><span class="hljs-keyword">try</span></span><span>:
                self._ser = self._serial_opener()
                </span><span><span class="hljs-built_in">print</span></span><span>(</span><span><span class="hljs-string">"[bridge] serial open ok"</span></span><span>)
                </span><span><span class="hljs-keyword">return</span></span><span>
            </span><span><span class="hljs-keyword">except</span></span><span> Exception </span><span><span class="hljs-keyword">as</span></span><span> e:
                </span><span><span class="hljs-built_in">print</span></span><span>(</span><span><span class="hljs-string">"[bridge] serial open failed, retry in 1s:"</span></span><span>, e)
                time.sleep(</span><span><span class="hljs-number">1</span></span><span>)

    </span><span><span class="hljs-keyword">def</span></span><span> </span><span><span class="hljs-title function_">_get_ser</span></span><span>(</span><span><span class="hljs-params">self</span></span><span>):
        </span><span><span class="hljs-keyword">with</span></span><span> self._ser_lock:
            </span><span><span class="hljs-keyword">return</span></span><span> self._ser

    </span><span><span class="hljs-keyword">def</span></span><span> </span><span><span class="hljs-title function_">_reopen_serial</span></span><span>(</span><span><span class="hljs-params">self</span></span><span>):
        </span><span><span class="hljs-keyword">with</span></span><span> self._ser_lock:
            </span><span><span class="hljs-keyword">try</span></span><span>:
                </span><span><span class="hljs-keyword">if</span></span><span> self._ser:
                    </span><span><span class="hljs-keyword">try</span></span><span>: self._ser.close()
                    </span><span><span class="hljs-keyword">except</span></span><span>: </span><span><span class="hljs-keyword">pass</span></span><span>
            </span><span><span class="hljs-keyword">finally</span></span><span>:
                self._ser = </span><span><span class="hljs-literal">None</span></span><span>
        self._open_serial_blocking()

    </span><span><span class="hljs-keyword">def</span></span><span> </span><span><span class="hljs-title function_">_on_message</span></span><span>(</span><span><span class="hljs-params">self, client, userdata, msg</span></span><span>):
        </span><span><span class="hljs-keyword">if</span></span><span> </span><span><span class="hljs-built_in">any</span></span><span>(re.</span><span><span class="hljs-built_in">compile</span></span><span>(p).search(msg.topic) </span><span><span class="hljs-keyword">for</span></span><span> p </span><span><span class="hljs-keyword">in</span></span><span> EXCLUDE_PATTERNS):
            </span><span><span class="hljs-keyword">return</span></span><span>
        </span><span><span class="hljs-keyword">try</span></span><span>:
            ser = self._get_ser()
            </span><span><span class="hljs-keyword">if</span></span><span> </span><span><span class="hljs-keyword">not</span></span><span> ser: </span><span><span class="hljs-keyword">raise</span></span><span> SerialException(</span><span><span class="hljs-string">"serial not ready"</span></span><span>)
            frame = pack_frame(msg.topic, msg.payload, msg.qos, msg.retain)
            ser.write(frame); ser.flush()
        </span><span><span class="hljs-keyword">except</span></span><span> Exception </span><span><span class="hljs-keyword">as</span></span><span> e:
            </span><span><span class="hljs-built_in">print</span></span><span>(</span><span><span class="hljs-string">"[bridge] serial write error:"</span></span><span>, e)
            </span><span><span class="hljs-comment"># 常见是 EIO/ENXIO：设备消失 → 触发重开</span></span><span>
            self._reopen_serial()

    </span><span><span class="hljs-keyword">def</span></span><span> </span><span><span class="hljs-title function_">_serial_reader</span></span><span>(</span><span><span class="hljs-params">self</span></span><span>):
        buf = </span><span><span class="hljs-built_in">bytearray</span></span><span>()
        </span><span><span class="hljs-keyword">while</span></span><span> </span><span><span class="hljs-literal">True</span></span><span>:
            </span><span><span class="hljs-keyword">try</span></span><span>:
                ser = self._get_ser()
                </span><span><span class="hljs-keyword">if</span></span><span> </span><span><span class="hljs-keyword">not</span></span><span> ser:
                    time.sleep(</span><span><span class="hljs-number">0.2</span></span><span>); </span><span><span class="hljs-keyword">continue</span></span><span>
                chunk = ser.read(</span><span><span class="hljs-number">1024</span></span><span>)
                </span><span><span class="hljs-keyword">if</span></span><span> </span><span><span class="hljs-keyword">not</span></span><span> chunk:
                    time.sleep(</span><span><span class="hljs-number">0.01</span></span><span>); </span><span><span class="hljs-keyword">continue</span></span><span>
                buf += chunk
                </span><span><span class="hljs-keyword">for</span></span><span> payload </span><span><span class="hljs-keyword">in</span></span><span> iter_frames(buf):
                    </span><span><span class="hljs-keyword">try</span></span><span>:
                        obj = json.loads(payload.decode(</span><span><span class="hljs-string">"utf-8"</span></span><span>))
                        </span><span><span class="hljs-keyword">if</span></span><span> obj.get(</span><span><span class="hljs-string">"type"</span></span><span>) != </span><span><span class="hljs-string">"pub"</span></span><span>: </span><span><span class="hljs-keyword">continue</span></span><span>
                        t = obj[</span><span><span class="hljs-string">"topic"</span></span><span>]
                        </span><span><span class="hljs-keyword">if</span></span><span> </span><span><span class="hljs-built_in">any</span></span><span>(re.</span><span><span class="hljs-built_in">compile</span></span><span>(p).search(t) </span><span><span class="hljs-keyword">for</span></span><span> p </span><span><span class="hljs-keyword">in</span></span><span> EXCLUDE_PATTERNS):
                            </span><span><span class="hljs-keyword">continue</span></span><span>
                        qos = </span><span><span class="hljs-built_in">int</span></span><span>(obj.get(</span><span><span class="hljs-string">"qos"</span></span><span>, </span><span><span class="hljs-number">0</span></span><span>))
                        retain = </span><span><span class="hljs-built_in">bool</span></span><span>(obj.get(</span><span><span class="hljs-string">"retain"</span></span><span>, </span><span><span class="hljs-literal">False</span></span><span>))
                        pl = base64.b64decode(obj.get(</span><span><span class="hljs-string">"payload_b64"</span></span><span>, </span><span><span class="hljs-string">""</span></span><span>))
                        self.cli.publish(t, pl, qos=qos, retain=retain,
                                         properties=mqtt.Properties(mqtt.PacketTypes.PUBLISH))
                    </span><span><span class="hljs-keyword">except</span></span><span> Exception </span><span><span class="hljs-keyword">as</span></span><span> e:
                        </span><span><span class="hljs-built_in">print</span></span><span>(</span><span><span class="hljs-string">"[bridge] frame error:"</span></span><span>, e)
            </span><span><span class="hljs-keyword">except</span></span><span> Exception </span><span><span class="hljs-keyword">as</span></span><span> e:
                </span><span><span class="hljs-comment"># 读失败（EIO/设备消失）→ 重开</span></span><span>
                </span><span><span class="hljs-built_in">print</span></span><span>(</span><span><span class="hljs-string">"[bridge] serial read error:"</span></span><span>, e)
                self._reopen_serial()
                time.sleep(</span><span><span class="hljs-number">0.5</span></span><span>)

</span><span><span class="hljs-comment"># ====== RFCOMM 管理器 ======</span></span><span>
</span><span><span class="hljs-keyword">class</span></span><span> </span><span><span class="hljs-title class_">RfcommManager</span></span><span>:
    </span><span><span class="hljs-keyword">def</span></span><span> </span><span><span class="hljs-title function_">__init__</span></span><span>(</span><span><span class="hljs-params">self</span></span><span>):
        self.proc = </span><span><span class="hljs-literal">None</span></span><span>

    </span><span><span class="hljs-keyword">def</span></span><span> </span><span><span class="hljs-title function_">_run</span></span><span>(</span><span><span class="hljs-params">self, argv</span></span><span>):
        </span><span><span class="hljs-comment"># 让 rfcomm 前台运行，便于我们监控退出并重启</span></span><span>
        </span><span><span class="hljs-built_in">print</span></span><span>(</span><span><span class="hljs-string">"[rfcomm] exec:"</span></span><span>, </span><span><span class="hljs-string">" "</span></span><span>.join(argv))
        </span><span><span class="hljs-keyword">return</span></span><span> subprocess.Popen(argv, stdout=subprocess.PIPE, stderr=subprocess.STDOUT, text=</span><span><span class="hljs-literal">True</span></span><span>)

    </span><span><span class="hljs-keyword">def</span></span><span> </span><span><span class="hljs-title function_">ensure_running</span></span><span>(</span><span><span class="hljs-params">self</span></span><span>):
        </span><span><span class="hljs-keyword">if</span></span><span> self.proc </span><span><span class="hljs-keyword">and</span></span><span> self.proc.poll() </span><span><span class="hljs-keyword">is</span></span><span> </span><span><span class="hljs-literal">None</span></span><span>:
            </span><span><span class="hljs-keyword">return</span></span><span>
        </span><span><span class="hljs-keyword">if</span></span><span> ROLE == </span><span><span class="hljs-string">"server"</span></span><span>:
            </span><span><span class="hljs-keyword">if</span></span><span> ENABLE_SDP:
                </span><span><span class="hljs-comment"># 幂等尝试；失败也不致命</span></span><span>
                subprocess.run([</span><span><span class="hljs-string">"sdptool"</span></span><span>, </span><span><span class="hljs-string">"add"</span></span><span>, </span><span><span class="hljs-string">"--channel"</span></span><span>, </span><span><span class="hljs-built_in">str</span></span><span>(CHANNEL), </span><span><span class="hljs-string">"SP"</span></span><span>], check=</span><span><span class="hljs-literal">False</span></span><span>)
            </span><span><span class="hljs-comment"># 某些版本是 rfcomm listen /dev/rfcomm0 1</span></span><span>
            self.proc = self._run([</span><span><span class="hljs-string">"rfcomm"</span></span><span>, </span><span><span class="hljs-string">"listen"</span></span><span>, RFCOMM_DEV, </span><span><span class="hljs-built_in">str</span></span><span>(CHANNEL)])
        </span><span><span class="hljs-keyword">else</span></span><span>:
            </span><span><span class="hljs-comment"># 优先使用支持重连的 -r；若你的 rfcomm 不支持 -r，可以删掉这个参数。</span></span><span>
            self.proc = self._run([</span><span><span class="hljs-string">"rfcomm"</span></span><span>, </span><span><span class="hljs-string">"connect"</span></span><span>, </span><span><span class="hljs-string">"-r"</span></span><span>, RFCOMM_DEV, REMOTE, </span><span><span class="hljs-built_in">str</span></span><span>(CHANNEL)])

        </span><span><span class="hljs-comment"># 异步打印 rfcomm 输出，便于日志查看</span></span><span>
        threading.Thread(target=self._pump_log, daemon=</span><span><span class="hljs-literal">True</span></span><span>).start()

    </span><span><span class="hljs-keyword">def</span></span><span> </span><span><span class="hljs-title function_">_pump_log</span></span><span>(</span><span><span class="hljs-params">self</span></span><span>):
        </span><span><span class="hljs-keyword">if</span></span><span> </span><span><span class="hljs-keyword">not</span></span><span> self.proc </span><span><span class="hljs-keyword">or</span></span><span> </span><span><span class="hljs-keyword">not</span></span><span> self.proc.stdout: </span><span><span class="hljs-keyword">return</span></span><span>
        </span><span><span class="hljs-keyword">for</span></span><span> line </span><span><span class="hljs-keyword">in</span></span><span> self.proc.stdout:
            </span><span><span class="hljs-built_in">print</span></span><span>(</span><span><span class="hljs-string">"[rfcomm]"</span></span><span>, line.rstrip())

    </span><span><span class="hljs-keyword">def</span></span><span> </span><span><span class="hljs-title function_">wait_device_node</span></span><span>(</span><span><span class="hljs-params">self, timeout=<span class="hljs-number">30</span></span></span><span>):
        t0 = time.time()
        </span><span><span class="hljs-keyword">while</span></span><span> time.time() - t0 &lt; timeout:
            </span><span><span class="hljs-keyword">if</span></span><span> os.path.exists(RFCOMM_DEV):
                </span><span><span class="hljs-comment"># 再给内核/udev 一点时间</span></span><span>
                time.sleep(</span><span><span class="hljs-number">0.2</span></span><span>)
                </span><span><span class="hljs-keyword">return</span></span><span> </span><span><span class="hljs-literal">True</span></span><span>
            time.sleep(</span><span><span class="hljs-number">0.2</span></span><span>)
        </span><span><span class="hljs-keyword">return</span></span><span> </span><span><span class="hljs-literal">False</span></span><span>

    </span><span><span class="hljs-keyword">def</span></span><span> </span><span><span class="hljs-title function_">reopen_if_stopped</span></span><span>(</span><span><span class="hljs-params">self</span></span><span>):
        </span><span><span class="hljs-keyword">if</span></span><span> self.proc </span><span><span class="hljs-keyword">and</span></span><span> self.proc.poll() </span><span><span class="hljs-keyword">is</span></span><span> </span><span><span class="hljs-keyword">not</span></span><span> </span><span><span class="hljs-literal">None</span></span><span>:
            </span><span><span class="hljs-built_in">print</span></span><span>(</span><span><span class="hljs-string">"[rfcomm] exited with"</span></span><span>, self.proc.returncode)
            self.proc = </span><span><span class="hljs-literal">None</span></span><span>
        self.ensure_running()

</span><span><span class="hljs-keyword">def</span></span><span> </span><span><span class="hljs-title function_">open_serial_once</span></span><span>():
    </span><span><span class="hljs-comment"># 每次需要打开串口时调用，Bridge 内部会在失败时重试</span></span><span>
    </span><span><span class="hljs-keyword">return</span></span><span> serial.Serial(RFCOMM_DEV, SERIAL_BAUD, timeout=</span><span><span class="hljs-number">0.05</span></span><span>)

</span><span><span class="hljs-keyword">if</span></span><span> __name__ == </span><span><span class="hljs-string">"__main__"</span></span><span>:
    </span><span><span class="hljs-keyword">import</span></span><span> threading
    mgr = RfcommManager()
    backoff = </span><span><span class="hljs-number">1</span></span><span>
    </span><span><span class="hljs-keyword">while</span></span><span> </span><span><span class="hljs-literal">True</span></span><span>:
        </span><span><span class="hljs-keyword">try</span></span><span>:
            mgr.ensure_running()
            </span><span><span class="hljs-keyword">if</span></span><span> </span><span><span class="hljs-keyword">not</span></span><span> mgr.wait_device_node(timeout=</span><span><span class="hljs-number">15</span></span><span>):
                </span><span><span class="hljs-keyword">raise</span></span><span> RuntimeError(</span><span><span class="hljs-string">"rfcomm device not present"</span></span><span>)
            br = Bridge(open_serial_once)
            </span><span><span class="hljs-comment"># 进入守护循环：监控 rfcomm 进程；若退出则触发串口重开</span></span><span>
            </span><span><span class="hljs-keyword">while</span></span><span> </span><span><span class="hljs-literal">True</span></span><span>:
                time.sleep(</span><span><span class="hljs-number">2</span></span><span>)
                mgr.reopen_if_stopped()
                </span><span><span class="hljs-keyword">if</span></span><span> </span><span><span class="hljs-keyword">not</span></span><span> os.path.exists(RFCOMM_DEV):
                    </span><span><span class="hljs-built_in">print</span></span><span>(</span><span><span class="hljs-string">"[main] rfcomm node disappeared; forcing serial reopen"</span></span><span>)
                    </span><span><span class="hljs-keyword">try</span></span><span>:
                        br._reopen_serial()
                    </span><span><span class="hljs-keyword">except</span></span><span> Exception </span><span><span class="hljs-keyword">as</span></span><span> e:
                        </span><span><span class="hljs-built_in">print</span></span><span>(</span><span><span class="hljs-string">"[main] reopen error:"</span></span><span>, e)
        </span><span><span class="hljs-keyword">except</span></span><span> KeyboardInterrupt:
            </span><span><span class="hljs-keyword">try</span></span><span>:
                </span><span><span class="hljs-keyword">if</span></span><span> mgr.proc: mgr.proc.send_signal(signal.SIGINT)
            </span><span><span class="hljs-keyword">except</span></span><span>: </span><span><span class="hljs-keyword">pass</span></span><span>
            sys.exit(</span><span><span class="hljs-number">0</span></span><span>)
        </span><span><span class="hljs-keyword">except</span></span><span> Exception </span><span><span class="hljs-keyword">as</span></span><span> e:
            </span><span><span class="hljs-built_in">print</span></span><span>(</span><span><span class="hljs-string">"[main] top-level error:"</span></span><span>, e)
            time.sleep(backoff)
            backoff = </span><span><span class="hljs-built_in">min</span></span><span>(backoff * </span><span><span class="hljs-number">2</span></span><span>, </span><span><span class="hljs-number">10</span></span><span>)
</span></span></code></div></div></pre>
<h3 data-start="9844" data-end="9852">使用方法</h3>
<ul data-start="9853" data-end="9869">
<li data-start="9853" data-end="9869">
<p data-start="9855" data-end="9869"><strong data-start="9855" data-end="9868">imop（服务端）</strong>：</p>
</li>
</ul>
<pre class="overflow-visible!" data-start="9870" data-end="9951"><div class="contain-inline-size rounded-2xl relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl">bash</div><div class="sticky top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="icon-sm"><path d="M12.668 10.667C12.668 9.95614 12.668 9.46258 12.6367 9.0791C12.6137 8.79732 12.5758 8.60761 12.5244 8.46387L12.4688 8.33399C12.3148 8.03193 12.0803 7.77885 11.793 7.60254L11.666 7.53125C11.508 7.45087 11.2963 7.39395 10.9209 7.36328C10.5374 7.33197 10.0439 7.33203 9.33301 7.33203H6.5C5.78896 7.33203 5.29563 7.33195 4.91211 7.36328C4.63016 7.38632 4.44065 7.42413 4.29688 7.47559L4.16699 7.53125C3.86488 7.68518 3.61186 7.9196 3.43555 8.20703L3.36524 8.33399C3.28478 8.49198 3.22795 8.70352 3.19727 9.0791C3.16595 9.46259 3.16504 9.95611 3.16504 10.667V13.5C3.16504 14.211 3.16593 14.7044 3.19727 15.0879C3.22797 15.4636 3.28473 15.675 3.36524 15.833L3.43555 15.959C3.61186 16.2466 3.86474 16.4807 4.16699 16.6348L4.29688 16.6914C4.44063 16.7428 4.63025 16.7797 4.91211 16.8027C5.29563 16.8341 5.78896 16.835 6.5 16.835H9.33301C10.0439 16.835 10.5374 16.8341 10.9209 16.8027C11.2965 16.772 11.508 16.7152 11.666 16.6348L11.793 16.5645C12.0804 16.3881 12.3148 16.1351 12.4688 15.833L12.5244 15.7031C12.5759 15.5594 12.6137 15.3698 12.6367 15.0879C12.6681 14.7044 12.668 14.211 12.668 13.5V10.667ZM13.998 12.665C14.4528 12.6634 14.8011 12.6602 15.0879 12.6367C15.4635 12.606 15.675 12.5492 15.833 12.4688L15.959 12.3975C16.2466 12.2211 16.4808 11.9682 16.6348 11.666L16.6914 11.5361C16.7428 11.3924 16.7797 11.2026 16.8027 10.9209C16.8341 10.5374 16.835 10.0439 16.835 9.33301V6.5C16.835 5.78896 16.8341 5.29563 16.8027 4.91211C16.7797 4.63025 16.7428 4.44063 16.6914 4.29688L16.6348 4.16699C16.4807 3.86474 16.2466 3.61186 15.959 3.43555L15.833 3.36524C15.675 3.28473 15.4636 3.22797 15.0879 3.19727C14.7044 3.16593 14.211 3.16504 13.5 3.16504H10.667C9.9561 3.16504 9.46259 3.16595 9.0791 3.19727C8.79739 3.22028 8.6076 3.2572 8.46387 3.30859L8.33399 3.36524C8.03176 3.51923 7.77886 3.75343 7.60254 4.04102L7.53125 4.16699C7.4508 4.32498 7.39397 4.53655 7.36328 4.91211C7.33985 5.19893 7.33562 5.54719 7.33399 6.00195H9.33301C10.022 6.00195 10.5791 6.00131 11.0293 6.03809C11.4873 6.07551 11.8937 6.15471 12.2705 6.34668L12.4883 6.46875C12.984 6.7728 13.3878 7.20854 13.6533 7.72949L13.7197 7.87207C13.8642 8.20859 13.9292 8.56974 13.9619 8.9707C13.9987 9.42092 13.998 9.97799 13.998 10.667V12.665ZM18.165 9.33301C18.165 10.022 18.1657 10.5791 18.1289 11.0293C18.0961 11.4302 18.0311 11.7914 17.8867 12.1279L17.8203 12.2705C17.5549 12.7914 17.1509 13.2272 16.6553 13.5313L16.4365 13.6533C16.0599 13.8452 15.6541 13.9245 15.1963 13.9619C14.8593 13.9895 14.4624 13.9935 13.9951 13.9951C13.9935 14.4624 13.9895 14.8593 13.9619 15.1963C13.9292 15.597 13.864 15.9576 13.7197 16.2939L13.6533 16.4365C13.3878 16.9576 12.9841 17.3941 12.4883 17.6982L12.2705 17.8203C11.8937 18.0123 11.4873 18.0915 11.0293 18.1289C10.5791 18.1657 10.022 18.165 9.33301 18.165H6.5C5.81091 18.165 5.25395 18.1657 4.80371 18.1289C4.40306 18.0962 4.04235 18.031 3.70606 17.8867L3.56348 17.8203C3.04244 17.5548 2.60585 17.151 2.30176 16.6553L2.17969 16.4365C1.98788 16.0599 1.90851 15.6541 1.87109 15.1963C1.83431 14.746 1.83496 14.1891 1.83496 13.5V10.667C1.83496 9.978 1.83432 9.42091 1.87109 8.9707C1.90851 8.5127 1.98772 8.10625 2.17969 7.72949L2.30176 7.51172C2.60586 7.0159 3.04236 6.6122 3.56348 6.34668L3.70606 6.28027C4.04237 6.136 4.40303 6.07083 4.80371 6.03809C5.14051 6.01057 5.53708 6.00551 6.00391 6.00391C6.00551 5.53708 6.01057 5.14051 6.03809 4.80371C6.0755 4.34588 6.15483 3.94012 6.34668 3.56348L6.46875 3.34473C6.77282 2.84912 7.20856 2.44514 7.72949 2.17969L7.87207 2.11328C8.20855 1.96886 8.56979 1.90385 8.9707 1.87109C9.42091 1.83432 9.978 1.83496 10.667 1.83496H13.5C14.1891 1.83496 14.746 1.83431 15.1963 1.87109C15.6541 1.90851 16.0599 1.98788 16.4365 2.17969L16.6553 2.30176C17.151 2.60585 17.5548 3.04244 17.8203 3.56348L17.8867 3.70606C18.031 4.04235 18.0962 4.40306 18.1289 4.80371C18.1657 5.25395 18.165 5.81091 18.165 6.5V9.33301Z"></path></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-bash"><span><span>ROLE=server CHANNEL=1 MQTT_PORT=1883 sudo -E python3 rfcomm_bridge.py
</span></span></code></div></div></pre>
<ul data-start="9952" data-end="9969">
<li data-start="9952" data-end="9969">
<p data-start="9954" data-end="9969"><strong data-start="9954" data-end="9968">iwalk（客户端）</strong>：</p>
</li>
</ul>
<pre class="overflow-visible!" data-start="9970" data-end="10076"><div class="contain-inline-size rounded-2xl relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl">bash</div><div class="sticky top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="icon-sm"><path d="M12.668 10.667C12.668 9.95614 12.668 9.46258 12.6367 9.0791C12.6137 8.79732 12.5758 8.60761 12.5244 8.46387L12.4688 8.33399C12.3148 8.03193 12.0803 7.77885 11.793 7.60254L11.666 7.53125C11.508 7.45087 11.2963 7.39395 10.9209 7.36328C10.5374 7.33197 10.0439 7.33203 9.33301 7.33203H6.5C5.78896 7.33203 5.29563 7.33195 4.91211 7.36328C4.63016 7.38632 4.44065 7.42413 4.29688 7.47559L4.16699 7.53125C3.86488 7.68518 3.61186 7.9196 3.43555 8.20703L3.36524 8.33399C3.28478 8.49198 3.22795 8.70352 3.19727 9.0791C3.16595 9.46259 3.16504 9.95611 3.16504 10.667V13.5C3.16504 14.211 3.16593 14.7044 3.19727 15.0879C3.22797 15.4636 3.28473 15.675 3.36524 15.833L3.43555 15.959C3.61186 16.2466 3.86474 16.4807 4.16699 16.6348L4.29688 16.6914C4.44063 16.7428 4.63025 16.7797 4.91211 16.8027C5.29563 16.8341 5.78896 16.835 6.5 16.835H9.33301C10.0439 16.835 10.5374 16.8341 10.9209 16.8027C11.2965 16.772 11.508 16.7152 11.666 16.6348L11.793 16.5645C12.0804 16.3881 12.3148 16.1351 12.4688 15.833L12.5244 15.7031C12.5759 15.5594 12.6137 15.3698 12.6367 15.0879C12.6681 14.7044 12.668 14.211 12.668 13.5V10.667ZM13.998 12.665C14.4528 12.6634 14.8011 12.6602 15.0879 12.6367C15.4635 12.606 15.675 12.5492 15.833 12.4688L15.959 12.3975C16.2466 12.2211 16.4808 11.9682 16.6348 11.666L16.6914 11.5361C16.7428 11.3924 16.7797 11.2026 16.8027 10.9209C16.8341 10.5374 16.835 10.0439 16.835 9.33301V6.5C16.835 5.78896 16.8341 5.29563 16.8027 4.91211C16.7797 4.63025 16.7428 4.44063 16.6914 4.29688L16.6348 4.16699C16.4807 3.86474 16.2466 3.61186 15.959 3.43555L15.833 3.36524C15.675 3.28473 15.4636 3.22797 15.0879 3.19727C14.7044 3.16593 14.211 3.16504 13.5 3.16504H10.667C9.9561 3.16504 9.46259 3.16595 9.0791 3.19727C8.79739 3.22028 8.6076 3.2572 8.46387 3.30859L8.33399 3.36524C8.03176 3.51923 7.77886 3.75343 7.60254 4.04102L7.53125 4.16699C7.4508 4.32498 7.39397 4.53655 7.36328 4.91211C7.33985 5.19893 7.33562 5.54719 7.33399 6.00195H9.33301C10.022 6.00195 10.5791 6.00131 11.0293 6.03809C11.4873 6.07551 11.8937 6.15471 12.2705 6.34668L12.4883 6.46875C12.984 6.7728 13.3878 7.20854 13.6533 7.72949L13.7197 7.87207C13.8642 8.20859 13.9292 8.56974 13.9619 8.9707C13.9987 9.42092 13.998 9.97799 13.998 10.667V12.665ZM18.165 9.33301C18.165 10.022 18.1657 10.5791 18.1289 11.0293C18.0961 11.4302 18.0311 11.7914 17.8867 12.1279L17.8203 12.2705C17.5549 12.7914 17.1509 13.2272 16.6553 13.5313L16.4365 13.6533C16.0599 13.8452 15.6541 13.9245 15.1963 13.9619C14.8593 13.9895 14.4624 13.9935 13.9951 13.9951C13.9935 14.4624 13.9895 14.8593 13.9619 15.1963C13.9292 15.597 13.864 15.9576 13.7197 16.2939L13.6533 16.4365C13.3878 16.9576 12.9841 17.3941 12.4883 17.6982L12.2705 17.8203C11.8937 18.0123 11.4873 18.0915 11.0293 18.1289C10.5791 18.1657 10.022 18.165 9.33301 18.165H6.5C5.81091 18.165 5.25395 18.1657 4.80371 18.1289C4.40306 18.0962 4.04235 18.031 3.70606 17.8867L3.56348 17.8203C3.04244 17.5548 2.60585 17.151 2.30176 16.6553L2.17969 16.4365C1.98788 16.0599 1.90851 15.6541 1.87109 15.1963C1.83431 14.746 1.83496 14.1891 1.83496 13.5V10.667C1.83496 9.978 1.83432 9.42091 1.87109 8.9707C1.90851 8.5127 1.98772 8.10625 2.17969 7.72949L2.30176 7.51172C2.60586 7.0159 3.04236 6.6122 3.56348 6.34668L3.70606 6.28027C4.04237 6.136 4.40303 6.07083 4.80371 6.03809C5.14051 6.01057 5.53708 6.00551 6.00391 6.00391C6.00551 5.53708 6.01057 5.14051 6.03809 4.80371C6.0755 4.34588 6.15483 3.94012 6.34668 3.56348L6.46875 3.34473C6.77282 2.84912 7.20856 2.44514 7.72949 2.17969L7.87207 2.11328C8.20855 1.96886 8.56979 1.90385 8.9707 1.87109C9.42091 1.83432 9.978 1.83496 10.667 1.83496H13.5C14.1891 1.83496 14.746 1.83431 15.1963 1.87109C15.6541 1.90851 16.0599 1.98788 16.4365 2.17969L16.6553 2.30176C17.151 2.60585 17.5548 3.04244 17.8203 3.56348L17.8867 3.70606C18.031 4.04235 18.0962 4.40306 18.1289 4.80371C18.1657 5.25395 18.165 5.81091 18.165 6.5V9.33301Z"></path></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-bash"><span><span>ROLE=client REMOTE=AA:BB:CC:DD:EE:FF CHANNEL=1 MQTT_PORT=1884 sudo -E python3 rfcomm_bridge.py
</span></span></code></div></div></pre>
<blockquote data-start="10078" data-end="10344">
<p data-start="10080" data-end="10084">说明</p>
<ol data-start="10087" data-end="10344">
<li data-start="10087" data-end="10125">
<p data-start="10090" data-end="10125">代码里 <code data-start="10094" data-end="10102">Bridge</code> 仍是“读写串口帧 ↔ MQTT”的逻辑；</p>
</li>
<li data-start="10128" data-end="10190">
<p data-start="10131" data-end="10190"><code data-start="10131" data-end="10146">RfcommManager</code> 负责起 <code data-start="10151" data-end="10174">rfcomm listen/connect</code>，并在掉线或进程退出时重启；</p>
</li>
<li data-start="10193" data-end="10276">
<p data-start="10196" data-end="10276">串口丢失（常见 <code data-start="10204" data-end="10215">EIO/ENXIO</code>）时，<code data-start="10218" data-end="10226">Bridge</code> 会触发 <code data-start="10231" data-end="10249">_reopen_serial()</code>，等待 <code data-start="10253" data-end="10267">/dev/rfcomm0</code> 回来再继续；</p>
</li>
<li data-start="10279" data-end="10344">
<p data-start="10282" data-end="10344">如果你的 <code data-start="10287" data-end="10295">rfcomm</code> 不支持 <code data-start="10300" data-end="10304">-r</code>，删掉该参数，靠外层循环/<code data-start="10317" data-end="10338">reopen_if_stopped()</code> 重试即可。</p>
</li>
</ol>
</blockquote>
<hr data-start="10346" data-end="10349">
<h2 data-start="10351" data-end="10366">若仍偶发掉线：三个小锦囊</h2>
<ol data-start="10367" data-end="10668">
<li data-start="10367" data-end="10450">
<p data-start="10370" data-end="10450"><strong data-start="10370" data-end="10378">轻量心跳</strong>：哪怕业务空闲，也每 5–10 秒经 RFCOMM 发一帧很小的 ping（十几字节足够），能显著降低监督超时/深度 sniff 掉线概率。</p>
</li>
<li data-start="10451" data-end="10534">
<p data-start="10454" data-end="10534"><strong data-start="10454" data-end="10462">提高稳态</strong>：保持 MQTT <code data-start="10471" data-end="10485">keepalive=30</code>（你已设），并尽量让一侧做“常驻监听”（server），另一侧做“主动重连”（client）。</p>
</li>
<li data-start="10535" data-end="10668">
<p data-start="10538" data-end="10668"><strong data-start="10538" data-end="10544">诊断</strong>：遇到顽固掉线，用 <code data-start="10554" data-end="10566">sudo btmon</code> + <code data-start="10569" data-end="10597">journalctl -u bluetooth -f</code> 抓一次，关注断开 reason：<code data-start="10614" data-end="10620">0x13</code> 多为对端主动断；<code data-start="10629" data-end="10635">0x08</code> 多为 supervision timeout——这时心跳最有效。</p>
</li>
</ol>
<hr data-start="10670" data-end="10673">
<p data-start="10675" data-end="10776" data-is-last-node="" data-is-only-node="">如果你希望，我也可以把你原始 <code data-start="10690" data-end="10701">bridge.py</code> 直接打上最小补丁（只加“串口重开”那几行），或者给出 systemd 完整单元文件（<code data-start="10744" data-end="10761">rfcomm + bridge</code> 两个服务的依赖、重启策略）。</p></div>
<div style="margin-bottom:16px;"><strong>用户:</strong><br>目标的MAC是：DC:4A:9E:31:D4:7D。给出完整的程序，我可以直接放到iwalk与imop中，并直接python运行，或者放到service运行</div>
<div style="margin-bottom:16px;"><strong>ChatGPT:</strong><br><p data-start="0" data-end="141">没问题！下面给你<strong data-start="8" data-end="25">一份完整可运行的单文件程序</strong>（<code data-start="26" data-end="44">rfcomm_bridge.py</code>），把<strong data-start="47" data-end="65">RFCOMM 建连/断线重连</strong>与<strong data-start="66" data-end="85">MQTT↔RFCOMM 串口桥</strong>整合在一起；还附上<strong data-start="94" data-end="110">systemd 服务模板</strong>，直接可放到 iwalk（客户端）与 imop（服务端）里跑。</p>
<ul data-start="143" data-end="310">
<li data-start="143" data-end="210">
<p data-start="145" data-end="210">默认假设：<strong data-start="150" data-end="164">imop = 服务端</strong>（监听 RFCOMM ch=1），<strong data-start="181" data-end="196">iwalk = 客户端</strong>（主动连到 imop）。</p>
</li>
<li data-start="211" data-end="266">
<p data-start="213" data-end="266">你提供的目标 MAC：<code data-start="224" data-end="243">DC:4A:9E:31:D4:7D</code>（脚本里已设为客户端默认 REMOTE）。</p>
</li>
<li data-start="267" data-end="310">
<p data-start="269" data-end="310">端口习惯保留：iwalk 用 1884，imop 用 1883（可用环境变量改）。</p>
</li>
</ul>
<hr data-start="312" data-end="315">
<h3 data-start="317" data-end="351"><code data-start="321" data-end="339">rfcomm_bridge.py</code>（两端通用，按角色运行）</h3>
<p data-start="353" data-end="390">把下面代码保存为 <code data-start="362" data-end="380">rfcomm_bridge.py</code>（两端都放同一份）：</p>
<pre class="overflow-visible!" data-start="392" data-end="10296"><div class="contain-inline-size rounded-2xl relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl">python</div><div class="sticky top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="icon-sm"><path d="M12.668 10.667C12.668 9.95614 12.668 9.46258 12.6367 9.0791C12.6137 8.79732 12.5758 8.60761 12.5244 8.46387L12.4688 8.33399C12.3148 8.03193 12.0803 7.77885 11.793 7.60254L11.666 7.53125C11.508 7.45087 11.2963 7.39395 10.9209 7.36328C10.5374 7.33197 10.0439 7.33203 9.33301 7.33203H6.5C5.78896 7.33203 5.29563 7.33195 4.91211 7.36328C4.63016 7.38632 4.44065 7.42413 4.29688 7.47559L4.16699 7.53125C3.86488 7.68518 3.61186 7.9196 3.43555 8.20703L3.36524 8.33399C3.28478 8.49198 3.22795 8.70352 3.19727 9.0791C3.16595 9.46259 3.16504 9.95611 3.16504 10.667V13.5C3.16504 14.211 3.16593 14.7044 3.19727 15.0879C3.22797 15.4636 3.28473 15.675 3.36524 15.833L3.43555 15.959C3.61186 16.2466 3.86474 16.4807 4.16699 16.6348L4.29688 16.6914C4.44063 16.7428 4.63025 16.7797 4.91211 16.8027C5.29563 16.8341 5.78896 16.835 6.5 16.835H9.33301C10.0439 16.835 10.5374 16.8341 10.9209 16.8027C11.2965 16.772 11.508 16.7152 11.666 16.6348L11.793 16.5645C12.0804 16.3881 12.3148 16.1351 12.4688 15.833L12.5244 15.7031C12.5759 15.5594 12.6137 15.3698 12.6367 15.0879C12.6681 14.7044 12.668 14.211 12.668 13.5V10.667ZM13.998 12.665C14.4528 12.6634 14.8011 12.6602 15.0879 12.6367C15.4635 12.606 15.675 12.5492 15.833 12.4688L15.959 12.3975C16.2466 12.2211 16.4808 11.9682 16.6348 11.666L16.6914 11.5361C16.7428 11.3924 16.7797 11.2026 16.8027 10.9209C16.8341 10.5374 16.835 10.0439 16.835 9.33301V6.5C16.835 5.78896 16.8341 5.29563 16.8027 4.91211C16.7797 4.63025 16.7428 4.44063 16.6914 4.29688L16.6348 4.16699C16.4807 3.86474 16.2466 3.61186 15.959 3.43555L15.833 3.36524C15.675 3.28473 15.4636 3.22797 15.0879 3.19727C14.7044 3.16593 14.211 3.16504 13.5 3.16504H10.667C9.9561 3.16504 9.46259 3.16595 9.0791 3.19727C8.79739 3.22028 8.6076 3.2572 8.46387 3.30859L8.33399 3.36524C8.03176 3.51923 7.77886 3.75343 7.60254 4.04102L7.53125 4.16699C7.4508 4.32498 7.39397 4.53655 7.36328 4.91211C7.33985 5.19893 7.33562 5.54719 7.33399 6.00195H9.33301C10.022 6.00195 10.5791 6.00131 11.0293 6.03809C11.4873 6.07551 11.8937 6.15471 12.2705 6.34668L12.4883 6.46875C12.984 6.7728 13.3878 7.20854 13.6533 7.72949L13.7197 7.87207C13.8642 8.20859 13.9292 8.56974 13.9619 8.9707C13.9987 9.42092 13.998 9.97799 13.998 10.667V12.665ZM18.165 9.33301C18.165 10.022 18.1657 10.5791 18.1289 11.0293C18.0961 11.4302 18.0311 11.7914 17.8867 12.1279L17.8203 12.2705C17.5549 12.7914 17.1509 13.2272 16.6553 13.5313L16.4365 13.6533C16.0599 13.8452 15.6541 13.9245 15.1963 13.9619C14.8593 13.9895 14.4624 13.9935 13.9951 13.9951C13.9935 14.4624 13.9895 14.8593 13.9619 15.1963C13.9292 15.597 13.864 15.9576 13.7197 16.2939L13.6533 16.4365C13.3878 16.9576 12.9841 17.3941 12.4883 17.6982L12.2705 17.8203C11.8937 18.0123 11.4873 18.0915 11.0293 18.1289C10.5791 18.1657 10.022 18.165 9.33301 18.165H6.5C5.81091 18.165 5.25395 18.1657 4.80371 18.1289C4.40306 18.0962 4.04235 18.031 3.70606 17.8867L3.56348 17.8203C3.04244 17.5548 2.60585 17.151 2.30176 16.6553L2.17969 16.4365C1.98788 16.0599 1.90851 15.6541 1.87109 15.1963C1.83431 14.746 1.83496 14.1891 1.83496 13.5V10.667C1.83496 9.978 1.83432 9.42091 1.87109 8.9707C1.90851 8.5127 1.98772 8.10625 2.17969 7.72949L2.30176 7.51172C2.60586 7.0159 3.04236 6.6122 3.56348 6.34668L3.70606 6.28027C4.04237 6.136 4.40303 6.07083 4.80371 6.03809C5.14051 6.01057 5.53708 6.00551 6.00391 6.00391C6.00551 5.53708 6.01057 5.14051 6.03809 4.80371C6.0755 4.34588 6.15483 3.94012 6.34668 3.56348L6.46875 3.34473C6.77282 2.84912 7.20856 2.44514 7.72949 2.17969L7.87207 2.11328C8.20855 1.96886 8.56979 1.90385 8.9707 1.87109C9.42091 1.83432 9.978 1.83496 10.667 1.83496H13.5C14.1891 1.83496 14.746 1.83431 15.1963 1.87109C15.6541 1.90851 16.0599 1.98788 16.4365 2.17969L16.6553 2.30176C17.151 2.60585 17.5548 3.04244 17.8203 3.56348L17.8867 3.70606C18.031 4.04235 18.0962 4.40306 18.1289 4.80371C18.1657 5.25395 18.165 5.81091 18.165 6.5V9.33301Z"></path></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-python"><span><span><span class="hljs-comment">#!/usr/bin/env python3</span></span><span>
</span><span><span class="hljs-comment"># -*- coding: utf-8 -*-</span></span><span>
<span class="hljs-string">"""
rfcomm_bridge.py
- 统一管理：RFCOMM 建链 / 自动重连 + MQTT&lt;-&gt;RFCOMM 桥
- 运行方式：
  服务端(imop)：ROLE=server CHANNEL=1 MQTT_PORT=1883 sudo -E python3 rfcomm_bridge.py
  客户端(iwalk)：ROLE=client REMOTE=DC:4A:9E:31:D4:7D CHANNEL=1 MQTT_PORT=1884 sudo -E python3 rfcomm_bridge.py
依赖：sudo apt-get install -y bluez bluez-tools; pip install pyserial paho-mqtt
"""</span>

</span><span><span class="hljs-keyword">import</span></span><span> os, sys, time, subprocess, signal, threading, json, base64, struct, re
</span><span><span class="hljs-keyword">import</span></span><span> errno
</span><span><span class="hljs-keyword">from</span></span><span> typing </span><span><span class="hljs-keyword">import</span></span><span> </span><span><span class="hljs-type">Optional</span></span><span>

</span><span><span class="hljs-comment"># ===== 角色/蓝牙基础配置 =====</span></span><span>
ROLE = os.getenv(</span><span><span class="hljs-string">"ROLE"</span></span><span>, </span><span><span class="hljs-string">"client"</span></span><span>).strip()          </span><span><span class="hljs-comment"># "server" 或 "client"</span></span><span>
RFCOMM_DEV = os.getenv(</span><span><span class="hljs-string">"RFCOMM_DEV"</span></span><span>, </span><span><span class="hljs-string">"/dev/rfcomm0"</span></span><span>)
CHANNEL = </span><span><span class="hljs-built_in">int</span></span><span>(os.getenv(</span><span><span class="hljs-string">"CHANNEL"</span></span><span>, </span><span><span class="hljs-string">"1"</span></span><span>))
REMOTE = os.getenv(</span><span><span class="hljs-string">"REMOTE"</span></span><span>, </span><span><span class="hljs-string">"DC:4A:9E:31:D4:7D"</span></span><span>)   </span><span><span class="hljs-comment"># 客户端默认目标 MAC（你提供的）</span></span><span>

</span><span><span class="hljs-comment"># 服务端是否尝试注册 SPP（幂等、失败不致命）</span></span><span>
ENABLE_SDP = os.getenv(</span><span><span class="hljs-string">"ENABLE_SDP"</span></span><span>, </span><span><span class="hljs-string">"1"</span></span><span>) == </span><span><span class="hljs-string">"1"</span></span><span>

</span><span><span class="hljs-comment"># ===== MQTT 与串口配置（沿用你的习惯）=====</span></span><span>
MQTT_HOST = os.getenv(</span><span><span class="hljs-string">"MQTT_HOST"</span></span><span>, </span><span><span class="hljs-string">"127.0.0.1"</span></span><span>)
MQTT_PORT = </span><span><span class="hljs-built_in">int</span></span><span>(os.getenv(</span><span><span class="hljs-string">"MQTT_PORT"</span></span><span>, </span><span><span class="hljs-string">"1884"</span></span><span>))     </span><span><span class="hljs-comment"># imop 改 1883；iwalk 用 1884</span></span><span>
SERIAL_BAUD = </span><span><span class="hljs-built_in">int</span></span><span>(os.getenv(</span><span><span class="hljs-string">"SERIAL_BAUD"</span></span><span>, </span><span><span class="hljs-string">"115200"</span></span><span>))

</span><span><span class="hljs-comment"># ===== 桥的过滤/帧格式，与你原代码一致 =====</span></span><span>
MAGIC = </span><span><span class="hljs-string">b"\xAA\x55"</span></span><span>
CLIENT_ID = os.getenv(</span><span><span class="hljs-string">"CLIENT_ID"</span></span><span>, </span><span><span class="hljs-string">"bt-bridge"</span></span><span>)
SUB_PATTERNS = os.getenv(</span><span><span class="hljs-string">"SUB_PATTERNS"</span></span><span>, </span><span><span class="hljs-string">"#"</span></span><span>).split(</span><span><span class="hljs-string">","</span></span><span>)  </span><span><span class="hljs-comment"># 逗号分隔，默认 ["#"]</span></span><span>
EXCLUDE_PATTERNS = [p </span><span><span class="hljs-keyword">for</span></span><span> p </span><span><span class="hljs-keyword">in</span></span><span> os.getenv(</span><span><span class="hljs-string">"EXCLUDE_PATTERNS"</span></span><span>, </span><span><span class="hljs-string">r"^\$SYS/"</span></span><span>).split(</span><span><span class="hljs-string">","</span></span><span>) </span><span><span class="hljs-keyword">if</span></span><span> p]

</span><span><span class="hljs-comment"># ===== 依赖（pyserial / paho-mqtt）=====</span></span><span>
</span><span><span class="hljs-keyword">try</span></span><span>:
    </span><span><span class="hljs-keyword">import</span></span><span> serial
    </span><span><span class="hljs-keyword">from</span></span><span> serial </span><span><span class="hljs-keyword">import</span></span><span> SerialException
</span><span><span class="hljs-keyword">except</span></span><span> Exception </span><span><span class="hljs-keyword">as</span></span><span> e:
    </span><span><span class="hljs-built_in">print</span></span><span>(</span><span><span class="hljs-string">"[fatal] 缺少依赖 pyserial，请：pip install pyserial"</span></span><span>)
    </span><span><span class="hljs-keyword">raise</span></span><span>

</span><span><span class="hljs-keyword">try</span></span><span>:
    </span><span><span class="hljs-keyword">import</span></span><span> paho.mqtt.client </span><span><span class="hljs-keyword">as</span></span><span> mqtt
    </span><span><span class="hljs-keyword">from</span></span><span> paho.mqtt.client </span><span><span class="hljs-keyword">import</span></span><span> CallbackAPIVersion
</span><span><span class="hljs-keyword">except</span></span><span> Exception </span><span><span class="hljs-keyword">as</span></span><span> e:
    </span><span><span class="hljs-built_in">print</span></span><span>(</span><span><span class="hljs-string">"[fatal] 缺少依赖 paho-mqtt，请：pip install paho-mqtt"</span></span><span>)
    </span><span><span class="hljs-keyword">raise</span></span><span>

</span><span><span class="hljs-comment"># ---------------- 工具函数 ----------------</span></span><span>
</span><span><span class="hljs-keyword">def</span></span><span> </span><span><span class="hljs-title function_">pack_frame</span></span><span>(</span><span><span class="hljs-params">topic: <span class="hljs-built_in">str</span></span></span><span>, payload: </span><span><span class="hljs-built_in">bytes</span></span><span>, qos: </span><span><span class="hljs-built_in">int</span></span><span>, retain: </span><span><span class="hljs-built_in">bool</span></span><span>) -&gt; </span><span><span class="hljs-built_in">bytes</span></span><span>:
    obj = {
        </span><span><span class="hljs-string">"type"</span></span><span>: </span><span><span class="hljs-string">"pub"</span></span><span>,
        </span><span><span class="hljs-string">"topic"</span></span><span>: topic,
        </span><span><span class="hljs-string">"qos"</span></span><span>: </span><span><span class="hljs-built_in">int</span></span><span>(qos),
        </span><span><span class="hljs-string">"retain"</span></span><span>: </span><span><span class="hljs-built_in">bool</span></span><span>(retain),
        </span><span><span class="hljs-string">"payload_b64"</span></span><span>: base64.b64encode(payload).decode(</span><span><span class="hljs-string">"ascii"</span></span><span>),
    }
    data = json.dumps(obj, separators=(</span><span><span class="hljs-string">","</span></span><span>, </span><span><span class="hljs-string">":"</span></span><span>)).encode(</span><span><span class="hljs-string">"utf-8"</span></span><span>)
    </span><span><span class="hljs-keyword">return</span></span><span> MAGIC + struct.pack(</span><span><span class="hljs-string">"&gt;I"</span></span><span>, </span><span><span class="hljs-built_in">len</span></span><span>(data)) + data

</span><span><span class="hljs-keyword">def</span></span><span> </span><span><span class="hljs-title function_">iter_frames</span></span><span>(</span><span><span class="hljs-params">buf: <span class="hljs-built_in">bytearray</span></span></span><span>):
    </span><span><span class="hljs-keyword">while</span></span><span> </span><span><span class="hljs-literal">True</span></span><span>:
        mpos = buf.find(MAGIC)
        </span><span><span class="hljs-keyword">if</span></span><span> mpos &lt; </span><span><span class="hljs-number">0</span></span><span>:
            </span><span><span class="hljs-keyword">if</span></span><span> </span><span><span class="hljs-built_in">len</span></span><span>(buf) &gt; </span><span><span class="hljs-number">65536</span></span><span>:
                buf.clear()
            </span><span><span class="hljs-keyword">return</span></span><span>
        </span><span><span class="hljs-keyword">if</span></span><span> </span><span><span class="hljs-built_in">len</span></span><span>(buf) &lt; mpos + </span><span><span class="hljs-number">6</span></span><span>:
            </span><span><span class="hljs-keyword">return</span></span><span>
        ln = struct.unpack(</span><span><span class="hljs-string">"&gt;I"</span></span><span>, buf[mpos+</span><span><span class="hljs-number">2</span></span><span>:mpos+</span><span><span class="hljs-number">6</span></span><span>])[</span><span><span class="hljs-number">0</span></span><span>]
        </span><span><span class="hljs-keyword">if</span></span><span> </span><span><span class="hljs-built_in">len</span></span><span>(buf) &lt; mpos + </span><span><span class="hljs-number">6</span></span><span> + ln:
            </span><span><span class="hljs-keyword">return</span></span><span>
        payload = </span><span><span class="hljs-built_in">bytes</span></span><span>(buf[mpos+</span><span><span class="hljs-number">6</span></span><span>:mpos+</span><span><span class="hljs-number">6</span></span><span>+ln])
        </span><span><span class="hljs-keyword">del</span></span><span> buf[:mpos+</span><span><span class="hljs-number">6</span></span><span>+ln]
        </span><span><span class="hljs-keyword">yield</span></span><span> payload

</span><span><span class="hljs-comment"># ---------------- Bridge 本体（轻改版：支持串口丢失时自动重开） ----------------</span></span><span>
</span><span><span class="hljs-keyword">class</span></span><span> </span><span><span class="hljs-title class_">Bridge</span></span><span>:
    </span><span><span class="hljs-keyword">def</span></span><span> </span><span><span class="hljs-title function_">__init__</span></span><span>(</span><span><span class="hljs-params">self, serial_opener</span></span><span>):
        self._serial_opener = serial_opener
        self._ser = </span><span><span class="hljs-literal">None</span></span><span>
        self._ser_lock = threading.Lock()

        self._open_serial_blocking()

        self.cli = mqtt.Client(
            client_id=CLIENT_ID,
            protocol=mqtt.MQTTv5,
            callback_api_version=CallbackAPIVersion.VERSION2,
        )
        self.cli.connect(MQTT_HOST, MQTT_PORT, keepalive=</span><span><span class="hljs-number">30</span></span><span>)
        self.cli.on_message = self._on_message

        opts = mqtt.SubscribeOptions(qos=</span><span><span class="hljs-number">0</span></span><span>, noLocal=</span><span><span class="hljs-literal">True</span></span><span>, retainAsPublished=</span><span><span class="hljs-literal">False</span></span><span>, retainHandling=</span><span><span class="hljs-number">2</span></span><span>)
        </span><span><span class="hljs-keyword">for</span></span><span> pat </span><span><span class="hljs-keyword">in</span></span><span> SUB_PATTERNS:
            self.cli.subscribe(pat, options=opts)

        self.cli.loop_start()
        threading.Thread(target=self._serial_reader, daemon=</span><span><span class="hljs-literal">True</span></span><span>).start()
        </span><span><span class="hljs-built_in">print</span></span><span>(</span><span><span class="hljs-string">f"[bridge] up on mqtt <span class="hljs-subst">{MQTT_HOST}</span></span></span><span>:</span><span><span class="hljs-subst">{MQTT_PORT}</span></span><span>, serial </span><span><span class="hljs-subst">{RFCOMM_DEV}</span></span><span>@</span><span><span class="hljs-subst">{SERIAL_BAUD}</span></span><span>")

    </span><span><span class="hljs-keyword">def</span></span><span> </span><span><span class="hljs-title function_">_open_serial_blocking</span></span><span>(</span><span><span class="hljs-params">self</span></span><span>):
        </span><span><span class="hljs-keyword">while</span></span><span> </span><span><span class="hljs-literal">True</span></span><span>:
            </span><span><span class="hljs-keyword">try</span></span><span>:
                self._ser = self._serial_opener()
                </span><span><span class="hljs-built_in">print</span></span><span>(</span><span><span class="hljs-string">"[bridge] serial open ok"</span></span><span>)
                </span><span><span class="hljs-keyword">return</span></span><span>
            </span><span><span class="hljs-keyword">except</span></span><span> Exception </span><span><span class="hljs-keyword">as</span></span><span> e:
                </span><span><span class="hljs-built_in">print</span></span><span>(</span><span><span class="hljs-string">"[bridge] serial open failed, retry in 1s:"</span></span><span>, e)
                time.sleep(</span><span><span class="hljs-number">1</span></span><span>)

    </span><span><span class="hljs-keyword">def</span></span><span> </span><span><span class="hljs-title function_">_get_ser</span></span><span>(</span><span><span class="hljs-params">self</span></span><span>):
        </span><span><span class="hljs-keyword">with</span></span><span> self._ser_lock:
            </span><span><span class="hljs-keyword">return</span></span><span> self._ser

    </span><span><span class="hljs-keyword">def</span></span><span> </span><span><span class="hljs-title function_">_reopen_serial</span></span><span>(</span><span><span class="hljs-params">self</span></span><span>):
        </span><span><span class="hljs-keyword">with</span></span><span> self._ser_lock:
            </span><span><span class="hljs-keyword">try</span></span><span>:
                </span><span><span class="hljs-keyword">if</span></span><span> self._ser:
                    </span><span><span class="hljs-keyword">try</span></span><span>:
                        self._ser.close()
                    </span><span><span class="hljs-keyword">except</span></span><span>:
                        </span><span><span class="hljs-keyword">pass</span></span><span>
            </span><span><span class="hljs-keyword">finally</span></span><span>:
                self._ser = </span><span><span class="hljs-literal">None</span></span><span>
        self._open_serial_blocking()

    </span><span><span class="hljs-keyword">def</span></span><span> </span><span><span class="hljs-title function_">_excluded</span></span><span>(</span><span><span class="hljs-params">self, topic: <span class="hljs-built_in">str</span></span></span><span>) -&gt; </span><span><span class="hljs-built_in">bool</span></span><span>:
        </span><span><span class="hljs-keyword">return</span></span><span> </span><span><span class="hljs-built_in">any</span></span><span>(re.</span><span><span class="hljs-built_in">compile</span></span><span>(p).search(topic) </span><span><span class="hljs-keyword">for</span></span><span> p </span><span><span class="hljs-keyword">in</span></span><span> EXCLUDE_PATTERNS)

    </span><span><span class="hljs-comment"># 本地 MQTT → 串口 → 对端</span></span><span>
    </span><span><span class="hljs-keyword">def</span></span><span> </span><span><span class="hljs-title function_">_on_message</span></span><span>(</span><span><span class="hljs-params">self, client, userdata, msg: mqtt.MQTTMessage</span></span><span>):
        </span><span><span class="hljs-keyword">if</span></span><span> self._excluded(msg.topic):
            </span><span><span class="hljs-keyword">return</span></span><span>
        </span><span><span class="hljs-keyword">try</span></span><span>:
            ser = self._get_ser()
            </span><span><span class="hljs-keyword">if</span></span><span> </span><span><span class="hljs-keyword">not</span></span><span> ser:
                </span><span><span class="hljs-keyword">raise</span></span><span> SerialException(</span><span><span class="hljs-string">"serial not ready"</span></span><span>)
            frame = pack_frame(msg.topic, msg.payload, msg.qos, msg.retain)
            ser.write(frame)
            ser.flush()
        </span><span><span class="hljs-keyword">except</span></span><span> Exception </span><span><span class="hljs-keyword">as</span></span><span> e:
            </span><span><span class="hljs-built_in">print</span></span><span>(</span><span><span class="hljs-string">"[bridge] serial write error:"</span></span><span>, e)
            self._reopen_serial()

    </span><span><span class="hljs-comment"># 串口 → 本地 MQTT（发布），因 no_local 不会再被自己订阅</span></span><span>
    </span><span><span class="hljs-keyword">def</span></span><span> </span><span><span class="hljs-title function_">_serial_reader</span></span><span>(</span><span><span class="hljs-params">self</span></span><span>):
        buf = </span><span><span class="hljs-built_in">bytearray</span></span><span>()
        </span><span><span class="hljs-keyword">while</span></span><span> </span><span><span class="hljs-literal">True</span></span><span>:
            </span><span><span class="hljs-keyword">try</span></span><span>:
                ser = self._get_ser()
                </span><span><span class="hljs-keyword">if</span></span><span> </span><span><span class="hljs-keyword">not</span></span><span> ser:
                    time.sleep(</span><span><span class="hljs-number">0.2</span></span><span>)
                    </span><span><span class="hljs-keyword">continue</span></span><span>
                chunk = ser.read(</span><span><span class="hljs-number">1024</span></span><span>)
                </span><span><span class="hljs-keyword">if</span></span><span> </span><span><span class="hljs-keyword">not</span></span><span> chunk:
                    time.sleep(</span><span><span class="hljs-number">0.01</span></span><span>)
                    </span><span><span class="hljs-keyword">continue</span></span><span>
                buf += chunk
                </span><span><span class="hljs-keyword">for</span></span><span> payload </span><span><span class="hljs-keyword">in</span></span><span> iter_frames(buf):
                    </span><span><span class="hljs-keyword">try</span></span><span>:
                        obj = json.loads(payload.decode(</span><span><span class="hljs-string">"utf-8"</span></span><span>))
                        </span><span><span class="hljs-keyword">if</span></span><span> obj.get(</span><span><span class="hljs-string">"type"</span></span><span>) != </span><span><span class="hljs-string">"pub"</span></span><span>:
                            </span><span><span class="hljs-keyword">continue</span></span><span>
                        t = obj[</span><span><span class="hljs-string">"topic"</span></span><span>]
                        </span><span><span class="hljs-keyword">if</span></span><span> self._excluded(t):
                            </span><span><span class="hljs-keyword">continue</span></span><span>
                        qos = </span><span><span class="hljs-built_in">int</span></span><span>(obj.get(</span><span><span class="hljs-string">"qos"</span></span><span>, </span><span><span class="hljs-number">0</span></span><span>))
                        retain = </span><span><span class="hljs-built_in">bool</span></span><span>(obj.get(</span><span><span class="hljs-string">"retain"</span></span><span>, </span><span><span class="hljs-literal">False</span></span><span>))
                        pl = base64.b64decode(obj.get(</span><span><span class="hljs-string">"payload_b64"</span></span><span>, </span><span><span class="hljs-string">""</span></span><span>))
                        self.cli.publish(
                            t, pl, qos=qos, retain=retain,
                            properties=mqtt.Properties(mqtt.PacketTypes.PUBLISH)
                        )
                    </span><span><span class="hljs-keyword">except</span></span><span> Exception </span><span><span class="hljs-keyword">as</span></span><span> e:
                        </span><span><span class="hljs-built_in">print</span></span><span>(</span><span><span class="hljs-string">"[bridge] frame error:"</span></span><span>, e)
            </span><span><span class="hljs-keyword">except</span></span><span> Exception </span><span><span class="hljs-keyword">as</span></span><span> e:
                </span><span><span class="hljs-built_in">print</span></span><span>(</span><span><span class="hljs-string">"[bridge] serial read error:"</span></span><span>, e)
                self._reopen_serial()
                time.sleep(</span><span><span class="hljs-number">0.5</span></span><span>)

</span><span><span class="hljs-comment"># ---------------- RFCOMM 管理器（拉起/监听/重连） ----------------</span></span><span>
</span><span><span class="hljs-keyword">class</span></span><span> </span><span><span class="hljs-title class_">RfcommManager</span></span><span>:
    </span><span><span class="hljs-keyword">def</span></span><span> </span><span><span class="hljs-title function_">__init__</span></span><span>(</span><span><span class="hljs-params">self</span></span><span>):
        self.proc: </span><span><span class="hljs-type">Optional</span></span><span>[subprocess.Popen] = </span><span><span class="hljs-literal">None</span></span><span>

    </span><span><span class="hljs-keyword">def</span></span><span> </span><span><span class="hljs-title function_">_run</span></span><span>(</span><span><span class="hljs-params">self, argv</span></span><span>):
        </span><span><span class="hljs-built_in">print</span></span><span>(</span><span><span class="hljs-string">"[rfcomm] exec:"</span></span><span>, </span><span><span class="hljs-string">" "</span></span><span>.join(argv))
        </span><span><span class="hljs-comment"># 前台运行便于监控退出，stdout 合流便于日志</span></span><span>
        </span><span><span class="hljs-keyword">return</span></span><span> subprocess.Popen(argv, stdout=subprocess.PIPE, stderr=subprocess.STDOUT, text=</span><span><span class="hljs-literal">True</span></span><span>)

    </span><span><span class="hljs-keyword">def</span></span><span> </span><span><span class="hljs-title function_">ensure_running</span></span><span>(</span><span><span class="hljs-params">self</span></span><span>):
        </span><span><span class="hljs-keyword">if</span></span><span> self.proc </span><span><span class="hljs-keyword">and</span></span><span> self.proc.poll() </span><span><span class="hljs-keyword">is</span></span><span> </span><span><span class="hljs-literal">None</span></span><span>:
            </span><span><span class="hljs-keyword">return</span></span><span>

        </span><span><span class="hljs-keyword">if</span></span><span> ROLE == </span><span><span class="hljs-string">"server"</span></span><span>:
            </span><span><span class="hljs-keyword">if</span></span><span> ENABLE_SDP:
                </span><span><span class="hljs-comment"># 注册 SPP（多次执行也无妨）</span></span><span>
                subprocess.run([</span><span><span class="hljs-string">"sdptool"</span></span><span>, </span><span><span class="hljs-string">"add"</span></span><span>, </span><span><span class="hljs-string">"--channel"</span></span><span>, </span><span><span class="hljs-built_in">str</span></span><span>(CHANNEL), </span><span><span class="hljs-string">"SP"</span></span><span>], check=</span><span><span class="hljs-literal">False</span></span><span>)
            </span><span><span class="hljs-comment"># 某些发行版需要 "rfcomm listen rfcomm0 1"；此处统一加设备路径</span></span><span>
            self.proc = self._run([</span><span><span class="hljs-string">"rfcomm"</span></span><span>, </span><span><span class="hljs-string">"listen"</span></span><span>, RFCOMM_DEV, </span><span><span class="hljs-built_in">str</span></span><span>(CHANNEL)])
        </span><span><span class="hljs-keyword">else</span></span><span>:
            </span><span><span class="hljs-comment"># 优先尝试支持 -r 的 rfcomm；若不支持，命令很快退出，外层会重启进入不带 -r 的分支</span></span><span>
            try_cmd = [</span><span><span class="hljs-string">"rfcomm"</span></span><span>, </span><span><span class="hljs-string">"connect"</span></span><span>, </span><span><span class="hljs-string">"-r"</span></span><span>, RFCOMM_DEV, REMOTE, </span><span><span class="hljs-built_in">str</span></span><span>(CHANNEL)]
            self.proc = self._run(try_cmd)

        threading.Thread(target=self._pump_log, daemon=</span><span><span class="hljs-literal">True</span></span><span>).start()

    </span><span><span class="hljs-keyword">def</span></span><span> </span><span><span class="hljs-title function_">_pump_log</span></span><span>(</span><span><span class="hljs-params">self</span></span><span>):
        </span><span><span class="hljs-keyword">if</span></span><span> </span><span><span class="hljs-keyword">not</span></span><span> self.proc </span><span><span class="hljs-keyword">or</span></span><span> </span><span><span class="hljs-keyword">not</span></span><span> self.proc.stdout:
            </span><span><span class="hljs-keyword">return</span></span><span>
        </span><span><span class="hljs-keyword">for</span></span><span> line </span><span><span class="hljs-keyword">in</span></span><span> self.proc.stdout:
            </span><span><span class="hljs-built_in">print</span></span><span>(</span><span><span class="hljs-string">"[rfcomm]"</span></span><span>, line.rstrip())

    </span><span><span class="hljs-keyword">def</span></span><span> </span><span><span class="hljs-title function_">wait_device_node</span></span><span>(</span><span><span class="hljs-params">self, timeout=<span class="hljs-number">30</span></span></span><span>):
        t0 = time.time()
        </span><span><span class="hljs-keyword">while</span></span><span> time.time() - t0 &lt; timeout:
            </span><span><span class="hljs-keyword">if</span></span><span> os.path.exists(RFCOMM_DEV):
                time.sleep(</span><span><span class="hljs-number">0.2</span></span><span>)
                </span><span><span class="hljs-keyword">return</span></span><span> </span><span><span class="hljs-literal">True</span></span><span>
            time.sleep(</span><span><span class="hljs-number">0.2</span></span><span>)
        </span><span><span class="hljs-keyword">return</span></span><span> </span><span><span class="hljs-literal">False</span></span><span>

    </span><span><span class="hljs-keyword">def</span></span><span> </span><span><span class="hljs-title function_">reopen_if_stopped</span></span><span>(</span><span><span class="hljs-params">self</span></span><span>):
        </span><span><span class="hljs-keyword">if</span></span><span> self.proc </span><span><span class="hljs-keyword">and</span></span><span> self.proc.poll() </span><span><span class="hljs-keyword">is</span></span><span> </span><span><span class="hljs-keyword">not</span></span><span> </span><span><span class="hljs-literal">None</span></span><span>:
            code = self.proc.returncode
            </span><span><span class="hljs-built_in">print</span></span><span>(</span><span><span class="hljs-string">f"[rfcomm] exited with <span class="hljs-subst">{code}</span></span></span><span>")
            </span><span><span class="hljs-comment"># 若 -r 不被支持，可能立即退出；改用不带 -r 的方式</span></span><span>
            </span><span><span class="hljs-keyword">if</span></span><span> ROLE == </span><span><span class="hljs-string">"client"</span></span><span>:
                self.proc = </span><span><span class="hljs-literal">None</span></span><span>
                self.proc = self._run([</span><span><span class="hljs-string">"rfcomm"</span></span><span>, </span><span><span class="hljs-string">"connect"</span></span><span>, RFCOMM_DEV, REMOTE, </span><span><span class="hljs-built_in">str</span></span><span>(CHANNEL)])
                threading.Thread(target=self._pump_log, daemon=</span><span><span class="hljs-literal">True</span></span><span>).start()
                </span><span><span class="hljs-keyword">return</span></span><span>
            self.proc = </span><span><span class="hljs-literal">None</span></span><span>
        self.ensure_running()

</span><span><span class="hljs-comment"># ---------------- 串口打开器 ----------------</span></span><span>
</span><span><span class="hljs-keyword">def</span></span><span> </span><span><span class="hljs-title function_">open_serial_once</span></span><span>():
    </span><span><span class="hljs-keyword">return</span></span><span> serial.Serial(RFCOMM_DEV, SERIAL_BAUD, timeout=</span><span><span class="hljs-number">0.05</span></span><span>)

</span><span><span class="hljs-comment"># ---------------- 主流程 ----------------</span></span><span>
</span><span><span class="hljs-keyword">def</span></span><span> </span><span><span class="hljs-title function_">main</span></span><span>():
    </span><span><span class="hljs-built_in">print</span></span><span>(</span><span><span class="hljs-string">f"[main] ROLE=<span class="hljs-subst">{ROLE}</span></span></span><span> dev=</span><span><span class="hljs-subst">{RFCOMM_DEV}</span></span><span> ch=</span><span><span class="hljs-subst">{CHANNEL}</span></span><span> remote=</span><span><span class="hljs-subst">{REMOTE}</span></span><span> mqtt=</span><span><span class="hljs-subst">{MQTT_HOST}</span></span><span>:</span><span><span class="hljs-subst">{MQTT_PORT}</span></span><span>")
    </span><span><span class="hljs-keyword">if</span></span><span> ROLE </span><span><span class="hljs-keyword">not</span></span><span> </span><span><span class="hljs-keyword">in</span></span><span> (</span><span><span class="hljs-string">"server"</span></span><span>, </span><span><span class="hljs-string">"client"</span></span><span>):
        </span><span><span class="hljs-built_in">print</span></span><span>(</span><span><span class="hljs-string">"[fatal] ROLE 只能为 server 或 client"</span></span><span>)
        sys.exit(</span><span><span class="hljs-number">2</span></span><span>)

    mgr = RfcommManager()
    backoff = </span><span><span class="hljs-number">1</span></span><span>
    </span><span><span class="hljs-keyword">while</span></span><span> </span><span><span class="hljs-literal">True</span></span><span>:
        </span><span><span class="hljs-keyword">try</span></span><span>:
            mgr.ensure_running()
            </span><span><span class="hljs-keyword">if</span></span><span> </span><span><span class="hljs-keyword">not</span></span><span> mgr.wait_device_node(timeout=</span><span><span class="hljs-number">20</span></span><span>):
                </span><span><span class="hljs-keyword">raise</span></span><span> RuntimeError(</span><span><span class="hljs-string">"rfcomm device not present yet"</span></span><span>)
            br = Bridge(open_serial_once)

            </span><span><span class="hljs-comment"># 守护循环：监控 rfcomm 进程与设备节点</span></span><span>
            </span><span><span class="hljs-keyword">while</span></span><span> </span><span><span class="hljs-literal">True</span></span><span>:
                time.sleep(</span><span><span class="hljs-number">2</span></span><span>)
                mgr.reopen_if_stopped()
                </span><span><span class="hljs-keyword">if</span></span><span> </span><span><span class="hljs-keyword">not</span></span><span> os.path.exists(RFCOMM_DEV):
                    </span><span><span class="hljs-built_in">print</span></span><span>(</span><span><span class="hljs-string">"[main] rfcomm node disappeared; forcing serial reopen"</span></span><span>)
                    </span><span><span class="hljs-keyword">try</span></span><span>:
                        br._reopen_serial()
                    </span><span><span class="hljs-keyword">except</span></span><span> Exception </span><span><span class="hljs-keyword">as</span></span><span> e:
                        </span><span><span class="hljs-built_in">print</span></span><span>(</span><span><span class="hljs-string">"[main] reopen error:"</span></span><span>, e)
        </span><span><span class="hljs-keyword">except</span></span><span> KeyboardInterrupt:
            </span><span><span class="hljs-keyword">try</span></span><span>:
                </span><span><span class="hljs-keyword">if</span></span><span> mgr.proc:
                    mgr.proc.send_signal(signal.SIGINT)
            </span><span><span class="hljs-keyword">except</span></span><span>:
                </span><span><span class="hljs-keyword">pass</span></span><span>
            sys.exit(</span><span><span class="hljs-number">0</span></span><span>)
        </span><span><span class="hljs-keyword">except</span></span><span> Exception </span><span><span class="hljs-keyword">as</span></span><span> e:
            </span><span><span class="hljs-built_in">print</span></span><span>(</span><span><span class="hljs-string">"[main] top-level error:"</span></span><span>, e)
            time.sleep(backoff)
            backoff = </span><span><span class="hljs-built_in">min</span></span><span>(backoff * </span><span><span class="hljs-number">2</span></span><span>, </span><span><span class="hljs-number">10</span></span><span>)

</span><span><span class="hljs-keyword">if</span></span><span> __name__ == </span><span><span class="hljs-string">"__main__"</span></span><span>:
    main()
</span></span></code></div></div></pre>
<hr data-start="10298" data-end="10301">
<h2 data-start="10303" data-end="10310">运行方式</h2>
<h3 data-start="10312" data-end="10325">imop（服务端）</h3>
<pre class="overflow-visible!" data-start="10326" data-end="10560"><div class="contain-inline-size rounded-2xl relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl">bash</div><div class="sticky top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="icon-sm"><path d="M12.668 10.667C12.668 9.95614 12.668 9.46258 12.6367 9.0791C12.6137 8.79732 12.5758 8.60761 12.5244 8.46387L12.4688 8.33399C12.3148 8.03193 12.0803 7.77885 11.793 7.60254L11.666 7.53125C11.508 7.45087 11.2963 7.39395 10.9209 7.36328C10.5374 7.33197 10.0439 7.33203 9.33301 7.33203H6.5C5.78896 7.33203 5.29563 7.33195 4.91211 7.36328C4.63016 7.38632 4.44065 7.42413 4.29688 7.47559L4.16699 7.53125C3.86488 7.68518 3.61186 7.9196 3.43555 8.20703L3.36524 8.33399C3.28478 8.49198 3.22795 8.70352 3.19727 9.0791C3.16595 9.46259 3.16504 9.95611 3.16504 10.667V13.5C3.16504 14.211 3.16593 14.7044 3.19727 15.0879C3.22797 15.4636 3.28473 15.675 3.36524 15.833L3.43555 15.959C3.61186 16.2466 3.86474 16.4807 4.16699 16.6348L4.29688 16.6914C4.44063 16.7428 4.63025 16.7797 4.91211 16.8027C5.29563 16.8341 5.78896 16.835 6.5 16.835H9.33301C10.0439 16.835 10.5374 16.8341 10.9209 16.8027C11.2965 16.772 11.508 16.7152 11.666 16.6348L11.793 16.5645C12.0804 16.3881 12.3148 16.1351 12.4688 15.833L12.5244 15.7031C12.5759 15.5594 12.6137 15.3698 12.6367 15.0879C12.6681 14.7044 12.668 14.211 12.668 13.5V10.667ZM13.998 12.665C14.4528 12.6634 14.8011 12.6602 15.0879 12.6367C15.4635 12.606 15.675 12.5492 15.833 12.4688L15.959 12.3975C16.2466 12.2211 16.4808 11.9682 16.6348 11.666L16.6914 11.5361C16.7428 11.3924 16.7797 11.2026 16.8027 10.9209C16.8341 10.5374 16.835 10.0439 16.835 9.33301V6.5C16.835 5.78896 16.8341 5.29563 16.8027 4.91211C16.7797 4.63025 16.7428 4.44063 16.6914 4.29688L16.6348 4.16699C16.4807 3.86474 16.2466 3.61186 15.959 3.43555L15.833 3.36524C15.675 3.28473 15.4636 3.22797 15.0879 3.19727C14.7044 3.16593 14.211 3.16504 13.5 3.16504H10.667C9.9561 3.16504 9.46259 3.16595 9.0791 3.19727C8.79739 3.22028 8.6076 3.2572 8.46387 3.30859L8.33399 3.36524C8.03176 3.51923 7.77886 3.75343 7.60254 4.04102L7.53125 4.16699C7.4508 4.32498 7.39397 4.53655 7.36328 4.91211C7.33985 5.19893 7.33562 5.54719 7.33399 6.00195H9.33301C10.022 6.00195 10.5791 6.00131 11.0293 6.03809C11.4873 6.07551 11.8937 6.15471 12.2705 6.34668L12.4883 6.46875C12.984 6.7728 13.3878 7.20854 13.6533 7.72949L13.7197 7.87207C13.8642 8.20859 13.9292 8.56974 13.9619 8.9707C13.9987 9.42092 13.998 9.97799 13.998 10.667V12.665ZM18.165 9.33301C18.165 10.022 18.1657 10.5791 18.1289 11.0293C18.0961 11.4302 18.0311 11.7914 17.8867 12.1279L17.8203 12.2705C17.5549 12.7914 17.1509 13.2272 16.6553 13.5313L16.4365 13.6533C16.0599 13.8452 15.6541 13.9245 15.1963 13.9619C14.8593 13.9895 14.4624 13.9935 13.9951 13.9951C13.9935 14.4624 13.9895 14.8593 13.9619 15.1963C13.9292 15.597 13.864 15.9576 13.7197 16.2939L13.6533 16.4365C13.3878 16.9576 12.9841 17.3941 12.4883 17.6982L12.2705 17.8203C11.8937 18.0123 11.4873 18.0915 11.0293 18.1289C10.5791 18.1657 10.022 18.165 9.33301 18.165H6.5C5.81091 18.165 5.25395 18.1657 4.80371 18.1289C4.40306 18.0962 4.04235 18.031 3.70606 17.8867L3.56348 17.8203C3.04244 17.5548 2.60585 17.151 2.30176 16.6553L2.17969 16.4365C1.98788 16.0599 1.90851 15.6541 1.87109 15.1963C1.83431 14.746 1.83496 14.1891 1.83496 13.5V10.667C1.83496 9.978 1.83432 9.42091 1.87109 8.9707C1.90851 8.5127 1.98772 8.10625 2.17969 7.72949L2.30176 7.51172C2.60586 7.0159 3.04236 6.6122 3.56348 6.34668L3.70606 6.28027C4.04237 6.136 4.40303 6.07083 4.80371 6.03809C5.14051 6.01057 5.53708 6.00551 6.00391 6.00391C6.00551 5.53708 6.01057 5.14051 6.03809 4.80371C6.0755 4.34588 6.15483 3.94012 6.34668 3.56348L6.46875 3.34473C6.77282 2.84912 7.20856 2.44514 7.72949 2.17969L7.87207 2.11328C8.20855 1.96886 8.56979 1.90385 8.9707 1.87109C9.42091 1.83432 9.978 1.83496 10.667 1.83496H13.5C14.1891 1.83496 14.746 1.83431 15.1963 1.87109C15.6541 1.90851 16.0599 1.98788 16.4365 2.17969L16.6553 2.30176C17.151 2.60585 17.5548 3.04244 17.8203 3.56348L17.8867 3.70606C18.031 4.04235 18.0962 4.40306 18.1289 4.80371C18.1657 5.25395 18.165 5.81091 18.165 6.5V9.33301Z"></path></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-bash"><span><span><span class="hljs-comment"># 安装依赖（仅示例）</span></span><span>
sudo apt-get update
sudo apt-get install -y bluez bluez-tools python3-pip
pip3 install --upgrade pyserial paho-mqtt

</span><span><span class="hljs-comment"># 运行（监听 ch=1，MQTT 1883）</span></span><span>
ROLE=server CHANNEL=1 MQTT_PORT=1883 sudo -E python3 rfcomm_bridge.py
</span></span></code></div></div></pre>
<h3 data-start="10562" data-end="10576">iwalk（客户端）</h3>
<pre class="overflow-visible!" data-start="10577" data-end="10843"><div class="contain-inline-size rounded-2xl relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl">bash</div><div class="sticky top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="icon-sm"><path d="M12.668 10.667C12.668 9.95614 12.668 9.46258 12.6367 9.0791C12.6137 8.79732 12.5758 8.60761 12.5244 8.46387L12.4688 8.33399C12.3148 8.03193 12.0803 7.77885 11.793 7.60254L11.666 7.53125C11.508 7.45087 11.2963 7.39395 10.9209 7.36328C10.5374 7.33197 10.0439 7.33203 9.33301 7.33203H6.5C5.78896 7.33203 5.29563 7.33195 4.91211 7.36328C4.63016 7.38632 4.44065 7.42413 4.29688 7.47559L4.16699 7.53125C3.86488 7.68518 3.61186 7.9196 3.43555 8.20703L3.36524 8.33399C3.28478 8.49198 3.22795 8.70352 3.19727 9.0791C3.16595 9.46259 3.16504 9.95611 3.16504 10.667V13.5C3.16504 14.211 3.16593 14.7044 3.19727 15.0879C3.22797 15.4636 3.28473 15.675 3.36524 15.833L3.43555 15.959C3.61186 16.2466 3.86474 16.4807 4.16699 16.6348L4.29688 16.6914C4.44063 16.7428 4.63025 16.7797 4.91211 16.8027C5.29563 16.8341 5.78896 16.835 6.5 16.835H9.33301C10.0439 16.835 10.5374 16.8341 10.9209 16.8027C11.2965 16.772 11.508 16.7152 11.666 16.6348L11.793 16.5645C12.0804 16.3881 12.3148 16.1351 12.4688 15.833L12.5244 15.7031C12.5759 15.5594 12.6137 15.3698 12.6367 15.0879C12.6681 14.7044 12.668 14.211 12.668 13.5V10.667ZM13.998 12.665C14.4528 12.6634 14.8011 12.6602 15.0879 12.6367C15.4635 12.606 15.675 12.5492 15.833 12.4688L15.959 12.3975C16.2466 12.2211 16.4808 11.9682 16.6348 11.666L16.6914 11.5361C16.7428 11.3924 16.7797 11.2026 16.8027 10.9209C16.8341 10.5374 16.835 10.0439 16.835 9.33301V6.5C16.835 5.78896 16.8341 5.29563 16.8027 4.91211C16.7797 4.63025 16.7428 4.44063 16.6914 4.29688L16.6348 4.16699C16.4807 3.86474 16.2466 3.61186 15.959 3.43555L15.833 3.36524C15.675 3.28473 15.4636 3.22797 15.0879 3.19727C14.7044 3.16593 14.211 3.16504 13.5 3.16504H10.667C9.9561 3.16504 9.46259 3.16595 9.0791 3.19727C8.79739 3.22028 8.6076 3.2572 8.46387 3.30859L8.33399 3.36524C8.03176 3.51923 7.77886 3.75343 7.60254 4.04102L7.53125 4.16699C7.4508 4.32498 7.39397 4.53655 7.36328 4.91211C7.33985 5.19893 7.33562 5.54719 7.33399 6.00195H9.33301C10.022 6.00195 10.5791 6.00131 11.0293 6.03809C11.4873 6.07551 11.8937 6.15471 12.2705 6.34668L12.4883 6.46875C12.984 6.7728 13.3878 7.20854 13.6533 7.72949L13.7197 7.87207C13.8642 8.20859 13.9292 8.56974 13.9619 8.9707C13.9987 9.42092 13.998 9.97799 13.998 10.667V12.665ZM18.165 9.33301C18.165 10.022 18.1657 10.5791 18.1289 11.0293C18.0961 11.4302 18.0311 11.7914 17.8867 12.1279L17.8203 12.2705C17.5549 12.7914 17.1509 13.2272 16.6553 13.5313L16.4365 13.6533C16.0599 13.8452 15.6541 13.9245 15.1963 13.9619C14.8593 13.9895 14.4624 13.9935 13.9951 13.9951C13.9935 14.4624 13.9895 14.8593 13.9619 15.1963C13.9292 15.597 13.864 15.9576 13.7197 16.2939L13.6533 16.4365C13.3878 16.9576 12.9841 17.3941 12.4883 17.6982L12.2705 17.8203C11.8937 18.0123 11.4873 18.0915 11.0293 18.1289C10.5791 18.1657 10.022 18.165 9.33301 18.165H6.5C5.81091 18.165 5.25395 18.1657 4.80371 18.1289C4.40306 18.0962 4.04235 18.031 3.70606 17.8867L3.56348 17.8203C3.04244 17.5548 2.60585 17.151 2.30176 16.6553L2.17969 16.4365C1.98788 16.0599 1.90851 15.6541 1.87109 15.1963C1.83431 14.746 1.83496 14.1891 1.83496 13.5V10.667C1.83496 9.978 1.83432 9.42091 1.87109 8.9707C1.90851 8.5127 1.98772 8.10625 2.17969 7.72949L2.30176 7.51172C2.60586 7.0159 3.04236 6.6122 3.56348 6.34668L3.70606 6.28027C4.04237 6.136 4.40303 6.07083 4.80371 6.03809C5.14051 6.01057 5.53708 6.00551 6.00391 6.00391C6.00551 5.53708 6.01057 5.14051 6.03809 4.80371C6.0755 4.34588 6.15483 3.94012 6.34668 3.56348L6.46875 3.34473C6.77282 2.84912 7.20856 2.44514 7.72949 2.17969L7.87207 2.11328C8.20855 1.96886 8.56979 1.90385 8.9707 1.87109C9.42091 1.83432 9.978 1.83496 10.667 1.83496H13.5C14.1891 1.83496 14.746 1.83431 15.1963 1.87109C15.6541 1.90851 16.0599 1.98788 16.4365 2.17969L16.6553 2.30176C17.151 2.60585 17.5548 3.04244 17.8203 3.56348L17.8867 3.70606C18.031 4.04235 18.0962 4.40306 18.1289 4.80371C18.1657 5.25395 18.165 5.81091 18.165 6.5V9.33301Z"></path></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-bash"><span><span><span class="hljs-comment"># 安装依赖（同上）</span></span><span>
sudo apt-get update
sudo apt-get install -y bluez bluez-tools python3-pip
pip3 install --upgrade pyserial paho-mqtt

</span><span><span class="hljs-comment"># 运行（主动连到 imop 的 MAC，MQTT 1884）</span></span><span>
ROLE=client REMOTE=DC:4A:9E:31:D4:7D CHANNEL=1 MQTT_PORT=1884 sudo -E python3 rfcomm_bridge.py
</span></span></code></div></div></pre>
<blockquote data-start="10845" data-end="11022">
<p data-start="10847" data-end="10850">提示：</p>
<ul data-start="10853" data-end="11022">
<li data-start="10853" data-end="10914">
<p data-start="10855" data-end="10914">需要两端已经 <strong data-start="10862" data-end="10876">完成配对 &amp; 可信任</strong>（<code data-start="10877" data-end="10891">bluetoothctl</code> 里 <code data-start="10894" data-end="10900">pair</code> / <code data-start="10903" data-end="10910">trust</code>）。</p>
</li>
<li data-start="10917" data-end="10970">
<p data-start="10919" data-end="10970"><code data-start="10919" data-end="10928">sudo -E</code> 让环境变量传进程序；蓝牙 RFCOMM 与 SDP 通常需要 root 权限。</p>
</li>
<li data-start="10973" data-end="11022">
<p data-start="10975" data-end="11022">如果你发行版的 <code data-start="10983" data-end="10991">rfcomm</code> 不支持 <code data-start="10996" data-end="11000">-r</code>，脚本会自动回落为“循环重启”方式保持重连。</p>
</li>
</ul>
</blockquote>
<hr data-start="11024" data-end="11027">
<h2 data-start="11029" data-end="11049">可选：systemd 服务（推荐）</h2>
<h3 data-start="11051" data-end="11118">1) 服务端（imop）：<code data-start="11068" data-end="11118">/etc/systemd/system/rfcomm-bridge-server.service</code></h3>
<pre class="overflow-visible!" data-start="11119" data-end="11523"><div class="contain-inline-size rounded-2xl relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl">ini</div><div class="sticky top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="icon-sm"><path d="M12.668 10.667C12.668 9.95614 12.668 9.46258 12.6367 9.0791C12.6137 8.79732 12.5758 8.60761 12.5244 8.46387L12.4688 8.33399C12.3148 8.03193 12.0803 7.77885 11.793 7.60254L11.666 7.53125C11.508 7.45087 11.2963 7.39395 10.9209 7.36328C10.5374 7.33197 10.0439 7.33203 9.33301 7.33203H6.5C5.78896 7.33203 5.29563 7.33195 4.91211 7.36328C4.63016 7.38632 4.44065 7.42413 4.29688 7.47559L4.16699 7.53125C3.86488 7.68518 3.61186 7.9196 3.43555 8.20703L3.36524 8.33399C3.28478 8.49198 3.22795 8.70352 3.19727 9.0791C3.16595 9.46259 3.16504 9.95611 3.16504 10.667V13.5C3.16504 14.211 3.16593 14.7044 3.19727 15.0879C3.22797 15.4636 3.28473 15.675 3.36524 15.833L3.43555 15.959C3.61186 16.2466 3.86474 16.4807 4.16699 16.6348L4.29688 16.6914C4.44063 16.7428 4.63025 16.7797 4.91211 16.8027C5.29563 16.8341 5.78896 16.835 6.5 16.835H9.33301C10.0439 16.835 10.5374 16.8341 10.9209 16.8027C11.2965 16.772 11.508 16.7152 11.666 16.6348L11.793 16.5645C12.0804 16.3881 12.3148 16.1351 12.4688 15.833L12.5244 15.7031C12.5759 15.5594 12.6137 15.3698 12.6367 15.0879C12.6681 14.7044 12.668 14.211 12.668 13.5V10.667ZM13.998 12.665C14.4528 12.6634 14.8011 12.6602 15.0879 12.6367C15.4635 12.606 15.675 12.5492 15.833 12.4688L15.959 12.3975C16.2466 12.2211 16.4808 11.9682 16.6348 11.666L16.6914 11.5361C16.7428 11.3924 16.7797 11.2026 16.8027 10.9209C16.8341 10.5374 16.835 10.0439 16.835 9.33301V6.5C16.835 5.78896 16.8341 5.29563 16.8027 4.91211C16.7797 4.63025 16.7428 4.44063 16.6914 4.29688L16.6348 4.16699C16.4807 3.86474 16.2466 3.61186 15.959 3.43555L15.833 3.36524C15.675 3.28473 15.4636 3.22797 15.0879 3.19727C14.7044 3.16593 14.211 3.16504 13.5 3.16504H10.667C9.9561 3.16504 9.46259 3.16595 9.0791 3.19727C8.79739 3.22028 8.6076 3.2572 8.46387 3.30859L8.33399 3.36524C8.03176 3.51923 7.77886 3.75343 7.60254 4.04102L7.53125 4.16699C7.4508 4.32498 7.39397 4.53655 7.36328 4.91211C7.33985 5.19893 7.33562 5.54719 7.33399 6.00195H9.33301C10.022 6.00195 10.5791 6.00131 11.0293 6.03809C11.4873 6.07551 11.8937 6.15471 12.2705 6.34668L12.4883 6.46875C12.984 6.7728 13.3878 7.20854 13.6533 7.72949L13.7197 7.87207C13.8642 8.20859 13.9292 8.56974 13.9619 8.9707C13.9987 9.42092 13.998 9.97799 13.998 10.667V12.665ZM18.165 9.33301C18.165 10.022 18.1657 10.5791 18.1289 11.0293C18.0961 11.4302 18.0311 11.7914 17.8867 12.1279L17.8203 12.2705C17.5549 12.7914 17.1509 13.2272 16.6553 13.5313L16.4365 13.6533C16.0599 13.8452 15.6541 13.9245 15.1963 13.9619C14.8593 13.9895 14.4624 13.9935 13.9951 13.9951C13.9935 14.4624 13.9895 14.8593 13.9619 15.1963C13.9292 15.597 13.864 15.9576 13.7197 16.2939L13.6533 16.4365C13.3878 16.9576 12.9841 17.3941 12.4883 17.6982L12.2705 17.8203C11.8937 18.0123 11.4873 18.0915 11.0293 18.1289C10.5791 18.1657 10.022 18.165 9.33301 18.165H6.5C5.81091 18.165 5.25395 18.1657 4.80371 18.1289C4.40306 18.0962 4.04235 18.031 3.70606 17.8867L3.56348 17.8203C3.04244 17.5548 2.60585 17.151 2.30176 16.6553L2.17969 16.4365C1.98788 16.0599 1.90851 15.6541 1.87109 15.1963C1.83431 14.746 1.83496 14.1891 1.83496 13.5V10.667C1.83496 9.978 1.83432 9.42091 1.87109 8.9707C1.90851 8.5127 1.98772 8.10625 2.17969 7.72949L2.30176 7.51172C2.60586 7.0159 3.04236 6.6122 3.56348 6.34668L3.70606 6.28027C4.04237 6.136 4.40303 6.07083 4.80371 6.03809C5.14051 6.01057 5.53708 6.00551 6.00391 6.00391C6.00551 5.53708 6.01057 5.14051 6.03809 4.80371C6.0755 4.34588 6.15483 3.94012 6.34668 3.56348L6.46875 3.34473C6.77282 2.84912 7.20856 2.44514 7.72949 2.17969L7.87207 2.11328C8.20855 1.96886 8.56979 1.90385 8.9707 1.87109C9.42091 1.83432 9.978 1.83496 10.667 1.83496H13.5C14.1891 1.83496 14.746 1.83431 15.1963 1.87109C15.6541 1.90851 16.0599 1.98788 16.4365 2.17969L16.6553 2.30176C17.151 2.60585 17.5548 3.04244 17.8203 3.56348L17.8867 3.70606C18.031 4.04235 18.0962 4.40306 18.1289 4.80371C18.1657 5.25395 18.165 5.81091 18.165 6.5V9.33301Z"></path></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre!"><span><span><span class="hljs-section">[Unit]</span></span><span>
</span><span><span class="hljs-attr">Description</span></span><span>=RFCOMM Bridge (Server)
</span><span><span class="hljs-attr">After</span></span><span>=bluetooth.service
</span><span><span class="hljs-attr">Requires</span></span><span>=bluetooth.service

</span><span><span class="hljs-section">[Service]</span></span><span>
</span><span><span class="hljs-attr">Type</span></span><span>=simple
</span><span><span class="hljs-attr">Environment</span></span><span>=ROLE=server
</span><span><span class="hljs-attr">Environment</span></span><span>=CHANNEL=</span><span><span class="hljs-number">1</span></span><span>
</span><span><span class="hljs-attr">Environment</span></span><span>=MQTT_HOST=</span><span><span class="hljs-number">127.0</span></span><span>.</span><span><span class="hljs-number">0.1</span></span><span>
</span><span><span class="hljs-attr">Environment</span></span><span>=MQTT_PORT=</span><span><span class="hljs-number">1883</span></span><span>
</span><span><span class="hljs-attr">Environment</span></span><span>=RFCOMM_DEV=/dev/rfcomm0
</span><span><span class="hljs-attr">Environment</span></span><span>=ENABLE_SDP=</span><span><span class="hljs-number">1</span></span><span>
</span><span><span class="hljs-attr">ExecStart</span></span><span>=/usr/bin/python3 /opt/rfcomm_bridge.py
</span><span><span class="hljs-attr">Restart</span></span><span>=always
</span><span><span class="hljs-attr">RestartSec</span></span><span>=</span><span><span class="hljs-number">2</span></span><span>

</span><span><span class="hljs-section">[Install]</span></span><span>
</span><span><span class="hljs-attr">WantedBy</span></span><span>=multi-user.target
</span></span></code></div></div></pre>
<h3 data-start="11525" data-end="11593">2) 客户端（iwalk）：<code data-start="11543" data-end="11593">/etc/systemd/system/rfcomm-bridge-client.service</code></h3>
<pre class="overflow-visible!" data-start="11594" data-end="12010"><div class="contain-inline-size rounded-2xl relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl">ini</div><div class="sticky top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="icon-sm"><path d="M12.668 10.667C12.668 9.95614 12.668 9.46258 12.6367 9.0791C12.6137 8.79732 12.5758 8.60761 12.5244 8.46387L12.4688 8.33399C12.3148 8.03193 12.0803 7.77885 11.793 7.60254L11.666 7.53125C11.508 7.45087 11.2963 7.39395 10.9209 7.36328C10.5374 7.33197 10.0439 7.33203 9.33301 7.33203H6.5C5.78896 7.33203 5.29563 7.33195 4.91211 7.36328C4.63016 7.38632 4.44065 7.42413 4.29688 7.47559L4.16699 7.53125C3.86488 7.68518 3.61186 7.9196 3.43555 8.20703L3.36524 8.33399C3.28478 8.49198 3.22795 8.70352 3.19727 9.0791C3.16595 9.46259 3.16504 9.95611 3.16504 10.667V13.5C3.16504 14.211 3.16593 14.7044 3.19727 15.0879C3.22797 15.4636 3.28473 15.675 3.36524 15.833L3.43555 15.959C3.61186 16.2466 3.86474 16.4807 4.16699 16.6348L4.29688 16.6914C4.44063 16.7428 4.63025 16.7797 4.91211 16.8027C5.29563 16.8341 5.78896 16.835 6.5 16.835H9.33301C10.0439 16.835 10.5374 16.8341 10.9209 16.8027C11.2965 16.772 11.508 16.7152 11.666 16.6348L11.793 16.5645C12.0804 16.3881 12.3148 16.1351 12.4688 15.833L12.5244 15.7031C12.5759 15.5594 12.6137 15.3698 12.6367 15.0879C12.6681 14.7044 12.668 14.211 12.668 13.5V10.667ZM13.998 12.665C14.4528 12.6634 14.8011 12.6602 15.0879 12.6367C15.4635 12.606 15.675 12.5492 15.833 12.4688L15.959 12.3975C16.2466 12.2211 16.4808 11.9682 16.6348 11.666L16.6914 11.5361C16.7428 11.3924 16.7797 11.2026 16.8027 10.9209C16.8341 10.5374 16.835 10.0439 16.835 9.33301V6.5C16.835 5.78896 16.8341 5.29563 16.8027 4.91211C16.7797 4.63025 16.7428 4.44063 16.6914 4.29688L16.6348 4.16699C16.4807 3.86474 16.2466 3.61186 15.959 3.43555L15.833 3.36524C15.675 3.28473 15.4636 3.22797 15.0879 3.19727C14.7044 3.16593 14.211 3.16504 13.5 3.16504H10.667C9.9561 3.16504 9.46259 3.16595 9.0791 3.19727C8.79739 3.22028 8.6076 3.2572 8.46387 3.30859L8.33399 3.36524C8.03176 3.51923 7.77886 3.75343 7.60254 4.04102L7.53125 4.16699C7.4508 4.32498 7.39397 4.53655 7.36328 4.91211C7.33985 5.19893 7.33562 5.54719 7.33399 6.00195H9.33301C10.022 6.00195 10.5791 6.00131 11.0293 6.03809C11.4873 6.07551 11.8937 6.15471 12.2705 6.34668L12.4883 6.46875C12.984 6.7728 13.3878 7.20854 13.6533 7.72949L13.7197 7.87207C13.8642 8.20859 13.9292 8.56974 13.9619 8.9707C13.9987 9.42092 13.998 9.97799 13.998 10.667V12.665ZM18.165 9.33301C18.165 10.022 18.1657 10.5791 18.1289 11.0293C18.0961 11.4302 18.0311 11.7914 17.8867 12.1279L17.8203 12.2705C17.5549 12.7914 17.1509 13.2272 16.6553 13.5313L16.4365 13.6533C16.0599 13.8452 15.6541 13.9245 15.1963 13.9619C14.8593 13.9895 14.4624 13.9935 13.9951 13.9951C13.9935 14.4624 13.9895 14.8593 13.9619 15.1963C13.9292 15.597 13.864 15.9576 13.7197 16.2939L13.6533 16.4365C13.3878 16.9576 12.9841 17.3941 12.4883 17.6982L12.2705 17.8203C11.8937 18.0123 11.4873 18.0915 11.0293 18.1289C10.5791 18.1657 10.022 18.165 9.33301 18.165H6.5C5.81091 18.165 5.25395 18.1657 4.80371 18.1289C4.40306 18.0962 4.04235 18.031 3.70606 17.8867L3.56348 17.8203C3.04244 17.5548 2.60585 17.151 2.30176 16.6553L2.17969 16.4365C1.98788 16.0599 1.90851 15.6541 1.87109 15.1963C1.83431 14.746 1.83496 14.1891 1.83496 13.5V10.667C1.83496 9.978 1.83432 9.42091 1.87109 8.9707C1.90851 8.5127 1.98772 8.10625 2.17969 7.72949L2.30176 7.51172C2.60586 7.0159 3.04236 6.6122 3.56348 6.34668L3.70606 6.28027C4.04237 6.136 4.40303 6.07083 4.80371 6.03809C5.14051 6.01057 5.53708 6.00551 6.00391 6.00391C6.00551 5.53708 6.01057 5.14051 6.03809 4.80371C6.0755 4.34588 6.15483 3.94012 6.34668 3.56348L6.46875 3.34473C6.77282 2.84912 7.20856 2.44514 7.72949 2.17969L7.87207 2.11328C8.20855 1.96886 8.56979 1.90385 8.9707 1.87109C9.42091 1.83432 9.978 1.83496 10.667 1.83496H13.5C14.1891 1.83496 14.746 1.83431 15.1963 1.87109C15.6541 1.90851 16.0599 1.98788 16.4365 2.17969L16.6553 2.30176C17.151 2.60585 17.5548 3.04244 17.8203 3.56348L17.8867 3.70606C18.031 4.04235 18.0962 4.40306 18.1289 4.80371C18.1657 5.25395 18.165 5.81091 18.165 6.5V9.33301Z"></path></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre!"><span><span><span class="hljs-section">[Unit]</span></span><span>
</span><span><span class="hljs-attr">Description</span></span><span>=RFCOMM Bridge (Client)
</span><span><span class="hljs-attr">After</span></span><span>=bluetooth.service
</span><span><span class="hljs-attr">Requires</span></span><span>=bluetooth.service

</span><span><span class="hljs-section">[Service]</span></span><span>
</span><span><span class="hljs-attr">Type</span></span><span>=simple
</span><span><span class="hljs-attr">Environment</span></span><span>=ROLE=client
</span><span><span class="hljs-attr">Environment</span></span><span>=REMOTE=DC:</span><span><span class="hljs-number">4</span></span><span>A:</span><span><span class="hljs-number">9</span></span><span>E:</span><span><span class="hljs-number">31</span></span><span>:D4:</span><span><span class="hljs-number">7</span></span><span>D
</span><span><span class="hljs-attr">Environment</span></span><span>=CHANNEL=</span><span><span class="hljs-number">1</span></span><span>
</span><span><span class="hljs-attr">Environment</span></span><span>=MQTT_HOST=</span><span><span class="hljs-number">127.0</span></span><span>.</span><span><span class="hljs-number">0.1</span></span><span>
</span><span><span class="hljs-attr">Environment</span></span><span>=MQTT_PORT=</span><span><span class="hljs-number">1884</span></span><span>
</span><span><span class="hljs-attr">Environment</span></span><span>=RFCOMM_DEV=/dev/rfcomm0
</span><span><span class="hljs-attr">ExecStart</span></span><span>=/usr/bin/python3 /opt/rfcomm_bridge.py
</span><span><span class="hljs-attr">Restart</span></span><span>=always
</span><span><span class="hljs-attr">RestartSec</span></span><span>=</span><span><span class="hljs-number">2</span></span><span>

</span><span><span class="hljs-section">[Install]</span></span><span>
</span><span><span class="hljs-attr">WantedBy</span></span><span>=multi-user.target
</span></span></code></div></div></pre>
<p data-start="12012" data-end="12018">部署与启用：</p>
<pre class="overflow-visible!" data-start="12019" data-end="13275"><div class="contain-inline-size rounded-2xl relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl">bash</div><div class="sticky top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="icon-sm"><path d="M12.668 10.667C12.668 9.95614 12.668 9.46258 12.6367 9.0791C12.6137 8.79732 12.5758 8.60761 12.5244 8.46387L12.4688 8.33399C12.3148 8.03193 12.0803 7.77885 11.793 7.60254L11.666 7.53125C11.508 7.45087 11.2963 7.39395 10.9209 7.36328C10.5374 7.33197 10.0439 7.33203 9.33301 7.33203H6.5C5.78896 7.33203 5.29563 7.33195 4.91211 7.36328C4.63016 7.38632 4.44065 7.42413 4.29688 7.47559L4.16699 7.53125C3.86488 7.68518 3.61186 7.9196 3.43555 8.20703L3.36524 8.33399C3.28478 8.49198 3.22795 8.70352 3.19727 9.0791C3.16595 9.46259 3.16504 9.95611 3.16504 10.667V13.5C3.16504 14.211 3.16593 14.7044 3.19727 15.0879C3.22797 15.4636 3.28473 15.675 3.36524 15.833L3.43555 15.959C3.61186 16.2466 3.86474 16.4807 4.16699 16.6348L4.29688 16.6914C4.44063 16.7428 4.63025 16.7797 4.91211 16.8027C5.29563 16.8341 5.78896 16.835 6.5 16.835H9.33301C10.0439 16.835 10.5374 16.8341 10.9209 16.8027C11.2965 16.772 11.508 16.7152 11.666 16.6348L11.793 16.5645C12.0804 16.3881 12.3148 16.1351 12.4688 15.833L12.5244 15.7031C12.5759 15.5594 12.6137 15.3698 12.6367 15.0879C12.6681 14.7044 12.668 14.211 12.668 13.5V10.667ZM13.998 12.665C14.4528 12.6634 14.8011 12.6602 15.0879 12.6367C15.4635 12.606 15.675 12.5492 15.833 12.4688L15.959 12.3975C16.2466 12.2211 16.4808 11.9682 16.6348 11.666L16.6914 11.5361C16.7428 11.3924 16.7797 11.2026 16.8027 10.9209C16.8341 10.5374 16.835 10.0439 16.835 9.33301V6.5C16.835 5.78896 16.8341 5.29563 16.8027 4.91211C16.7797 4.63025 16.7428 4.44063 16.6914 4.29688L16.6348 4.16699C16.4807 3.86474 16.2466 3.61186 15.959 3.43555L15.833 3.36524C15.675 3.28473 15.4636 3.22797 15.0879 3.19727C14.7044 3.16593 14.211 3.16504 13.5 3.16504H10.667C9.9561 3.16504 9.46259 3.16595 9.0791 3.19727C8.79739 3.22028 8.6076 3.2572 8.46387 3.30859L8.33399 3.36524C8.03176 3.51923 7.77886 3.75343 7.60254 4.04102L7.53125 4.16699C7.4508 4.32498 7.39397 4.53655 7.36328 4.91211C7.33985 5.19893 7.33562 5.54719 7.33399 6.00195H9.33301C10.022 6.00195 10.5791 6.00131 11.0293 6.03809C11.4873 6.07551 11.8937 6.15471 12.2705 6.34668L12.4883 6.46875C12.984 6.7728 13.3878 7.20854 13.6533 7.72949L13.7197 7.87207C13.8642 8.20859 13.9292 8.56974 13.9619 8.9707C13.9987 9.42092 13.998 9.97799 13.998 10.667V12.665ZM18.165 9.33301C18.165 10.022 18.1657 10.5791 18.1289 11.0293C18.0961 11.4302 18.0311 11.7914 17.8867 12.1279L17.8203 12.2705C17.5549 12.7914 17.1509 13.2272 16.6553 13.5313L16.4365 13.6533C16.0599 13.8452 15.6541 13.9245 15.1963 13.9619C14.8593 13.9895 14.4624 13.9935 13.9951 13.9951C13.9935 14.4624 13.9895 14.8593 13.9619 15.1963C13.9292 15.597 13.864 15.9576 13.7197 16.2939L13.6533 16.4365C13.3878 16.9576 12.9841 17.3941 12.4883 17.6982L12.2705 17.8203C11.8937 18.0123 11.4873 18.0915 11.0293 18.1289C10.5791 18.1657 10.022 18.165 9.33301 18.165H6.5C5.81091 18.165 5.25395 18.1657 4.80371 18.1289C4.40306 18.0962 4.04235 18.031 3.70606 17.8867L3.56348 17.8203C3.04244 17.5548 2.60585 17.151 2.30176 16.6553L2.17969 16.4365C1.98788 16.0599 1.90851 15.6541 1.87109 15.1963C1.83431 14.746 1.83496 14.1891 1.83496 13.5V10.667C1.83496 9.978 1.83432 9.42091 1.87109 8.9707C1.90851 8.5127 1.98772 8.10625 2.17969 7.72949L2.30176 7.51172C2.60586 7.0159 3.04236 6.6122 3.56348 6.34668L3.70606 6.28027C4.04237 6.136 4.40303 6.07083 4.80371 6.03809C5.14051 6.01057 5.53708 6.00551 6.00391 6.00391C6.00551 5.53708 6.01057 5.14051 6.03809 4.80371C6.0755 4.34588 6.15483 3.94012 6.34668 3.56348L6.46875 3.34473C6.77282 2.84912 7.20856 2.44514 7.72949 2.17969L7.87207 2.11328C8.20855 1.96886 8.56979 1.90385 8.9707 1.87109C9.42091 1.83432 9.978 1.83496 10.667 1.83496H13.5C14.1891 1.83496 14.746 1.83431 15.1963 1.87109C15.6541 1.90851 16.0599 1.98788 16.4365 2.17969L16.6553 2.30176C17.151 2.60585 17.5548 3.04244 17.8203 3.56348L17.8867 3.70606C18.031 4.04235 18.0962 4.40306 18.1289 4.80371C18.1657 5.25395 18.165 5.81091 18.165 6.5V9.33301Z"></path></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-bash"><span><span><span class="hljs-comment"># 把 rfcomm_bridge.py 放到 /opt/</span></span><span>
sudo install -Dm755 rfcomm_bridge.py /opt/rfcomm_bridge.py

</span><span><span class="hljs-comment"># 放入服务文件</span></span><span>
sudo </span><span><span class="hljs-built_in">tee</span></span><span> /etc/systemd/system/rfcomm-bridge-server.service &gt;/dev/null &lt;&lt;</span><span><span class="hljs-string">'EOF'</span></span><span>
[Unit]
Description=RFCOMM Bridge (Server)
After=bluetooth.service
Requires=bluetooth.service
[Service]
Type=simple
Environment=ROLE=server
Environment=CHANNEL=1
Environment=MQTT_HOST=127.0.0.1
Environment=MQTT_PORT=1883
Environment=RFCOMM_DEV=/dev/rfcomm0
Environment=ENABLE_SDP=1
ExecStart=/usr/bin/python3 /opt/rfcomm_bridge.py
Restart=always
RestartSec=2
[Install]
WantedBy=multi-user.target
EOF

sudo </span><span><span class="hljs-built_in">tee</span></span><span> /etc/systemd/system/rfcomm-bridge-client.service &gt;/dev/null &lt;&lt;</span><span><span class="hljs-string">'EOF'</span></span><span>
[Unit]
Description=RFCOMM Bridge (Client)
After=bluetooth.service
Requires=bluetooth.service
[Service]
Type=simple
Environment=ROLE=client
Environment=REMOTE=DC:4A:9E:31:D4:7D
Environment=CHANNEL=1
Environment=MQTT_HOST=127.0.0.1
Environment=MQTT_PORT=1884
Environment=RFCOMM_DEV=/dev/rfcomm0
ExecStart=/usr/bin/python3 /opt/rfcomm_bridge.py
Restart=always
RestartSec=2
[Install]
WantedBy=multi-user.target
EOF

</span><span><span class="hljs-comment"># 启动（在各自设备上执行对应那一个）</span></span><span>
sudo systemctl daemon-reload
</span><span><span class="hljs-comment"># imop:</span></span><span>
sudo systemctl </span><span><span class="hljs-built_in">enable</span></span><span> --now rfcomm-bridge-server.service
</span><span><span class="hljs-comment"># iwalk:</span></span><span>
sudo systemctl </span><span><span class="hljs-built_in">enable</span></span><span> --now rfcomm-bridge-client.service
</span></span></code></div></div></pre>
<hr data-start="13277" data-end="13280">
<h3 data-start="13282" data-end="13294">小贴士（稳定性）</h3>
<ul data-start="13295" data-end="13576">
<li data-start="13295" data-end="13396">
<p data-start="13297" data-end="13396"><strong data-start="13297" data-end="13306">空闲期心跳</strong>：若业务长时间无 MQTT 流量，可考虑定时发布一个很小的本地主题（例如每 10s 发布 <code data-start="13351" data-end="13366">/bt/keepalive</code> 空载荷），两端会通过桥传一次，能有效避免监督超时掉线。</p>
</li>
<li data-start="13397" data-end="13506">
<p data-start="13399" data-end="13506"><strong data-start="13399" data-end="13405">诊断</strong>：掉线难题可用 <code data-start="13413" data-end="13425">sudo btmon</code> + <code data-start="13428" data-end="13456">journalctl -u bluetooth -f</code> 抓一次，关注 Disconn Reason（<code data-start="13479" data-end="13485">0x13</code> 对端主动、<code data-start="13491" data-end="13497">0x08</code> 监督超时）。</p>
</li>
<li data-start="13507" data-end="13576">
<p data-start="13509" data-end="13576"><strong data-start="13509" data-end="13515">权限</strong>：某些设备需把运行用户加入 <code data-start="13529" data-end="13540">bluetooth</code> 组或直接以 root 运行（上面的 service 就是 root）。</p>
</li>
</ul>
<p data-start="13578" data-end="13623" data-is-last-node="" data-is-only-node="">需要我把<strong data-start="13582" data-end="13588">心跳</strong>也内置到脚本里（可选开关）吗？我可以直接补上一个极轻量的定时发布逻辑。</p></div>
</body>
</html>