<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>首先，对这段代码进行总结，告诉我这段代码在干什么。然后，详细介绍它的技术栈。最后详细解释每一句代码：...</title>
  <meta name="created-at" content="1766943571512">
  <meta name="updated-at" content="1766943571512">
  <meta name="source-type" content="chatgpt">
  <meta name="source-url" content="https://chatgpt.com/c/69454c3a-1188-8322-aa3b-10b4d508b14d">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
      color: #333;
    }
    h1 {
      color: #333;
      border-bottom: 2px solid #10a37f;
      padding-bottom: 10px;
    }
    .message-block {
      margin: 20px 0;
      padding: 16px;
      border-radius: 12px;
    }
    .role-user {
      background: #e8f4fd;
      border-left: 4px solid #3b82f6;
    }
    .role-ai {
      background: #f0fdf4;
      border-left: 4px solid #10b981;
    }
    .message-role {
      font-weight: 700;
      margin-bottom: 8px;
    }
    .role-user .message-role { color: #2563eb; }
    .role-ai .message-role { color: #059669; }
    .message-content {
      line-height: 1.6;
    }
    pre {
      background: #1a1a1a;
      color: #e5e5e5;
      padding: 16px;
      border-radius: 8px;
      overflow-x: auto;
    }
    code {
      font-family: 'Consolas', 'Monaco', monospace;
    }
    img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <h1>首先，对这段代码进行总结，告诉我这段代码在干什么。然后，详细介绍它的技术栈。最后详细解释每一句代码：...</h1>
  <div class="message-block role-user">
          <div class="message-role">You</div>
          <div class="message-content">首先，对这段代码进行总结，告诉我这段代码在干什么。然后，详细介绍它的技术栈。最后详细解释每一句代码：
// Cloudflare Worker - Kimi K2 OpenAI API 兼容代理
// 环境变量: UPSTREAM_HOST (可选，默认 https://kimi-k2.ai)

const DEFAULT_UPSTREAM_HOST = "https://kimi-k2.ai";

/**
 * 生成随机 IP 地址
 * 使用常见的住宅/商业 IP 段，避免数据中心 IP 段
 */
function generateRandomIP() {
  // 常见的住宅/商业 IP 段前缀 (中国和国际)
  const ipPrefixes = [
    // 中国电信
    [113, 116], [114, 80], [115, 192], [116, 224], [117, 136],
    [118, 112], [119, 96], [120, 192], [121, 32], [122, 192],
    // 中国联通
    [112, 64], [113, 0], [116, 112], [119, 112], [120, 64],
    // 中国移动
    [111, 0], [112, 0], [117, 128], [120, 128], [183, 192],
    // 美国常见段
    [24, 0], [50, 0], [68, 0], [71, 0], [72, 0], [73, 0],
    [76, 0], [96, 0], [98, 0], [99, 0], [107, 0], [108, 0]
  ];

  const prefix = ipPrefixes[Math.floor(Math.random() * ipPrefixes.length)];
  const octet3 = Math.floor(Math.random() * 256);
  const octet4 = Math.floor(Math.random() * 254) + 1; // 避免 0 和 255

  return <code>${prefix[0]}.${prefix[1] + Math.floor(Math.random() * 16)}.${octet3}.${octet4}</code>;
}

/**
 * 生成包含伪造 IP 的请求头
 */
function generateSpoofedHeaders(baseHeaders = {}) {
  const fakeIP = generateRandomIP();
  console.log(<code>[IP伪造] 使用伪造 IP: ${fakeIP}</code>);

  return {
    ...baseHeaders,
    "X-Forwarded-For": fakeIP,
    "X-Real-IP": fakeIP,
    "CF-Connecting-IP": fakeIP,
    "X-Originating-IP": fakeIP,
    "True-Client-IP": fakeIP,
    "X-Client-IP": fakeIP,
    "Forwarded": <code>for=${fakeIP}</code>
  };
}

/**
 * 获取认证 Cookies
 */
async function getAuthCookies(upstreamHost) {
  console.log("[认证] 正在尝试获取认证 Cookies...");

  const headers = generateSpoofedHeaders({
    "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36",
    "accept": "*/*",
    "accept-language": "zh-CN,zh;q=0.9,en;q=0.8",
    "referer": <code>${upstreamHost}/zh/chat</code>
  });

  const response = await fetch(<code>${upstreamHost}/api/auth/session</code>, { headers });
  console.log(<code>[认证] 收到上游 Cookies 响应, 状态码: ${response.status}</code>);

  const cookies = response.headers.get("set-cookie");
  if (!cookies) {
    console.error("[认证] 错误: 未在响应头中找到 'set-cookie'");
    return null;
  }

  const csrfMatch = cookies.match(/__Host-authjs\.csrf-token=([^;]+)/);
  const callbackMatch = cookies.match(/__Secure-authjs\.callback-url=([^;]+)/);

  const authData = {
    csrf: csrfMatch ? csrfMatch[1] : null,
    callback: callbackMatch ? callbackMatch[1] : null
  };

  if (authData.csrf &amp;&amp; authData.callback) {
    console.log("[认证] 成功解析 CSRF 和 Callback Cookies");
  } else {
    console.warn("[认证] 警告: 未能完整解析 Cookies:", authData);
  }

  return authData;
}

/**
 * 生成 Session ID
 */
function generateSessionId() {
  const sessionId = crypto.randomUUID();
  console.log(<code>[工具] 生成新的 Session ID: ${sessionId}</code>);
  return sessionId;
}

/**
 * 将 OpenAI 格式请求转换为上游格式
 */
function convertToUpstreamFormat(openaiRequest) {
  console.log("[转换] 正在将 OpenAI 格式转换为上游格式...");
  return {
    messages: openaiRequest.messages,
    sessionId: generateSessionId(),
    searchContext: ""
  };
}

/**
 * 将上游响应转换为 OpenAI 格式
 */
function convertToOpenAIFormat(upstreamResponse, model, stream = false) {
  const id = <code>chatcmpl-${Date.now()}</code>;
  const created = Math.floor(Date.now() / 1000);

  if (stream) {
    console.log("[转换] 正在将上游响应转换为 OpenAI 流式格式...");
    const chunk = {
      id,
      object: "chat.completion.chunk",
      created,
      model,
      choices: [{
        index: 0,
        delta: { content: upstreamResponse.content },
        finish_reason: "stop"
      }]
    };
    return <code>data: ${JSON.stringify(chunk)}\n\ndata: [DONE]\n\n</code>;
  }

  console.log("[转换] 正在将上游响应转换为 OpenAI JSON 格式...");
  return {
    id,
    object: "chat.completion",
    created,
    model,
    choices: [{
      index: 0,
      message: {
        role: "assistant",
        content: upstreamResponse.content
      },
      finish_reason: "stop"
    }],
    usage: upstreamResponse.usage || {
      prompt_tokens: 0,
      completion_tokens: 0,
      total_tokens: 0
    }
  };
}

/**
 * 处理聊天完成请求
 */
async function handleChatCompletion(request, upstreamHost) {
  console.log("[聊天处理] 开始处理 /v1/chat/completions 请求...");
  const openaiRequest = await request.json();
  const stream = openaiRequest.stream === true;
  const model = openaiRequest.model || "kimi-k2";
  console.log(<code>[聊天处理] 请求参数: 模型=${model}, 是否流式=${stream}</code>);

  const authCookies = await getAuthCookies(upstreamHost);
  if (!authCookies || !authCookies.csrf || !authCookies.callback) {
    console.error("[聊天处理] 错误: 获取认证 Cookies 失败, 中断请求");
    return new Response(JSON.stringify({ error: "Failed to get auth cookies" }), {
      status: 500,
      headers: { "content-type": "application/json" }
    });
  }

  const upstreamRequest = convertToUpstreamFormat(openaiRequest);
  console.log(<code>[聊天处理] 准备向上游 ${upstreamHost}/api/chat 发送请求</code>);

  const chatHeaders = generateSpoofedHeaders({
    "content-type": "application/json",
    "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36",
    "accept": "*/*",
    "accept-language": "zh-CN,zh;q=0.9,en;q=0.8",
    "origin": upstreamHost,
    "referer": <code>${upstreamHost}/zh/chat</code>,
    "cookie": <code>__Host-authjs.csrf-token=${authCookies.csrf}; __Secure-authjs.callback-url=${authCookies.callback}</code>
  });

  const upstreamResponse = await fetch(<code>${upstreamHost}/api/chat</code>, {
    method: "POST",
    headers: chatHeaders,
    body: JSON.stringify(upstreamRequest)
  });

  console.log(<code>[聊天处理] 收到上游响应, 状态码: ${upstreamResponse.status}</code>);

  if (!upstreamResponse.ok) {
    console.error(<code>[聊天处理] 错误: 上游请求失败, 状态码: ${upstreamResponse.status}</code>);
    return new Response(JSON.stringify({ error: "Upstream request failed" }), {
      status: upstreamResponse.status,
      headers: { "content-type": "application/json" }
    });
  }

  const upstreamData = await upstreamResponse.json();
  console.log("[聊天处理] 成功解析上游 JSON 响应");

  if (stream) {
    console.log("[聊天处理] 正在以流式 (SSE) 格式返回响应");
    const streamData = convertToOpenAIFormat(upstreamData, model, true);
    return new Response(streamData, {
      headers: {
        "content-type": "text/event-stream",
        "cache-control": "no-cache",
        "connection": "keep-alive"
      }
    });
  }

  console.log("[聊天处理] 正在以 JSON 格式返回响应");
  const openaiResponse = convertToOpenAIFormat(upstreamData, model, false);
  return new Response(JSON.stringify(openaiResponse), {
    headers: { "content-type": "application/json" }
  });
}

/**
 * 添加 CORS 响应头
 */
function addCorsHeaders(response) {
  const newHeaders = new Headers(response.headers);
  newHeaders.set("Access-Control-Allow-Origin", "*");
  newHeaders.set("Access-Control-Allow-Methods", "GET, POST, OPTIONS");
  newHeaders.set("Access-Control-Allow-Headers", "Content-Type, Authorization");
  return new Response(response.body, {
    status: response.status,
    statusText: response.statusText,
    headers: newHeaders
  });
}

/**
 * 主请求处理函数
 */
async function handleRequest(request, env) {
  const upstreamHost = env.UPSTREAM_HOST || DEFAULT_UPSTREAM_HOST;
  const url = new URL(request.url);
  console.log(<code>[入口] 收到新请求: ${request.method} ${url.pathname}</code>);

  // 处理 CORS 预检请求
  if (request.method === "OPTIONS") {
    return new Response(null, {
      headers: {
        "Access-Control-Allow-Origin": "*",
        "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
        "Access-Control-Allow-Headers": "Content-Type, Authorization",
        "Access-Control-Max-Age": "86400"
      }
    });
  }

  let response;

  // 健康检查端点
  if (url.pathname === "/health" &amp;&amp; request.method === "GET") {
    console.log("[路由] 匹配到: /health (GET)");
    response = new Response(JSON.stringify({
      status: "healthy",
      timestamp: new Date().toISOString(),
      upstreamHost: upstreamHost
    }), {
      headers: { "content-type": "application/json" }
    });
    return addCorsHeaders(response);
  }

  // 聊天完成端点
  if (url.pathname === "/v1/chat/completions" &amp;&amp; request.method === "POST") {
    console.log("[路由] 匹配到: /v1/chat/completions (POST)");
    response = await handleChatCompletion(request, upstreamHost);
    return addCorsHeaders(response);
  }

  // 模型列表端点
  if (url.pathname === "/v1/models" &amp;&amp; request.method === "GET") {
    console.log("[路由] 匹配到: /v1/models (GET)");
    response = new Response(JSON.stringify({
      object: "list",
      data: [{
        id: "kimi-k2",
        object: "model",
        created: Math.floor(Date.now() / 1000),
        owned_by: "kimi"
      }]
    }), {
      headers: { "content-type": "application/json" }
    });
    return addCorsHeaders(response);
  }

  console.log(<code>[路由] 未找到匹配路由: ${url.pathname}, 返回 404</code>);
  return new Response("Not Found", { status: 404 });
}

// Cloudflare Worker 导出
export default {
  async fetch(request, env, ctx) {
    return handleRequest(request, env);
  }
};</div>
        </div>
<div class="message-block role-ai">
          <div class="message-role">AI</div>
          <div class="message-content"><p data-start="0" data-end="239">下面我会按你的要求分三部分来讲：<strong data-start="16" data-end="28">总结代码在干什么</strong> → <strong data-start="31" data-end="38">技术栈</strong> → <strong data-start="41" data-end="49">逐句解释</strong>。<br data-start="50" data-end="53">
先说明一点：这段代码里包含<strong data-start="66" data-end="80">伪造客户端 IP 头</strong>、以及<strong data-start="83" data-end="103">主动获取/拼接会话 Cookie</strong>来模拟浏览器认证的逻辑——这些做法很容易被用于<strong data-start="126" data-end="144">绕过访问控制/风控/地区限制</strong>或违反服务条款。对此我可以解释它“代码层面做了什么”和“整体设计思路”，但不会提供能直接用于规避安全机制的操作性建议（例如如何选 IP 段更不易被识别、如何稳定拿到可用 Cookie 等）。</p>
<hr data-start="241" data-end="244">
<h2 data-start="246" data-end="264">1) 这段代码在干什么（总结）</h2>
<p data-start="266" data-end="331">这是一段 <strong data-start="271" data-end="292">Cloudflare Worker</strong>（边缘函数）代码，把自己伪装成一个**“OpenAI API 兼容代理”**：</p>
<ul data-start="333" data-end="877">
<li data-start="333" data-end="486">
<p data-start="335" data-end="354">对外提供与 OpenAI 类似的接口：</p>
<ul data-start="357" data-end="486">
<li data-start="357" data-end="419">
<p data-start="359" data-end="419"><code data-start="359" data-end="386">POST /v1/chat/completions</code>：接收 OpenAI Chat Completions 风格的请求</p>
</li>
<li data-start="422" data-end="463">
<p data-start="424" data-end="463"><code data-start="424" data-end="440">GET /v1/models</code>：返回模型列表（固定返回 <code data-start="453" data-end="462">kimi-k2</code>）</p>
</li>
<li data-start="466" data-end="486">
<p data-start="468" data-end="486"><code data-start="468" data-end="481">GET /health</code>：健康检查</p>
</li>
</ul>
</li>
<li data-start="487" data-end="636">
<p data-start="489" data-end="555">对内把请求转发到一个“上游”网站（默认 <code data-start="509" data-end="529">https://kimi-k2.ai</code>，可用环境变量 <code data-start="537" data-end="552">UPSTREAM_HOST</code> 改）</p>
<ul data-start="558" data-end="636">
<li data-start="558" data-end="602">
<p data-start="560" data-end="602">先请求上游的 <code data-start="567" data-end="586">/api/auth/session</code> 试图拿到某些认证 Cookie</p>
</li>
<li data-start="605" data-end="636">
<p data-start="607" data-end="636">再携带这些 Cookie 调用上游 <code data-start="625" data-end="636">/api/chat</code></p>
</li>
</ul>
</li>
<li data-start="637" data-end="802">
<p data-start="639" data-end="655">在请求/响应之间做“格式转换”：</p>
<ul data-start="658" data-end="802">
<li data-start="658" data-end="708">
<p data-start="660" data-end="708"><strong data-start="660" data-end="680">OpenAI 请求 → 上游请求</strong>：加 <code data-start="683" data-end="694">sessionId</code>、保留 <code data-start="698" data-end="708">messages</code></p>
</li>
<li data-start="711" data-end="802">
<p data-start="713" data-end="802"><strong data-start="713" data-end="733">上游响应 → OpenAI 响应</strong>：包装成 OpenAI JSON 格式；如果 <code data-start="756" data-end="769">stream=true</code>，用 <strong data-start="772" data-end="779">SSE</strong> 形式回一段“单块流式数据 + [DONE]”</p>
</li>
</ul>
</li>
<li data-start="803" data-end="877">
<p data-start="805" data-end="813">额外做了两件事：</p>
<ul data-start="816" data-end="877">
<li data-start="816" data-end="847">
<p data-start="818" data-end="847">给所有响应加 <strong data-start="825" data-end="833">CORS</strong> 头，方便浏览器直接跨域调用</p>
</li>
<li data-start="850" data-end="877">
<p data-start="852" data-end="877">打大量 <code data-start="856" data-end="869">console.log</code> 用于调试与观测</p>
</li>
</ul>
</li>
</ul>
<hr data-start="879" data-end="882">
<h2 data-start="884" data-end="899">2) 技术栈（详细介绍）</h2>
<h3 data-start="901" data-end="912">运行环境与部署</h3>
<ul data-start="913" data-end="1065">
<li data-start="913" data-end="1065">
<p data-start="915" data-end="937"><strong data-start="915" data-end="937">Cloudflare Workers</strong></p>
<ul data-start="940" data-end="1065">
<li data-start="940" data-end="975">
<p data-start="942" data-end="975">基于 V8 Isolates 的边缘运行时（不是 Node.js）</p>
</li>
<li data-start="978" data-end="1023">
<p data-start="980" data-end="1023">入口是 <code data-start="984" data-end="1023">export default { fetch(...) { ... } }</code></p>
</li>
<li data-start="1026" data-end="1065">
<p data-start="1028" data-end="1065">通过 <code data-start="1031" data-end="1036">env</code> 读取环境变量（这里用到 <code data-start="1049" data-end="1064">UPSTREAM_HOST</code>）</p>
</li>
</ul>
</li>
</ul>
<h3 data-start="1067" data-end="1078">语言与模块体系</h3>
<ul data-start="1079" data-end="1254">
<li data-start="1079" data-end="1146">
<p data-start="1081" data-end="1107"><strong data-start="1081" data-end="1107">JavaScript（ES Modules）</strong></p>
<ul data-start="1110" data-end="1146">
<li data-start="1110" data-end="1146">
<p data-start="1112" data-end="1146">顶层 <code data-start="1115" data-end="1122">const</code>、函数声明、<code data-start="1128" data-end="1144">export default</code> 等</p>
</li>
</ul>
</li>
<li data-start="1147" data-end="1254">
<p data-start="1149" data-end="1157">运行时内置能力：</p>
<ul data-start="1160" data-end="1254">
<li data-start="1160" data-end="1184">
<p data-start="1162" data-end="1184"><code data-start="1162" data-end="1169">fetch</code>（Web Fetch API）</p>
</li>
<li data-start="1187" data-end="1219">
<p data-start="1189" data-end="1219"><code data-start="1189" data-end="1219">Request / Response / Headers</code></p>
</li>
<li data-start="1222" data-end="1254">
<p data-start="1224" data-end="1254"><code data-start="1224" data-end="1245">crypto.randomUUID()</code>（生成 UUID）</p>
</li>
</ul>
</li>
</ul>
<h3 data-start="1256" data-end="1267">协议与数据格式</h3>
<ul data-start="1268" data-end="1476">
<li data-start="1268" data-end="1284">
<p data-start="1270" data-end="1284"><strong data-start="1270" data-end="1284">HTTP/HTTPS</strong></p>
</li>
<li data-start="1285" data-end="1349">
<p data-start="1287" data-end="1295"><strong data-start="1287" data-end="1295">JSON</strong></p>
<ul data-start="1298" data-end="1349">
<li data-start="1298" data-end="1320">
<p data-start="1300" data-end="1320">请求体 <code data-start="1304" data-end="1320">request.json()</code></p>
</li>
<li data-start="1323" data-end="1349">
<p data-start="1325" data-end="1349">响应 <code data-start="1328" data-end="1349">JSON.stringify(...)</code></p>
</li>
</ul>
</li>
<li data-start="1350" data-end="1476">
<p data-start="1352" data-end="1379"><strong data-start="1352" data-end="1379">SSE（Server-Sent Events）</strong></p>
<ul data-start="1382" data-end="1476">
<li data-start="1382" data-end="1422">
<p data-start="1384" data-end="1422">当 <code data-start="1386" data-end="1399">stream=true</code> 返回 <code data-start="1403" data-end="1422">text/event-stream</code></p>
</li>
<li data-start="1425" data-end="1476">
<p data-start="1427" data-end="1476">但这里是“伪流式”：一次性返回一个 chunk + <code data-start="1453" data-end="1461">[DONE]</code>，并非真正逐 token 推送</p>
</li>
</ul>
</li>
</ul>
<h3 data-start="1478" data-end="1489">API 兼容层</h3>
<ul data-start="1490" data-end="1630">
<li data-start="1490" data-end="1630">
<p data-start="1492" data-end="1524"><strong data-start="1492" data-end="1524">OpenAI Chat Completions 兼容接口</strong></p>
<ul data-start="1527" data-end="1630">
<li data-start="1527" data-end="1581">
<p data-start="1529" data-end="1581">模仿 <code data-start="1532" data-end="1549">chat.completion</code> / <code data-start="1552" data-end="1575">chat.completion.chunk</code> 的字段结构</p>
</li>
<li data-start="1584" data-end="1630">
<p data-start="1586" data-end="1630">返回 <code data-start="1589" data-end="1609">choices[0].message</code> / <code data-start="1612" data-end="1630">choices[0].delta</code></p>
</li>
</ul>
</li>
</ul>
<h3 data-start="1632" data-end="1644">跨域与浏览器支持</h3>
<ul data-start="1645" data-end="1733">
<li data-start="1645" data-end="1733">
<p data-start="1647" data-end="1655"><strong data-start="1647" data-end="1655">CORS</strong></p>
<ul data-start="1658" data-end="1733">
<li data-start="1658" data-end="1674">
<p data-start="1660" data-end="1674"><code data-start="1660" data-end="1669">OPTIONS</code> 预检处理</p>
</li>
<li data-start="1677" data-end="1705">
<p data-start="1679" data-end="1705"><code data-start="1679" data-end="1703">Access-Control-Allow-*</code> 头</p>
</li>
<li data-start="1708" data-end="1733">
<p data-start="1710" data-end="1733">允许任意来源 <code data-start="1717" data-end="1720">*</code>（这在生产上通常要更谨慎）</p>
</li>
</ul>
</li>
</ul>
<h3 data-start="1735" data-end="1744">观测与调试</h3>
<ul data-start="1745" data-end="1826">
<li data-start="1745" data-end="1826">
<p data-start="1747" data-end="1791"><code data-start="1747" data-end="1791">console.log / console.warn / console.error</code></p>
<ul data-start="1794" data-end="1826">
<li data-start="1794" data-end="1826">
<p data-start="1796" data-end="1826">Workers 支持日志输出到 Cloudflare 控制台</p>
</li>
</ul>
</li>
</ul>
<hr data-start="1828" data-end="1831">
<h2 data-start="1833" data-end="1858">3) 逐句解释每一句代码（按代码块从上到下）</h2>
<blockquote data-start="1860" data-end="1935">
<p data-start="1862" data-end="1935">为了可读性，我按“代码块/语句序列”逐句解释；对明显涉及伪造/绕过风控的部分，我会解释其<strong data-start="1906" data-end="1912">作用</strong>，但不提供“如何更隐蔽/更稳定”等操作性细节。</p>
</blockquote>
<hr data-start="1937" data-end="1940">
<h3 data-start="1942" data-end="1955">顶部注释与默认上游</h3>
<pre class="overflow-visible! px-0!" data-start="1957" data-end="2063"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span><span class="hljs-comment">// Cloudflare Worker - Kimi K2 OpenAI API 兼容代理</span></span><span>
</span><span><span class="hljs-comment">// 环境变量: UPSTREAM_HOST (可选，默认 https://kimi-k2.ai)</span></span><span>
</span></span></code></div></div></pre>
<ul data-start="2064" data-end="2144">
<li data-start="2064" data-end="2105">
<p data-start="2066" data-end="2105">注释说明用途：Worker 作为 Kimi K2 的 OpenAI 兼容代理。</p>
</li>
<li data-start="2106" data-end="2144">
<p data-start="2108" data-end="2144">提醒可用环境变量 <code data-start="2117" data-end="2132">UPSTREAM_HOST</code> 指定上游，否则用默认。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="2146" data-end="2207"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span><span class="hljs-keyword">const</span></span><span> </span><span><span class="hljs-variable constant_">DEFAULT_UPSTREAM_HOST</span></span><span> = </span><span><span class="hljs-string">"https://kimi-k2.ai"</span></span><span>;
</span></span></code></div></div></pre>
<ul data-start="2208" data-end="2221">
<li data-start="2208" data-end="2221">
<p data-start="2210" data-end="2221">定义默认上游域名常量。</p>
</li>
</ul>
<hr data-start="2223" data-end="2226">
<h3 data-start="2228" data-end="2256">generateRandomIP：生成随机 IP</h3>
<pre class="overflow-visible! px-0!" data-start="2258" data-end="2350"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span><span class="hljs-comment">/**
 * 生成随机 IP 地址
 * 使用常见的住宅/商业 IP 段，避免数据中心 IP 段
 */</span>
</span><span><span class="hljs-keyword">function</span></span><span> </span><span><span class="hljs-title function_">generateRandomIP</span></span><span>(</span><span><span class="hljs-params"></span></span><span>) {
</span></span></code></div></div></pre>
<ul data-start="2351" data-end="2418">
<li data-start="2351" data-end="2380">
<p data-start="2353" data-end="2380">注释明确表明：生成“看起来像住宅/商业网络”的 IP。</p>
</li>
<li data-start="2381" data-end="2418">
<p data-start="2383" data-end="2418"><code data-start="2383" data-end="2412">function generateRandomIP()</code> 定义函数。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="2420" data-end="2481"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-comment">// 常见的住宅/商业 IP 段前缀 (中国和国际)</span></span><span>
  </span><span><span class="hljs-keyword">const</span></span><span> ipPrefixes = [
</span></span></code></div></div></pre>
<ul data-start="2482" data-end="2514">
<li data-start="2482" data-end="2514">
<p data-start="2484" data-end="2514">定义一个二维数组，存放若干 IP 段前缀（前两段八位字节）。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="2516" data-end="2941"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>    </span><span><span class="hljs-comment">// 中国电信</span></span><span>
    [</span><span><span class="hljs-number">113</span></span><span>, </span><span><span class="hljs-number">116</span></span><span>], [</span><span><span class="hljs-number">114</span></span><span>, </span><span><span class="hljs-number">80</span></span><span>], [</span><span><span class="hljs-number">115</span></span><span>, </span><span><span class="hljs-number">192</span></span><span>], [</span><span><span class="hljs-number">116</span></span><span>, </span><span><span class="hljs-number">224</span></span><span>], [</span><span><span class="hljs-number">117</span></span><span>, </span><span><span class="hljs-number">136</span></span><span>],
    [</span><span><span class="hljs-number">118</span></span><span>, </span><span><span class="hljs-number">112</span></span><span>], [</span><span><span class="hljs-number">119</span></span><span>, </span><span><span class="hljs-number">96</span></span><span>], [</span><span><span class="hljs-number">120</span></span><span>, </span><span><span class="hljs-number">192</span></span><span>], [</span><span><span class="hljs-number">121</span></span><span>, </span><span><span class="hljs-number">32</span></span><span>], [</span><span><span class="hljs-number">122</span></span><span>, </span><span><span class="hljs-number">192</span></span><span>],
    </span><span><span class="hljs-comment">// 中国联通</span></span><span>
    [</span><span><span class="hljs-number">112</span></span><span>, </span><span><span class="hljs-number">64</span></span><span>], [</span><span><span class="hljs-number">113</span></span><span>, </span><span><span class="hljs-number">0</span></span><span>], [</span><span><span class="hljs-number">116</span></span><span>, </span><span><span class="hljs-number">112</span></span><span>], [</span><span><span class="hljs-number">119</span></span><span>, </span><span><span class="hljs-number">112</span></span><span>], [</span><span><span class="hljs-number">120</span></span><span>, </span><span><span class="hljs-number">64</span></span><span>],
    </span><span><span class="hljs-comment">// 中国移动</span></span><span>
    [</span><span><span class="hljs-number">111</span></span><span>, </span><span><span class="hljs-number">0</span></span><span>], [</span><span><span class="hljs-number">112</span></span><span>, </span><span><span class="hljs-number">0</span></span><span>], [</span><span><span class="hljs-number">117</span></span><span>, </span><span><span class="hljs-number">128</span></span><span>], [</span><span><span class="hljs-number">120</span></span><span>, </span><span><span class="hljs-number">128</span></span><span>], [</span><span><span class="hljs-number">183</span></span><span>, </span><span><span class="hljs-number">192</span></span><span>],
    </span><span><span class="hljs-comment">// 美国常见段</span></span><span>
    [</span><span><span class="hljs-number">24</span></span><span>, </span><span><span class="hljs-number">0</span></span><span>], [</span><span><span class="hljs-number">50</span></span><span>, </span><span><span class="hljs-number">0</span></span><span>], [</span><span><span class="hljs-number">68</span></span><span>, </span><span><span class="hljs-number">0</span></span><span>], [</span><span><span class="hljs-number">71</span></span><span>, </span><span><span class="hljs-number">0</span></span><span>], [</span><span><span class="hljs-number">72</span></span><span>, </span><span><span class="hljs-number">0</span></span><span>], [</span><span><span class="hljs-number">73</span></span><span>, </span><span><span class="hljs-number">0</span></span><span>],
    [</span><span><span class="hljs-number">76</span></span><span>, </span><span><span class="hljs-number">0</span></span><span>], [</span><span><span class="hljs-number">96</span></span><span>, </span><span><span class="hljs-number">0</span></span><span>], [</span><span><span class="hljs-number">98</span></span><span>, </span><span><span class="hljs-number">0</span></span><span>], [</span><span><span class="hljs-number">99</span></span><span>, </span><span><span class="hljs-number">0</span></span><span>], [</span><span><span class="hljs-number">107</span></span><span>, </span><span><span class="hljs-number">0</span></span><span>], [</span><span><span class="hljs-number">108</span></span><span>, </span><span><span class="hljs-number">0</span></span><span>]
  ];
</span></span></code></div></div></pre>
<ul data-start="2942" data-end="3021">
<li data-start="2942" data-end="2977">
<p data-start="2944" data-end="2977">这些是预设“候选前缀”列表，后面会随机挑一个作为 IP 的前两段。</p>
</li>
<li data-start="2978" data-end="3021">
<p data-start="2980" data-end="3021">（风险提示）把 IP“伪装成特定网络段”常用于规避风控；我不建议将其用于绕过限制。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="3023" data-end="3108"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-keyword">const</span></span><span> prefix = ipPrefixes[</span><span><span class="hljs-title class_">Math</span></span><span>.</span><span><span class="hljs-title function_">floor</span></span><span>(</span><span><span class="hljs-title class_">Math</span></span><span>.</span><span><span class="hljs-title function_">random</span></span><span>() * ipPrefixes.</span><span><span class="hljs-property">length</span></span><span>)];
</span></span></code></div></div></pre>
<ul data-start="3109" data-end="3207">
<li data-start="3109" data-end="3143">
<p data-start="3111" data-end="3143"><code data-start="3111" data-end="3126">Math.random()</code> 生成 <code data-start="3130" data-end="3137">[0,1)</code> 的随机数。</p>
</li>
<li data-start="3144" data-end="3174">
<p data-start="3146" data-end="3174">乘以数组长度并 <code data-start="3154" data-end="3166">Math.floor</code> 得到随机索引。</p>
</li>
<li data-start="3175" data-end="3207">
<p data-start="3177" data-end="3207"><code data-start="3177" data-end="3185">prefix</code> 是形如 <code data-start="3190" data-end="3202">[113, 116]</code> 的数组。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="3209" data-end="3268"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-keyword">const</span></span><span> octet3 = </span><span><span class="hljs-title class_">Math</span></span><span>.</span><span><span class="hljs-title function_">floor</span></span><span>(</span><span><span class="hljs-title class_">Math</span></span><span>.</span><span><span class="hljs-title function_">random</span></span><span>() * </span><span><span class="hljs-number">256</span></span><span>);
</span></span></code></div></div></pre>
<ul data-start="3269" data-end="3291">
<li data-start="3269" data-end="3291">
<p data-start="3271" data-end="3291">生成第三段 <code data-start="3277" data-end="3284">0-255</code> 的随机整数。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="3293" data-end="3370"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-keyword">const</span></span><span> octet4 = </span><span><span class="hljs-title class_">Math</span></span><span>.</span><span><span class="hljs-title function_">floor</span></span><span>(</span><span><span class="hljs-title class_">Math</span></span><span>.</span><span><span class="hljs-title function_">random</span></span><span>() * </span><span><span class="hljs-number">254</span></span><span>) + </span><span><span class="hljs-number">1</span></span><span>; </span><span><span class="hljs-comment">// 避免 0 和 255</span></span><span>
</span></span></code></div></div></pre>
<ul data-start="3371" data-end="3423">
<li data-start="3371" data-end="3423">
<p data-start="3373" data-end="3423">生成第四段 <code data-start="3379" data-end="3386">1-254</code> 的随机整数，避免主机号为 <code data-start="3400" data-end="3403">0</code> 或 <code data-start="3406" data-end="3411">255</code>（常见保留/广播含义）。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="3425" data-end="3527"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-keyword">return</span></span><span> </span><span><span class="hljs-string">`<span class="hljs-subst">${prefix[<span class="hljs-number">0</span></span></span></span><span>]}.</span><span><span class="hljs-subst">${prefix[<span class="hljs-number">1</span></span></span><span>] + </span><span><span class="hljs-built_in">Math</span></span><span>.floor(</span><span><span class="hljs-built_in">Math</span></span><span>.random() * </span><span><span class="hljs-number">16</span></span><span>)}.</span><span><span class="hljs-subst">${octet3}</span></span><span>.</span><span><span class="hljs-subst">${octet4}</span></span><span>`;
}
</span></span></code></div></div></pre>
<ul data-start="3528" data-end="3606">
<li data-start="3528" data-end="3544">
<p data-start="3530" data-end="3544">用模板字符串拼成 IPv4。</p>
</li>
<li data-start="3545" data-end="3606">
<p data-start="3547" data-end="3606">注意第二段不是固定 <code data-start="3557" data-end="3568">prefix[1]</code>，而是 <code data-start="3572" data-end="3591">prefix[1] + 0..15</code> 的随机偏移，让范围更大一点。</p>
</li>
</ul>
<hr data-start="3608" data-end="3611">
<h3 data-start="3613" data-end="3653">generateSpoofedHeaders：构造“伪造 IP”的请求头</h3>
<pre class="overflow-visible! px-0!" data-start="3655" data-end="3742"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span><span class="hljs-comment">/**
 * 生成包含伪造 IP 的请求头
 */</span>
</span><span><span class="hljs-keyword">function</span></span><span> </span><span><span class="hljs-title function_">generateSpoofedHeaders</span></span><span>(</span><span><span class="hljs-params">baseHeaders = {}</span></span><span>) {
</span></span></code></div></div></pre>
<ul data-start="3743" data-end="3771">
<li data-start="3743" data-end="3771">
<p data-start="3745" data-end="3771">定义函数，入参是基础 headers（默认空对象）。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="3773" data-end="3819"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-keyword">const</span></span><span> fakeIP = </span><span><span class="hljs-title function_">generateRandomIP</span></span><span>();
</span></span></code></div></div></pre>
<ul data-start="3820" data-end="3836">
<li data-start="3820" data-end="3836">
<p data-start="3822" data-end="3836">调用上面函数生成随机 IP。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="3838" data-end="3891"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-variable language_">console</span></span><span>.</span><span><span class="hljs-title function_">log</span></span><span>(</span><span><span class="hljs-string">`[IP伪造] 使用伪造 IP: <span class="hljs-subst">${fakeIP}</span></span></span><span>`);
</span></span></code></div></div></pre>
<ul data-start="3892" data-end="3913">
<li data-start="3892" data-end="3913">
<p data-start="3894" data-end="3913">记录日志，打印所用的 fake IP。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="3915" data-end="4172"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-keyword">return</span></span><span> {
    ...baseHeaders,
    </span><span><span class="hljs-string">"X-Forwarded-For"</span></span><span>: fakeIP,
    </span><span><span class="hljs-string">"X-Real-IP"</span></span><span>: fakeIP,
    </span><span><span class="hljs-string">"CF-Connecting-IP"</span></span><span>: fakeIP,
    </span><span><span class="hljs-string">"X-Originating-IP"</span></span><span>: fakeIP,
    </span><span><span class="hljs-string">"True-Client-IP"</span></span><span>: fakeIP,
    </span><span><span class="hljs-string">"X-Client-IP"</span></span><span>: fakeIP,
    </span><span><span class="hljs-string">"Forwarded"</span></span><span>: </span><span><span class="hljs-string">`for=<span class="hljs-subst">${fakeIP}</span></span></span><span>`
  };
}
</span></span></code></div></div></pre>
<ul data-start="4173" data-end="4322">
<li data-start="4173" data-end="4252">
<p data-start="4175" data-end="4183">返回一个新对象：</p>
<ul data-start="4186" data-end="4252">
<li data-start="4186" data-end="4223">
<p data-start="4188" data-end="4223"><code data-start="4188" data-end="4204">...baseHeaders</code>：把调用者传入的 header 先展开</p>
</li>
<li data-start="4226" data-end="4252">
<p data-start="4228" data-end="4252">然后覆盖/新增一系列“标识客户端 IP”的请求头</p>
</li>
</ul>
</li>
<li data-start="4253" data-end="4322">
<p data-start="4255" data-end="4322">（重要说明）这些头在真实链路里通常由代理/CDN 写入，客户端随意伪造可能涉及绕过/欺骗。我只能解释字段含义，不建议用于规避安全策略。</p>
</li>
</ul>
<hr data-start="4324" data-end="4327">
<h3 data-start="4329" data-end="4365">getAuthCookies：向上游请求会话并解析 Cookie</h3>
<pre class="overflow-visible! px-0!" data-start="4367" data-end="4446"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span><span class="hljs-comment">/**
 * 获取认证 Cookies
 */</span>
</span><span><span class="hljs-keyword">async</span></span><span> </span><span><span class="hljs-keyword">function</span></span><span> </span><span><span class="hljs-title function_">getAuthCookies</span></span><span>(</span><span><span class="hljs-params">upstreamHost</span></span><span>) {
</span></span></code></div></div></pre>
<ul data-start="4447" data-end="4472">
<li data-start="4447" data-end="4472">
<p data-start="4449" data-end="4472">异步函数：从上游拿“认证相关 Cookie”。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="4474" data-end="4526"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-variable language_">console</span></span><span>.</span><span><span class="hljs-title function_">log</span></span><span>(</span><span><span class="hljs-string">"[认证] 正在尝试获取认证 Cookies..."</span></span><span>);
</span></span></code></div></div></pre>
<ul data-start="4527" data-end="4532">
<li data-start="4527" data-end="4532">
<p data-start="4529" data-end="4532">日志。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="4534" data-end="4772"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-keyword">const</span></span><span> headers = </span><span><span class="hljs-title function_">generateSpoofedHeaders</span></span><span>({
    </span><span><span class="hljs-string">"user-agent"</span></span><span>: </span><span><span class="hljs-string">"Mozilla/5.0 ... Chrome/131.0.0.0 Safari/537.36"</span></span><span>,
    </span><span><span class="hljs-string">"accept"</span></span><span>: </span><span><span class="hljs-string">"*/*"</span></span><span>,
    </span><span><span class="hljs-string">"accept-language"</span></span><span>: </span><span><span class="hljs-string">"zh-CN,zh;q=0.9,en;q=0.8"</span></span><span>,
    </span><span><span class="hljs-string">"referer"</span></span><span>: </span><span><span class="hljs-string">`<span class="hljs-subst">${upstreamHost}</span></span></span><span>/zh/chat`
  });
</span></span></code></div></div></pre>
<ul data-start="4773" data-end="4888">
<li data-start="4773" data-end="4888">
<p data-start="4775" data-end="4781">构造请求头：</p>
<ul data-start="4784" data-end="4888">
<li data-start="4784" data-end="4813">
<p data-start="4786" data-end="4813"><code data-start="4786" data-end="4798">user-agent</code>：伪装成 Chrome 浏览器</p>
</li>
<li data-start="4816" data-end="4868">
<p data-start="4818" data-end="4868"><code data-start="4818" data-end="4826">accept</code>、<code data-start="4827" data-end="4844">accept-language</code>、<code data-start="4845" data-end="4854">referer</code>：模拟从上游站点的聊天页发起</p>
</li>
<li data-start="4871" data-end="4888">
<p data-start="4873" data-end="4888">再叠加上一节的“伪造 IP”头</p>
</li>
</ul>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="4890" data-end="4980"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-keyword">const</span></span><span> response = </span><span><span class="hljs-keyword">await</span></span><span> </span><span><span class="hljs-title function_">fetch</span></span><span>(</span><span><span class="hljs-string">`<span class="hljs-subst">${upstreamHost}</span></span></span><span>/api/auth/session`, { headers });
</span></span></code></div></div></pre>
<ul data-start="4981" data-end="5015">
<li data-start="4981" data-end="5015">
<p data-start="4983" data-end="5015">向上游的会话接口发 GET 请求（默认 method=GET）。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="5017" data-end="5090"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-variable language_">console</span></span><span>.</span><span><span class="hljs-title function_">log</span></span><span>(</span><span><span class="hljs-string">`[认证] 收到上游 Cookies 响应, 状态码: <span class="hljs-subst">${response.status}</span></span></span><span>`);
</span></span></code></div></div></pre>
<ul data-start="5091" data-end="5105">
<li data-start="5091" data-end="5105">
<p data-start="5093" data-end="5105">打印 HTTP 状态码。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="5107" data-end="5170"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-keyword">const</span></span><span> cookies = response.</span><span><span class="hljs-property">headers</span></span><span>.</span><span><span class="hljs-title function_">get</span></span><span>(</span><span><span class="hljs-string">"set-cookie"</span></span><span>);
</span></span></code></div></div></pre>
<ul data-start="5171" data-end="5218">
<li data-start="5171" data-end="5218">
<p data-start="5173" data-end="5218">从响应头中取 <code data-start="5180" data-end="5192">set-cookie</code> 字段（上游如果设置 Cookie，会通过它下发）。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="5220" data-end="5321"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-keyword">if</span></span><span> (!cookies) {
    </span><span><span class="hljs-variable language_">console</span></span><span>.</span><span><span class="hljs-title function_">error</span></span><span>(</span><span><span class="hljs-string">"[认证] 错误: 未在响应头中找到 'set-cookie'"</span></span><span>);
    </span><span><span class="hljs-keyword">return</span></span><span> </span><span><span class="hljs-literal">null</span></span><span>;
  }
</span></span></code></div></div></pre>
<ul data-start="5322" data-end="5356">
<li data-start="5322" data-end="5356">
<p data-start="5324" data-end="5356">如果没有拿到任何 cookie，就返回 <code data-start="5344" data-end="5350">null</code> 表示失败。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="5358" data-end="5519"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-keyword">const</span></span><span> csrfMatch = cookies.</span><span><span class="hljs-title function_">match</span></span><span>(</span><span><span class="hljs-regexp">/__Host-authjs\.csrf-token=([^;]+)/</span></span><span>);
  </span><span><span class="hljs-keyword">const</span></span><span> callbackMatch = cookies.</span><span><span class="hljs-title function_">match</span></span><span>(</span><span><span class="hljs-regexp">/__Secure-authjs\.callback-url=([^;]+)/</span></span><span>);
</span></span></code></div></div></pre>
<ul data-start="5520" data-end="5647">
<li data-start="5520" data-end="5624">
<p data-start="5522" data-end="5558">用正则从 <code data-start="5527" data-end="5539">set-cookie</code> 字符串里提取两个 cookie 值：</p>
<ul data-start="5561" data-end="5624">
<li data-start="5561" data-end="5589">
<p data-start="5563" data-end="5589"><code data-start="5563" data-end="5589">__Host-authjs.csrf-token</code></p>
</li>
<li data-start="5592" data-end="5624">
<p data-start="5594" data-end="5624"><code data-start="5594" data-end="5624">__Secure-authjs.callback-url</code></p>
</li>
</ul>
</li>
<li data-start="5625" data-end="5647">
<p data-start="5627" data-end="5647"><code data-start="5627" data-end="5636">([^;]+)</code> 表示取到分号前的值。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="5649" data-end="5781"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-keyword">const</span></span><span> authData = {
    </span><span><span class="hljs-attr">csrf</span></span><span>: csrfMatch ? csrfMatch[</span><span><span class="hljs-number">1</span></span><span>] : </span><span><span class="hljs-literal">null</span></span><span>,
    </span><span><span class="hljs-attr">callback</span></span><span>: callbackMatch ? callbackMatch[</span><span><span class="hljs-number">1</span></span><span>] : </span><span><span class="hljs-literal">null</span></span><span>
  };
</span></span></code></div></div></pre>
<ul data-start="5782" data-end="5814">
<li data-start="5782" data-end="5814">
<p data-start="5784" data-end="5814">把匹配结果整理成对象：拿到就放值，没拿到就是 <code data-start="5807" data-end="5813">null</code>。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="5816" data-end="5994"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-keyword">if</span></span><span> (authData.</span><span><span class="hljs-property">csrf</span></span><span> &amp;&amp; authData.</span><span><span class="hljs-property">callback</span></span><span>) {
    </span><span><span class="hljs-variable language_">console</span></span><span>.</span><span><span class="hljs-title function_">log</span></span><span>(</span><span><span class="hljs-string">"[认证] 成功解析 CSRF 和 Callback Cookies"</span></span><span>);
  } </span><span><span class="hljs-keyword">else</span></span><span> {
    </span><span><span class="hljs-variable language_">console</span></span><span>.</span><span><span class="hljs-title function_">warn</span></span><span>(</span><span><span class="hljs-string">"[认证] 警告: 未能完整解析 Cookies:"</span></span><span>, authData);
  }
</span></span></code></div></div></pre>
<ul data-start="5995" data-end="6015">
<li data-start="5995" data-end="6015">
<p data-start="5997" data-end="6015">两个值都存在则视为成功；否则给警告。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="6017" data-end="6047"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-keyword">return</span></span><span> authData;
}
</span></span></code></div></div></pre>
<ul data-start="6048" data-end="6158">
<li data-start="6048" data-end="6086">
<p data-start="6050" data-end="6086">返回 <code data-start="6053" data-end="6073">{ csrf, callback }</code> 或其中部分为 null。</p>
</li>
<li data-start="6087" data-end="6158">
<p data-start="6089" data-end="6158">（合规提醒）主动抓取并复用他站会话 cookie，可能违反对方服务条款/安全策略；如需对接，建议使用对方提供的正式 API/Key 机制。</p>
</li>
</ul>
<hr data-start="6160" data-end="6163">
<h3 data-start="6165" data-end="6194">generateSessionId：生成会话 ID</h3>
<pre class="overflow-visible! px-0!" data-start="6196" data-end="6261"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span><span class="hljs-comment">/**
 * 生成 Session ID
 */</span>
</span><span><span class="hljs-keyword">function</span></span><span> </span><span><span class="hljs-title function_">generateSessionId</span></span><span>(</span><span><span class="hljs-params"></span></span><span>) {
</span></span></code></div></div></pre>
<ul data-start="6262" data-end="6269">
<li data-start="6262" data-end="6269">
<p data-start="6264" data-end="6269">定义函数。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="6271" data-end="6321"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-keyword">const</span></span><span> sessionId = crypto.</span><span><span class="hljs-title function_">randomUUID</span></span><span>();
</span></span></code></div></div></pre>
<ul data-start="6322" data-end="6379">
<li data-start="6322" data-end="6357">
<p data-start="6324" data-end="6357">用 Web Crypto 生成 UUID（Workers 支持）。</p>
</li>
<li data-start="6358" data-end="6379">
<p data-start="6360" data-end="6379">用来标识一次聊天会话（上游可能需要）。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="6381" data-end="6465"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-variable language_">console</span></span><span>.</span><span><span class="hljs-title function_">log</span></span><span>(</span><span><span class="hljs-string">`[工具] 生成新的 Session ID: <span class="hljs-subst">${sessionId}</span></span></span><span>`);
  </span><span><span class="hljs-keyword">return</span></span><span> sessionId;
}
</span></span></code></div></div></pre>
<ul data-start="6466" data-end="6475">
<li data-start="6466" data-end="6475">
<p data-start="6468" data-end="6475">打日志并返回。</p>
</li>
</ul>
<hr data-start="6477" data-end="6480">
<h3 data-start="6482" data-end="6524">convertToUpstreamFormat：OpenAI → 上游请求体</h3>
<pre class="overflow-visible! px-0!" data-start="6526" data-end="6778"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span><span class="hljs-comment">/**
 * 将 OpenAI 格式请求转换为上游格式
 */</span>
</span><span><span class="hljs-keyword">function</span></span><span> </span><span><span class="hljs-title function_">convertToUpstreamFormat</span></span><span>(</span><span><span class="hljs-params">openaiRequest</span></span><span>) {
  </span><span><span class="hljs-variable language_">console</span></span><span>.</span><span><span class="hljs-title function_">log</span></span><span>(</span><span><span class="hljs-string">"[转换] 正在将 OpenAI 格式转换为上游格式..."</span></span><span>);
  </span><span><span class="hljs-keyword">return</span></span><span> {
    </span><span><span class="hljs-attr">messages</span></span><span>: openaiRequest.</span><span><span class="hljs-property">messages</span></span><span>,
    </span><span><span class="hljs-attr">sessionId</span></span><span>: </span><span><span class="hljs-title function_">generateSessionId</span></span><span>(),
    </span><span><span class="hljs-attr">searchContext</span></span><span>: </span><span><span class="hljs-string">""</span></span><span>
  };
}
</span></span></code></div></div></pre>
<ul data-start="6779" data-end="6894">
<li data-start="6779" data-end="6894">
<p data-start="6781" data-end="6808">作用：把 OpenAI 的请求体映射为上游期望的字段：</p>
<ul data-start="6811" data-end="6894">
<li data-start="6811" data-end="6828">
<p data-start="6813" data-end="6828"><code data-start="6813" data-end="6823">messages</code>：直接复用</p>
</li>
<li data-start="6831" data-end="6848">
<p data-start="6833" data-end="6848"><code data-start="6833" data-end="6844">sessionId</code>：新生成</p>
</li>
<li data-start="6851" data-end="6894">
<p data-start="6853" data-end="6894"><code data-start="6853" data-end="6868">searchContext</code>：固定空字符串（可能是上游支持检索增强的上下文字段）</p>
</li>
</ul>
</li>
</ul>
<hr data-start="6896" data-end="6899">
<h3 data-start="6901" data-end="6948">convertToOpenAIFormat：上游 → OpenAI 响应体（含伪流式）</h3>
<pre class="overflow-visible! px-0!" data-start="6950" data-end="7063"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span><span class="hljs-comment">/**
 * 将上游响应转换为 OpenAI 格式
 */</span>
</span><span><span class="hljs-keyword">function</span></span><span> </span><span><span class="hljs-title function_">convertToOpenAIFormat</span></span><span>(</span><span><span class="hljs-params">upstreamResponse, model, stream = <span class="hljs-literal">false</span></span></span><span>) {
</span></span></code></div></div></pre>
<ul data-start="7064" data-end="7171">
<li data-start="7064" data-end="7171">
<p data-start="7066" data-end="7069">入参：</p>
<ul data-start="7072" data-end="7171">
<li data-start="7072" data-end="7127">
<p data-start="7074" data-end="7127"><code data-start="7074" data-end="7092">upstreamResponse</code>：上游 JSON（期望含 <code data-start="7105" data-end="7114">content</code>、可能含 <code data-start="7119" data-end="7126">usage</code>）</p>
</li>
<li data-start="7130" data-end="7150">
<p data-start="7132" data-end="7150"><code data-start="7132" data-end="7139">model</code>：返回给客户端的模型名</p>
</li>
<li data-start="7153" data-end="7171">
<p data-start="7155" data-end="7171"><code data-start="7155" data-end="7163">stream</code>：是否用流式响应</p>
</li>
</ul>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="7173" data-end="7270"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-keyword">const</span></span><span> id = </span><span><span class="hljs-string">`chatcmpl-<span class="hljs-subst">${<span class="hljs-built_in">Date</span></span></span></span><span>.now()}`;
  </span><span><span class="hljs-keyword">const</span></span><span> created = </span><span><span class="hljs-title class_">Math</span></span><span>.</span><span><span class="hljs-title function_">floor</span></span><span>(</span><span><span class="hljs-title class_">Date</span></span><span>.</span><span><span class="hljs-title function_">now</span></span><span>() / </span><span><span class="hljs-number">1000</span></span><span>);
</span></span></code></div></div></pre>
<ul data-start="7271" data-end="7321">
<li data-start="7271" data-end="7301">
<p data-start="7273" data-end="7301">生成一个类似 OpenAI 的响应 id（用时间戳拼）。</p>
</li>
<li data-start="7302" data-end="7321">
<p data-start="7304" data-end="7321"><code data-start="7304" data-end="7313">created</code> 用秒级时间戳。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="7323" data-end="7399"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-keyword">if</span></span><span> (stream) {
    </span><span><span class="hljs-variable language_">console</span></span><span>.</span><span><span class="hljs-title function_">log</span></span><span>(</span><span><span class="hljs-string">"[转换] 正在将上游响应转换为 OpenAI 流式格式..."</span></span><span>);
</span></span></code></div></div></pre>
<ul data-start="7400" data-end="7430">
<li data-start="7400" data-end="7430">
<p data-start="7402" data-end="7430">如果 stream 模式，准备输出 SSE chunk。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="7432" data-end="7674"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>    </span><span><span class="hljs-keyword">const</span></span><span> chunk = {
      id,
      </span><span><span class="hljs-attr">object</span></span><span>: </span><span><span class="hljs-string">"chat.completion.chunk"</span></span><span>,
      created,
      model,
      </span><span><span class="hljs-attr">choices</span></span><span>: [{
        </span><span><span class="hljs-attr">index</span></span><span>: </span><span><span class="hljs-number">0</span></span><span>,
        </span><span><span class="hljs-attr">delta</span></span><span>: { </span><span><span class="hljs-attr">content</span></span><span>: upstreamResponse.</span><span><span class="hljs-property">content</span></span><span> },
        </span><span><span class="hljs-attr">finish_reason</span></span><span>: </span><span><span class="hljs-string">"stop"</span></span><span>
      }]
    };
</span></span></code></div></div></pre>
<ul data-start="7675" data-end="7793">
<li data-start="7675" data-end="7753">
<p data-start="7677" data-end="7694">组装一个“流式 chunk”对象：</p>
<ul data-start="7697" data-end="7753">
<li data-start="7697" data-end="7720">
<p data-start="7699" data-end="7720"><code data-start="7699" data-end="7714">delta.content</code> 放上游内容</p>
</li>
<li data-start="7723" data-end="7753">
<p data-start="7725" data-end="7753"><code data-start="7725" data-end="7748">finish_reason: "stop"</code> 表示结束</p>
</li>
</ul>
</li>
<li data-start="7754" data-end="7793">
<p data-start="7756" data-end="7793">注意：真实 OpenAI 流式通常会多次推送 chunk，这里一次就结束。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="7795" data-end="7873"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>    </span><span><span class="hljs-keyword">return</span></span><span> </span><span><span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span></span></span></span><span>.stringify(chunk)}\n\ndata: [DONE]\n\n`;
  }
</span></span></code></div></div></pre>
<ul data-start="7874" data-end="7927">
<li data-start="7874" data-end="7927">
<p data-start="7876" data-end="7927">返回 SSE 文本：先 <code data-start="7888" data-end="7905">data: {...}\n\n</code>，再 <code data-start="7908" data-end="7926">data: [DONE]\n\n</code>。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="7929" data-end="8353"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-variable language_">console</span></span><span>.</span><span><span class="hljs-title function_">log</span></span><span>(</span><span><span class="hljs-string">"[转换] 正在将上游响应转换为 OpenAI JSON 格式..."</span></span><span>);
  </span><span><span class="hljs-keyword">return</span></span><span> {
    id,
    </span><span><span class="hljs-attr">object</span></span><span>: </span><span><span class="hljs-string">"chat.completion"</span></span><span>,
    created,
    model,
    </span><span><span class="hljs-attr">choices</span></span><span>: [{
      </span><span><span class="hljs-attr">index</span></span><span>: </span><span><span class="hljs-number">0</span></span><span>,
      </span><span><span class="hljs-attr">message</span></span><span>: {
        </span><span><span class="hljs-attr">role</span></span><span>: </span><span><span class="hljs-string">"assistant"</span></span><span>,
        </span><span><span class="hljs-attr">content</span></span><span>: upstreamResponse.</span><span><span class="hljs-property">content</span></span><span>
      },
      </span><span><span class="hljs-attr">finish_reason</span></span><span>: </span><span><span class="hljs-string">"stop"</span></span><span>
    }],
    </span><span><span class="hljs-attr">usage</span></span><span>: upstreamResponse.</span><span><span class="hljs-property">usage</span></span><span> || {
      </span><span><span class="hljs-attr">prompt_tokens</span></span><span>: </span><span><span class="hljs-number">0</span></span><span>,
      </span><span><span class="hljs-attr">completion_tokens</span></span><span>: </span><span><span class="hljs-number">0</span></span><span>,
      </span><span><span class="hljs-attr">total_tokens</span></span><span>: </span><span><span class="hljs-number">0</span></span><span>
    }
  };
}
</span></span></code></div></div></pre>
<ul data-start="8354" data-end="8465">
<li data-start="8354" data-end="8465">
<p data-start="8356" data-end="8378">非 stream：返回标准 JSON 结构：</p>
<ul data-start="8381" data-end="8465">
<li data-start="8381" data-end="8409">
<p data-start="8383" data-end="8409"><code data-start="8383" data-end="8409">message.role="assistant"</code></p>
</li>
<li data-start="8412" data-end="8437">
<p data-start="8414" data-end="8437"><code data-start="8414" data-end="8431">message.content</code> 用上游内容</p>
</li>
<li data-start="8440" data-end="8465">
<p data-start="8442" data-end="8465"><code data-start="8442" data-end="8449">usage</code> 如果上游不给，就填 0（占位）</p>
</li>
</ul>
</li>
</ul>
<hr data-start="8467" data-end="8470">
<h3 data-start="8472" data-end="8503">handleChatCompletion：核心代理逻辑</h3>
<pre class="overflow-visible! px-0!" data-start="8505" data-end="8595"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span><span class="hljs-comment">/**
 * 处理聊天完成请求
 */</span>
</span><span><span class="hljs-keyword">async</span></span><span> </span><span><span class="hljs-keyword">function</span></span><span> </span><span><span class="hljs-title function_">handleChatCompletion</span></span><span>(</span><span><span class="hljs-params">request, upstreamHost</span></span><span>) {
</span></span></code></div></div></pre>
<ul data-start="8596" data-end="8634">
<li data-start="8596" data-end="8634">
<p data-start="8598" data-end="8634">处理 <code data-start="8601" data-end="8628">POST /v1/chat/completions</code> 的主函数。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="8636" data-end="8748"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-variable language_">console</span></span><span>.</span><span><span class="hljs-title function_">log</span></span><span>(</span><span><span class="hljs-string">"[聊天处理] 开始处理 /v1/chat/completions 请求..."</span></span><span>);
  </span><span><span class="hljs-keyword">const</span></span><span> openaiRequest = </span><span><span class="hljs-keyword">await</span></span><span> request.</span><span><span class="hljs-title function_">json</span></span><span>();
</span></span></code></div></div></pre>
<ul data-start="8749" data-end="8774">
<li data-start="8749" data-end="8774">
<p data-start="8751" data-end="8774">读入 JSON 请求体（OpenAI 风格）。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="8776" data-end="8883"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-keyword">const</span></span><span> stream = openaiRequest.</span><span><span class="hljs-property">stream</span></span><span> === </span><span><span class="hljs-literal">true</span></span><span>;
  </span><span><span class="hljs-keyword">const</span></span><span> model = openaiRequest.</span><span><span class="hljs-property">model</span></span><span> || </span><span><span class="hljs-string">"kimi-k2"</span></span><span>;
</span></span></code></div></div></pre>
<ul data-start="8884" data-end="8925">
<li data-start="8884" data-end="8906">
<p data-start="8886" data-end="8906">判断是否流式（必须显式 <code data-start="8898" data-end="8904">true</code>）。</p>
</li>
<li data-start="8907" data-end="8925">
<p data-start="8909" data-end="8925">模型名默认 <code data-start="8915" data-end="8924">kimi-k2</code>。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="8927" data-end="8995"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-variable language_">console</span></span><span>.</span><span><span class="hljs-title function_">log</span></span><span>(</span><span><span class="hljs-string">`[聊天处理] 请求参数: 模型=<span class="hljs-subst">${model}</span></span></span><span>, 是否流式=</span><span><span class="hljs-subst">${stream}</span></span><span>`);
</span></span></code></div></div></pre>
<ul data-start="8996" data-end="9003">
<li data-start="8996" data-end="9003">
<p data-start="8998" data-end="9003">打印参数。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="9005" data-end="9140"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-keyword">const</span></span><span> authCookies = </span><span><span class="hljs-keyword">await</span></span><span> </span><span><span class="hljs-title function_">getAuthCookies</span></span><span>(upstreamHost);
  </span><span><span class="hljs-keyword">if</span></span><span> (!authCookies || !authCookies.</span><span><span class="hljs-property">csrf</span></span><span> || !authCookies.</span><span><span class="hljs-property">callback</span></span><span>) {
</span></span></code></div></div></pre>
<ul data-start="9141" data-end="9185">
<li data-start="9141" data-end="9162">
<p data-start="9143" data-end="9162">调用前面的“获取 cookie”逻辑。</p>
</li>
<li data-start="9163" data-end="9185">
<p data-start="9165" data-end="9185">如果对象不存在或关键字段缺失则认为失败。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="9187" data-end="9419"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>    </span><span><span class="hljs-variable language_">console</span></span><span>.</span><span><span class="hljs-title function_">error</span></span><span>(</span><span><span class="hljs-string">"[聊天处理] 错误: 获取认证 Cookies 失败, 中断请求"</span></span><span>);
    </span><span><span class="hljs-keyword">return</span></span><span> </span><span><span class="hljs-keyword">new</span></span><span> </span><span><span class="hljs-title class_">Response</span></span><span>(</span><span><span class="hljs-title class_">JSON</span></span><span>.</span><span><span class="hljs-title function_">stringify</span></span><span>({ </span><span><span class="hljs-attr">error</span></span><span>: </span><span><span class="hljs-string">"Failed to get auth cookies"</span></span><span> }), {
      </span><span><span class="hljs-attr">status</span></span><span>: </span><span><span class="hljs-number">500</span></span><span>,
      </span><span><span class="hljs-attr">headers</span></span><span>: { </span><span><span class="hljs-string">"content-type"</span></span><span>: </span><span><span class="hljs-string">"application/json"</span></span><span> }
    });
  }
</span></span></code></div></div></pre>
<ul data-start="9420" data-end="9445">
<li data-start="9420" data-end="9445">
<p data-start="9422" data-end="9445">返回 500，并给客户端一个 JSON 错误。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="9447" data-end="9583"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-keyword">const</span></span><span> upstreamRequest = </span><span><span class="hljs-title function_">convertToUpstreamFormat</span></span><span>(openaiRequest);
  </span><span><span class="hljs-variable language_">console</span></span><span>.</span><span><span class="hljs-title function_">log</span></span><span>(</span><span><span class="hljs-string">`[聊天处理] 准备向上游 <span class="hljs-subst">${upstreamHost}</span></span></span><span>/api/chat 发送请求`);
</span></span></code></div></div></pre>
<ul data-start="9584" data-end="9602">
<li data-start="9584" data-end="9602">
<p data-start="9586" data-end="9602">把请求转换为上游格式并日志提示。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="9604" data-end="10030"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-keyword">const</span></span><span> chatHeaders = </span><span><span class="hljs-title function_">generateSpoofedHeaders</span></span><span>({
    </span><span><span class="hljs-string">"content-type"</span></span><span>: </span><span><span class="hljs-string">"application/json"</span></span><span>,
    </span><span><span class="hljs-string">"user-agent"</span></span><span>: </span><span><span class="hljs-string">"Mozilla/5.0 ... Chrome/131.0.0.0 Safari/537.36"</span></span><span>,
    </span><span><span class="hljs-string">"accept"</span></span><span>: </span><span><span class="hljs-string">"*/*"</span></span><span>,
    </span><span><span class="hljs-string">"accept-language"</span></span><span>: </span><span><span class="hljs-string">"zh-CN,zh;q=0.9,en;q=0.8"</span></span><span>,
    </span><span><span class="hljs-string">"origin"</span></span><span>: upstreamHost,
    </span><span><span class="hljs-string">"referer"</span></span><span>: </span><span><span class="hljs-string">`<span class="hljs-subst">${upstreamHost}</span></span></span><span>/zh/chat`,
    </span><span><span class="hljs-string">"cookie"</span></span><span>: </span><span><span class="hljs-string">`__Host-authjs.csrf-token=<span class="hljs-subst">${authCookies.csrf}</span></span></span><span>; __Secure-authjs.callback-url=</span><span><span class="hljs-subst">${authCookies.callback}</span></span><span>`
  });
</span></span></code></div></div></pre>
<ul data-start="10031" data-end="10232">
<li data-start="10031" data-end="10169">
<p data-start="10033" data-end="10057">组装发往上游 <code data-start="10040" data-end="10051">/api/chat</code> 的请求头：</p>
<ul data-start="10060" data-end="10169">
<li data-start="10060" data-end="10084">
<p data-start="10062" data-end="10084"><code data-start="10062" data-end="10076">content-type</code> 指明 JSON</p>
</li>
<li data-start="10087" data-end="10122">
<p data-start="10089" data-end="10122"><code data-start="10089" data-end="10116">origin/referer/user-agent</code> 模拟浏览器</p>
</li>
<li data-start="10125" data-end="10151">
<p data-start="10127" data-end="10151"><code data-start="10127" data-end="10135">cookie</code> 手动拼接两个 cookie 值</p>
</li>
<li data-start="10154" data-end="10169">
<p data-start="10156" data-end="10169">再叠加伪造 IP 的那些头</p>
</li>
</ul>
</li>
<li data-start="10170" data-end="10232">
<p data-start="10172" data-end="10232">（提醒）手动伪造 cookie/header 的做法常涉及绕过认证/风控；这里我只解释结构，不提供如何增强成功率的指导。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="10234" data-end="10406"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-keyword">const</span></span><span> upstreamResponse = </span><span><span class="hljs-keyword">await</span></span><span> </span><span><span class="hljs-title function_">fetch</span></span><span>(</span><span><span class="hljs-string">`<span class="hljs-subst">${upstreamHost}</span></span></span><span>/api/chat`, {
    </span><span><span class="hljs-attr">method</span></span><span>: </span><span><span class="hljs-string">"POST"</span></span><span>,
    </span><span><span class="hljs-attr">headers</span></span><span>: chatHeaders,
    </span><span><span class="hljs-attr">body</span></span><span>: </span><span><span class="hljs-title class_">JSON</span></span><span>.</span><span><span class="hljs-title function_">stringify</span></span><span>(upstreamRequest)
  });
</span></span></code></div></div></pre>
<ul data-start="10407" data-end="10446">
<li data-start="10407" data-end="10446">
<p data-start="10409" data-end="10446">POST 到上游 <code data-start="10418" data-end="10429">/api/chat</code>，body 为转换后的 JSON。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="10448" data-end="10522"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-variable language_">console</span></span><span>.</span><span><span class="hljs-title function_">log</span></span><span>(</span><span><span class="hljs-string">`[聊天处理] 收到上游响应, 状态码: <span class="hljs-subst">${upstreamResponse.status}</span></span></span><span>`);
</span></span></code></div></div></pre>
<ul data-start="10523" data-end="10533">
<li data-start="10523" data-end="10533">
<p data-start="10525" data-end="10533">打印上游响应码。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="10535" data-end="10832"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-keyword">if</span></span><span> (!upstreamResponse.</span><span><span class="hljs-property">ok</span></span><span>) {
    </span><span><span class="hljs-variable language_">console</span></span><span>.</span><span><span class="hljs-title function_">error</span></span><span>(</span><span><span class="hljs-string">`[聊天处理] 错误: 上游请求失败, 状态码: <span class="hljs-subst">${upstreamResponse.status}</span></span></span><span>`);
    </span><span><span class="hljs-keyword">return</span></span><span> </span><span><span class="hljs-keyword">new</span></span><span> </span><span><span class="hljs-title class_">Response</span></span><span>(</span><span><span class="hljs-title class_">JSON</span></span><span>.</span><span><span class="hljs-title function_">stringify</span></span><span>({ </span><span><span class="hljs-attr">error</span></span><span>: </span><span><span class="hljs-string">"Upstream request failed"</span></span><span> }), {
      </span><span><span class="hljs-attr">status</span></span><span>: upstreamResponse.</span><span><span class="hljs-property">status</span></span><span>,
      </span><span><span class="hljs-attr">headers</span></span><span>: { </span><span><span class="hljs-string">"content-type"</span></span><span>: </span><span><span class="hljs-string">"application/json"</span></span><span> }
    });
  }
</span></span></code></div></div></pre>
<ul data-start="10833" data-end="10862">
<li data-start="10833" data-end="10862">
<p data-start="10835" data-end="10862">若非 2xx，则把错误透传回客户端（状态码沿用上游）。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="10864" data-end="10967"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-keyword">const</span></span><span> upstreamData = </span><span><span class="hljs-keyword">await</span></span><span> upstreamResponse.</span><span><span class="hljs-title function_">json</span></span><span>();
  </span><span><span class="hljs-variable language_">console</span></span><span>.</span><span><span class="hljs-title function_">log</span></span><span>(</span><span><span class="hljs-string">"[聊天处理] 成功解析上游 JSON 响应"</span></span><span>);
</span></span></code></div></div></pre>
<ul data-start="10968" data-end="10986">
<li data-start="10968" data-end="10986">
<p data-start="10970" data-end="10986">解析上游 JSON，并记录成功。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="10988" data-end="11324"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-keyword">if</span></span><span> (stream) {
    </span><span><span class="hljs-variable language_">console</span></span><span>.</span><span><span class="hljs-title function_">log</span></span><span>(</span><span><span class="hljs-string">"[聊天处理] 正在以流式 (SSE) 格式返回响应"</span></span><span>);
    </span><span><span class="hljs-keyword">const</span></span><span> streamData = </span><span><span class="hljs-title function_">convertToOpenAIFormat</span></span><span>(upstreamData, model, </span><span><span class="hljs-literal">true</span></span><span>);
    </span><span><span class="hljs-keyword">return</span></span><span> </span><span><span class="hljs-keyword">new</span></span><span> </span><span><span class="hljs-title class_">Response</span></span><span>(streamData, {
      </span><span><span class="hljs-attr">headers</span></span><span>: {
        </span><span><span class="hljs-string">"content-type"</span></span><span>: </span><span><span class="hljs-string">"text/event-stream"</span></span><span>,
        </span><span><span class="hljs-string">"cache-control"</span></span><span>: </span><span><span class="hljs-string">"no-cache"</span></span><span>,
        </span><span><span class="hljs-string">"connection"</span></span><span>: </span><span><span class="hljs-string">"keep-alive"</span></span><span>
      }
    });
  }
</span></span></code></div></div></pre>
<ul data-start="11325" data-end="11433">
<li data-start="11325" data-end="11433">
<p data-start="11327" data-end="11341">如果客户端要 stream：</p>
<ul data-start="11344" data-end="11433">
<li data-start="11344" data-end="11362">
<p data-start="11346" data-end="11362">把上游结果转换为 SSE 字符串</p>
</li>
<li data-start="11365" data-end="11401">
<p data-start="11367" data-end="11401">返回 <code data-start="11370" data-end="11389">text/event-stream</code>，并设置不缓存、保持连接</p>
</li>
<li data-start="11404" data-end="11433">
<p data-start="11406" data-end="11433">但如前所述：这里不是逐段推送，只返回一次 chunk。</p>
</li>
</ul>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="11435" data-end="11677"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-variable language_">console</span></span><span>.</span><span><span class="hljs-title function_">log</span></span><span>(</span><span><span class="hljs-string">"[聊天处理] 正在以 JSON 格式返回响应"</span></span><span>);
  </span><span><span class="hljs-keyword">const</span></span><span> openaiResponse = </span><span><span class="hljs-title function_">convertToOpenAIFormat</span></span><span>(upstreamData, model, </span><span><span class="hljs-literal">false</span></span><span>);
  </span><span><span class="hljs-keyword">return</span></span><span> </span><span><span class="hljs-keyword">new</span></span><span> </span><span><span class="hljs-title class_">Response</span></span><span>(</span><span><span class="hljs-title class_">JSON</span></span><span>.</span><span><span class="hljs-title function_">stringify</span></span><span>(openaiResponse), {
    </span><span><span class="hljs-attr">headers</span></span><span>: { </span><span><span class="hljs-string">"content-type"</span></span><span>: </span><span><span class="hljs-string">"application/json"</span></span><span> }
  });
}
</span></span></code></div></div></pre>
<ul data-start="11678" data-end="11709">
<li data-start="11678" data-end="11709">
<p data-start="11680" data-end="11709">非 stream：转换为 OpenAI JSON 并返回。</p>
</li>
</ul>
<hr data-start="11711" data-end="11714">
<h3 data-start="11716" data-end="11744">addCorsHeaders：给响应补 CORS</h3>
<pre class="overflow-visible! px-0!" data-start="11746" data-end="11814"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span><span class="hljs-comment">/**
 * 添加 CORS 响应头
 */</span>
</span><span><span class="hljs-keyword">function</span></span><span> </span><span><span class="hljs-title function_">addCorsHeaders</span></span><span>(</span><span><span class="hljs-params">response</span></span><span>) {
</span></span></code></div></div></pre>
<ul data-start="11815" data-end="11854">
<li data-start="11815" data-end="11854">
<p data-start="11817" data-end="11854">包装函数：输入 Response，输出带 CORS 的 Response。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="11856" data-end="11917"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-keyword">const</span></span><span> newHeaders = </span><span><span class="hljs-keyword">new</span></span><span> </span><span><span class="hljs-title class_">Headers</span></span><span>(response.</span><span><span class="hljs-property">headers</span></span><span>);
</span></span></code></div></div></pre>
<ul data-start="11918" data-end="11948">
<li data-start="11918" data-end="11948">
<p data-start="11920" data-end="11948">复制一份 headers（避免直接修改原对象/更安全）。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="11950" data-end="12166"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  newHeaders.</span><span><span class="hljs-title function_">set</span></span><span>(</span><span><span class="hljs-string">"Access-Control-Allow-Origin"</span></span><span>, </span><span><span class="hljs-string">"*"</span></span><span>);
  newHeaders.</span><span><span class="hljs-title function_">set</span></span><span>(</span><span><span class="hljs-string">"Access-Control-Allow-Methods"</span></span><span>, </span><span><span class="hljs-string">"GET, POST, OPTIONS"</span></span><span>);
  newHeaders.</span><span><span class="hljs-title function_">set</span></span><span>(</span><span><span class="hljs-string">"Access-Control-Allow-Headers"</span></span><span>, </span><span><span class="hljs-string">"Content-Type, Authorization"</span></span><span>);
</span></span></code></div></div></pre>
<ul data-start="12167" data-end="12253">
<li data-start="12167" data-end="12253">
<p data-start="12169" data-end="12176">设置允许跨域：</p>
<ul data-start="12179" data-end="12253">
<li data-start="12179" data-end="12191">
<p data-start="12181" data-end="12191">允许任意来源 <code data-start="12188" data-end="12191">*</code></p>
</li>
<li data-start="12194" data-end="12215">
<p data-start="12196" data-end="12215">允许 GET/POST/OPTIONS</p>
</li>
<li data-start="12218" data-end="12253">
<p data-start="12220" data-end="12253">允许 <code data-start="12223" data-end="12237">Content-Type</code>、<code data-start="12238" data-end="12253">Authorization</code></p>
</li>
</ul>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="12255" data-end="12401"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-keyword">return</span></span><span> </span><span><span class="hljs-keyword">new</span></span><span> </span><span><span class="hljs-title class_">Response</span></span><span>(response.</span><span><span class="hljs-property">body</span></span><span>, {
    </span><span><span class="hljs-attr">status</span></span><span>: response.</span><span><span class="hljs-property">status</span></span><span>,
    </span><span><span class="hljs-attr">statusText</span></span><span>: response.</span><span><span class="hljs-property">statusText</span></span><span>,
    </span><span><span class="hljs-attr">headers</span></span><span>: newHeaders
  });
}
</span></span></code></div></div></pre>
<ul data-start="12402" data-end="12458">
<li data-start="12402" data-end="12458">
<p data-start="12404" data-end="12458">用同样的 body 和状态码，构造一个新 Response，但 headers 换成加了 CORS 的版本。</p>
</li>
</ul>
<hr data-start="12460" data-end="12463">
<h3 data-start="12465" data-end="12490">handleRequest：路由分发与预检</h3>
<pre class="overflow-visible! px-0!" data-start="12492" data-end="12565"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span><span class="hljs-comment">/**
 * 主请求处理函数
 */</span>
</span><span><span class="hljs-keyword">async</span></span><span> </span><span><span class="hljs-keyword">function</span></span><span> </span><span><span class="hljs-title function_">handleRequest</span></span><span>(</span><span><span class="hljs-params">request, env</span></span><span>) {
</span></span></code></div></div></pre>
<ul data-start="12566" data-end="12581">
<li data-start="12566" data-end="12581">
<p data-start="12568" data-end="12581">总入口：按路径和方法分发。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="12583" data-end="12659"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-keyword">const</span></span><span> upstreamHost = env.</span><span><span class="hljs-property">UPSTREAM_HOST</span></span><span> || </span><span><span class="hljs-variable constant_">DEFAULT_UPSTREAM_HOST</span></span><span>;
</span></span></code></div></div></pre>
<ul data-start="12660" data-end="12679">
<li data-start="12660" data-end="12679">
<p data-start="12662" data-end="12679">从环境变量取上游域名，否则用默认。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="12681" data-end="12790"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-keyword">const</span></span><span> url = </span><span><span class="hljs-keyword">new</span></span><span> </span><span><span class="hljs-title function_">URL</span></span><span>(request.</span><span><span class="hljs-property">url</span></span><span>);
  </span><span><span class="hljs-variable language_">console</span></span><span>.</span><span><span class="hljs-title function_">log</span></span><span>(</span><span><span class="hljs-string">`[入口] 收到新请求: <span class="hljs-subst">${request.method}</span></span></span><span> </span><span><span class="hljs-subst">${url.pathname}</span></span><span>`);
</span></span></code></div></div></pre>
<ul data-start="12791" data-end="12824">
<li data-start="12791" data-end="12813">
<p data-start="12793" data-end="12813">解析 URL（拿到 pathname）。</p>
</li>
<li data-start="12814" data-end="12824">
<p data-start="12816" data-end="12824">打印方法和路径。</p>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="12826" data-end="13179"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-comment">// 处理 CORS 预检请求</span></span><span>
  </span><span><span class="hljs-keyword">if</span></span><span> (request.</span><span><span class="hljs-property">method</span></span><span> === </span><span><span class="hljs-string">"OPTIONS"</span></span><span>) {
    </span><span><span class="hljs-keyword">return</span></span><span> </span><span><span class="hljs-keyword">new</span></span><span> </span><span><span class="hljs-title class_">Response</span></span><span>(</span><span><span class="hljs-literal">null</span></span><span>, {
      </span><span><span class="hljs-attr">headers</span></span><span>: {
        </span><span><span class="hljs-string">"Access-Control-Allow-Origin"</span></span><span>: </span><span><span class="hljs-string">"*"</span></span><span>,
        </span><span><span class="hljs-string">"Access-Control-Allow-Methods"</span></span><span>: </span><span><span class="hljs-string">"GET, POST, OPTIONS"</span></span><span>,
        </span><span><span class="hljs-string">"Access-Control-Allow-Headers"</span></span><span>: </span><span><span class="hljs-string">"Content-Type, Authorization"</span></span><span>,
        </span><span><span class="hljs-string">"Access-Control-Max-Age"</span></span><span>: </span><span><span class="hljs-string">"86400"</span></span><span>
      }
    });
  }
</span></span></code></div></div></pre>
<ul data-start="13180" data-end="13268">
<li data-start="13180" data-end="13268">
<p data-start="13182" data-end="13202">浏览器跨域会先发 OPTIONS 预检：</p>
<ul data-start="13205" data-end="13268">
<li data-start="13205" data-end="13219">
<p data-start="13207" data-end="13219">这里直接返回空 body</p>
</li>
<li data-start="13222" data-end="13268">
<p data-start="13224" data-end="13268"><code data-start="13224" data-end="13255">Access-Control-Max-Age: 86400</code> 表示预检结果缓存 1 天</p>
</li>
</ul>
</li>
</ul>
<pre class="overflow-visible! px-0!" data-start="13270" data-end="13295"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-keyword">let</span></span><span> response;
</span></span></code></div></div></pre>
<ul data-start="13296" data-end="13314">
<li data-start="13296" data-end="13314">
<p data-start="13298" data-end="13314">声明变量，后续装不同路由的响应。</p>
</li>
</ul>
<hr data-start="13316" data-end="13319">
<h4 data-start="13321" data-end="13333">/health</h4>
<pre class="overflow-visible! px-0!" data-start="13335" data-end="13723"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-comment">// 健康检查端点</span></span><span>
  </span><span><span class="hljs-keyword">if</span></span><span> (url.</span><span><span class="hljs-property">pathname</span></span><span> === </span><span><span class="hljs-string">"/health"</span></span><span> &amp;&amp; request.</span><span><span class="hljs-property">method</span></span><span> === </span><span><span class="hljs-string">"GET"</span></span><span>) {
    </span><span><span class="hljs-variable language_">console</span></span><span>.</span><span><span class="hljs-title function_">log</span></span><span>(</span><span><span class="hljs-string">"[路由] 匹配到: /health (GET)"</span></span><span>);
    response = </span><span><span class="hljs-keyword">new</span></span><span> </span><span><span class="hljs-title class_">Response</span></span><span>(</span><span><span class="hljs-title class_">JSON</span></span><span>.</span><span><span class="hljs-title function_">stringify</span></span><span>({
      </span><span><span class="hljs-attr">status</span></span><span>: </span><span><span class="hljs-string">"healthy"</span></span><span>,
      </span><span><span class="hljs-attr">timestamp</span></span><span>: </span><span><span class="hljs-keyword">new</span></span><span> </span><span><span class="hljs-title class_">Date</span></span><span>().</span><span><span class="hljs-title function_">toISOString</span></span><span>(),
      </span><span><span class="hljs-attr">upstreamHost</span></span><span>: upstreamHost
    }), {
      </span><span><span class="hljs-attr">headers</span></span><span>: { </span><span><span class="hljs-string">"content-type"</span></span><span>: </span><span><span class="hljs-string">"application/json"</span></span><span> }
    });
    </span><span><span class="hljs-keyword">return</span></span><span> </span><span><span class="hljs-title function_">addCorsHeaders</span></span><span>(response);
  }
</span></span></code></div></div></pre>
<ul data-start="13724" data-end="13790">
<li data-start="13724" data-end="13790">
<p data-start="13726" data-end="13744">如果是 <code data-start="13730" data-end="13743">GET /health</code>：</p>
<ul data-start="13747" data-end="13790">
<li data-start="13747" data-end="13771">
<p data-start="13749" data-end="13771">返回 JSON：健康状态、当前时间、上游地址</p>
</li>
<li data-start="13774" data-end="13790">
<p data-start="13776" data-end="13790">然后加上 CORS 头再返回</p>
</li>
</ul>
</li>
</ul>
<hr data-start="13792" data-end="13795">
<h4 data-start="13797" data-end="13822">/v1/chat/completions</h4>
<pre class="overflow-visible! px-0!" data-start="13824" data-end="14088"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-comment">// 聊天完成端点</span></span><span>
  </span><span><span class="hljs-keyword">if</span></span><span> (url.</span><span><span class="hljs-property">pathname</span></span><span> === </span><span><span class="hljs-string">"/v1/chat/completions"</span></span><span> &amp;&amp; request.</span><span><span class="hljs-property">method</span></span><span> === </span><span><span class="hljs-string">"POST"</span></span><span>) {
    </span><span><span class="hljs-variable language_">console</span></span><span>.</span><span><span class="hljs-title function_">log</span></span><span>(</span><span><span class="hljs-string">"[路由] 匹配到: /v1/chat/completions (POST)"</span></span><span>);
    response = </span><span><span class="hljs-keyword">await</span></span><span> </span><span><span class="hljs-title function_">handleChatCompletion</span></span><span>(request, upstreamHost);
    </span><span><span class="hljs-keyword">return</span></span><span> </span><span><span class="hljs-title function_">addCorsHeaders</span></span><span>(response);
  }
</span></span></code></div></div></pre>
<ul data-start="14089" data-end="14137">
<li data-start="14089" data-end="14137">
<p data-start="14091" data-end="14108">如果命中 OpenAI 兼容端点：</p>
<ul data-start="14111" data-end="14137">
<li data-start="14111" data-end="14121">
<p data-start="14113" data-end="14121">调用核心代理函数</p>
</li>
<li data-start="14124" data-end="14137">
<p data-start="14126" data-end="14137">给返回结果加 CORS</p>
</li>
</ul>
</li>
</ul>
<hr data-start="14139" data-end="14142">
<h4 data-start="14144" data-end="14159">/v1/models</h4>
<pre class="overflow-visible! px-0!" data-start="14161" data-end="14621"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-comment">// 模型列表端点</span></span><span>
  </span><span><span class="hljs-keyword">if</span></span><span> (url.</span><span><span class="hljs-property">pathname</span></span><span> === </span><span><span class="hljs-string">"/v1/models"</span></span><span> &amp;&amp; request.</span><span><span class="hljs-property">method</span></span><span> === </span><span><span class="hljs-string">"GET"</span></span><span>) {
    </span><span><span class="hljs-variable language_">console</span></span><span>.</span><span><span class="hljs-title function_">log</span></span><span>(</span><span><span class="hljs-string">"[路由] 匹配到: /v1/models (GET)"</span></span><span>);
    response = </span><span><span class="hljs-keyword">new</span></span><span> </span><span><span class="hljs-title class_">Response</span></span><span>(</span><span><span class="hljs-title class_">JSON</span></span><span>.</span><span><span class="hljs-title function_">stringify</span></span><span>({
      </span><span><span class="hljs-attr">object</span></span><span>: </span><span><span class="hljs-string">"list"</span></span><span>,
      </span><span><span class="hljs-attr">data</span></span><span>: [{
        </span><span><span class="hljs-attr">id</span></span><span>: </span><span><span class="hljs-string">"kimi-k2"</span></span><span>,
        </span><span><span class="hljs-attr">object</span></span><span>: </span><span><span class="hljs-string">"model"</span></span><span>,
        </span><span><span class="hljs-attr">created</span></span><span>: </span><span><span class="hljs-title class_">Math</span></span><span>.</span><span><span class="hljs-title function_">floor</span></span><span>(</span><span><span class="hljs-title class_">Date</span></span><span>.</span><span><span class="hljs-title function_">now</span></span><span>() / </span><span><span class="hljs-number">1000</span></span><span>),
        </span><span><span class="hljs-attr">owned_by</span></span><span>: </span><span><span class="hljs-string">"kimi"</span></span><span>
      }]
    }), {
      </span><span><span class="hljs-attr">headers</span></span><span>: { </span><span><span class="hljs-string">"content-type"</span></span><span>: </span><span><span class="hljs-string">"application/json"</span></span><span> }
    });
    </span><span><span class="hljs-keyword">return</span></span><span> </span><span><span class="hljs-title function_">addCorsHeaders</span></span><span>(response);
  }
</span></span></code></div></div></pre>
<ul data-start="14622" data-end="14712">
<li data-start="14622" data-end="14649">
<p data-start="14624" data-end="14649">返回一个固定模型列表（只有 <code data-start="14638" data-end="14647">kimi-k2</code>）。</p>
</li>
<li data-start="14650" data-end="14712">
<p data-start="14652" data-end="14712">字段结构模仿 OpenAI 的 models list：<code data-start="14680" data-end="14696">object: "list"</code>, <code data-start="14698" data-end="14711">data: [...]</code>。</p>
</li>
</ul>
<hr data-start="14714" data-end="14717">
<h4 data-start="14719" data-end="14729">未匹配路由</h4>
<pre class="overflow-visible! px-0!" data-start="14731" data-end="14851"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>  </span><span><span class="hljs-variable language_">console</span></span><span>.</span><span><span class="hljs-title function_">log</span></span><span>(</span><span><span class="hljs-string">`[路由] 未找到匹配路由: <span class="hljs-subst">${url.pathname}</span></span></span><span>, 返回 404`);
  </span><span><span class="hljs-keyword">return</span></span><span> </span><span><span class="hljs-keyword">new</span></span><span> </span><span><span class="hljs-title class_">Response</span></span><span>(</span><span><span class="hljs-string">"Not Found"</span></span><span>, { </span><span><span class="hljs-attr">status</span></span><span>: </span><span><span class="hljs-number">404</span></span><span> });
}
</span></span></code></div></div></pre>
<ul data-start="14852" data-end="14870">
<li data-start="14852" data-end="14870">
<p data-start="14854" data-end="14870">所有路由都不匹配则返回 404。</p>
</li>
</ul>
<hr data-start="14872" data-end="14875">
<h3 data-start="14877" data-end="14892">Worker 导出入口</h3>
<pre class="overflow-visible! px-0!" data-start="14894" data-end="15026"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span><span class="hljs-comment">// Cloudflare Worker 导出</span></span><span>
</span><span><span class="hljs-keyword">export</span></span><span> </span><span><span class="hljs-keyword">default</span></span><span> {
  </span><span><span class="hljs-keyword">async</span></span><span> </span><span><span class="hljs-title function_">fetch</span></span><span>(</span><span><span class="hljs-params">request, env, ctx</span></span><span>) {
    </span><span><span class="hljs-keyword">return</span></span><span> </span><span><span class="hljs-title function_">handleRequest</span></span><span>(request, env);
  }
};
</span></span></code></div></div></pre>
<ul data-start="15027" data-end="15131">
<li data-start="15027" data-end="15080">
<p data-start="15029" data-end="15080">Cloudflare Workers 的模块式写法：导出一个对象，包含 <code data-start="15065" data-end="15072">fetch</code> 方法作为入口。</p>
</li>
<li data-start="15081" data-end="15101">
<p data-start="15083" data-end="15101"><code data-start="15083" data-end="15088">ctx</code>（执行上下文）这里没用到。</p>
</li>
<li data-start="15102" data-end="15131">
<p data-start="15104" data-end="15131">所有请求都交给 <code data-start="15112" data-end="15127">handleRequest</code> 分发。</p>
</li>
</ul>
<hr data-start="15133" data-end="15136">
<h2 data-start="15138" data-end="15166">如果你想把它改成“合规的 OpenAI 兼容代理”</h2>
<p data-start="15168" data-end="15207">如果你的目标是“提供 OpenAI 兼容接口，但对接一个合法上游”，通常建议：</p>
<ul data-start="15208" data-end="15398">
<li data-start="15208" data-end="15259">
<p data-start="15210" data-end="15259">使用上游<strong data-start="15214" data-end="15248">官方 API Key / OAuth / 服务端 token</strong>，不要抓 cookie</p>
</li>
<li data-start="15260" data-end="15348">
<p data-start="15262" data-end="15348">不要伪造 <code data-start="15267" data-end="15301">X-Forwarded-For/CF-Connecting-IP</code> 等头；如需传递真实客户端信息，用 Cloudflare 提供的真实连接信息或你自己的鉴权方案</p>
</li>
<li data-start="15349" data-end="15398">
<p data-start="15351" data-end="15398">真流式：用 <code data-start="15357" data-end="15373">ReadableStream</code> 边读上游边转发为 SSE（而不是一次性拼字符串）</p>
</li>
</ul>
<p data-start="15400" data-end="15495" data-is-last-node="" data-is-only-node="">如果你愿意，我也可以在不涉及绕过/伪造的前提下，帮你把这份代码“重构成合规版模板”（保留路由、CORS、OpenAI schema、真正的流式转发），并指出需要你从上游拿到哪些正式鉴权信息。</p></div>
        </div>
<div class="message-block role-user">
          <div class="message-role">You</div>
          <div class="message-content">跟我讲一下这种通信吧，我对你上面说的内容一点都不同</div>
        </div>
<div class="message-block role-ai">
          <div class="message-role">AI</div>
          <div class="message-content"><p data-start="0" data-end="120">好，我用“从零开始、按通信链路”把它讲清楚：这段代码里主要涉及 <strong data-start="32" data-end="40">三种通信</strong>：普通 HTTP/JSON、SSE 流式（Server-Sent Events）、以及浏览器跨域的 CORS 预检。你可以把它理解成一个“翻译+转发”的中转站。</p>
<hr data-start="122" data-end="125">
<h2 data-start="127" data-end="172">1) 整体通信链路：客户端 → Worker → 上游 → Worker → 客户端</h2>
<p data-start="174" data-end="180">你请求的是：</p>
<ul data-start="182" data-end="345">
<li data-start="182" data-end="242">
<p data-start="184" data-end="242">客户端（你的程序/网页/SDK）把请求打到 <strong data-start="206" data-end="227">Cloudflare Worker</strong>（它就是一个 HTTP 服务）</p>
</li>
<li data-start="243" data-end="292">
<p data-start="245" data-end="292">Worker 再把请求打到 <strong data-start="259" data-end="267">上游站点</strong>（默认 <code data-start="271" data-end="291">https://kimi-k2.ai</code>）</p>
</li>
<li data-start="293" data-end="309">
<p data-start="295" data-end="309">上游返回结果给 Worker</p>
</li>
<li data-start="310" data-end="345">
<p data-start="312" data-end="345">Worker 把结果“包装成 OpenAI 兼容格式”返回给客户端</p>
</li>
</ul>
<p data-start="347" data-end="397">所以 Worker 的角色是：<strong data-start="362" data-end="396">反向代理 + 协议适配器（OpenAI 格式 ↔ 上游格式）</strong>。</p>
<hr data-start="399" data-end="402">
<h2 data-start="404" data-end="440">2) 通信 ①：普通 HTTP + JSON（最常见的请求/响应）</h2>
<h3 data-start="442" data-end="467">客户端 → Worker（JSON 请求）</h3>
<p data-start="468" data-end="524">当你发 <code data-start="472" data-end="499">POST /v1/chat/completions</code> 时，请求体是 JSON，典型长这样（概念示例）：</p>
<ul data-start="526" data-end="676">
<li data-start="526" data-end="540">
<p data-start="528" data-end="540">HTTP 方法：POST</p>
</li>
<li data-start="541" data-end="568">
<p data-start="543" data-end="568">路径：<code data-start="546" data-end="568">/v1/chat/completions</code></p>
</li>
<li data-start="569" data-end="610">
<p data-start="571" data-end="610">Header：<code data-start="578" data-end="610">Content-Type: application/json</code></p>
</li>
<li data-start="611" data-end="676">
<p data-start="613" data-end="624">Body（JSON）：</p>
<ul data-start="627" data-end="676">
<li data-start="627" data-end="636">
<p data-start="629" data-end="636"><code data-start="629" data-end="636">model</code></p>
</li>
<li data-start="639" data-end="659">
<p data-start="641" data-end="659"><code data-start="641" data-end="651">messages</code>（一组对话消息）</p>
</li>
<li data-start="662" data-end="676">
<p data-start="664" data-end="676"><code data-start="664" data-end="672">stream</code>（可选）</p>
</li>
</ul>
</li>
</ul>
<p data-start="678" data-end="721">Worker 用 <code data-start="687" data-end="709">await request.json()</code> 把 JSON 读出来。</p>
<h3 data-start="723" data-end="747">Worker → 上游（JSON 请求）</h3>
<p data-start="748" data-end="783">Worker 会把这个 JSON <strong data-start="765" data-end="771">转换</strong>成上游需要的结构，然后：</p>
<ul data-start="785" data-end="877">
<li data-start="785" data-end="877">
<p data-start="787" data-end="877"><code data-start="787" data-end="877">fetch(upstreamHost + "/api/chat", { method:"POST", headers, body: JSON.stringify(...) })</code></p>
</li>
</ul>
<h3 data-start="879" data-end="903">上游 → Worker（JSON 响应）</h3>
<p data-start="904" data-end="941">上游返回一个 JSON（至少包含 <code data-start="921" data-end="930">content</code>），Worker 用：</p>
<ul data-start="943" data-end="976">
<li data-start="943" data-end="976">
<p data-start="945" data-end="976"><code data-start="945" data-end="976">await upstreamResponse.json()</code></p>
</li>
</ul>
<h3 data-start="978" data-end="1003">Worker → 客户端（JSON 响应）</h3>
<p data-start="1004" data-end="1045">如果你没有 <code data-start="1010" data-end="1023">stream=true</code>，它返回一个 OpenAI 风格 JSON：</p>
<ul data-start="1047" data-end="1149">
<li data-start="1047" data-end="1081">
<p data-start="1049" data-end="1081"><code data-start="1049" data-end="1081">content-type: application/json</code></p>
</li>
<li data-start="1082" data-end="1149">
<p data-start="1084" data-end="1149">body：<code data-start="1089" data-end="1149">{ id, object, created, model, choices: [...], usage: ... }</code></p>
</li>
</ul>
<p data-start="1151" data-end="1188"><strong data-start="1151" data-end="1188">这就是最标准的“请求一次，响应一次”的 HTTP/JSON 通信。</strong></p>
<hr data-start="1190" data-end="1193">
<h2 data-start="1195" data-end="1234">3) 通信 ②：SSE 流式通信（Server-Sent Events）</h2>
<p data-start="1236" data-end="1276">你上面说“我提到的内容你一点都不懂”，通常卡点就在这里：<strong data-start="1264" data-end="1275">什么叫“流式”</strong>。</p>
<h3 data-start="1278" data-end="1290">SSE 是什么？</h3>
<p data-start="1291" data-end="1318">SSE 是一种基于 HTTP 的<strong data-start="1307" data-end="1315">单向推送</strong>机制：</p>
<ul data-start="1320" data-end="1452">
<li data-start="1320" data-end="1341">
<p data-start="1322" data-end="1341">仍然是 HTTP 请求（客户端发出去）</p>
</li>
<li data-start="1342" data-end="1383">
<p data-start="1344" data-end="1383">服务器返回 <code data-start="1350" data-end="1383">Content-Type: text/event-stream</code></p>
</li>
<li data-start="1384" data-end="1394">
<p data-start="1386" data-end="1394">连接不会马上关掉</p>
</li>
<li data-start="1395" data-end="1425">
<p data-start="1397" data-end="1425">服务器可以<strong data-start="1402" data-end="1417">不断往这个连接里写事件</strong>（一段一段输出）</p>
</li>
<li data-start="1426" data-end="1452">
<p data-start="1428" data-end="1452">客户端就能“边收到边显示”，不用等整个答案生成完</p>
</li>
</ul>
<h3 data-start="1454" data-end="1470">SSE 的数据长什么样？</h3>
<p data-start="1471" data-end="1515">SSE 的传输格式是一行行文本，每个事件通常以 <code data-start="1495" data-end="1502">data:</code> 开头，以空行结尾，例如：</p>
<pre class="overflow-visible! px-0!" data-start="1517" data-end="1591"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">kotlin</div><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="复制"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-i9agxugi.svg#ce3544" fill="currentColor"></use></svg>复制代码</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre!"><span><span><span class="hljs-keyword">data</span></span><span>: {</span><span><span class="hljs-string">"some"</span></span><span>:</span><span><span class="hljs-string">"json"</span></span><span>}
  
</span><span><span class="hljs-keyword">data</span></span><span>: {</span><span><span class="hljs-string">"some"</span></span><span>:</span><span><span class="hljs-string">"json2"</span></span><span>}
  
</span><span><span class="hljs-keyword">data</span></span><span>: [DONE]
  
</span></span></code></div></div></pre>
<p data-start="1593" data-end="1612">（空行是 SSE 的“事件分隔符”。）</p>
<h3 data-start="1614" data-end="1640">这段代码的 “stream” 做法（关键点）</h3>
<p data-start="1641" data-end="1681">它确实返回了 <code data-start="1648" data-end="1667">text/event-stream</code>，但它其实是<strong data-start="1673" data-end="1680">伪流式</strong>：</p>
<ul data-start="1683" data-end="1735">
<li data-start="1683" data-end="1695">
<p data-start="1685" data-end="1695">它并没有“多次推送”</p>
</li>
<li data-start="1696" data-end="1735">
<p data-start="1698" data-end="1735">它是把完整结果一次性放进一个 chunk 里，然后立刻发 <code data-start="1727" data-end="1735">[DONE]</code></p>
</li>
</ul>
<p data-start="1737" data-end="1783">也就是说：<br data-start="1742" data-end="1745">
<strong data-start="1745" data-end="1783">形式上是 SSE，体验上更像一次性返回，只是包装成 SSE 的格式。</strong></p>
<p data-start="1785" data-end="1843">如果你期待的是 ChatGPT 那种“逐字往外蹦”，那需要服务器端“持续写入”并且上游也得支持真正的流式读取/转发。</p>
<hr data-start="1845" data-end="1848">
<h2 data-start="1850" data-end="1886">4) 通信 ③：浏览器跨域 CORS（以及 OPTIONS 预检）</h2>
<p data-start="1888" data-end="1927">如果你用网页直接调用 Worker（不同域名），浏览器会执行 CORS 规则：</p>
<h3 data-start="1929" data-end="1950">为什么会有 OPTIONS 预检？</h3>
<p data-start="1951" data-end="2038">当浏览器认为你的请求“可能不安全”（比如带 <code data-start="1973" data-end="2005">Content-Type: application/json</code>、带自定义头、带 Authorization 等），它会先发一个：</p>
<ul data-start="2040" data-end="2072">
<li data-start="2040" data-end="2072">
<p data-start="2042" data-end="2072"><code data-start="2042" data-end="2072">OPTIONS /v1/chat/completions</code></p>
</li>
</ul>
<p data-start="2074" data-end="2115">问服务器：“我等下能不能用 POST 发 JSON？能不能带这些 header？”</p>
<h3 data-start="2117" data-end="2133">Worker 怎么回答？</h3>
<p data-start="2134" data-end="2152">代码里对 OPTIONS 直接返回：</p>
<ul data-start="2154" data-end="2337">
<li data-start="2154" data-end="2188">
<p data-start="2156" data-end="2188"><code data-start="2156" data-end="2188">Access-Control-Allow-Origin: *</code></p>
</li>
<li data-start="2189" data-end="2241">
<p data-start="2191" data-end="2241"><code data-start="2191" data-end="2241">Access-Control-Allow-Methods: GET, POST, OPTIONS</code></p>
</li>
<li data-start="2242" data-end="2303">
<p data-start="2244" data-end="2303"><code data-start="2244" data-end="2303">Access-Control-Allow-Headers: Content-Type, Authorization</code></p>
</li>
<li data-start="2304" data-end="2337">
<p data-start="2306" data-end="2337"><code data-start="2306" data-end="2337">Access-Control-Max-Age: 86400</code></p>
</li>
</ul>
<p data-start="2339" data-end="2386">这表示：<br data-start="2343" data-end="2346">
“随便哪个网站都能跨域调用我；允许 POST/JSON；预检结果可以缓存一天。”</p>
<p data-start="2388" data-end="2417"><strong data-start="2388" data-end="2417">所以这段 Worker 很适合被前端网页直接调用。</strong></p>
<hr data-start="2419" data-end="2422">
<h2 data-start="2424" data-end="2454">5) 还有一种“通信”：请求头/身份信息在链路里怎么传</h2>
<p data-start="2456" data-end="2488">你可能也困惑：为什么它要搞那么多 headers、cookie？</p>
<h3 data-start="2490" data-end="2505">Cookie 是什么？</h3>
<p data-start="2506" data-end="2595">Cookie 是服务器发给客户端的一种“会话标识”，浏览器之后访问同站点时会自动带上。<br data-start="2549" data-end="2552">
这段 Worker 不是浏览器，所以它要自己去拿 cookie、再自己拼进下一次请求。</p>
<h3 data-start="2597" data-end="2621">那些 IP 相关 header 是什么？</h3>
<p data-start="2622" data-end="2740">比如 <code data-start="2625" data-end="2642">X-Forwarded-For</code>、<code data-start="2643" data-end="2661">CF-Connecting-IP</code> 等，一般是<strong data-start="2667" data-end="2677">代理/CDN</strong>用来告诉上游“原始客户端 IP 是谁”。<br data-start="2697" data-end="2700">
客户端伪造这些 header 在很多系统里属于<strong data-start="2723" data-end="2730">不可信</strong>或者会触发安全策略。</p>
<p data-start="2742" data-end="2771">我能解释它们的“用途”，但不建议把它们当作绕过风控的手段。</p>
<hr data-start="2773" data-end="2776">
<h2 data-start="2778" data-end="2797">6) 用一张“心智模型”快速记住</h2>
<p data-start="2799" data-end="2806">把它当成三层：</p>
<ol data-start="2808" data-end="2820">
<li data-start="2808" data-end="2820">
<p data-start="2811" data-end="2820"><strong data-start="2811" data-end="2820">应用层协议</strong></p>
</li>
</ol>
<ul data-start="2821" data-end="2872">
<li data-start="2821" data-end="2837">
<p data-start="2823" data-end="2837">普通：HTTP + JSON</p>
</li>
<li data-start="2838" data-end="2872">
<p data-start="2840" data-end="2872">流式：HTTP + SSE（text/event-stream）</p>
</li>
</ul>
<ol start="2" data-start="2874" data-end="2887">
<li data-start="2874" data-end="2887">
<p data-start="2877" data-end="2887"><strong data-start="2877" data-end="2887">浏览器安全层</strong></p>
</li>
</ol>
<ul data-start="2888" data-end="2916">
<li data-start="2888" data-end="2916">
<p data-start="2890" data-end="2916">CORS + OPTIONS 预检（浏览器才会强制）</p>
</li>
</ul>
<ol start="3" data-start="2918" data-end="2931">
<li data-start="2918" data-end="2931">
<p data-start="2921" data-end="2931"><strong data-start="2921" data-end="2931">会话/身份层</strong></p>
</li>
</ol>
<ul data-start="2932" data-end="2975">
<li data-start="2932" data-end="2975">
<p data-start="2934" data-end="2975">Cookie / Authorization / 一些标识头（谁在请求、是否登录）</p>
</li>
</ul>
<hr data-start="2977" data-end="2980">
<p data-start="2982" data-end="3143" data-is-last-node="" data-is-only-node="">如果你愿意，我可以按你的使用场景来讲得更贴：<br data-start="3004" data-end="3007">
你是 <strong data-start="3010" data-end="3021">在浏览器里调用</strong>（前端 fetch）？还是 <strong data-start="3035" data-end="3048">在后端/脚本里调用</strong>（curl/Node/Python）？<br data-start="3067" data-end="3070">
不用你再贴代码，你只要回答“前端/后端”两个字，我就能用对应视角把这三种通信串起来讲一遍，并给你一个最小可运行的请求示例（不涉及任何伪造/绕过）。</p></div>
        </div>
</body>
</html>