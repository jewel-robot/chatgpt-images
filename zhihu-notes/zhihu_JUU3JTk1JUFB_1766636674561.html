<meta itemprop="headline" content="番外一：重新审视 EM Planner的规划框架"><meta itemprop="url" content="https://zhuanlan.zhihu.com/p/1979534602667323915"><meta itemprop="datePublished" content="2025-12-23T15:37:59.000Z"><meta itemprop="dateModified" content="2025-12-23T15:37:59.000Z"><meta itemprop="commentCount" content="2"><header class="Post-Header"><h1 class="Post-Title">番外一：重新审视 EM Planner的规划框架</h1><div class="Post-Author"><div class="AuthorInfo" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><div class="AuthorInfo"><meta itemprop="name" content="胖胖橙"><meta itemprop="image" content="https://pica.zhimg.com/v2-8ab856e72fbe4edb7642df4788e3055e_xl.jpg?source=32738c0c&amp;needBackground=1"><meta itemprop="url" content="https://www.zhihu.com/people/wang-hao-cheng-71"><meta itemprop="zhihu:followerCount" content="917"><span class="UserLink AuthorInfo-avatarWrapper"><div class="css-1gomreu"><a href="//www.zhihu.com/people/wang-hao-cheng-71" target="_blank" class="UserLink-link" data-za-detail-view-element_name="User"><img class="Avatar AuthorInfo-avatar css-mc624r" src="https://pica.zhimg.com/v2-8ab856e72fbe4edb7642df4788e3055e_l.jpg?source=32738c0c&amp;needBackground=1" srcset="https://pica.zhimg.com/v2-8ab856e72fbe4edb7642df4788e3055e_l.jpg?source=32738c0c&amp;needBackground=1 2x" alt="胖胖橙"></a></div></span><div class="AuthorInfo-content"><div class="AuthorInfo-head"><span class="UserLink AuthorInfo-name"><div class="css-1gomreu"><a href="//www.zhihu.com/people/wang-hao-cheng-71" target="_blank" class="UserLink-link" data-za-detail-view-element_name="User">胖胖橙</a></div></span></div><div class="AuthorInfo-detail"><div class="AuthorInfo-badge"><div class="ztext AuthorInfo-badgeText css-0">广阔天地 大有作为</div></div></div></div></div></div><button type="button" class="Button FollowButton FEfUrdfMIKpQDJDqkjte Button--primary Button--blue epMJl0lFQuYbC7jrwr_o JmYzaky7MEPMFcJDLNMG"><span style="display:inline-flex;align-items:center">​<svg width="1.2em" height="1.2em" viewBox="0 0 24 24" class="Zi Zi--Plus FollowButton-icon" fill="currentColor"><path fill-rule="evenodd" d="M13.25 3.25a1.25 1.25 0 1 0-2.5 0v7.5h-7.5a1.25 1.25 0 1 0 0 2.5h7.5v7.5a1.25 1.25 0 1 0 2.5 0v-7.5h7.5a1.25 1.25 0 0 0 0-2.5h-7.5v-7.5Z" clip-rule="evenodd"></path></svg></span>关注他</button></div><div class="css-9x8rdd"><div class="css-q2wk8b"><a class="css-n4rzfz" href="https://www.zhihu.com/column/c_1865469663493877760" style="cursor:pointer"><svg width="20" height="20" viewBox="0 0 24 24" fill="#1772F6" class="ZDI ZDI--ColumnFill24 css-1tu59u4"><path fill-rule="evenodd" d="M7.1 2.625A3.475 3.475 0 0 0 3.625 6.1v13.83a1.875 1.875 0 0 0 2.668 1.699l5.22-2.437c.302-.14.65-.14.95 0l5.246 2.44a1.875 1.875 0 0 0 2.666-1.7V6.1A3.475 3.475 0 0 0 16.9 2.625H7.1ZM16.375 9a.875.875 0 0 1-.875.875h-7a.875.875 0 1 1 0-1.75h7c.483 0 .875.392.875.875ZM8.5 13.875h7a.875.875 0 0 0 0-1.75h-7a.875.875 0 0 0 0 1.75Z" clip-rule="evenodd"></path></svg><div class="css-4rl99m"><div class="css-140fcia">收录于 · 自动驾驶决策与规划</div></div><svg width="12" height="12" viewBox="0 0 16 16" fill="#1772F6" class="ZDI ZDI--ArrowRight16 css-77ab9r"><path fill-rule="evenodd" d="M6.252 2.328a.75.75 0 0 1 1.04.213l3.334 5.05a.75.75 0 0 1 0 .826L7.292 13.46a.75.75 0 0 1-1.251-.828L9.1 8.004 6.04 3.367a.75.75 0 0 1 .212-1.039Z" clip-rule="evenodd"></path></svg></a></div></div><div><div class="css-dvccr2"><div class="css-1lr85n">12 人赞同了该文章</div><svg width="14px" height="14px" viewBox="0 0 16 16" class="ZDI ZDI--ArrowRight16 css-z4ujak" fill="currentColor"><path fill-rule="evenodd" d="M6.252 2.328a.75.75 0 0 1 1.04.213l3.334 5.05a.75.75 0 0 1 0 .826L7.292 13.46a.75.75 0 0 1-1.251-.828L9.1 8.004 6.04 3.367a.75.75 0 0 1 .212-1.039Z" clip-rule="evenodd"></path></svg></div></div><span class="css-z4ujak"></span><div role="button" tabindex="0" class="ContentItem-time" style="padding: 0px;">发布于 2025-12-23 23:37<!-- -->・<!-- -->江苏</div></header><div class="Post-RichTextContainer"><div class="css-1od93p9"><div class="css-376mun"><div class="css-h7wqi8"><div class="css-gzps3f"><div class="css-lcgmxk"><div><div class="Catalog isCatalogV2 css-2hy5iv" data-za-detail-view-name="正文"><div class="css-8kjoqe"><div class="css-u56wtg"><span style="display: inline-flex; align-items: center;">​<svg width="1.2em" height="1.2em" viewBox="0 0 24 24" class="ZDI ZDI--Catalog24" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 0 1 1-1h10a1 1 0 1 1 0 2H11a1 1 0 0 1-1-1Zm4 6a1 1 0 1 0 0 2h7a1 1 0 1 0 0-2h-7Zm0 7a1 1 0 1 0 0 2h7a1 1 0 1 0 0-2h-7Zm-8.335.25a.915.915 0 0 1-.915-.915V12.75H10a.75.75 0 0 0 0-1.5H4.75V6.665c0-.505.41-.915.915-.915H7a.75.75 0 0 0 0-1.5H5.665A2.415 2.415 0 0 0 3.25 6.665v10.67a2.415 2.415 0 0 0 2.415 2.415H10a.75.75 0 0 0 0-1.5H5.665Z" clip-rule="evenodd"></path></svg></span><div class="css-1czzy4f">目录</div></div></div></div></div></div></div></div><span id="content"><div class="RichText ztext Post-RichText css-1olvdus" options="[object Object]"><h2 data-first-child="" id="h_1979534602667323915_0" data-into-catalog-status="">0. 引言：为什么要重新审视 EM Planner</h2><p data-pid="70Ek_uhx">在自动驾驶量产规划系统中，轨迹生成既需要满足复杂的几何与动力学约束，又必须在极短的时间预算内稳定运行。如何在高维、强非凸的时空约束下，构建一个可解释、可调试、可工程化落地的规划框架，是业界长期面临的核心问题。</p><p data-pid="QeB4DkgO">Apollo EM Planner 正是在这一背景下诞生的经典方案。它通过将三维时空轨迹规划问题拆解为 Path（空间）与 Speed（时间）两个低维子问题，并借助 EM-like 迭代机制不断对齐二者的一致性，成为过去十余年中被广泛采用的量产级规划架构。</p><p data-pid="7C2o3eRb">本文将从工程视角系统解析 EM Planner 的设计动机、核心机制与内在假设，并进一步讨论其在真实复杂场景中的局限性，为后续规划方法向统一时空建模演进奠定背景基础。</p><h2 id="h_1979534602667323915_1" data-into-catalog-status=""><b>1.  </b>轨迹规划的工程现实：为什么 3D 问题不可直接求解</h2><p data-pid="Y-lAMnK6">轨迹规划本质上是一个连续 3D 优化问题： <span class="ztext-math" data-eeimg="1" data-tex=" \min_{x(t),y(t)} J(x(t),y(t)) "><span></span><span><script type="math/tex;mode=inline"> \min_{x(t),y(t)} J(x(t),y(t)) </script><span class="tex2jax_ignore math-holder"> \min_{x(t),y(t)} J(x(t),y(t)) </span></span></span> ，</p><p data-pid="qh_AhlLU">但道路结构、障碍物与车辆动力学导致该问题 高度非凸，维度高，实时不可解。在早期车规算力与算法条件下，直接求解三维时空轨迹优化问题在工程上并不现实。</p><p data-pid="Qla51bWL">Apollo 的关键设计是：</p><blockquote data-pid="Y31wcu-E"> 将 3D 时空轨迹优化拆解为两个 2D 优化问题：SL Path（横向） + ST Speed（纵向），再使用 EM-like 迭代框架使两者互相收敛。</blockquote><ol><li data-pid="7H-xXYKH"><b>Path：解决“往哪走”</b> 只考虑 SL 平面几何（空间避障）  </li><li data-pid="gDC1Gw07"><b>Speed：解决“什么时候走、走多快”</b> 在固定的路径上处理 ST 避障（时间避障）  </li></ol><figure data-size="normal"><div><img src="https://pica.zhimg.com/v2-55438aa6d288e47630f5f6c4409c0a84_1440w.jpg" data-size="normal" data-rawwidth="804" data-rawheight="785" data-original-token="v2-1e9f3c3fd2a5c07f3d02422562b81fe2" class="origin_image zh-lightbox-thumb" width="804" data-original="https://pica.zhimg.com/v2-55438aa6d288e47630f5f6c4409c0a84_r.jpg"></div><figcaption>EM Framework</figcaption></figure><h3 id="h_1979534602667323915_2" data-into-catalog-status="">1.1 EM Iteration</h3><p data-pid="QTOCGnjT">把Path 与 Speed分开优化，会存在以下问题：</p><p data-pid="u9hjNtNR">● Path 认为自己正在超车（绕左）</p><p data-pid="fQ5VQaXq">但 Speed 决定继续跟车（降低速度） → 出现 行为不一致：车辆横向往左走，但纵向仍慢速跟车 → 奇怪的 “半超车” 行为</p><p data-pid="5eWV0xWa">● Path 决定右绕障碍</p><p data-pid="iiqeKQJY">但 Speed 在 ST 图上发现时机不对，选择刹车等待 → Path 需要根据新的速度重新评估 SL 障碍</p><p data-pid="XoicKRjw">● Speed 发现某个动态障碍预测严重冲突，要 yield，但 Path 的 DP 仍给出直行→ 实际车辆会蛇行</p><hr><p data-pid="MH-MyZPZ">Path 与 Speed 是在不同空间（SL vs ST）优化的，必须通过 EM 迭代才能相互对齐。EM Planner 并非严格意义上的 EM 算法，而是一种工程化的交替优化框架。</p><p data-pid="1xVmJ28s"><b>Step 1（M-step）：Path Planning 先运行</b></p><p data-pid="5CnPqGqq">在假设速度 profile 已知的情况下：</p><ul><li data-pid="Dn05CBfN">计算动态障碍在 SL 平面的可达区域</li><li data-pid="GT_RSppt">通过 DP 搜索路径拓扑（左绕/右绕/贴线等）</li><li data-pid="fFXTc4Z0">用 QP 对轨迹进行平滑优化</li></ul><p data-pid="2wRyLa9N"><b>Step 2（E-step）：Speed Planning 再运行</b></p><p data-pid="6DoUH417">在假设路径已知的情况下：</p><ul><li data-pid="iPg2PvKY">构建 ST Boundaries（速度障碍）</li><li data-pid="qXbmsMMB">通过 DP 生成粗速度</li><li data-pid="uSf49cAW">用 QP 优化速度 profile</li></ul><p data-pid="cdXK6S7e"><b>Step 3：收敛检查</b></p><p data-pid="Zt_0P6C5">若 path 与 speed 不一致（如 path 想超车、speed 仍在跟车），则：</p><ul><li data-pid="bBBQxMG8">更新动态障碍投影</li><li data-pid="7WsGPr_s">再次执行 step1 与 step2</li></ul><figure data-size="normal"><div><img src="https://pica.zhimg.com/v2-9865d120e0abbcddd22218011057353a_1440w.jpg" data-size="normal" data-rawwidth="886" data-rawheight="463" data-original-token="v2-a0a65d0d2d96073c4c5cbcd700402168" class="origin_image zh-lightbox-thumb" width="886" data-original="https://pica.zhimg.com/v2-9865d120e0abbcddd22218011057353a_r.jpg"></div><figcaption>EM Iteration</figcaption></figure><hr><h3 id="h_1979534602667323915_3" data-into-catalog-status=""> 1.2 EM 循环主要解决三类关键问题：</h3><p data-pid="_phu41x0"><b> 1.动态障碍 SL 投影依赖 speed → 需要同步速度与空间路线</b></p><p data-pid="pgmBYd03">动态障碍的位置在 SL 平面上依赖 ego 的速度：</p><ul><li data-pid="lQ0E_3dI"> ego 快 → 会更早遇到障碍 → SL 投影往前</li><li data-pid="fwiq6kYQ"> ego 慢 → SL 投影变短 → Path 可选区域变大</li></ul><p data-pid="oCAtuMR-">所以第一次 Path 用的是“上一周期速度”，可能不准确。</p><p data-pid="k5QXiyKt">Speed 第二次更新速度后，就必须反过来刷新 SL 投影 → 然后 Path 重新规划。EM 循环方能让 SL 投影正确对齐。</p><p data-pid="COo_UUrA"><b>2.Path 决策拓扑（左绕、右绕、贴线）与速度行为（跟车、超车、停）要一致</b></p><p data-pid="n6yiJEmu">如果不进行 EM：</p><ul><li data-pid="mmVkIdiQ"> Path 可能给出超车拓扑</li><li data-pid="FINnGzLE"> Speed 在 ST 图里又发现不可行</li><li data-pid="now8lfO8"> 车辆行为出现抖动和不稳定</li></ul><p data-pid="r2MJwAVY">EM 的机制：Path ← Speed 约束 ， Speed ← Path 拓扑   不断互相收缩可行域直到一致</p><p data-pid="2rQ7inia"><b> 3. 最终保证轨迹可行、平滑、无冲突</b></p><p data-pid="72t7YuCL">一次 Path 决策不可能考虑所有动态场景：</p><ul><li data-pid="8TBibyjQ"> merge car cut-in</li><li data-pid="mUsXsTym"> oncoming vehicle yield</li><li data-pid="E8D2JYZw"> 低速障碍绕行</li><li data-pid="iEIvEywM"> 静态障碍 nudge</li></ul><p data-pid="k8Q14_Rf">Speed 也不可能在一次 DP/QP 中完成所有避障。</p><p data-pid="w6QZpTmj">因此 EM 提供了一个 <b>在多层次约束下逼近一致解的过程</b>。</p><p data-pid="5XJn6lU_"><i>“Path and speed planning are iteratively refined to reach a consistent trajectory.”</i></p><hr><h2 id="h_1979534602667323915_4" data-into-catalog-status="">2. EM Planner：Path Planning 路径规划</h2><p data-pid="6-oKpLsD">EM 的关键假设：</p><blockquote data-pid="X9I6n6Ru"> 在 Path 优化阶段，把动态障碍投影成 SL 几何的“静态障碍带”。因此 Path 部分的输入是 <i>空间几何约束</i>，输出是 <i>光滑连续的横向轨迹</i>。</blockquote><p data-pid="Sq9xtAkT">Path Planning的三个关键步骤： SL Projection --&gt; DP Path Search --&gt; QP Path Optimization</p><h3 id="h_1979534602667323915_5" data-into-catalog-status=""><b>2.1 SL Projection（动态障碍 → 空间障碍）</b></h3><blockquote data-pid="rUB8G8S3"> “The speed profile from the last cycle is used to estimate interactions with oncoming and low-speed dynamic obstacles … we assume a static environment.”</blockquote><p data-pid="V8QKVywJ"><b>为什么需要 SL Projection？</b></p><p data-pid="DplHqRb8">障碍物是动态的，但 Path 优化希望看到“静态几何形状”。<br>因此，需要用上一周期的速度曲线把障碍物从时间维度“压缩”成 SL 维度的障碍带（blocking zone）。</p><p data-pid="kZ-1kHL8">例如，若上一周期预测 ego 会在 3 秒后抵达 s=20，那么前车在 3 秒时所在的 SL 区域会被标记为“障碍阻挡区”。</p><figure data-size="normal"><div><img src="https://pic4.zhimg.com/v2-d6b1cfe5ccc3061cd79f4186b7890399_1440w.jpg" data-size="normal" data-rawwidth="1372" data-rawheight="230" data-original-token="v2-8f53c7935aba8ef475b9118859e7dd69" class="origin_image zh-lightbox-thumb" width="1372" data-original="https://pic4.zhimg.com/v2-d6b1cfe5ccc3061cd79f4186b7890399_r.jpg"></div><figcaption>SL Projection with oncoming traffic example</figcaption></figure><hr><h3 id="h_1979534602667323915_6" data-into-catalog-status=""><b>2.2 DP Path Decision（粗路径拓扑搜索）</b></h3><p data-pid="356ZkP-C">DP 的作用不是微调，而是<b>决定路径拓扑结构</b>： 绕障从左还是右？是否微调/nudge？corridor 内有没有连续可行 tunnel？</p><p data-pid="wzlZgQx5"><b>DP Path Planning 的本质是：在纵向分层、横向采样的 SL lattice 上，用五次多项式连接节点形成可行的边，并基于平滑度、障碍距离和参考线偏离等 cost，通过 DP 搜索代价最小的粗路径。</b></p><p data-pid="6TJtWGb0">所以 DP 输出的是：<br><b>一条粗糙但“拓扑正确”的路径</b><br>但 DP 的缺点是： <b>DP path is suboptimal，</b> 因为 lattice 图有限，没有覆盖全连续空间，解只在图上最优但不是真正最优，所以需要QP。</p><figure data-size="normal"><div><img src="https://pic4.zhimg.com/v2-2c672bd4f3ffbb1b7a857407d8d2fdd5_1440w.jpg" data-size="normal" data-rawwidth="478" data-rawheight="150" data-original-token="v2-f15352f7639183745855b722834ead7a" class="origin_image zh-lightbox-thumb" width="478" data-original="https://pic4.zhimg.com/v2-2c672bd4f3ffbb1b7a857407d8d2fdd5_r.jpg"></div><figcaption>DP Path Planning</figcaption></figure><p data-pid="3-vVIQs8"><br><b> 1. 离散化 s-lattice（纵向分层，横向采样）</b></p><p data-pid="4rzVHlYN">将未来规划区间按纵向 s 坐标分成若干“行”（layers），<br>每一行（固定 s）上布置多个可能的横向采样点 l_i：</p><div class="highlight"><pre><code class="language-text">s = s0:   l = [-1.0, -0.5, 0, 0.5, 1.0]
s = s1:   l = [-1.0, -0.5, 0, 0.5, 1.0]
s = s2:   l = [-1.0, -0.5, 0, 0.5, 1.0]
...</code></pre></div><p data-pid="o8-Xdvz3">这样构成了一个 <b>2D 网格图（lattice graph）</b>。</p><p data-pid="MorZKHft"><b>2. 不同行的点之间用 quintic polynomial（五次多项式）连接成边</b></p><p data-pid="y-NBoRj2">SL 中相邻行之间的每两点可以构成一条五次多项式曲线：</p><p data-pid="IehnTLk4"><span class="ztext-math" data-eeimg="1" data-tex="l(s) = a_0 + a_1 s + a_2 s^2 + a_3 s^3 + a_4 s^4 + a_5 s^5"><span></span><span><script type="math/tex;mode=inline">l(s) = a_0 + a_1 s + a_2 s^2 + a_3 s^3 + a_4 s^4 + a_5 s^5</script><span class="tex2jax_ignore math-holder">l(s) = a_0 + a_1 s + a_2 s^2 + a_3 s^3 + a_4 s^4 + a_5 s^5</span></span></span> </p><p data-pid="cj17F3i6">这样做的好处：保证曲线连续可导，保证曲率、曲率导数平滑，便于控制边的可行性（如方向盘可转角）。</p><p data-pid="WDduyjU-">DP 的节点是采样点，DP 的边就是这些 quintic 曲线。</p><p data-pid="ERlmWG2q"><b>3. 每条边都可以计算一个 cost（代价）</b></p><p data-pid="3X1AYyOk">DP 路径规划代价函数为： <span class="ztext-math" data-eeimg="1" data-tex="C_{\text{total}}(f(s)) = C_{\text{smooth}}(f) + C_{\text{obs}}(f) + C_{\text{guidance}}(f)"><span></span><span><script type="math/tex;mode=inline">C_{\text{total}}(f(s)) = C_{\text{smooth}}(f) + C_{\text{obs}}(f) + C_{\text{guidance}}(f)</script><span class="tex2jax_ignore math-holder">C_{\text{total}}(f(s)) = C_{\text{smooth}}(f) + C_{\text{obs}}(f) + C_{\text{guidance}}(f)</span></span></span> </p><p data-pid="WN0ivzaV"><b>1）平滑成本（Smoothness Cost）</b></p><p data-pid="9Z80g4zM"><span class="ztext-math" data-eeimg="1" data-tex="C_{\text{smooth}}(f) = w_1 \int (f'(s))^2  ds+  w_2 \int (f''(s))^2 ds+    w_3 \int (f'''(s))^2 ds"><span></span><span><script type="math/tex;mode=inline">C_{\text{smooth}}(f) = w_1 \int (f'(s))^2  ds+  w_2 \int (f''(s))^2 ds+    w_3 \int (f'''(s))^2 ds</script><span class="tex2jax_ignore math-holder">C_{\text{smooth}}(f) = w_1 \int (f'(s))^2  ds+  w_2 \int (f''(s))^2 ds+    w_3 \int (f'''(s))^2 ds</span></span></span> </p><p data-pid="0Uvjsrtv">该部分惩罚：</p><ul><li data-pid="KSKiYeeP"> 一阶导 → 横向偏移速率</li><li data-pid="c3Ex_MBh"> 二阶导 → 曲率</li><li data-pid="vwoQ_9cc"> 三阶导 → 曲率变化率（方向盘 jerk）</li></ul><p data-pid="6Zfnr918"><b>2）障碍物成本（Obstacle Cost）</b></p><p data-pid="0jH4Dvu4">障碍物距离记为 <span class="ztext-math" data-eeimg="1" data-tex="d"><span></span><span><script type="math/tex;mode=inline">d</script><span class="tex2jax_ignore math-holder">d</span></span></span> ，障碍物成本定义为：</p><p data-pid="zhV4YryZ"><span class="ztext-math" data-eeimg="1" data-tex="C_{\text{obs}}(d) = \begin{cases} 0, &amp; d &gt; d_n \\[6pt] C_{\text{nudge}} (d - d_c), &amp; d_c \le d \le d_n \\[6pt] C_{\text{collision}}, &amp; d &lt; d_c \end{cases}"><span></span><span><script type="math/tex;mode=inline">C_{\text{obs}}(d) = \begin{cases} 0, & d > d_n \\[6pt] C_{\text{nudge}} (d - d_c), & d_c \le d \le d_n \\[6pt] C_{\text{collision}}, & d < d_c \end{cases}</script><span class="tex2jax_ignore math-holder">C_{\text{obs}}(d) = \begin{cases} 0, &amp; d &gt; d_n \\[6pt] C_{\text{nudge}} (d - d_c), &amp; d_c \le d \le d_n \\[6pt] C_{\text{collision}}, &amp; d &lt; d_c \end{cases}</span></span></span> </p><p data-pid="jAYM1X4e">其中：</p><ul><li data-pid="GGp7Xn7H"><span class="ztext-math" data-eeimg="1" data-tex="d_n"><span></span><span><script type="math/tex;mode=inline">d_n</script><span class="tex2jax_ignore math-holder">d_n</span></span></span> ：nudge 区域的起始距离</li><li data-pid="MdCs6G11"><span class="ztext-math" data-eeimg="1" data-tex="d_c"><span></span><span><script type="math/tex;mode=inline">d_c</script><span class="tex2jax_ignore math-holder">d_c</span></span></span> ：碰撞距离阈值</li><li data-pid="4_BCK7xI"><span class="ztext-math" data-eeimg="1" data-tex="C_{\text{nudge}}"><span></span><span><script type="math/tex;mode=inline">C_{\text{nudge}}</script><span class="tex2jax_ignore math-holder">C_{\text{nudge}}</span></span></span> ：用于侧向挤避让的代价</li><li data-pid="RZIKjGGQ"><span class="ztext-math" data-eeimg="1" data-tex="C_{\text{collision}}"><span></span><span><script type="math/tex;mode=inline">C_{\text{collision}}</script><span class="tex2jax_ignore math-holder">C_{\text{collision}}</span></span></span> ：碰撞惩罚（通常是一个极大的数字）</li></ul><p data-pid="w-t0w_B5"><b> 3）引导成本（Guidance Cost）</b></p><p data-pid="4wCmymtK"><span class="ztext-math" data-eeimg="1" data-tex="C_{\text{guidance}}(f) = \int (f(s) - g(s))^2 , ds"><span></span><span><script type="math/tex;mode=inline">C_{\text{guidance}}(f) = \int (f(s) - g(s))^2 , ds</script><span class="tex2jax_ignore math-holder">C_{\text{guidance}}(f) = \int (f(s) - g(s))^2 , ds</span></span></span> </p><p data-pid="j9bp1hb0">其中：</p><ul><li data-pid="Fo3LaPrI"><span class="ztext-math" data-eeimg="1" data-tex="f(s)"><span></span><span><script type="math/tex;mode=inline">f(s)</script><span class="tex2jax_ignore math-holder">f(s)</span></span></span> ：当前路径横向偏移</li><li data-pid="ln-g4Pqb"><span class="ztext-math" data-eeimg="1" data-tex="g(s)"><span></span><span><script type="math/tex;mode=inline">g(s)</script><span class="tex2jax_ignore math-holder">g(s)</span></span></span> ：参考路线、先验路径或目标横向分布</li><li data-pid="mvh7rl1j"> 此项用于“贴近参考线”或满足行为要求（如靠右 / 靠左） <span class="ztext-math" data-eeimg="1" data-tex="C_{\text{total}} = \underbrace{w_1\int (f')^2 ds + w_2 \int (f'')^2 ds + w_3\int (f''')^2 ds}{\textbf{平滑性}} + \underbrace{C{\text{obs}}(d)}{\textbf{障碍物惩罚}} + \underbrace{\int (f - g)^2 ds}{\textbf{引导项}}"><span></span><span><script type="math/tex;mode=inline">C_{\text{total}} = \underbrace{w_1\int (f')^2 ds + w_2 \int (f'')^2 ds + w_3\int (f''')^2 ds}{\textbf{平滑性}} + \underbrace{C{\text{obs}}(d)}{\textbf{障碍物惩罚}} + \underbrace{\int (f - g)^2 ds}{\textbf{引导项}}</script><span class="tex2jax_ignore math-holder">C_{\text{total}} = \underbrace{w_1\int (f')^2 ds + w_2 \int (f'')^2 ds + w_3\int (f''')^2 ds}{\textbf{平滑性}} + \underbrace{C{\text{obs}}(d)}{\textbf{障碍物惩罚}} + \underbrace{\int (f - g)^2 ds}{\textbf{引导项}}</span></span></span> </li></ul><p data-pid="8G5PDyyJ"><b>4. DP 在 lattice graph 上求最优路径</b></p><p data-pid="jeNKl6n4">整个规划区域变成： 节点 --&gt; 采样点、边 --&gt; 两节点之间的 quintic 多项式、边的cost --&gt;上面三大 cost 之和。</p><p data-pid="fh7WShnl">DP 搜索就是在离散采样 lattice 中寻找： <span class="ztext-math" data-eeimg="1" data-tex="f^*(s) = \arg\min_{f} C_{\text{total}}(f)"><span></span><span><script type="math/tex;mode=inline">f^*(s) = \arg\min_{f} C_{\text{total}}(f)</script><span class="tex2jax_ignore math-holder">f^*(s) = \arg\min_{f} C_{\text{total}}(f)</span></span></span></p><div class="highlight"><pre><code class="language-text">对于每一行：
  对每个节点：
    从上一行所有节点尝试连接 → 计算 cost
    取最小 cost 作为当前节点的代价</code></pre></div><p data-pid="Dbv-uX4a">最终在 DP lattice 上找到 <b>总代价最小的路径</b>。</p><p data-pid="QcEHIkjY">DP 输出的结果是： 一条离散的 SL 路径（粗路径），且具有明确的拓扑含义（左绕/右绕/nudge/follow等）</p><figure data-size="normal"><div><img src="https://pic2.zhimg.com/v2-44581ecd7c24326c088b6d0e1ab0bd73_1440w.jpg" data-size="small" data-rawwidth="269" data-rawheight="157" data-original-token="v2-0e8a60b72cc5ec7518e62772fbca0a8c" class="content_image" width="269"></div><figcaption>lattice graph</figcaption></figure><hr><h3 id="h_1979534602667323915_7" data-into-catalog-status=""><b>2.3 QP Path Optimization（连续、光滑、可控的路径）</b></h3><p data-pid="vljTobkU">DP 给出的路径是离散、折线状的，必须用 QP 优化成可控制的二阶连续曲线。</p><p data-pid="DTu4SbhV">QP 本质上是一个 convex optimization，前提是：可行域必须是凸的、参考点必须提供拓扑信息。</p><figure data-size="normal"><div><img src="https://pic4.zhimg.com/v2-4d7fc7a386671206b7cf934151f68a33_1440w.jpg" data-size="normal" data-rawwidth="789" data-rawheight="115" data-original-token="v2-4d7fc7a386671206b7cf934151f68a33" class="origin_image zh-lightbox-thumb" width="789" data-original="https://pic4.zhimg.com/v2-4d7fc7a386671206b7cf934151f68a33_r.jpg"></div><figcaption>DP path 与 QP path</figcaption></figure><p data-pid="E6YnyHPO">QP 的目标函数：<br> <span class="ztext-math" data-eeimg="1" data-tex="C(f) = w_1 \int (f''(s))^2 ds+ w_2 \int (f'''(s))^2 ds+ w_3 \int (f(s)-g(s))^2 ds"><span></span><span><script type="math/tex;mode=inline">C(f) = w_1 \int (f''(s))^2 ds+ w_2 \int (f'''(s))^2 ds+ w_3 \int (f(s)-g(s))^2 ds</script><span class="tex2jax_ignore math-holder">C(f) = w_1 \int (f''(s))^2 ds+ w_2 \int (f'''(s))^2 ds+ w_3 \int (f(s)-g(s))^2 ds</span></span></span> <br><br>解释如下：</p><ul><li data-pid="iEs_yNeV"><span class="ztext-math" data-eeimg="1" data-tex="f(s)"><span></span><span><script type="math/tex;mode=inline">f(s)</script><span class="tex2jax_ignore math-holder">f(s)</span></span></span> ：最终优化出的横向偏移</li><li data-pid="aNGBKhYk"><span class="ztext-math" data-eeimg="1" data-tex="g(s) "><span></span><span><script type="math/tex;mode=inline">g(s) </script><span class="tex2jax_ignore math-holder">g(s) </span></span></span> ：DP 路径（guidance line）</li><li data-pid="NSLSCgWM">一二三阶导数贡献平滑性与可控性</li></ul><p data-pid="YsRCNFim">这套 cost 与典型的车辆动力学需求一致：</p><table data-draft-node="block" data-draft-type="table" data-size="normal" data-row-style="normal"><tbody><tr><td>项</td><td>控制需求</td><td>物理意义</td></tr><tr><td>( f''(s)^2 )</td><td>舒适性</td><td>限制曲率</td></tr><tr><td>( f'''(s)^2 )</td><td>稳定性</td><td>限制曲率变化率</td></tr><tr><td>( (f - g)^2 )</td><td>参考一致</td><td>向 DP 结果靠拢</td></tr></tbody></table><hr><h3 id="h_1979534602667323915_8" data-into-catalog-status=""> 2.4 <b>为什么 Path Optimization 可以被建模成 QP问题？</b></h3><ul><li data-pid="T3tA7Qdc"> 轨迹是标量函数 ( l(s) )（横向偏移）</li><li data-pid="f59iU1zu"> 优化目标是二阶导、三阶导、偏离参考线 → 都是二次项</li><li data-pid="dViUz39d"> 约束可以被线性化（lateral bounds、curvature bounds）<br> 所以整个问题可以写成：二次目标函数、 线性约束（或线性化约束）→ 这是典型 convex QP</li></ul><p data-pid="8qahlvvE"><b> 2.4.1 Path Optimization 的参数化</b></p><p data-pid="DfNWuMqX">QP 不直接优化连续函数，而是将路径用 <b>多项式 or spline</b> 离散化。</p><p data-pid="OewA2pZ4">Apollo 中采用 <b>piecewise polynomial spline</b>（段三次样条）：</p><p data-pid="DK8jQ86y"><span class="ztext-math" data-eeimg="1" data-tex="l(s) = a_0 + a_1 s + a_2 s^2 + a_3 s^3 "><span></span><span><script type="math/tex;mode=inline">l(s) = a_0 + a_1 s + a_2 s^2 + a_3 s^3 </script><span class="tex2jax_ignore math-holder">l(s) = a_0 + a_1 s + a_2 s^2 + a_3 s^3 </span></span></span> </p><p data-pid="sSptAuE0">多个样条段拼接，每一段 4 个系数。</p><p data-pid="GqcFbWc5">如果一共有 (N) 个段，则参数维度 (4N)。</p><p data-pid="EZ8yOM4v">QP 优化的变量就是这些 spline 系数：</p><p data-pid="3k0K0uJT"><span class="ztext-math" data-eeimg="1" data-tex="x = [a_{0}^{(1)}, a_{1}^{(1)}, a_{2}^{(1)}, a_{3}^{(1)}, \dots , a_{3}^{(N)}]"><span></span><span><script type="math/tex;mode=inline">x = [a_{0}^{(1)}, a_{1}^{(1)}, a_{2}^{(1)}, a_{3}^{(1)}, \dots , a_{3}^{(N)}]</script><span class="tex2jax_ignore math-holder">x = [a_{0}^{(1)}, a_{1}^{(1)}, a_{2}^{(1)}, a_{3}^{(1)}, \dots , a_{3}^{(N)}]</span></span></span> </p><p data-pid="HOfIw5EO">轨迹平滑性、参考线约束、障碍约束都表达为 x 的二次函数 → 符合 QP 形式。</p><hr><p data-pid="2DGM0KKK"><b>2.4.2 QP 的目标函数建模</b></p><p data-pid="Vhc4qE_1">QP 目标包含 3 个组成部分：</p><p data-pid="er_tzQZ_"><b>1）最小化曲率 / 二阶导（舒适性）：</b></p><p data-pid="zFeFPIhp"><span class="ztext-math" data-eeimg="1" data-tex="J_1 = \int (l''(s))^2 , ds "><span></span><span><script type="math/tex;mode=inline">J_1 = \int (l''(s))^2 , ds </script><span class="tex2jax_ignore math-holder">J_1 = \int (l''(s))^2 , ds </span></span></span> </p><p data-pid="05coolwz">代入样条表达式： <span class="ztext-math" data-eeimg="1" data-tex="l''(s) = 2a_2 + 6a_3 s"><span></span><span><script type="math/tex;mode=inline">l''(s) = 2a_2 + 6a_3 s</script><span class="tex2jax_ignore math-holder">l''(s) = 2a_2 + 6a_3 s</span></span></span>  -&gt;  <span class="ztext-math" data-eeimg="1" data-tex="(l''(s))^2 = (2a_2 + 6a_3 s)^2 "><span></span><span><script type="math/tex;mode=inline">(l''(s))^2 = (2a_2 + 6a_3 s)^2 </script><span class="tex2jax_ignore math-holder">(l''(s))^2 = (2a_2 + 6a_3 s)^2 </span></span></span> </p><p data-pid="7HMpoymu">对 s 积分得到： <span class="ztext-math" data-eeimg="1" data-tex="J_1= 4 a_2^2 \Delta s + 12 a_2 a_3 \Delta s^2 + 12 a_3^2 \Delta s^3"><span></span><span><script type="math/tex;mode=inline">J_1= 4 a_2^2 \Delta s + 12 a_2 a_3 \Delta s^2 + 12 a_3^2 \Delta s^3</script><span class="tex2jax_ignore math-holder">J_1= 4 a_2^2 \Delta s + 12 a_2 a_3 \Delta s^2 + 12 a_3^2 \Delta s^3</span></span></span> </p><p data-pid="sv5FOEJT">组合成矩阵形式 <span class="ztext-math" data-eeimg="1" data-tex="x^T H_1 x"><span></span><span><script type="math/tex;mode=inline">x^T H_1 x</script><span class="tex2jax_ignore math-holder">x^T H_1 x</span></span></span> ：</p><p data-pid="WvEVWfwE"><span class="ztext-math" data-eeimg="1" data-tex=" x=[a_0,a_1,a_2,a_3]^T "><span></span><span><script type="math/tex;mode=inline"> x=[a_0,a_1,a_2,a_3]^T </script><span class="tex2jax_ignore math-holder"> x=[a_0,a_1,a_2,a_3]^T </span></span></span> </p><p data-pid="7Ziq3wLR">构造H： <span class="ztext-math" data-eeimg="1" data-tex="H_1 = \begin{bmatrix} 0 &amp; 0 &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; 8 \Delta s &amp; 12\Delta s^2\\ 0 &amp; 0 &amp; 12\Delta s^2 &amp; 24\Delta s^3 \end{bmatrix}"><span></span><span><script type="math/tex;mode=inline">H_1 = \begin{bmatrix} 0 & 0 & 0 & 0 \\ 0 & 0 & 0 & 0 \\ 0 & 0 & 8 \Delta s & 12\Delta s^2\\ 0 & 0 & 12\Delta s^2 & 24\Delta s^3 \end{bmatrix}</script><span class="tex2jax_ignore math-holder">H_1 = \begin{bmatrix} 0 &amp; 0 &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; 8 \Delta s &amp; 12\Delta s^2\\ 0 &amp; 0 &amp; 12\Delta s^2 &amp; 24\Delta s^3 \end{bmatrix}</span></span></span> </p><p data-pid="A_ifSD1Q">于是： <span class="ztext-math" data-eeimg="1" data-tex="x^T H_1 x = 4 a_2^2 \Delta s +  12 a_2 a_3 \Delta s^2+    12 a_3^2 \Delta s^3"><span></span><span><script type="math/tex;mode=inline">x^T H_1 x = 4 a_2^2 \Delta s +  12 a_2 a_3 \Delta s^2+    12 a_3^2 \Delta s^3</script><span class="tex2jax_ignore math-holder">x^T H_1 x = 4 a_2^2 \Delta s +  12 a_2 a_3 \Delta s^2+    12 a_3^2 \Delta s^3</span></span></span> </p><p data-pid="C0JueV9L">即： <span class="ztext-math" data-eeimg="1" data-tex="J_1 = x^T H_1 x"><span></span><span><script type="math/tex;mode=inline">J_1 = x^T H_1 x</script><span class="tex2jax_ignore math-holder">J_1 = x^T H_1 x</span></span></span> ，严格凸的二次函数，这就是为什么 QP 天然适合轨迹优化。</p><p data-pid="ADrZHJdy"><b>2）最小化一阶导（横向速度）</b></p><p data-pid="HNjVmFfe"><span class="ztext-math" data-eeimg="1" data-tex="J_2 = \int (l'(s))^2 ds "><span></span><span><script type="math/tex;mode=inline">J_2 = \int (l'(s))^2 ds </script><span class="tex2jax_ignore math-holder">J_2 = \int (l'(s))^2 ds </span></span></span> </p><p data-pid="Hv1HOYdh"><span class="ztext-math" data-eeimg="1" data-tex="l'(s) = a_1 + 2 a_2 s + 3 a_3 s^2"><span></span><span><script type="math/tex;mode=inline">l'(s) = a_1 + 2 a_2 s + 3 a_3 s^2</script><span class="tex2jax_ignore math-holder">l'(s) = a_1 + 2 a_2 s + 3 a_3 s^2</span></span></span> </p><p data-pid="pEwuJJeh">同样可展开 → 积分 → 得到： <span class="ztext-math" data-eeimg="1" data-tex="J_2 = x^T H_2 x"><span></span><span><script type="math/tex;mode=inline">J_2 = x^T H_2 x</script><span class="tex2jax_ignore math-holder">J_2 = x^T H_2 x</span></span></span> </p><p data-pid="ckXJEpS3"><b>3）贴合 DP Guidance（使 QP 不跳拓扑）</b></p><p data-pid="iBC-8vkl">DP 路径给出参考线 <span class="ztext-math" data-eeimg="1" data-tex="l_{\text{ref}}(s)"><span></span><span><script type="math/tex;mode=inline">l_{\text{ref}}(s)</script><span class="tex2jax_ignore math-holder">l_{\text{ref}}(s)</span></span></span>。</p><p data-pid="-N_K0TVp"><span class="ztext-math" data-eeimg="1" data-tex="J_3 = \int (l(s) - l_{\text{ref}}(s))^2 ds"><span></span><span><script type="math/tex;mode=inline">J_3 = \int (l(s) - l_{\text{ref}}(s))^2 ds</script><span class="tex2jax_ignore math-holder">J_3 = \int (l(s) - l_{\text{ref}}(s))^2 ds</span></span></span> </p><p data-pid="GUccamAu"><span class="ztext-math" data-eeimg="1" data-tex="l(s) - l_{\text{ref}}(s) = a_0 + a_1 s + a_2 s^2 + a_3 s^3 - r(s)"><span></span><span><script type="math/tex;mode=inline">l(s) - l_{\text{ref}}(s) = a_0 + a_1 s + a_2 s^2 + a_3 s^3 - r(s)</script><span class="tex2jax_ignore math-holder">l(s) - l_{\text{ref}}(s) = a_0 + a_1 s + a_2 s^2 + a_3 s^3 - r(s)</span></span></span> </p><p data-pid="qmszVMtU">展开后同样得到一个二次函数： <span class="ztext-math" data-eeimg="1" data-tex="J_3 = x^T H_3 x - 2 b^T x + c"><span></span><span><script type="math/tex;mode=inline">J_3 = x^T H_3 x - 2 b^T x + c</script><span class="tex2jax_ignore math-holder">J_3 = x^T H_3 x - 2 b^T x + c</span></span></span> ,其中 b 与 c 来自  <span class="ztext-math" data-eeimg="1" data-tex=" r(s) "><span></span><span><script type="math/tex;mode=inline"> r(s) </script><span class="tex2jax_ignore math-holder"> r(s) </span></span></span> 的积分。</p><p data-pid="eTxVavHS"><b>总目标函数组合</b></p><p data-pid="MFEGEddV"><span class="ztext-math" data-eeimg="1" data-tex="J(x) = w_k J_1 + w_d J_2 + w_p J_3 "><span></span><span><script type="math/tex;mode=inline">J(x) = w_k J_1 + w_d J_2 + w_p J_3 </script><span class="tex2jax_ignore math-holder">J(x) = w_k J_1 + w_d J_2 + w_p J_3 </span></span></span> </p><p data-pid="rODeX8RU">可写成标准 QP 形式： <span class="ztext-math" data-eeimg="1" data-tex="{ \min_x  \frac{1}{2} x^T H x + f^T x }"><span></span><span><script type="math/tex;mode=inline">{ \min_x  \frac{1}{2} x^T H x + f^T x }</script><span class="tex2jax_ignore math-holder">{ \min_x  \frac{1}{2} x^T H x + f^T x }</span></span></span>  其中： <span class="ztext-math" data-eeimg="1" data-tex="H = w_k H_1 + w_d H_2 + w_p H_3 "><span></span><span><script type="math/tex;mode=inline">H = w_k H_1 + w_d H_2 + w_p H_3 </script><span class="tex2jax_ignore math-holder">H = w_k H_1 + w_d H_2 + w_p H_3 </span></span></span>, <span class="ztext-math" data-eeimg="1" data-tex="f = - w_p b "><span></span><span><script type="math/tex;mode=inline">f = - w_p b </script><span class="tex2jax_ignore math-holder">f = - w_p b </span></span></span> </p><hr><p data-pid="t0shyWtI"><b>2.4. 3. QP 的约束建模</b></p><p data-pid="fy6Q6zXR"><b>1）lateral boundary 线性约束</b></p><p data-pid="rkSKDxah">道路边界或 DP tunnel 给出： <span class="ztext-math" data-eeimg="1" data-tex="l_{\min}(s_i) \le l(s_i) \le l_{\max}(s_i)"><span></span><span><script type="math/tex;mode=inline">l_{\min}(s_i) \le l(s_i) \le l_{\max}(s_i)</script><span class="tex2jax_ignore math-holder">l_{\min}(s_i) \le l(s_i) \le l_{\max}(s_i)</span></span></span> </p><p data-pid="24zxwNOJ">因为 <span class="ztext-math" data-eeimg="1" data-tex=" l(s) "><span></span><span><script type="math/tex;mode=inline"> l(s) </script><span class="tex2jax_ignore math-holder"> l(s) </span></span></span> 是多项式： <span class="ztext-math" data-eeimg="1" data-tex="l(s_i) = a_0 + a_1 s_i + a_2 s_i^2 + a_3 s_i^3 "><span></span><span><script type="math/tex;mode=inline">l(s_i) = a_0 + a_1 s_i + a_2 s_i^2 + a_3 s_i^3 </script><span class="tex2jax_ignore math-holder">l(s_i) = a_0 + a_1 s_i + a_2 s_i^2 + a_3 s_i^3 </span></span></span> </p><p data-pid="fegwM2if">所以： <span class="ztext-math" data-eeimg="1" data-tex="A x \le b"><span></span><span><script type="math/tex;mode=inline">A x \le b</script><span class="tex2jax_ignore math-holder">A x \le b</span></span></span>  这是严格的线性约束。</p><p data-pid="K_HBuxGx"><b>2）曲率约束（需要近似 ）</b></p><p data-pid="rugujhrC">车辆曲率：</p><p data-pid="sRd5GQNC"><span class="ztext-math" data-eeimg="1" data-tex="\kappa = \frac{l''}{(1 + l'^2)^{3/2}}"><span></span><span><script type="math/tex;mode=inline">\kappa = \frac{l''}{(1 + l'^2)^{3/2}}</script><span class="tex2jax_ignore math-holder">\kappa = \frac{l''}{(1 + l'^2)^{3/2}}</span></span></span> </p><p data-pid="UYdK2_cZ">这是非线形，但 EM Planner 做了两个近似：</p><p data-pid="edOLIB5y">近似 1：假设  <b><span class="ztext-math" data-eeimg="1" data-tex="l′ "><span></span><span><script type="math/tex;mode=inline">l′ </script><span class="tex2jax_ignore math-holder">l′ </span></span></span> 小（路径小角度偏移）</b></p><p data-pid="XCzx5Qvf">因为路径偏移量是小量，横向导数很小： <span class="ztext-math" data-eeimg="1" data-tex="l' \ll 1 → (1 + l'^2)^{3/2} ≈ 1"><span></span><span><script type="math/tex;mode=inline">l' \ll 1 → (1 + l'^2)^{3/2} ≈ 1</script><span class="tex2jax_ignore math-holder">l' \ll 1 → (1 + l'^2)^{3/2} ≈ 1</span></span></span> ，</p><p data-pid="otZq5IWS">曲率近似为： <span class="ztext-math" data-eeimg="1" data-tex="\kappa(s) \approx l''(s)"><span></span><span><script type="math/tex;mode=inline">\kappa(s) \approx l''(s)</script><span class="tex2jax_ignore math-holder">\kappa(s) \approx l''(s)</span></span></span> </p><p data-pid="_2HhWV4w">所以约束变成： <span class="ztext-math" data-eeimg="1" data-tex="|\kappa| \le \kappa_{\max} \Rightarrow |l''(s_i)| \le \kappa_{\max} "><span></span><span><script type="math/tex;mode=inline">|\kappa| \le \kappa_{\max} \Rightarrow |l''(s_i)| \le \kappa_{\max} </script><span class="tex2jax_ignore math-holder">|\kappa| \le \kappa_{\max} \Rightarrow |l''(s_i)| \le \kappa_{\max} </span></span></span> </p><p data-pid="_vMQ7GIo">将二阶导写成线性表达式： <span class="ztext-math" data-eeimg="1" data-tex="l''(s_i) = 2a_2 + 6a_3 s_i"><span></span><span><script type="math/tex;mode=inline">l''(s_i) = 2a_2 + 6a_3 s_i</script><span class="tex2jax_ignore math-holder">l''(s_i) = 2a_2 + 6a_3 s_i</span></span></span>  --&gt; 线性约束。</p><p data-pid="h96M1YXN"> 近似 2：对极值点约束离散化</p><p data-pid="y2fpAnuK">曲率是在连续空间最大，但 QP 只检查离散点： <span class="ztext-math" data-eeimg="1" data-tex="s_i = i \cdot \Delta s "><span></span><span><script type="math/tex;mode=inline">s_i = i \cdot \Delta s </script><span class="tex2jax_ignore math-holder">s_i = i \cdot \Delta s </span></span></span> </p><p data-pid="Hn7vPuTR"> 这是 QP 中一个重要 engineering trick,近似有效，计算速度快。</p><p data-pid="ezmJvie3"><b>3）初末点连续性约束（spline boundary constraints）</b></p><p data-pid="uD_wnfZ5"><span class="ztext-math" data-eeimg="1" data-tex=" l(0),l'(0), l''(0)"><span></span><span><script type="math/tex;mode=inline"> l(0),l'(0), l''(0)</script><span class="tex2jax_ignore math-holder"> l(0),l'(0), l''(0)</span></span></span> , 这些都是线性方程约束： <span class="ztext-math" data-eeimg="1" data-tex="A_{eq} x = b_{eq}"><span></span><span><script type="math/tex;mode=inline">A_{eq} x = b_{eq}</script><span class="tex2jax_ignore math-holder">A_{eq} x = b_{eq}</span></span></span> </p><hr><p data-pid="mweYCOBc"><b>2.4.4. 最终 QP 问题</b></p><p data-pid="cwI_V995"><span class="ztext-math" data-eeimg="1" data-tex="\boxed{ \begin{aligned} \min_x \quad &amp; \frac{1}{2}x^T H x + f^T x \ \text{s.t.} \quad &amp; A x \le b \ &amp; A_{eq} x = b_{eq} \end{aligned} }"><span></span><span><script type="math/tex;mode=inline">\boxed{ \begin{aligned} \min_x \quad & \frac{1}{2}x^T H x + f^T x \ \text{s.t.} \quad & A x \le b \ & A_{eq} x = b_{eq} \end{aligned} }</script><span class="tex2jax_ignore math-holder">\boxed{ \begin{aligned} \min_x \quad &amp; \frac{1}{2}x^T H x + f^T x \ \text{s.t.} \quad &amp; A x \le b \ &amp; A_{eq} x = b_{eq} \end{aligned} }</span></span></span> </p><p data-pid="UA8T6BGx">其中：</p><ul><li data-pid="NhyO3sMz"><span class="ztext-math" data-eeimg="1" data-tex="H"><span></span><span><script type="math/tex;mode=inline">H</script><span class="tex2jax_ignore math-holder">H</span></span></span>：由一二三阶导数积分构成（平滑项）</li><li data-pid="t0jbZCq_"><span class="ztext-math" data-eeimg="1" data-tex=" f"><span></span><span><script type="math/tex;mode=inline"> f</script><span class="tex2jax_ignore math-holder"> f</span></span></span> ：来自参考线偏离项</li><li data-pid="87Wta-uj"><span class="ztext-math" data-eeimg="1" data-tex="A"><span></span><span><script type="math/tex;mode=inline">A</script><span class="tex2jax_ignore math-holder">A</span></span></span> ：道路边界 + 曲率线性约束</li><li data-pid="ni9x6AtF"><span class="ztext-math" data-eeimg="1" data-tex="A_eq"><span></span><span><script type="math/tex;mode=inline">A_eq</script><span class="tex2jax_ignore math-holder">A_eq</span></span></span> ：起点状态与 spline 连续性</li></ul><p data-pid="PjM3zAG_">这是一个严格凸优化问题 → 有唯一解 → 可实时求解。</p><hr><h2 id="h_1979534602667323915_9" data-into-catalog-status="">3. EM Planner：Speed Planning 速度规划 </h2><p data-pid="raIVkAIl">在 Path Planning 得到横向轨迹 f(s) 后，Speed Planning 负责生成一条在该路径上运动的纵向速度曲线 v(t)，并确保纵向与横向行为一致、不冲突。</p><p data-pid="Fhz6Rcqn">Speed Planning 的核心思想：</p><ul><li data-pid="9AdiVz9g">将动态障碍投影到 ST（纵向–时间）平面、</li><li data-pid="SGvfSRV2">在 ST 中确定可行速度隧道（speed corridor）</li><li data-pid="d40otGym">使用 DP + QP 结合完成速度决策与优化</li><li data-pid="X9X2ZA-V">通过 EM 循环与 Path 部分相互收敛</li></ul><h3 id="h_1979534602667323915_10" data-into-catalog-status="">3.1 为什么要做 Speed Planning？</h3><p data-pid="44MLD5qL">横向路径规划只能告诉车辆“往哪里走”，无法告诉车辆：</p><ul><li data-pid="pb1R0VAN">什么时候绕过去？</li><li data-pid="rVg1oHni">需不需要刹车让行？</li><li data-pid="BWkBz5EW">是否需要超车？</li><li data-pid="NhEyVhwB">与前车保持什么样的时机和距离？</li></ul><p data-pid="b1XjimZe">这些问题本质全部是“时间问题（t-domain）”，因此必须在 ST 域上求解。</p><p data-pid="6I-BRH2V">在 EM 框架中：Path 解决几何避障（SL）、Speed 解决时间避障（ST)，两者通过 EM-like 的迭代实现一致性。</p><hr><h3 id="h_1979534602667323915_11" data-into-catalog-status="">3.2 ST Projection（障碍物在 ST 平面上的投影）</h3><p data-pid="uHIlkFkE">动态障碍物的运动 (o(t)) 会影响车辆的行驶时机，但 Path 阶段无法处理时间维度，因此需要先将障碍物投影到 ST 平面：</p><ul><li data-pid="GAD5kHx5">前车在 ST 中形成一条“上升斜带”</li><li data-pid="Lov7v45B">静态障碍在 ST 中是“垂直阻塞区域”</li><li data-pid="EPJQRPIz">对向来车、cut-in、merge 等形成“时间冲突窗口”</li></ul><figure data-size="normal"><div><img src="https://pic2.zhimg.com/v2-533e450dc5aa4a0934bbb394e1221955_1440w.jpg" data-size="normal" data-rawwidth="794" data-rawheight="214" data-original-token="v2-4b2ee7e94a9fa029c05ddc6744578632" class="origin_image zh-lightbox-thumb" width="794" data-original="https://pic2.zhimg.com/v2-533e450dc5aa4a0934bbb394e1221955_r.jpg"></div><figcaption>前车cut-in 典型场景</figcaption></figure><figure data-size="normal"><div><img src="https://pic1.zhimg.com/v2-68ec6816886a52c1bfac1198ee444ca6_1440w.jpg" data-size="small" data-rawwidth="327" data-rawheight="284" data-original-token="v2-a2b170553c7e140db26773abdd68b6d8" class="content_image" width="327"></div><figcaption>s-t 图</figcaption></figure><hr><h3 id="h_1979534602667323915_12" data-into-catalog-status=""><b>3.3 DP Speed Decision：粗速度决策（跟车、让行、超车、穿越）</b></h3><p data-pid="ZY79PHbu">在 ST corridor 上，用动态规划（DP）搜索一条“粗速度曲线”，决定：</p><ul><li data-pid="THxQRfK_">是继续跟车（follow）</li><li data-pid="DjSY-eLE">还是提前加速超车（overtake）</li><li data-pid="wLLRLSmV">还是减速让行（yield）</li><li data-pid="WVsmxiHi">是否需要停车（stop）</li><li data-pid="tG78IY4Z">是否穿越对向车/行人 gap（pass）</li></ul><figure data-size="normal"><div><img src="https://pic2.zhimg.com/v2-04713cb560810f43fe68f88143f0b0a1_1440w.jpg" data-size="small" data-rawwidth="317" data-rawheight="273" data-original-token="v2-a39f06666018d786443c39b9d66120e3" class="content_image" width="317"></div><figcaption>DP Speed Search</figcaption></figure><p data-pid="MnNPwJXf">DP 的作用是决定 <b>行为拓扑</b>，而不是生成平滑速度；DP 负责“选择行为“，QP 负责“优化曲线”</p><p data-pid="cH_wtr_U">DP 的cost包括：</p><p data-pid="aDq1dtFp">1）速度平滑： <span class="ztext-math" data-eeimg="1" data-tex="C_smooth = ∫ (v̇)^2 dt"><span></span><span><script type="math/tex;mode=inline">C_smooth = ∫ (v̇)^2 dt</script><span class="tex2jax_ignore math-holder">C_smooth = ∫ (v̇)^2 dt</span></span></span> </p><p data-pid="f_xX64Fj">2）与参考速度的一致性:   <span class="ztext-math" data-eeimg="1" data-tex=" C_ref = ∫ (v − v_ref)^2 dt "><span></span><span><script type="math/tex;mode=inline"> C_ref = ∫ (v − v_ref)^2 dt </script><span class="tex2jax_ignore math-holder"> C_ref = ∫ (v − v_ref)^2 dt </span></span></span> </p><p data-pid="PGouKYEu">3）碰撞风险:  <span class="ztext-math" data-eeimg="1" data-tex=" C_obs = big number"><span></span><span><script type="math/tex;mode=inline"> C_obs = big number</script><span class="tex2jax_ignore math-holder"> C_obs = big number</span></span></span> （进入障碍区域） </p><p data-pid="74SQPnlK">4）行为一致性: <span class="ztext-math" data-eeimg="1" data-tex="C_behavior"><span></span><span><script type="math/tex;mode=inline">C_behavior</script><span class="tex2jax_ignore math-holder">C_behavior</span></span></span>  （跟车、让行、超车等的行为 tag）</p><p data-pid="bof4wjDK">DP Speed 的输出：一条粗糙但行为明确的速度曲线，且决定了当前周期的纵向行为：</p><ul><li data-pid="JSVEOndi">跟车 → 维持安全距离</li><li data-pid="Y_V9N68j">超车 → 提前加速</li><li data-pid="DskiuWau">让行（yield）→ 主动降速等待</li><li data-pid="td1VWRNr">停车（stop）→ 逐渐减速至 0</li><li data-pid="wvmS7LvH">穿越 → 保持较高速度通过 gap</li></ul><p data-pid="2SrtFsg_">DP speed 的“行为标签”也将被传递给 QP Path 作为“拓扑约束”。</p><p class="ztext-empty-paragraph"><br></p><hr><h3 id="h_1979534602667323915_13" data-into-catalog-status=""><b>3.4 QP Speed Optimization ：连续平滑可控的速度曲线</b></h3><p data-pid="Mn3e_lXS">DP 给出的速度曲线只具有行为拓扑意义（是否跟车、是否让行等），但不能直接执行。 因此，需要将速度规划问题转化为一个凸二次规划（QP），生成真实可控、连续的纵向轨迹。</p><figure data-size="normal"><div><img src="https://pic3.zhimg.com/v2-61d66e6ba141066fcbb50addecd33ea2_1440w.jpg" data-size="small" data-rawwidth="320" data-rawheight="295" data-original-token="v2-27b8281294e491ce5bf7fda6d246ab63" class="content_image" width="320"></div><figcaption>DP Speed、QP Speed</figcaption></figure><p data-pid="RBI96IVF"><b>1. QP 的变量定义</b></p><p data-pid="OPRy1J0x">QP 直接优化离散时刻的纵向位置序列： <span class="ztext-math" data-eeimg="1" data-tex="[ x = [s_0,; s_1,; \dots,; s_N]^{T} ]"><span></span><span><script type="math/tex;mode=inline">[ x = [s_0,; s_1,; \dots,; s_N]^{T} ]</script><span class="tex2jax_ignore math-holder">[ x = [s_0,; s_1,; \dots,; s_N]^{T} ]</span></span></span> </p><p data-pid="XxlMxDoK">其中： <span class="ztext-math" data-eeimg="1" data-tex="s_k = s(t_k)"><span></span><span><script type="math/tex;mode=inline">s_k = s(t_k)</script><span class="tex2jax_ignore math-holder">s_k = s(t_k)</span></span></span> <span class="ztext-math" data-eeimg="1" data-tex="\dot{s}(t)) 与 (\ddot{s}(t)"><span></span><span><script type="math/tex;mode=inline">\dot{s}(t)) 与 (\ddot{s}(t)</script><span class="tex2jax_ignore math-holder">\dot{s}(t)) 与 (\ddot{s}(t)</span></span></span> 可由差分计算： <span class="ztext-math" data-eeimg="1" data-tex="\dot{s}k = \frac{s{k+1} - s_k}{\Delta t}, \qquad \ddot{s}k = \frac{s{k+1} - 2s_k + s_{k-1}}{\Delta t^2}"><span></span><span><script type="math/tex;mode=inline">\dot{s}k = \frac{s{k+1} - s_k}{\Delta t}, \qquad \ddot{s}k = \frac{s{k+1} - 2s_k + s_{k-1}}{\Delta t^2}</script><span class="tex2jax_ignore math-holder">\dot{s}k = \frac{s{k+1} - s_k}{\Delta t}, \qquad \ddot{s}k = \frac{s{k+1} - 2s_k + s_{k-1}}{\Delta t^2}</span></span></span> </p><p data-pid="yho_NURU">QP 输出最终的：位移 <span class="ztext-math" data-eeimg="1" data-tex="s(t)"><span></span><span><script type="math/tex;mode=inline">s(t)</script><span class="tex2jax_ignore math-holder">s(t)</span></span></span> 、速度 <span class="ztext-math" data-eeimg="1" data-tex="v(t)=\dot{s}(t)"><span></span><span><script type="math/tex;mode=inline">v(t)=\dot{s}(t)</script><span class="tex2jax_ignore math-holder">v(t)=\dot{s}(t)</span></span></span> 、加速度 <span class="ztext-math" data-eeimg="1" data-tex="a(t)=\ddot{s}(t)"><span></span><span><script type="math/tex;mode=inline">a(t)=\ddot{s}(t)</script><span class="tex2jax_ignore math-holder">a(t)=\ddot{s}(t)</span></span></span> 。</p><p data-pid="bCHWYIHk"><b>2. QP 目标函数</b></p><p data-pid="BCT3Guqv">QP Speed 的核心目标是：</p><p data-pid="1grIAI_9">1）保证 jerk、加速度平滑<br>2）保证与 DP 行为一致（不跳变）<br>3）满足终端约束 / 参考意图<br>4）优化整体舒适性和时序可行性</p><p data-pid="3bLCwT_P">目标函数： <span class="ztext-math" data-eeimg="1" data-tex="\begin{aligned} J_{\text{QP}} = w_j \sum_{k=1}^{N-1} (\ddot{s}_k)^2 w_v \sum_{k=0}^{N} (\dot{s}k - v{DP,k})^2 \ &amp;+ w_s \sum_{k=0}^{N} (s_k - s_{\text{ref},k})^2 w_T (s_N - s_{\text{target}})^2 \end{aligned} "><span></span><span><script type="math/tex;mode=inline">\begin{aligned} J_{\text{QP}} = w_j \sum_{k=1}^{N-1} (\ddot{s}_k)^2 w_v \sum_{k=0}^{N} (\dot{s}k - v{DP,k})^2 \ &+ w_s \sum_{k=0}^{N} (s_k - s_{\text{ref},k})^2 w_T (s_N - s_{\text{target}})^2 \end{aligned} </script><span class="tex2jax_ignore math-holder">\begin{aligned} J_{\text{QP}} = w_j \sum_{k=1}^{N-1} (\ddot{s}_k)^2 w_v \sum_{k=0}^{N} (\dot{s}k - v{DP,k})^2 \ &amp;+ w_s \sum_{k=0}^{N} (s_k - s_{\text{ref},k})^2 w_T (s_N - s_{\text{target}})^2 \end{aligned} </span></span></span> </p><p data-pid="diQ-xOwP">其中：</p><ul><li data-pid="bTtQ59KQ">jerk 项 <span class="ztext-math" data-eeimg="1" data-tex="w_j \ddot{s}^2"><span></span><span><script type="math/tex;mode=inline">w_j \ddot{s}^2</script><span class="tex2jax_ignore math-holder">w_j \ddot{s}^2</span></span></span> → 控制舒适性，抑制速度曲线抖动</li><li data-pid="VZbM6KTK">速度 tracking 项 <span class="ztext-math" data-eeimg="1" data-tex="w_v (\dot{s} - v_{DP})^2"><span></span><span><script type="math/tex;mode=inline">w_v (\dot{s} - v_{DP})^2</script><span class="tex2jax_ignore math-holder">w_v (\dot{s} - v_{DP})^2</span></span></span> → 使 QP 与 DP 拓扑一致（是否跟车 / 超车）</li><li data-pid="VkCj_K5r">位置 tracking 项 <span class="ztext-math" data-eeimg="1" data-tex="w_s (s - s_{\text{ref}})^2"><span></span><span><script type="math/tex;mode=inline">w_s (s - s_{\text{ref}})^2</script><span class="tex2jax_ignore math-holder">w_s (s - s_{\text{ref}})^2</span></span></span> → 常用于靠近目标停车点、红灯 stop line</li><li data-pid="yJx46z8M">终端约束项 <span class="ztext-math" data-eeimg="1" data-tex="w_T"><span></span><span><script type="math/tex;mode=inline">w_T</script><span class="tex2jax_ignore math-holder">w_T</span></span></span> → 使最终速度/位置达到预期目标（停车/变速场景）</li></ul><p data-pid="Hj16zDP9"><span class="ztext-math" data-eeimg="1" data-tex="\boxed{J_{\text{QP}} = \frac{1}{2} x^T H x + f^T x} "><span></span><span><script type="math/tex;mode=inline">\boxed{J_{\text{QP}} = \frac{1}{2} x^T H x + f^T x} </script><span class="tex2jax_ignore math-holder">\boxed{J_{\text{QP}} = \frac{1}{2} x^T H x + f^T x} </span></span></span> </p><p data-pid="4T_STosF">通过对差分形式展开，就能得到 <span class="ztext-math" data-eeimg="1" data-tex="H"><span></span><span><script type="math/tex;mode=inline">H</script><span class="tex2jax_ignore math-holder">H</span></span></span> , <span class="ztext-math" data-eeimg="1" data-tex="f "><span></span><span><script type="math/tex;mode=inline">f </script><span class="tex2jax_ignore math-holder">f </span></span></span> 的具体矩阵结构（稀疏且对称）。</p><hr><p data-pid="KRijgrpU"><b>3. QP 的约束（线性形式）</b></p><p data-pid="kl0rW1nW">1）ST corridor（时序安全约束）： <span class="ztext-math" data-eeimg="1" data-tex="s_{min}(t_k) \le s_k \le s_{max}(t_k)"><span></span><span><script type="math/tex;mode=inline">s_{min}(t_k) \le s_k \le s_{max}(t_k)</script><span class="tex2jax_ignore math-holder">s_{min}(t_k) \le s_k \le s_{max}(t_k)</span></span></span> </p><p data-pid="blzthZS9">2）初始状态约束： <span class="ztext-math" data-eeimg="1" data-tex="s_0 = s(0),\quad \dot{s}_0 = v(0),\quad \ddot{s}_0 = a(0) "><span></span><span><script type="math/tex;mode=inline">s_0 = s(0),\quad \dot{s}_0 = v(0),\quad \ddot{s}_0 = a(0) </script><span class="tex2jax_ignore math-holder">s_0 = s(0),\quad \dot{s}_0 = v(0),\quad \ddot{s}_0 = a(0) </span></span></span> </p><p data-pid="W5jm7WS_">3） 最大速度 / 加速度约束（线性化）： <span class="ztext-math" data-eeimg="1" data-tex="0 \le \dot{s}k \le v{\max} ] [ a_{min} \le \ddot{s}k \le a{max} "><span></span><span><script type="math/tex;mode=inline">0 \le \dot{s}k \le v{\max} ] [ a_{min} \le \ddot{s}k \le a{max} </script><span class="tex2jax_ignore math-holder">0 \le \dot{s}k \le v{\max} ] [ a_{min} \le \ddot{s}k \le a{max} </span></span></span> </p><p data-pid="9P2MvpnY">这些都可以用线性方式写成： <span class="ztext-math" data-eeimg="1" data-tex="A x \le b,\qquad A_{eq} x = b_{eq}"><span></span><span><script type="math/tex;mode=inline">A x \le b,\qquad A_{eq} x = b_{eq}</script><span class="tex2jax_ignore math-holder">A x \le b,\qquad A_{eq} x = b_{eq}</span></span></span> </p><p data-pid="ydkqZbtH"><b>4. 最终 QP 问题</b></p><p data-pid="RdVagK03"><span class="ztext-math" data-eeimg="1" data-tex="[ \boxed{ \begin{aligned} \min_{x} ;&amp; \frac{1}{2}x^T H x + f^T x\\[4pt] \text{s.t.};&amp; A x \le b\ &amp; A_{eq} x = b_{eq} \end{aligned}} ]"><span></span><span><script type="math/tex;mode=inline">[ \boxed{ \begin{aligned} \min_{x} ;& \frac{1}{2}x^T H x + f^T x\\[4pt] \text{s.t.};& A x \le b\ & A_{eq} x = b_{eq} \end{aligned}} ]</script><span class="tex2jax_ignore math-holder">[ \boxed{ \begin{aligned} \min_{x} ;&amp; \frac{1}{2}x^T H x + f^T x\\[4pt] \text{s.t.};&amp; A x \le b\ &amp; A_{eq} x = b_{eq} \end{aligned}} ]</span></span></span> </p><p data-pid="w2HAb_V1">这是行业内 Speed Planning 的标准 QP 形式，可通过OSQP高效求解。</p><hr><h2 id="h_1979534602667323915_14" data-into-catalog-status="">4.为什么EM Planner曾是行业主流？</h2><p data-pid="xA2fF0uF">在当时的工程条件下，EM Planner 在实时性、可解释性与稳定性之间取得了难以替代的平衡。</p><p data-pid="mRybnlgS">1. 将高维规划拆解为两个凸优化问题，确保实时性。单周期可在 5–20 ms 内稳定运行，适合车规嵌入式系统。</p><p data-pid="hWZdzHF6">2. 结构清晰、逻辑明确、功能可控，每一层都有明确职责、调参、debug 都相对可控，整个规划逻辑“可解释性高”。</p><p data-pid="wbHcGkHT">3. 可扩展性强：可替换 DP/QP 模块、外部行为层（behavior planner）、多拓扑路径（path graph）、 fusion 策略（nudge, yield, merge）等。</p><p data-pid="L6N-16YI">4. 对 perception &amp; prediction 要求相对可控，EM 仅需障碍物及预测轨迹，预测误差不会直接导致规划彻底失败，具备很好鲁棒性。 </p><hr><h2 id="h_1979534602667323915_15" data-into-catalog-status="">5. EM Planner：路径–速度解耦的结构性边界</h2><p data-pid="2xp_0WOe">Path–Speed 拓扑不一致并非工程实现缺陷，而是路径–速度解耦建模方式所带来的结构性结果。</p><p data-pid="yg2JeW8F"><b>1. Path 与 Speed 的拓扑一致性难以保证（核心痛点）</b></p><p data-pid="I5rRpiHy">典型问题：</p><ul><li data-pid="4rqjhxsl"> Path 判断应超车，但 Speed 选择跟车</li><li data-pid="f-K1RKSD"> Speed 判断应让行，但 Path 仍绕障</li><li data-pid="-IXgc8bV"> yield/over-take 行为不一致</li><li data-pid="jKMaifKI"> “半超车”“来回挤”“蛇形速度变化”</li><li data-pid="9MmwS7d4"> 行人穿越 gap pass 决策震荡<br> <br><b> 本质原因：</b></li></ul><blockquote data-pid="sTzDR4YC"><b>EM Planner 将高维动态规划问题分解为两个低维问题，但真实的障碍物可行域无法在 SL 与 ST 中被同时正确表达。这必然导致 Path 与 Speed 拓扑不一致，EM 只能靠迭代修补，并不保证收敛。</b></blockquote><p data-pid="5kZ2s3Fl"><b>2. SL Projection（动态障碍几何化）不精确</b></p><p data-pid="32oUQVVd">SL Projection 使用上周期的 speed 估计来投影，这是因为 Path Planner 在 Speed Planner 之前运行，系统无法知道当前周期的速度规划结果，只能使用上一周期速度来估计未来障碍物在 SL 坐标中的位置。这是 Path–Speed 解耦带来的天然结构性限制，也是 EM Planner 不是严格时空耦合的原因。</p><p data-pid="XSmTzdLw">并且SL Projection 将动态障碍物强行“压扁”为 SL 几何带： <span class="ztext-math" data-eeimg="1" data-tex="O(t) \rightarrow O^{SL}(s, l)"><span></span><span><script type="math/tex;mode=inline">O(t) \rightarrow O^{SL}(s, l)</script><span class="tex2jax_ignore math-holder">O(t) \rightarrow O^{SL}(s, l)</span></span></span> <br>这个映射依赖：上一周期 ego 的速度、障碍物预测，任何误差都会导致SL 投影偏移，造成Speed 与 Path 互相矛盾，进而导致路径不稳定抖动。</p><p data-pid="mRErnGH5"><b>3. EM Iteration 的收敛不保证（算法性缺陷）</b></p><p data-pid="Zm4MqzwF">EM 迭代实际只是“来回试探”： <span class="ztext-math" data-eeimg="1" data-tex="\text{Path}^{(k)} \rightarrow \text{Speed}^{(k)} \rightarrow \text{Path}^{(k+1)}"><span></span><span><script type="math/tex;mode=inline">\text{Path}^{(k)} \rightarrow \text{Speed}^{(k)} \rightarrow \text{Path}^{(k+1)}</script><span class="tex2jax_ignore math-holder">\text{Path}^{(k)} \rightarrow \text{Speed}^{(k)} \rightarrow \text{Path}^{(k+1)}</span></span></span> ，并<b>没有数学意义上的收敛性保证</b>。</p><p data-pid="3-BsOqDt">当存在： 复杂交互（merge, cut-in, intersection）、双向博弈关系（oncoming yield）、高速 overtaking时，EM 往往会 oscillate（震荡）。</p><p data-pid="U-MWQOLo">因此工程上通常采用： 最大迭代次数限制、  fallback 轨迹、强制行为切换、reduce tunnel 等方法。<br> </p><p data-pid="mlFoi9AK"><b>4. DP 和 QP 的 cost tuning 极其复杂（调参噩梦）</b></p><p data-pid="rQaFawgG">一个能处理所有场景的统一 cost 函数几乎不可能存在。调参巨耗人力，且迁移难度非常大。</p><p data-pid="27tyEOLH"><b>5. 难以处理高维交互行为</b></p><p data-pid="TyoI_Qh0">本质上它不是一个统一的时空规划框架，在解决多车 merge、 多车交互（如双车会车）、博弈（对向车、停车让行）、 行人 + 自车交互、复杂城市道路、快速 cut-in等场景时比较吃力。</p><hr><h3 id="h_1979534602667323915_16" data-into-catalog-status=""><b>工程中 EM 需要重点解决的关键问题</b></h3><ol><li data-pid="aWlYZJl6"><b>Path–Speed 一致性（topology consistency）</b></li><li data-pid="FE3wKaL6"><b>SL Projection 准确性（dynamic obstacle mapping）</b></li><li data-pid="DklMV4MM"><b>ST Boundary 凸化（保证 QP 可解）</b></li><li data-pid="eJ60mRg1"><b>cut-in / merge 的可行速度带构造</b></li><li data-pid="2-4Czlc1"><b>DP cost tuning 的自动化（避免手工调参）</b></li><li data-pid="tchQE6ho"><b>EM 收敛策略（fallback + safemode）</b></li><li data-pid="k68_JvTV"><b>behavior fusion：行为层如何指导 EM</b></li><li data-pid="Tm8yznQB"><b>ST corridor discontinuity（障碍跳变带来的 path/speed 不连续）</b></li></ol><p data-pid="iwWzxAxB">从更长期的技术演进角度看，EM Planner 所暴露的局限并不意味着其工程设计存在问题，而是反映了路径–速度解耦这一规划范式在复杂动态场景下面临的天然能力边界。该范式通过拆解高维问题换取了实时性与可解释性，但其代价是时空一致性只能通过迭代修补，而非在建模阶段得到统一保证。</p><p data-pid="Xx9lF67S">随着车规算力提升以及连续优化方法的逐步成熟，在规划层面直接引入统一的时空状态建模，将路径选择与时间决策纳入同一优化框架中联合求解。通过这种方式，轨迹的几何可行性与时序可行性不再依赖事后对齐，从而在方法论上规避路径–速度拓扑不一致所带来的系统性问题。</p></div><span id="VirtualCatalogAnchorPoint"></span></span></div></div></div><div class="css-3ibr72"><div class="css-34mzkj"><div></div><a href="https://zhuanlan.zhihu.com/c_1865469663493877760" target="_blank" aria-label="自动驾驶决策与规划" class="css-1b0xgmx">所属专栏 · 2025-12-23 23:41 更新</a><div class="css-vurnku"><div class="css-4cffwv"><a href="https://zhuanlan.zhihu.com/c_1865469663493877760" target="_blank" aria-label="自动驾驶决策与规划" class="css-fx0vze"><img src="https://picx.zhimg.com/v2-c5be1695771c4f9b442b5bde56e5e8e0_720w.jpg?source=172ae18b" alt="" class="css-1rguod0"><div class="css-pvcl3l"><div class="css-573q3">自动驾驶决策与规划</div><div class="css-15gd1w6"><img src="https://pic1.zhimg.com/v2-8ab856e72fbe4edb7642df4788e3055e_l.jpg?source=172ae18b" alt="" class="css-1tuazgb"><div class="css-13lpifz">胖胖橙</div><div class="css-1h9hcdn"></div></div><div class="css-6tjr2x">6 篇内容 · 550 赞同</div></div></a><button type="button" class="Button css-ooiubj FEfUrdfMIKpQDJDqkjte Button--primary Button--blue epMJl0lFQuYbC7jrwr_o JmYzaky7MEPMFcJDLNMG">订阅</button></div><a href="https://zhuanlan.zhihu.com/c_1865469663493877760" target="_blank" aria-label="自动驾驶决策与规划" class="css-3ohqj7"><div class="css-oir6xv"><div class="css-pqko58">最热内容 ·</div><div class="css-fkrpal">自动驾驶决策规划---时空联合规划</div></div></a></div></div></div><div role="button" tabindex="0" class="ContentItem-time">发布于 2025-12-23 23:37<!-- -->・<!-- -->江苏</div><div><div class="Sticky RichContent-actions is-fixed is-bottom" style="width: 654px; bottom: 0px; left: 145.2px;"><div class="ContentItem-actions" data-za-detail-view-path-module="BottomBar" data-za-extra-module="{&quot;card&quot;:{&quot;content&quot;:{&quot;type&quot;:&quot;Post&quot;,&quot;id&quot;:&quot;1979534602667323915&quot;,&quot;token&quot;:&quot;1979534602667323915&quot;}}}"><span><span><button aria-label="赞同 12 " aria-live="polite" type="button" class="Button VoteButton FEfUrdfMIKpQDJDqkjte"><span style="display:inline-flex;align-items:center">​<svg width="10" height="10" viewBox="0 0 24 24" class="Zi Zi--TriangleUp VoteButton-TriangleUp" fill="currentColor"><path fill-rule="evenodd" d="M13.792 3.681c-.781-1.406-2.803-1.406-3.584 0l-7.79 14.023c-.76 1.367.228 3.046 1.791 3.046h15.582c1.563 0 2.55-1.68 1.791-3.046l-7.79-14.023Z" clip-rule="evenodd"></path></svg></span>赞同 12</button></span><button aria-label="反对" aria-live="polite" type="button" class="Button VoteButton VoteButton--down FEfUrdfMIKpQDJDqkjte"><span style="display:inline-flex;align-items:center">​<svg width="10" height="10" viewBox="0 0 24 24" class="Zi Zi--TriangleDown" fill="currentColor"><path fill-rule="evenodd" d="M13.792 20.319c-.781 1.406-2.803 1.406-3.584 0L2.418 6.296c-.76-1.367.228-3.046 1.791-3.046h15.582c1.563 0 2.55 1.68 1.791 3.046l-7.79 14.023Z" clip-rule="evenodd"></path></svg></span></button></span><button type="button" class="Button BottomActions-CommentBtn FEfUrdfMIKpQDJDqkjte Button--plain Button--withIcon Button--withLabel fEPKGkUK5jyc4fUuT0QP B46v1Ak6Gj5sL2JTS4PY RuuQ6TOh2cRzJr6WlyQp"><span style="display:inline-flex;align-items:center">​<svg width="1.2em" height="1.2em" viewBox="0 0 24 24" class="Zi Zi--Comment Button-zi t2ntD6J1DemdOdvh5FB4" fill="currentColor"><path fill-rule="evenodd" d="M12 2.75a9.25 9.25 0 1 0 4.737 17.197l2.643.817a1 1 0 0 0 1.25-1.25l-.8-2.588A9.25 9.25 0 0 0 12 2.75Z" clip-rule="evenodd"></path></svg></span>2 条评论</button><div class="Popover ShareMenu"><div class="ShareMenu-toggler" id="Popover4-toggle" aria-haspopup="true" aria-expanded="false"><button type="button" class="Button FEfUrdfMIKpQDJDqkjte Button--plain Button--withIcon Button--withLabel fEPKGkUK5jyc4fUuT0QP B46v1Ak6Gj5sL2JTS4PY RuuQ6TOh2cRzJr6WlyQp"><span style="display:inline-flex;align-items:center">​<svg width="1.2em" height="1.2em" viewBox="0 0 24 24" class="ZDI ZDI--PaperplaneFill24 Button-zi t2ntD6J1DemdOdvh5FB4" fill="currentColor"><path d="M19.47 1.914a.8.8 0 0 1 1.204.778l-1.872 16.386a.9.9 0 0 1-1.204.743l-4.615-1.692a.7.7 0 0 0-.831.28l-1.927 3.02c-.43.674-1.474.369-1.474-.43v-3.865a.8.8 0 0 1 .179-.504l5.808-7.148a.595.595 0 0 0-.897-.781l-5.93 6.354a1.1 1.1 0 0 1-1.258.252L2.57 13.46a.8.8 0 0 1-.08-1.415l16.98-10.13Z"></path></svg></span>分享</button></div></div><button aria-live="polite" type="button" class="Button ContentItem-action FEfUrdfMIKpQDJDqkjte Button--plain Button--withIcon Button--withLabel fEPKGkUK5jyc4fUuT0QP B46v1Ak6Gj5sL2JTS4PY RuuQ6TOh2cRzJr6WlyQp"><span style="display:inline-flex;align-items:center">​<svg width="1.2em" height="1.2em" viewBox="0 0 24 24" class="Zi Zi--Heart Button-zi t2ntD6J1DemdOdvh5FB4" fill="currentColor"><path fill-rule="evenodd" d="M17.142 3.041c1.785.325 3.223 1.518 4.167 3.071 1.953 3.215.782 7.21-1.427 9.858a23.968 23.968 0 0 1-4.085 3.855c-.681.5-1.349.923-1.962 1.234-.597.303-1.203.532-1.748.587a.878.878 0 0 1-.15.002c-.545-.04-1.162-.276-1.762-.582a14.845 14.845 0 0 1-2.008-1.27 24.254 24.254 0 0 1-4.21-4.002c-2.1-2.56-3.16-6.347-1.394-9.463.92-1.624 2.362-2.892 4.173-3.266 1.657-.341 3.469.097 5.264 1.44 1.75-1.309 3.516-1.76 5.142-1.464Z" clip-rule="evenodd"></path></svg></span>喜欢</button><button type="button" class="Button FEfUrdfMIKpQDJDqkjte Button--plain Button--withIcon Button--withLabel fEPKGkUK5jyc4fUuT0QP B46v1Ak6Gj5sL2JTS4PY RuuQ6TOh2cRzJr6WlyQp"><span style="display:inline-flex;align-items:center">​<svg width="1.2em" height="1.2em" viewBox="0 0 24 24" class="Zi Zi--Star Button-zi t2ntD6J1DemdOdvh5FB4" fill="currentColor"><path d="M10.484 3.307c.673-1.168 2.358-1.168 3.032 0l2.377 4.122a.25.25 0 0 0 .165.12l4.655.987c1.319.28 1.84 1.882.937 2.884l-3.186 3.535a.25.25 0 0 0-.063.193l.5 4.733c.142 1.34-1.222 2.33-2.453 1.782l-4.346-1.938a.25.25 0 0 0-.204 0l-4.346 1.938c-1.231.549-2.595-.442-2.453-1.782l.5-4.733a.25.25 0 0 0-.064-.193L2.35 11.42c-.903-1.002-.382-2.604.937-2.884l4.655-.987a.25.25 0 0 0 .164-.12l2.378-4.122Z"></path></svg></span>收藏</button><button type="button" class="Button ContentItem-action FEfUrdfMIKpQDJDqkjte Button--plain Button--withIcon Button--withLabel fEPKGkUK5jyc4fUuT0QP B46v1Ak6Gj5sL2JTS4PY RuuQ6TOh2cRzJr6WlyQp"><span style="display:inline-flex;align-items:center">​<svg width="1.2em" height="1.2em" viewBox="0 0 24 24" class="Zi Zi--Deliver Button-zi t2ntD6J1DemdOdvh5FB4" fill="currentColor"><g fill-rule="evenodd" clip-rule="evenodd"><path d="M7.821 12a.75.75 0 0 1 .75-.75h6.857a.75.75 0 0 1 0 1.5H8.571a.75.75 0 0 1-.75-.75ZM8.965 8a.75.75 0 0 1 .75-.75h4.571a.75.75 0 0 1 0 1.5H9.715a.75.75 0 0 1-.75-.75Z"></path><path d="M7.527 3.15a2.35 2.35 0 0 0-2.309 1.91L3.165 15.84a.85.85 0 0 0-.015.16v2.5a2.35 2.35 0 0 0 2.35 2.35h13a2.35 2.35 0 0 0 2.35-2.35V16a.848.848 0 0 0-.015-.16L18.78 5.06a2.35 2.35 0 0 0-2.308-1.91H7.527Zm0 1.7a.65.65 0 0 0-.639.528l-1.88 9.872h13.984l-1.88-9.872a.65.65 0 0 0-.64-.528H7.528Z"></path></g></svg></span>申请转载</button><div class="Post-ActionMenuButton"><div class="Popover"><div id="Popover5-toggle" aria-haspopup="true" aria-expanded="false"><button type="button" class="Button FEfUrdfMIKpQDJDqkjte Button--plain Button--withIcon Button--iconOnly fEPKGkUK5jyc4fUuT0QP B46v1Ak6Gj5sL2JTS4PY hIwDV_tcL6XN1HprrnAq"><span style="display:inline-flex;align-items:center">​<svg width="1.2em" height="1.2em" viewBox="0 0 24 24" class="Zi Zi--Dots Button-zi t2ntD6J1DemdOdvh5FB4" fill="currentColor"><path d="M6 10.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3ZM10.5 12a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0ZM16.5 12a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0Z"></path></svg></span></button></div></div></div></div></div><div class="Sticky--holder" style="position: static; inset: auto auto 0px 0px; display: block; float: none; margin: 0px 0px 10px; height: 53.6px;"></div></div>